<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>File Access</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/footer.css">
<title>TERASOLUNA Batch Framework for Java (5.x) Development Guideline</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8VC2LCPQFM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());  gtag('config', 'G-8VC2LCPQFM');
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46550814-2', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body id="Ch05_FileAccess" class="book toc2 toc-left">
<div id="header">
<h1>File Access</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch05_FileAccess_Overview">Overview</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_Overview_FileType">Type of File which can be handled</a></li>
<li><a href="#Ch05_FileAccess_Overview_FileAccessComponents">A component that inputs and outputs a flat file</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToUse">How To Use</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_VariableLength">Variable-length record</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_VariableLength_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_VariableLength_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_FixedLength">Fixed-length record</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_FixedLength_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_FixedLength_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_PathhThrough">Single String record</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_PathhThrough_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_PathhThrough_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HeaderFooter">Header and Footer</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_HeaderFooter_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_HeaderFooter_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_MultiFile">Multiple Files</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_MultiFile_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_MultiFile_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_Output_ControlBreak">Control Break</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>
<ul class="sectlevel2">
<li><a href="#Ch05_FileAccess_FieldSetMapper">Implmementation of FieldSetMapper</a></li>
<li><a href="#Ch05_FileAccess_Xml">XML File</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_Xml_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_Xml_Output">Output</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess_MultiFormat">Multi format</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_MultiLine_Input">Input</a></li>
<li><a href="#Ch05_FileAccess_MultiLine_Output">Output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch05_FileAccess_Overview"><a class="anchor" href="#Ch05_FileAccess_Overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how to input and output files.</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Overview_FileType"><a class="anchor" href="#Ch05_FileAccess_Overview_FileType"></a>Type of File which can be handled</h3>
<div class="paragraph">
<div class="title">Type of File which can be handled</div>
<p>The type of files that can be handled with TERASOLUNA Batch 5.x are ones decribed as below.<br>
This is the same for which Spring Batch can handle.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Flat File</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here it will explain how to handle flat file first,
and then explain about XML in <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>.</p>
</div>
<div class="paragraph">
<p>First, show the types of Flat File which can be used with TERASOLUNA Batch 5.x.
Each row inside the flat file will be called <code>record</code>,
and type of file is determined by the record&#8217;s format.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Record Format</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable-length Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record format which each items are separated by a delimiter, such as CSV and TSF. Each item&#8217;s length can be variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed-length Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record format which each items are separeted by the items length(bytes). Each item&#8217;s length are fixed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single String Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 Record will be handled as 1 String item.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">File Structure which can be handled</div>
<p>The basic structure for Flat File is constructed by these 2 points.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Record Division</p>
</li>
<li>
<p>Record Format</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Elements to construct format of Flat File</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Record Division</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A division will indicate the type of record, such as Header Record, Data Record, and Trailer Record.<br>
Details will be described later.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Record Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The format will have informations of the record such as how many rows there is for Header, Data, and Trailer, how many times eace record will repeat, and so on.<br>
There is also Single Format and Multi Format.Details will be described later.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>With TERASOLUNA Batch 5.x, Flat File with Single Format of Multi Format which includes each record division can be handles.</p>
</div>
<div class="paragraph">
<p>Here it willl explain about the record division and the record formats.</p>
</div>
<div class="paragraph">
<p>The overview of each record devision is explained as below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Characteristic of each Record Division</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Record Division</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the beginning of the file(data part).<br>
It has items such as field names, common matters of the file, and summary of the data part.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is a record having data to be processed as a main object of the file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trailer/Footer Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the end of the file if the file(data part).<br>
It has items such as common matters of the file and summary of the data part.<br>
For Single Format file, it is called a Fotter Record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Footer/End Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the end of the file if the file is a Multi Format.<br>
It has items such as common matters of the file and summary of the data part.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About the field that indicates the record division</div>
<div class="paragraph">
<p>A flat file having a header record or a trailer record may have a field indicating a record division.<br>
In TERASOLUNA Batch 5.x, especially in the processing of multi-format files, the record division field is utilized, for example when different processing is performed for each record division.<br>
Refer to <a href="#Ch05_FileAccess_MultiFormat">Multi format</a> for the implementation when selecting the processing to be executed by record classification.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About the name of file format</div>
<div class="paragraph">
<p>Depending on the definition of the file format in each system,
There are cases where names are different from this guideline such as calling Footer Record as End Record.<br>
Must be read as appropriate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A summary of Single Format and Multi Format is shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Overview of Single Format and Multi Format</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A format with Header N Rows + Data N Rows + Trailer N Rows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A format with (Header N Rows + Data N Rows + Trailer N Rows) * N + Footer N Rows.<br>
A format in which a Footer Record is added after repeating a Single Format a plurality of times.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Multi Format record structure is shown in the figure as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FileFormat_multi.png" alt="Multi format file layout">
</div>
<div class="title">Multi Format Rrecord Structure Diagram</div>
</div>
<div class="paragraph">
<p>An example of a Single Format and Multi Format flat file is shown below.<br>
<code>// </code> is used as a comment-out character for the description of the file.</p>
</div>
<div class="listingblock">
<div class="title">Example of Single Format, flat file(CSV format) without record division</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">branchId,year,month,customerId,amount  // (1)
000001,2016,1,0000000001,100000000  // (2)
000001,2016,1,0000000002,200000000  // (2)
000001,2016,1,0000000003,300000000  // (2)
000001,3,600000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of file contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Descriptions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A header record<br>
Field name of the data part is described.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A data record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A trailer record.<br>
It holds summary information of the data part.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example of Single Format, flat file(CSV format) with record division</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">// (1)
H,branchId,year,month,customerId,amount  // (2)
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,branchId,year,month,customerId,amount  // (2)
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,branchId,year,month,customerId,amount  // (2)
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
F,3,9,4500000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of file contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Descriptions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It has a field indicating the record division at the beginning of the record.<br>
Each record division is defined as below.<br>
<code>H</code>：Header Record<br>
<code>D</code>：Data Record<br>
<code>T</code>：Trailer Record<br>
<code>F</code>：Footer Record</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Every time branchId changes, it repeats header, data, trailer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A footer record.<br>
It holds summary information for the whole file.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Assumptions on format of data part</div>
<div class="paragraph">
<p>In <a href="#Ch05_FileAccess_HowToUse">How To Use</a>, it will explain on the premise that the layout of the data part is the same format.
This means that all the records of the data part are mapped to the same conversion target class</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About explanation of Multi Format file</div>
<div class="ulist">
<ul>
<li>
<p>In <a href="#Ch05_FileAccess_HowToUse">How To Use</a>, it will describe about the Single Format file.</p>
</li>
<li>
<p>For flat files having Multi Format or a structure including a footer part in the above structure, refer to <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Overview_FileAccessComponents"><a class="anchor" href="#Ch05_FileAccess_Overview_FileAccessComponents"></a>A component that inputs and outputs a flat file</h3>
<div class="paragraph">
<p>Describe a class for handling flat file.</p>
</div>
<div class="paragraph">
<div class="title">Input</div>
<p>The relationships of classes used for inputting flat files are as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_class.png" alt="Component relationship FlatFileItemReader class diagram">
</div>
<div class="title">Relationship of classes used for inputting flat files</div>
</div>
<div class="paragraph">
<p>The calling relationship of each component is as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_sequence.png" alt="Component relationship FlatFileItemReader sequence diagram">
</div>
<div class="title">Calling relationship of each component</div>
</div>
<div class="paragraph">
<p>Details of each component are shown below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemReader</dt>
<dd>
<p>Implementation class of <code>ItemReader</code> to use for loading flat files. Use the following components.<br>
The flow of simple processing is as follows.<br>
1.Use <code>BufferedReaderFactory</code> to get <code>BufferedReader</code>.<br>
2.Read one record from the flat file using the acquired <code>BufferedReader</code>.<br>
3.Use <code>LineMapper</code> to map one record to the target bean.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.BufferedReaderFactory</dt>
<dd>
<p>Generate <code>BufferedReader</code> to read the file.</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.LineMapper</dt>
<dd>
<p>One record is mapped to the target bean. Use the following components.<br>
The flow of simple processing is as follows.<br>
1.Use <code>LineTokenizer</code> to split one record into each item.<br>
2.Mapping items split by <code>FieldSetMapper</code> to bean properties.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineTokenizer</dt>
<dd>
<p>Divide one record acquired from the file into each item.<br>
Each partitioned item is stored in <code>FieldSet</code> class.</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.mapping.FieldSetMapper</dt>
<dd>
<p>Map each item in one divided record to the property of the target bean.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Output</div>
<p>Relationships of classes used for outputting flat files are as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_class.png" alt="Component relationship FlatFileItemWriter class diagram">
</div>
<div class="title">Relationship of classes used for outputting flat files</div>
</div>
<div class="paragraph">
<p>The calling relationship of each component is as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_sequence.png" alt="Component relationship FlatFileItemWriter sequence diagram">
</div>
<div class="title">Calling relationship of each component</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemWriter</dt>
<dd>
<p>Implementation class of <code>ItemWriter</code> for exporting to a flat file. Use the following components.
<code>LineAggregator</code> Mapping the target bean to one record.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineAggregator</dt>
<dd>
<p>It is used to map the target bean to one record.
The mapping between the properties of the bean and each item in the record is done in <code>FieldExtractor</code>.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.FieldExtractor</dt>
<dd>
<p>Map the property of the target bean to each item in one record.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05_FileAccess_HowToUse"><a class="anchor" href="#Ch05_FileAccess_HowToUse"></a>How To Use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Descriptoins for how to use flat file according to the record format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_VariableLength">Variable-length record</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_FixedLength">Fixed-length record</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_PathhThrough">Single String record</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, the following items are explained.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HeaderFooter">Header and Footer</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_MultiFile">Multiple Files</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_Output_ControlBreak">Control Break</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_VariableLength"><a class="anchor" href="#Ch05_FileAccess_VariableLength"></a>Variable-length record</h3>
<div class="paragraph">
<p>Describe the definition method when dealing with variable-length record file.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_VariableLength_Input"><a class="anchor" href="#Ch05_FileAccess_VariableLength_Input"></a>Input</h4>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="comment">&lt;!-- (6) (7) (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM&#8217;s default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>.<br>
<code>DefaultLineMapper</code> is <code>LineMapper</code> which provides the basic operation of converting records to the class to be converted using the defined <code>LineTokenizer</code> and <code>FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>.<br>
<code>DelimitedLineTokenizer</code> is an implementation class of <code>LineTokenizer</code> that separates records by specifying delimiters.<br>
It corresponds to the reading of escaped line feeds, delimiters, and enclosed characters defined in the specification of RFC-4180, which is a general format of CSV format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record.<br>
Each item can be retrieved using the name set in <code>FieldSet</code> used in <code>FieldSetMapper</code>.<br>
Set each name from the beginning of the record with a comma separator.<br>
When using <code>BeanWrapperFieldSetMapper</code> it is mandatory setting.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set delimiter</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">quoteCharacter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set enclosing character</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing such as character strings and numbers is unnecessary, use <code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>,
and specify the class to be converted to property <code>targetType</code>.
By doing this, an instance that automatically sets the value in the field that matches the name of each item set in (5) will be created.<br>
If conversion processing is necessary, set the implementation class of <code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a> for the case of implementing FieldSetMapper yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to enter TSV format file</div>
<div class="paragraph">
<p>When reading the TSV file, it can be realized by setting a tab as a delimiter.</p>
</div>
<div class="listingblock">
<div class="title">TSV file loading: Example of delimiter setting (setting by constant)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, it may be as follows.</p>
</div>
<div class="listingblock">
<div class="title">TSV file reading: Example of delimiter setting (setting by character reference)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_VariableLength_Output"><a class="anchor" href="#Ch05_FileAccess_VariableLength_Output"></a>Output</h4>
<div class="paragraph">
<p>An example of setting for writing the following output file is shown.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">001,CustomerName001,CustomerAddress001,11111111111,001
002,CustomerName002,CustomerAddress002,11111111111,002
003,CustomerName003,CustomerAddress003,11111111111,003</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="comment">&lt;!-- (11) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set record break (line feed code).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, add to the existing file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the output if it is an empty file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="Ch05_Transaction.html#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>.<br>
To enclose a field around it, set <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>.<br>
Usage of <code>EnclosableDelimitedLineAggregator</code> will be described later.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the delimiter.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for strings and numbers is unnecessary, you can use <code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>.<br>
If conversion processing is necessary, set implementation class of <code>org.springframework.batch.item.file.transform.FieldExtractor</code>.<br>
An example for implementatiion of <code>FieldExtractor</code>, refer to <a href="#Ch05_FileAccess_FixedLength_Output">Output of Fixed-length file</a> where a sample is described using full-width character.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record. Set each name from the beginning of the record with a comma separator.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">How to use EnclosableDelimitedLineAggregator</div>
<p>To enclose a field around it, use <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code> provided by TERASOLUNA Batch 5.x.<br>
The specification of <code>EnclosableDelimitedLineAggregator</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optional specification of enclosure character and delimiter character</p>
<div class="ulist">
<ul>
<li>
<p>Default is the following value commonly used in CSV format</p>
<div class="ulist">
<ul>
<li>
<p>Enclosed character: <code>"</code>(double quote)</p>
</li>
<li>
<p>Separator: <code>, </code> (comma)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If the field contains a carriage return, line feed, enclosure character, or delimiter, enclose the field with an enclosing character</p>
<div class="ulist">
<ul>
<li>
<p>When enclosing characters are included, the enclosing character will be escaped by adding an enclosing character right before this enclosing characters.</p>
</li>
<li>
<p>All fields can be surrounded by characters by setting</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The usage of <code>EnclosableDelimitedLineAggregator</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">&quot;001&quot;,&quot;CustomerName&quot;&quot;001&quot;&quot;&quot;,&quot;CustomerAddress,001&quot;,&quot;11111111111&quot;,&quot;001&quot;
&quot;002&quot;,&quot;CustomerName&quot;&quot;002&quot;&quot;&quot;,&quot;CustomerAddress,002&quot;,&quot;11111111111&quot;,&quot;002&quot;
&quot;003&quot;,&quot;CustomerName&quot;&quot;003&quot;&quot;&quot;,&quot;CustomerAddress,003&quot;,&quot;11111111111&quot;,&quot;003&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Same as above example</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition example(only settings for lineAggregator)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
  <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:enclosure</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>
        <span class="attribute-name">p:allEnclosing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the delimiter.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enclosure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the enclosing character.<br>
If the enclosing character is included in the field, it is replaced with a concatenated character as an escape process.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allEnclosing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, all fields are enclosed in an enclosing character.<br>
If false, only fields containing carriage return (CR), line-leading (LF), delimiter, and enclosing characters will be enclosed.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>TERASOLUNA Batch 5.x provides the extension class <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code> to satisfy the specification of RFC-4180.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code> provided by Spring Batch does not correspond to the enclosing process of the field, therefore it can not satisfy the specification of RFC-4180.
Refer to <a href="https://jira.spring.io/browse/BATCH-2463">Spring Batch/BATCH-2463</a> .</p>
</div>
<div class="paragraph">
<p>The format of the CSV format is defined as follows in RFC-4180 which is a general format of CSV format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the field does not contain line breaks, enclosing characters, or delimiters, each field can be enclosed in double quotes (enclosing characters) or not enclosed</p>
</li>
<li>
<p>Fields that contain line feed (CRLF), double quote (enclosing character), comma (delimiter) should be enclosed in double quotes</p>
</li>
<li>
<p>If the field is enclosed in double quotes (enclosing characters), the double quotes contained in the value of the field must be escaped with a single double quote immediately before it</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to output TSV format file</div>
<div class="paragraph">
<p>When outputting a TSV file, it can be realized by setting a tab as a delimiter.</p>
</div>
<div class="listingblock">
<div class="title">Setting example of delimiter when outputting TSV file (setting by constant)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, it may be as follows.</p>
</div>
<div class="listingblock">
<div class="title">Example of delimiter setting when TSV file is output (setting by character reference)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_FixedLength"><a class="anchor" href="#Ch05_FileAccess_FixedLength"></a>Fixed-length record</h3>
<div class="paragraph">
<p>Describe how to define fixed length record files.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_FixedLength_Input"><a class="anchor" href="#Ch05_FileAccess_FixedLength_Input"></a>Input</h4>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown.</p>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.x corresponds to a format in which record delimitation is judged by line feed and format judged by the number of bytes.</p>
</div>
<div class="listingblock">
<div class="title">Input file example 1 (record breaks are line feeds)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Sale012016 1   00000011000000000
Sale022017 2   00000022000000000
Sale032018 3   00000033000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Input file example 2 (record delimiter is byte number, 32 bytes is 1 record)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Sale012016 1   00000011000000000Sale022017 2   00000022000000000Sale032018 3   00000033000000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Input file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Number of bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.DefaultBufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span>
                <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="comment">&lt;!-- (9) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bufferedReaderFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To decide record breaks by line breaks, use the default value <code>org.springframework.batch.item.file.DefaultBufferedReaderFactory</code>.
<code>BufferedReader</code> generated by <code>DefaultBufferedReaderFactory</code> acquires up to a newline as one record.
</p><p class="tableblock">To judge the delimiter of a record by the number of bytes, set <code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code> provided by TERASOLUNA Batch 5.x.
<code>BufferedReader</code> generated by <code>FixedByteLengthBufferedReaderFactory</code> acquires up to the specified number of bytes as one record.<br>
Detailed specifications and usage of <code>FixedByteLengthBufferedReaderFactory</code> will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultBufferedReaderFactory</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</code> provided by TERASOLUNA Batch 5.x.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record.<br>
Each item can be retrieved using the name set in <code>FieldSet</code> used in <code>FieldSetMapper</code>.<br>
Set each name from the beginning of the record with a comma separator.<br>
When using <code> BeanWrapperFieldSetMapper</code> it is mandatory setting.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ranges<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the break position. Set the delimiter position from the beginning of the record, separated by commas.<br>
The unit of each delimiter position is byte, and it is specified in <code>start position - end position</code> format.<br>
The range specified from the record is acquired in the order in which the delimiter positions are set, and stored in <code>FieldSet</code>.<br>
When names of (6) are specified, the delimiter positions are stored in <code> FieldSet</code> in correspondence with names in the order in which they are set.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">charset<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the same character code as (2).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for character strings and numbers is unnecessary, use <code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>,
 and specify the conversion target class as property <code>targetType</code>.
By doing this, we create an instance that automatically sets the value in the field that matches the name of each item set in (6).<br>
If conversion processing is necessary, set the implementation class of <code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a> for the case of implementing FieldSetMapper yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">How to use FixedByteLengthBufferedReaderFactory</div>
<p>To read a file that judges record delimiter by byte count, use <code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code> provided by TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>By using <code>FixedByteLengthBufferedReaderFactory</code>, it is possible to acquire up to the number of bytes specified as one record.<br>
The specification of <code>FixedByteLengthBufferedReaderFactory</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify byte count of record as constructor argument</p>
</li>
<li>
<p>Generate <code>FixedByteLengthBufferedReader</code> which reads the file with the specified number of bytes as one record</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use of <code>FixedByteLengthBufferedReader</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reads a file with one byte length specified at instance creation</p>
</li>
<li>
<p>If there is a line feed code, do not discard it and read it by including it in the byte length of one record</p>
</li>
<li>
<p>The file encoding to be used for reading is the value set for <code>FlatFileItemWriter</code>, and it will be used when <code>BufferedReader</code> is generated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method of defining <code> FixedByteLengthBufferedReaderFactory</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">c:byteLength</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>

<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byteLength<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of bytes per record.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Components to use when handling Fixed-length files</div>
<div class="paragraph">
<p>When dealing with Fixed-length files, it is based on using the component provided by TERASOLUNA Batch 5.x.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FixedByteLengthBufferedReaderFactory</dt>
<dd>
<p><code>BufferedReader</code> generation class that reads one record from the fixed-length file without line break by the number of bytes of the specified character code</p>
</dd>
<dt class="hdlist1">FixedByteLengthLineTokenizer</dt>
<dd>
<p>The <code>FixedLengthTokenizer</code> extension class, separated by the number of bytes corresponding to the multibyte character string</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Processing records containing multibyte character strings</div>
<div class="paragraph">
<p>When processing records containing multibyte character strings, be sure to use <code>FixedByteLengthLineTokenizer</code>.<br>
The <code> FixedLengthTokenizer</code> provided by Spring Batch separates the record by the number of characters instead of the number of bytes, so there is a possibility that the item will not be extracted as expected.</p>
</div>
<div class="paragraph">
<p>Since this issue is already reported to JIRA <a href="https://jira.spring.io/browse/BATCH-2540">Spring Batch/BATCH-2540</a>, it might be unnecessary in the future.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the implementation of FieldSetMapper, refer to <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_FixedLength_Output"><a class="anchor" href="#Ch05_FileAccess_FixedLength_Output"></a>Output</h4>
<div class="paragraph">
<p>An example of setting for writing the following output file is shown.</p>
</div>
<div class="paragraph">
<p>In order to write a fixed-length file, it is necessary to format the value obtained from the bean according to the number of bytes of the field.<br>
The format execution method differs as follows depending on whether double-byte characters are included or not.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If double-byte characters is not included(single-byte characters only and the number of bytes of characters is constant)</p>
<div class="ulist">
<ul>
<li>
<p>Format using <code>FormatterLineAggregator</code>.</p>
</li>
<li>
<p>The format is set by the format used in the <code> String.format</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If double-byte characters is included(The number of bytes of characters is not constant depending on the character code)</p>
<div class="ulist">
<ul>
<li>
<p>Format with implementation class of <code>FieldExtractor</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, a setting example in the case where double-byte characters are not included in the output file is shown, followed by a setting example in the case where double-byte characters are included.</p>
</div>
<div class="paragraph">
<p>The setting when double-byte characters are not included in the output file is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
   0022017 20000000002  20000000
   0032018 30000000003  30000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Output file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Number of bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If the field&#8217;s value is less than the number of bytes specified, the rest of the field will be filled with halfwidth space.</p>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%6s%4s%2s%10s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code)<br>
To make it without line breaks, set <code>(empty string)</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, append to the existing file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the output if it is an empty file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="Ch05_Transaction.html#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output format with the format used in the <code>String.format</code> method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for strings and numbers is unnecessary, you can use <code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>.<br>
</p><p class="tableblock">If conversion processing is necessary, set implementation class of <code>org.springframework.batch.item.file.transform.FieldExtractor</code>.<br>
An example for implementatiion of <code>FieldExtractor</code> to format double-byte characters is written later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record. Set the names of each field from the beginning of the record with a comma.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About PassThroughFieldExtractor</div>
<div class="paragraph">
<p>Deafult value for property <code>fieldExtractor</code> of <code>FormatterLineAggregator</code> is <code>org.springframework.batch.item.file.transform.PassThroughFieldExtractor</code>.</p>
</div>
<div class="paragraph">
<p><code>PassThroughFieldExtractor</code> is a class to return the original item without processing anything, and is used when <code>FieldExtractor</code> will not process anything.</p>
</div>
<div class="paragraph">
<p>If the item is an array or a collection, it is returned as is, otherwise it is wrapped in an array of single elements.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Example of how to format a field with double-byte character</div>
<p>When formatting for double-byte characters, since the number of bytes per character differs depending on the character code, use the implementation class of <code>FieldExtractor</code> instead of <code>FormatterLineAggregator</code>.</p>
</div>
<div class="paragraph">
<p>Implementation class of <code>FieldExtractor</code> is to be done as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FieldExtractor</code> and override extract method.</p>
</li>
<li>
<p>extract method is to be implemented as below</p>
<div class="ulist">
<ul>
<li>
<p>get the value from the item(target bean), and perform the conversion as needed</p>
</li>
<li>
<p>set the value to an array of object and return it.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The format of a field that includes double-byte characters is to be done in the implementation class of <code>FieldExtractor</code> by the following way.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get the number of bytes for the character code</p>
</li>
<li>
<p>Format the value by trimming or padding it according to be number of bytes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is a setting example for formatting a field including double-byte characters.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
  番号2017 2 売上高002  20000000
 番号32018 3   売上003  30000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use of the output file is the same as the example above.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition(settings of lineAggregator only)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%s%4s%2s%s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.plan.SalesPlanFixedLengthFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output format with the format used in the <code>String.format</code> method.
The number of digits is specified only for fields that do not contain double-byte characters.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FieldExtractor</code>.<br>
An implementation example will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample implementation of FieldExtractor to format double-byte characters</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanFixedLengthFieldExtractor</span> <span class="directive">implements</span> FieldExtractor&lt;SalesPlanDetail&gt; {
    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span><span class="type">[]</span> extract(SalesPlanDetail item) {
        <span class="predefined-type">Object</span><span class="type">[]</span> values = <span class="keyword">new</span> <span class="predefined-type">Object</span>[<span class="integer">5</span>];  <span class="comment">// (2)</span>

        <span class="comment">// (3)</span>
        values[<span class="integer">0</span>] = fillUpSpace(item.getBranchId(), <span class="integer">6</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">1</span>] = item.getYear();
        values[<span class="integer">2</span>] = item.getMonth();
        values[<span class="integer">3</span>] = fillUpSpace(item.getCustomerId(), <span class="integer">10</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">4</span>] = item.getAmount();

        <span class="keyword">return</span> values; <span class="comment">// (7)</span>
    }

    <span class="comment">// It is a simple impl for example</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> fillUpSpace(<span class="predefined-type">String</span> val, <span class="type">int</span> num) {
        <span class="predefined-type">String</span> charsetName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>;
        <span class="type">int</span> len;
        <span class="keyword">try</span> {
            len = val.getBytes(charsetName).length;  <span class="comment">// (5)</span>
        } <span class="keyword">catch</span> (<span class="exception">UnsupportedEncodingException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="predefined-type">String</span> fillStr = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; (num - len); i++) { <span class="comment">// (6)</span>
            fillStr += <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>;
        }

        <span class="keyword">return</span> fillStr + val;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FieldExtractor</code> class and override extract method.<br>
Set the conversion target class as the type argument of <code>FieldExtractor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a Object type array to store data after the conversion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the value from the item(target bean), and perform the conversion as needed, set the value to an array of object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format the field that includes double-byte character.<br>
Refer to (5) and (6) for the details of format process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the number of bytes for the character code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format the value by trimming or padding it according to be number of bytes.<br>
In the implementation example, white space characters are added before the character string up to the specified number of bytes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns an array of Object type holding the processing result.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_PathhThrough"><a class="anchor" href="#Ch05_FileAccess_PathhThrough"></a>Single String record</h3>
<div class="paragraph">
<p>Describe the definition method when dealing with a single character string record file.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_PathhThrough_Input"><a class="anchor" href="#Ch05_FileAccess_PathhThrough_Input"></a>Input</h4>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Input file sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PassThroughLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.PassThroughLineMapper</code>.<br>
<code>PassThroughLineMapper</code> is a implementation class of <code>LineMapper</code>, and it will return the String value of passed record as it is.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_PathhThrough_Output"><a class="anchor" href="#Ch05_FileAccess_PathhThrough_Output"></a>Output</h4>
<div class="paragraph">
<p>The setting for writing the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code)<br></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, append to the existing file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the output if it is an empty file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="Ch05_Transaction.html#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>.<br>
<code>PassThroughLineAggregator</code> is the implementation class of <code>LineAggregator</code> that will return the converted String value of the item(target Bean) as it is by processing <code>item.toString()</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter"></a>Header and Footer</h3>
<div class="paragraph">
<p>Explain the input / output method when there is a header / footer.</p>
</div>
<div class="paragraph">
<p>Here, a method of skipping the header footer by specifying the number of lines will be explained.<br>
When the number of records of header / footer is variable and it is not possible to specify the number of lines, use <code>PatternMatchingCompositeLineMapper</code> with reference to <a href="#Ch05_FileAccess_MultiLine_Input">Multi format input</a></p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HeaderFooter_Input"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input"></a>Input</h4>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Input_SkipHeaders"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_SkipHeaders"></a>Skipping Header</h5>
<div class="paragraph">
<p>There are 2 ways to skip the header record.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the number of lines to skip to property <code>linesToSkip</code> of <code>FlatFileItemReader</code></p>
</li>
<li>
<p>Remove header record in preprocessing by OS command</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Input file sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_11
branchId,year,month,customerId,amount
000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first 2 lines is the header record.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>The setting for reading the above file is as follows.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Skip by using linesToSkip</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="attribute-value">value</span><span class="error">=</span><span class="error">&quot;</span><span class="attribute-name">2</span><span class="error">&quot;</span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of header record lines to skipl.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Skip by using OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in header from the top of input file
tail -n +`expr 2 + 1` input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the tail command and get the 3rd line and after from input.txt, and then write it out to output.txt.
Please note that the value specified for option <code>-n + K</code> of tail command is the number of header records + 1.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">OS command to skip header record and footer record</div>
<div class="paragraph">
<p>By using the head and tail commands, it is possible to skip the header record and footer record by specifying the number of lines.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">How to skip the header record</dt>
<dd>
<p>Execute the tail command with option <code>-n +K</code>, and get the lines after <code>K</code> from the target file.</p>
</dd>
<dt class="hdlist1">How to skip the footer record</dt>
<dd>
<p>Execute the head command with option <code>-n -K</code>, and get the lines befor <code>K</code> from the target file.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A sample of shell script to skip header record and footer record can be written as follows.<br></p>
</div>
<div class="listingblock">
<div class="title">An example of a shell script that removes a specified number of lines from a header / footer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">#!/bin/bash

if [ $# -ne 4 ]; then
  echo &quot;The number of arguments must be 4, given is $#.&quot; 1&gt;&amp;2
  exit 1
fi

# Input file.
input=$1

# Output file.
output=$2

# Number of lines in header.
header=$3

# Number of lines in footer.
footer=$4

# Remove number of lines in header from the top of input file
# and number of lines in footer from the end,
# and save to output file.
tail -n +`expr ${header} + 1` ${input} | head -n -${footer} &gt; ${output}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Arguments</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of lines to skip for header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of lines to skip for footer</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Input_AccessHeaders"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders"></a>Retrieving header information</h5>
<div class="paragraph">
<p>Here shows how to recognize and retrive the header record.</p>
</div>
<div class="paragraph">
<p>The extraction of header information is implemented as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Settings</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Write the process for header record in implementation class of <code>org.springframework.batch.item.file.LineCallbackHandler</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the information retrieved in <code>LineCallbackHandler#handleLine()</code> to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set implementation class of <code>LineCallbackHandler</code> to property skippedLinesCallback<code> of </code>FlatFileItemReader``</p>
</li>
<li>
<p>Set the number of lines to skip to property <code>linesToSkip</code> of <code>FlatFileItemReader</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reading files and retrieving header information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>For each line which is skipped by the setting of <code>linesToSkip</code>, <code>LineCallbackHandler#handleLine()</code> is executed</p>
<div class="ulist">
<ul>
<li>
<p>Header information is set to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Use retrieved header information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Get header information from <code>stepExecutionContext</code> and use it in the processing of the data part</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An example of implementation for retrieving header record information is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.HoldHeaderLineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:skippedLinesCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of lines to skip.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">skippedLinesCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>LineCallbackHandler</code>.<br>
An implementation sample will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StepExecutionListener</code>.<br>
This setting is needed sinche the <code>LineCallbackHandler</code> set to property <code>skippedLinesCallback</code> of <code>FlatFileItemReader</code> will not be automatically registered as the <code>Listener</code>.<br>
The detailed reason will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About the listener</div>
<div class="paragraph">
<p>Since the following two cases are not automatically registered as <code> Listener</code>, it is necessary to add a definition to <code> Listeners</code> at the time of job definition.<br>
(If listener definitions are not added, <code> StepExecutionListener # beforeStep () </code> will not be executed)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener</code> of <code>LineCallbackHandler</code> which is set to <code>skippedLinesCallback</code> of <code>FlatFileItemReader</code></p>
</li>
<li>
<p><code>StepExecutionListener</code> implemented to implementation class of <code>Tasklet</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingItemReaderListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="comment">&lt;!-- mandatory --&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LineCallbackHandler</code> should be implemented as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener#beforeStep()</code></p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener#beforeStep()</code> by either ways shown below</p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener</code> class and override beforeStep method</p>
</li>
<li>
<p>Implement beforeStep method and annotate with <code>@BeforeStep</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Get <code> StepExecution</code> in the beforeStep method and save it in the class field</p>
</li>
</ul>
</div>
</li>
<li>
<p>Implement <code>LineCallbackHandler#handleLine()</code></p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code></p>
<div class="ulist">
<ul>
<li>
<p>Note that <code>handleLine</code> method will be executed each time skip is proceeded</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get <code>stepExecutionContext</code> from <code>StepExecution</code> and set header information to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample implementation of LineCallbackHandler</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HoldHeaderLineCallbackHandler</span> <span class="directive">implements</span> LineCallbackHandler {  <span class="comment">// (!)</span>
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (2)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (4)</span>
    }

    <span class="annotation">@Override</span>  <span class="comment">// (5)</span>
    <span class="directive">public</span> <span class="type">void</span> handleLine(<span class="predefined-type">String</span> line) {
        <span class="local-variable">this</span>.stepExecution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, line);  <span class="comment">// (6)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a field to save <code>StepExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>beforeStep</code> method and annotate it with <code>@BeforeStep</code>.<br>
The signature will be <code>void beforeStep(StepExecution stepExecution)</code>.<br>
It is also possible to implement the <code>StepExecutionListener</code> class and override <code>beforeStep</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the <code>StepExecution</code> and save it to the class field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>stepExecutionContext</code> from <code>StepExecution</code>, set header information to <code>stepExecutionContext</code> by using key <code>header</code>.<br>
Here, for simplicity, only the last one line of two lines to be skipped is stored.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here is a sample of getting the header information from <code>stepExecutionContext</code> and using it for processing of data part.<br>
A sample of using header information in <code>ItemProcessor</code> will be described as an example.<br>
The same can be done when using header information in other components.</p>
</div>
<div class="paragraph">
<p>The implementation of using header information is done as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As like the sample of implementing <code>LineCallbackHandler</code>, implement <code>StepExecutionListener#beforeStep()</code></p>
</li>
<li>
<p>Get <code>StepExecution</code> in beforeStep method and save it to the class field</p>
</li>
<li>
<p>Get <code>stepExecutionContext</code> and the header information from <code>StepExecution</code> and use it</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample of how to use header information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggingHeaderRecordItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (1)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (3)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> headerData = <span class="local-variable">this</span>.stepExecution.getExecutionContext()
                .getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (4)</span>
        <span class="comment">// omitted business logic</span>
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a field to save <code>StepExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>beforeStep</code> method and annotate it with <code>@BeforeStep</code>.<br>
The signature will be <code>void beforeStep(StepExecution stepExecution)</code>.<br>
It is also possible to implement the <code>StepExecutionListener</code> class and override <code>beforeStep</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the <code>StepExecution</code> and save it to the class field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>stepExecutionContext</code> from <code>StepExecution</code>, set header information to <code>stepExecutionContext</code> by using key <code>header</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About the use of ExecutionContext of Job/Step</div>
<div class="paragraph">
<p>In retrieving header (footer) information, the method is to store the read header information in <code>ExecutionContext</code> of <code>StepExecution</code>, and retrieves it from <code>ExecutionContext</code> when using it.</p>
</div>
<div class="paragraph">
<p>In the example below, header information is stored in <code>ExecutionContext</code> of <code>StepExecution</code> in order to obtain and use header information within one step.
If step is divided by retreiving and using the header information, use <code>ExecutionContext</code> of <code>JobExecution</code>.</p>
</div>
<div class="paragraph">
<p>For details about <code>ExecutionContext</code> of Job/Step, refer to <a href="Ch02_SpringBatchArchitecture.html#Ch02_SpringBatchArch">Architecture of Spring Batch</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Input_SkipFooters"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_SkipFooters"></a>Skipping Footer</h5>
<div class="paragraph">
<p>Since Spring Batch nor TERASOLUNA Batch 5.x does not support skipping footer record, it needs to be done by OS command.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last 2 lines is the footer record.</p>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Skipping by OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in footer from the end of input file
head -n -2 input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use head command, get the lines above the second line from the last from input.txt, and write it out to output.txt.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is reported to JIRA <a href="https://jira.spring.io/browse/BATCH-2539">Spring Batch/BATCH-2539</a> that Spring Batch does not have a functions to skip the footer record.<br>
Hence, there is a possibility that not only by OS command, but Spring Batch will be able to skip the footer record in the future.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Input_AccessFooters"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_AccessFooters"></a>Retrieving footer information</h5>
<div class="paragraph">
<p>In Spring Batch and TERASOLUNA Batch 5.x, functions for skipping footer record retreiving footer information is not provided.</p>
</div>
<div class="paragraph">
<p>Therefore, it needs to be divided into preprocessing OS command and 2 steps as described below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Divide footer record by OS command</p>
</li>
<li>
<p>In 1st step, read the footer record and set footer information to <code>ExecutionContext</code></p>
</li>
<li>
<p>In 2nd step, retrive footer information from <code>ExecutionContext</code> and use it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retreiving footer information will be implemented as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Divide footer record by OS command</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Use OS command to divide the input file to footer part and others</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">1st step, read the footer record and get footer information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Read the footer record and set it to <code>jobExecutionContext</code></p>
<div class="ulist">
<ul>
<li>
<p>Since the steps are different in storing and using footer information, store it in <code>jobExecutionContext</code>.</p>
</li>
<li>
<p>The use of <code>jobExecutionContext</code> is same as the <code>stepExecutionContext</code> explained in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>, execpt for the scope of Job and Step.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">2nd step, use the retrieved footer information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Get the footer information from  <code>jobExecutionContext</code> and use it for processing of data part.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An example will be described in which footer information of the following file is taken out and used.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last 2 lines is footer record.</p>
</div>
<div class="paragraph">
<div class="title">Divide footer record by OS command</div>
<p>The setting to divide the above file into footer part and others by OS command is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Skipping by OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Extract non-footer record from input file and save to output file.
head -n -2 input.txt &gt; input_data.txt

# Extract footer record from input file and save to output file.
tail -n 2 input.txt &gt; input_footer.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use head command, write footer part of input.txt to input_footer.txt, and others to input_data.txt.</p>
</div>
<div class="paragraph">
<p>Output file sample is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Output file example(input_data.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output file example(input_footer.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Get/Use footer information</div>
<p>Explain how to get and use footer information from a footer record divided by OS command.<br></p>
</div>
<div class="paragraph">
<p>The step of reading the footer record is divided into the preprocessing and main processing.<br>
Refer to <a href="Ch08_FlowControll.html#Ch08_FlowControll">Flow Controll</a> for details of step dividing.</p>
</div>
<div class="paragraph">
<p>In the example below, a sample is shown in which footer information is retreived and stored in <code>jobExecutionContext</code>.<br>
Footer information can be used by retreiving it from <code>jobExecutionContext</code> like the same way described in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p>
</div>
<div class="listingblock">
<div class="title">Class to set information of data record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to set information of footer record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Define the Bean like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define <code>ItemReader</code> to read footer record</p>
</li>
<li>
<p>Define <code>ItemReader</code> to read data record</p>
</li>
<li>
<p>Define business logic to retreive footer record</p>
<div class="ulist">
<ul>
<li>
<p>In the sample below, it is done by implementing <code>Tasklet</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Define a job</p>
<div class="ulist">
<ul>
<li>
<p>Define a step with a preprocess to get footer information and a main process to read data records.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- ItemReader for reading footer records --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[footerInputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- ItemReader for reading data records --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[dataInputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;!-- omitted settings --&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Tasklet for reading footer records --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.ReadFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step01</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>ItemReader</code> to read a file with footer record.<br>
Used by injecting it to <code>readFooterTasklet</code> which is executed when retreiving footer information.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>ItemReader</code> to read a file with data record.<br></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">preprocess step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a step to get the footer information.<br>
Implemented at <code>readFooterTasklet</code>. Implementation sample is written later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">main process step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A step of retreiving data information and using footer information is defined.<br>
Use <code>dataReader</code> for <code>reader</code>.<br>
In the sample, method to get footer information from <code>jobExecutionContext</code> such as <code>ItemProcessor</code> is not implemented.<br>
Footer information can be retreived and used the same way described in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listeners</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>readFooterTasklet</code>.<br>
Without this setting, <code>JobExecutionListener#beforeJob()</code> implemented in <code>readFooterTasklet</code> will not be executed.<br>
For details, refer to <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An example for reading a file with footer record and storing it to <code>jobExecutionContext</code>is shown below.</p>
</div>
<div class="paragraph">
<p>The way to make it as the implementation class of <code>Tasklet</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inject the bean defined <code>footerReader</code> by name using <code>@Inject@</code> and <code>@Named</code></p>
</li>
<li>
<p>Set the footer information to <code>jobExecutionContext</code></p>
<div class="ulist">
<ul>
<li>
<p>The realization method is the same as <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Getting footer information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ReadFooterTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>)
    ItemStreamReader&lt;SalesPlanDetailFooter&gt; itemReader;

    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="comment">// (2)</span>
        itemReader.open(chunkContext.getStepContext().getStepExecution()
                .getExecutionContext());

        SalesPlanDetailFooter footer;
        <span class="keyword">while</span> ((footer = itemReader.read()) != <span class="predefined-constant">null</span>) {
            footers.add(footer);
        }

        <span class="comment">// (3)</span>
        jobExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>, footers);

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject the bean defined <code>footerReader</code> by name using <code>@Inject@</code> and <code>@Named</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>footerReader</code> to read the file with footer record and get the footer information.<br>
To use <code>ItemReader</code> bean defined in implementation class of <code>Tasklet</code>, refer to <a href="Ch03_CreateTaskletJob.html#Ch03_CreateTaskletJob_HowToUse_Implements">Creating a tasklet-oriented job</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>jobExecutionContext</code> from <code>JobExecution</code>, set the footer information to <code>jobExecutionContext</code> by key <code>footers</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HeaderFooter_Output"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output"></a>Output</h4>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Output_Headers"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output_Headers"></a>Output header information</h5>
<div class="paragraph">
<p>To output header information to a flat file, implement as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>org.springframework.batch.item.file.FlatFileHeaderCallback</code></p>
</li>
<li>
<p>Set the implemented <code>FlatFileHeaderCallback</code> to property <code>headerCallback</code> of <code>FlatFileItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>By setting <code>headerCallback</code>, <code>FlatFileHeaderCallback#writeHeader()</code> will be executed at first when processing <code>FlatFileItemWriter</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implement <code>FlatFileHeaderCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FlatFileHeaderCallback</code> class and override <code>writeHeader</code>.</p>
</li>
<li>
<p>Write the header information using <code>Writer</code> from the argument.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sample implementation of <code>FlatFileHeaderCallback</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Sample implementation of FlatFileHeaderCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileHeaderCallback {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeHeader(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="comment">// (2)</span>
        writer.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">omitted</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FlatFileHeaderCallback</code> class and override writeHeader method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write the header information using <code>Writer</code> from the argument.<br>
Write method of <code>FlatFileItemWriter</code> will be executed right after the execution of <code>FlatFileHeaderCallback#writeHeader()</code>.<br>
Therefore, printing line break at the end of header information is not needed.
The line feed that is printed is the one set when <code>FlatFileItemWriter</code> bean was defined.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FlatFileHeaderCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code)<br></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">When implementing FlatFileHeaderCallback, printing line feed at the end of header information is not necessary</div>
<div class="paragraph">
<p>Right after executing <code>FlatFileHeaderCallback#writeHeader()</code> in <code>FlatFileItemWriter</code>, line feed is printed according to the bean definition, so the line feed at the end of header information does not need to be printed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter_Output_Footers"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output_Footers"></a>Output footer information</h5>
<div class="paragraph">
<p>To output footer information to a flat file, implement as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>org.springframework.batch.item.file.FlatFileFooterCallback</code></p>
</li>
<li>
<p>Set the implemented <code>FlatFileFooterCallback</code> to property <code>footerCallback</code> of <code>FlatFileItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>By setting <code>footerCallback</code>, <code>FlatFileHeaderCallback#writeFooter()</code> will be executed at first when processing <code>FlatFileItemWriter</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A method of outputting footer information with a flat file will be described.</p>
</div>
<div class="paragraph">
<p>Implement <code>FlatFileFooterCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Output footer information using <code>Writer</code> from the argument.</p>
</li>
<li>
<p>Implement <code>FlatFileFooterCallback</code> class and override <code>writeFooter</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an implementation sample of <code>FlatFileFooterCallback</code> class for a Job to get footer information from <code>ExecutionContext</code> and write it out to a file.</p>
</div>
<div class="listingblock">
<div class="title">Class to set information of footer record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of FlatFileFooterCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteFooterFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileFooterCallback {  <span class="comment">// (1)</span>
    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = (<span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt;) <span class="local-variable">this</span>.jobExecution.getExecutionContext().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (2)</span>

        <span class="predefined-type">BufferedWriter</span> bufferedWriter = <span class="keyword">new</span> <span class="predefined-type">BufferedWriter</span>(writer);  <span class="comment">// (3)</span>
        <span class="comment">// (4)</span>
        <span class="keyword">for</span> (SalesPlanDetailFooter footer : footers) {
            bufferedWriter.write(footer.getName() +<span class="string"><span class="delimiter">&quot;</span><span class="content"> is </span><span class="delimiter">&quot;</span></span> + footer.getValue());
            bufferedWriter.newLine();
            bufferedWriter.flush();
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FlatFileFooterCallback</code> class and override writeFooter method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get footer information form <code>ExecutionContext</code> of the Job using key <code>footers</code>.<br>
In the sample, it uses ArrayList to get several footer informations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In the sample, in order to use <code>BufferedWriter.newLine()</code> for printing line feed, it is using <code>Writer</code> from the argument as a parameter to generate <code>BufferedWriter</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the <code>Writer</code> of argument to print footer information.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FlatFileFooterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_MultiFile"><a class="anchor" href="#Ch05_FileAccess_MultiFile"></a>Multiple Files</h3>
<div class="paragraph">
<p>Describe how to handle multiple files.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_MultiFile_Input"><a class="anchor" href="#Ch05_FileAccess_MultiFile_Input"></a>Input</h4>
<div class="paragraph">
<p>To read multiple files of the same record format, use <code>org.springframework.batch.item.file.MultiResourceItemReader</code>.<br>
<code> MultiResourceItemReader</code> can use the specified <code> ItemReader</code> to read multiple files specified by regular expressions.</p>
</div>
<div class="paragraph">
<p>Implement <code>MultiResourceItemReader</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define bean of <code>MultiResourceItemReader</code></p>
<div class="ulist">
<ul>
<li>
<p>Set file to read to property <code>resources</code></p>
<div class="ulist">
<ul>
<li>
<p>user regular expression to read multiple files</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set <code>ItemReader</code> to read files to property <code>delegate</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is a definition example of <code>MultiResourceItemReader</code> to read multiple files with the following file names.</p>
</div>
<div class="listingblock">
<div class="title">File to be read (file name)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_01.csv
sales_plan_detail_02.csv
sales_plan_detail_03.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:input/sales_plan_detail_*.csv</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set multiple input files with regular expressions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>ItemReader</code> where it has the actual file read implementation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code> with the actual file read implementation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition for property <code>resource</code> is not needed since it will be automatically set from <code>MultiResourceItemReader</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">It is unnecessary to specify resource for ItemReader used by MultiResourceItemReader</div>
<div class="paragraph">
<p>The <code>resource</code> of <code>ItemReader</code> delegated from <code>MultiResourceItemReader</code> is automatically set from <code>MultiResourceItemReader</code>, so setting in the bean definition is unnecessary.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_MultiFile_Output"><a class="anchor" href="#Ch05_FileAccess_MultiFile_Output"></a>Output</h4>
<div class="paragraph">
<p>Explain how to define multiple files.</p>
</div>
<div class="paragraph">
<p>To output to a different file for a certain number of cases, use <code>org.springframework.batch.item.file.MultiResourceItemWriter</code>.</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code> can output to multiple files for each number specified using the specified <code>ItemWriter</code>.<br>
It is necessary to make the output file name unique so as not to overlap, but <code>ResourceSuffixCreator</code> is provided as a mechanism for doing it.<br>
<code>ResourceSuffixCreator</code> is a class that generates a suffix that makes the file name unique.<br></p>
</div>
<div class="paragraph">
<p>For example, if you want to make the output target file a file name <code>outputDir / customer_list_01.csv</code> (<code>01</code> part is serial number), set it as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set <code>outputDir/customer_list_</code> to <code>MultiResourceItemWriter</code></p>
</li>
<li>
<p>Implement a code to generate suffix <code>01.csv</code>(<code>01</code> part is serial number) at <code>ResourceSuffixCreator</code></p>
<div class="ulist">
<ul>
<li>
<p>Serial numbers can use the value automatically incremented and passed from <code>MultiResourceItemWriter</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>outputDir/customer_list_01.csv</code> is set to the <code>ItemWriter</code> that is actually used</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code> is defined as follows. How to implement <code>ResourceSuffixCreator</code> is described later.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define implementation class of <code>ResourceSuffixCreator</code></p>
</li>
<li>
<p>Define bean for <code>MultiResourceItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>Set output file to property <code>resources</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the file name up to the suffix given to implementation class of <code>ResourceSuffixCreator</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set implementation class of <code>ResourceSuffixCreator</code> that generates suffix to property <code>resourceSuffixCreator</code></p>
</li>
<li>
<p>Set <code>ItemWrite</code> which is to be used to read file to property <code>delegate</code></p>
</li>
<li>
<p>Set the number of output per file to property <code>itemCountLimitPerResource</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputDir]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resourceSuffixCreator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:itemCountLimitPerResource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.CustomerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the state before adding the suffix of the output target file.<br>
A file name with suffix given automatically by <code>MultiResourceItemWriter</code> is set to <code>ItemWriter</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourceSuffixCreator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>ResourceSuffixCreator</code>.<br>
Default is <code>org.springframework.batch.item.file.SimpleResourceSuffixCreator</code> whice generates suffix <code>"." + index</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleResourceSuffixCreator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a <code>ItemWriter</code> which actually reads the file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemCountLimitPerResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of output per file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer.MAX_VALUE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code> which actually reads the file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property <code>resource</code> is not needed since it will be automatically set from <code>MultiResourceItemWriter</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Setting of resource of ItemWrite used by MultiResourceItemWriter is not necessary</div>
<div class="paragraph">
<p>Since <code>Resource</code> of <code>ItemWriter</code> delegated from <code>MultiResourceItemWriter</code> is automatically set from <code>MultiResourceItemWriter</code>, it is unnecessary to set it in the bean definition.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implement <code>ResourceSuffixCreator</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>ResourceSuffixCreator</code> and override getSuffix method</p>
</li>
<li>
<p>Use argument&#8217;s <code>index</code> and generate suffix to return</p>
<div class="ulist">
<ul>
<li>
<p><code>index</code> is an <code>int</code> type value with initial value <code>1</code>, and will be incremented for each output file</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample implementation of ResourceSuffixCreator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerListResourceSuffixCreator</span> <span class="directive">implements</span> ResourceSuffixCreator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSuffix(<span class="type">int</span> index) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%02d</span><span class="delimiter">&quot;</span></span>, index) + <span class="string"><span class="delimiter">&quot;</span><span class="content">.csv</span><span class="delimiter">&quot;</span></span>;  <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ResourceSuffixCreator</code> class and override getSuffix method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use argument&#8217;s <code>index</code> to generate suffix to return.
<code>index</code> is an <code>int</code> type value with initial value <code>1</code>, and will be incremented for each output file.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Output_ControlBreak"><a class="anchor" href="#Ch05_FileAccess_Output_ControlBreak"></a>Control Break</h3>
<div class="paragraph">
<p>How to actually do the Control Break will be described here.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">What is Control Break</dt>
<dd>
<p>Control Break process(or Key Break process) is a process method to read sorted records one by one,
and handle records with a certain item(key item) as one group.<br>
It is an algorithm that is used mainly for aggregating data,
continues counting while key items are the same value,
and outputs aggregate values when key items become different values.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In order to perform the control break processing, it is necessary to pre-read the record in order to judge the change of the group.
Pre-reading records can be done by using <code>org.springframework.batch.item.support.SingleItemPeekableItemReader</code>.<br>
Also, control break can be processed only in tasklet model.
This is because of the premise that the chunk model is based on, which are "processing N data rows defined by one line" and "transaction boundaries every fixed number of lines",
does not fit with the control break&#8217;s basic algorithm, "proceed at the turn of group".</p>
</div>
<div class="paragraph">
<p>The execution timing of control break processing and comparison conditions are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute control break before processing the target record</p>
<div class="ulist">
<ul>
<li>
<p>Keep the previously read record, compare previous record with current record</p>
</li>
</ul>
</div>
</li>
<li>
<p>Execute control break after processing the target record</p>
<div class="ulist">
<ul>
<li>
<p>Pre-read the next record by <code>SingleItemPeekableItemReader</code> and compare the current record with the next record</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A sample for outputting process result from input data using control break is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Input Data</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
02,2016,12,900
02,2016,12,1200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Process Result</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">Header Branch Id : 01,,,
01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
Summary Branch Id : 01,,,3800
Header Branch Id : 02,,,
02,2016,12,900
02,2016,12,1200
Summary Branch Id : 02,,,2100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of Control Break</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ControlBreakTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    SingleItemPeekableItemReader&lt;SalesPerformanceDetail&gt; reader; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPerformanceDetail&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        SalesPerformanceDetail previousData = <span class="predefined-constant">null</span>;   <span class="comment">// (2)</span>
        <span class="predefined-type">BigDecimal</span> summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);  <span class="comment">//(3)</span>

        <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();   <span class="comment">// (4)</span>

        <span class="keyword">try</span> {
            reader.open(executionContext);
            writer.open(executionContext);

            <span class="keyword">while</span> (reader.peek() != <span class="predefined-constant">null</span>) {   <span class="comment">// (5)</span>
                SalesPerformanceDetail data = reader.read(); <span class="comment">// (6)</span>

                <span class="comment">// (7)</span>
                <span class="keyword">if</span> (isBreakByBranchId(previousData, data)) {
                    SalesPerformanceDetail beforeBreakData =
                            <span class="keyword">new</span> SalesPerformanceDetail();
                    beforeBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Header Branch Id : </span><span class="delimiter">&quot;</span></span>
                              + currentData.getBranchId());
                    items.add(beforeBreakData);
                }

                <span class="comment">// omitted.</span>
                items.add(data);  <span class="comment">// (8)</span>

                SalesPerformanceDetail nextData = reader.peek();  <span class="comment">// (9)</span>
                summary = summary.add(data.getAmount());

                <span class="comment">// (10)</span>
                SalesPerformanceDetail afterBreakData = <span class="predefined-constant">null</span>;
                <span class="keyword">if</span> (isBreakByBranchId(nextData, data)) {
                    afterBreakData = <span class="keyword">new</span> SalesPerformanceDetail();
                    afterBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Summary Branch Id : </span><span class="delimiter">&quot;</span></span>
                            + currentData.getBranchId());
                    afterBreakData.setAmount(summary);
                    items.add(afterBreakData);
                    summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);
                    writer.write(items);  <span class="comment">// (11)</span>
                    items.clear();
                }
                previousData = data;  <span class="comment">// (12)</span>
            }
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
            <span class="keyword">try</span> {
                writer.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
    <span class="comment">// (13)</span>
    <span class="directive">private</span> <span class="type">boolean</span> isBreakByBranchId(SalesPerformanceDetail o1,
            SalesPerformanceDetail o2) {
        <span class="keyword">return</span> (o1 == <span class="predefined-constant">null</span> || !o1.getBranchId().equals(o2.getBranchId()));
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject <code>SingleItemPeekableItemReader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set the previously read record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set aggregated values for each group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set records for each group including the control break&#8217;s process result</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repeat the process until there is no input data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read the record to be processed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute a control break before target record processing.<br>
In the sample, if it is at the beginning of the group, heading is set stored it the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the process result to the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pre-read the next record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute a control break after target record processing.
In this case, if it is at the end of the group, the aggregated data is set in the trailer and stored in the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output processing results for each group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the processing record in the variable defined in (2).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge whether the key item has switched or not.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.SingleItemPeekableItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define bean for <code>SingleItemPeekableItemReader</code>. It will be injected to the Tasklet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the bean of ItemReader that actually reads the file to <code>delegate</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a bean for ItemReader that actually read the file.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05_FileAccess_HowToExtend"><a class="anchor" href="#Ch05_FileAccess_HowToExtend"></a>How To Extend</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here, an explanation will be written based on the below case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_FieldSetMapper">Implmementation of FieldSetMapper</a></p>
</li>
<li>
<p>Input/Output of <a href="#Ch05_FileAccess_Xml">XML File</a></p>
</li>
<li>
<p>Input/Output of <a href="#Ch05_FileAccess_MultiFormat">Multi format</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_FieldSetMapper"><a class="anchor" href="#Ch05_FileAccess_FieldSetMapper"></a>Implmementation of FieldSetMapper</h3>
<div class="paragraph">
<p>Explain how to implement <code>FieldSetMapper</code> yourself.</p>
</div>
<div class="paragraph">
<p>Implement <code>FieldSetMapper</code> class as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FieldSetMapper</code> class and override mapFieldSet method.</p>
</li>
<li>
<p>Get the value from argument&#8217;s <code>FieldSet</code>, do any process needed, and then set it to the conversion target bean as a return value</p>
<div class="ulist">
<ul>
<li>
<p>The <code>FieldSet</code> class is a class that holds data in association with an index or name, as in the JDBC <code>ResultSet</code> class</p>
</li>
<li>
<p>The <code>FieldSet</code> class holds the value of each field of a record divided by <code>LineTokenizer</code></p>
</li>
<li>
<p>You can store and retrieve values by specifying an index or name</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is sample implementation for reading a file that includes data that needs to be converted, such as BigDecimal type with comma and Date type of Japanese calendar format.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">&quot;000001&quot;,&quot;平成28年1月1日&quot;,&quot;000000001&quot;,&quot;1,000,000,000&quot;
&quot;000002&quot;,&quot;平成29年2月2日&quot;,&quot;000000002&quot;,&quot;2,000,000,000&quot;
&quot;000003&quot;,&quot;平成30年3月3日&quot;,&quot;000000003&quot;,&quot;3,000,000,000&quot;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Input file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese calendar format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">include comma</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="predefined-type">Date</span> date;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of FieldSetMapper</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetailFieldSetMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;UseDateSalesPlanDetail&gt; {  <span class="comment">// (1)</span>
    <span class="comment">/**
     * {@inheritDoc}
     *
     * @param fieldSet {@inheritDoc}
     * @return Sales performance detail.
     * @throws BindException {@inheritDoc}
     */</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> UseDateSalesPlanDetail mapFieldSet(FieldSet fieldSet) <span class="directive">throws</span> <span class="exception">BindException</span> {
        UseDateSalesPlanDetail item = <span class="keyword">new</span> UseDateSalesPlanDetail();  <span class="comment">// (2)</span>

        item.setBranchId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (3)</span>

        <span class="comment">// (4)</span>
        <span class="predefined-type">DateFormat</span> japaneseFormat = <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GGGGy年M月d日</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Locale</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ja</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">try</span> {
            item.setDate(japaneseFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (5)</span>
        item.setCustomerId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// (6)</span>
        <span class="predefined-type">DecimalFormat</span> decimalFormat = <span class="keyword">new</span> <span class="predefined-type">DecimalFormat</span>();
        decimalFormat.setParseBigDecimal(<span class="predefined-constant">true</span>);
        <span class="keyword">try</span> {
            item.setAmount((<span class="predefined-type">BigDecimal</span>) decimalFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="keyword">return</span> item;  <span class="comment">// (7)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FieldSetMapper</code> class and override mapFieldSet method.
Set conversion target class for type argument of <code>FieldSetMapper</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable of conversion target class to store converted data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>branchId</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Conversion for <code>branchId</code> is not done in the sample since it is not necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>date</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Use <code>SimpleDateFormat</code> to convert Japanese calendar format date to Date type value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>customerId</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Conversion for <code>customerId</code> is not done in the sample since it is not necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>amount</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Use <code>DecimalFormat</code> to convert value with comma to BigDecimal type value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the conversion target class holding the processing result.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Getting value from FieldSet class</div>
<div class="paragraph">
<p>The <code>FieldSet</code> class has methods corresponding to various data types for obtaining stored values such as listed below.<br>
When generating <code>FieldSet</code> if data is stored in association with the field name, it is possible to get data by specifying that name or by specifying the index.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readString()</code></p>
</li>
<li>
<p><code>readInt()</code></p>
</li>
<li>
<p><code>readBigDecimal()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>etc</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_Xml"><a class="anchor" href="#Ch05_FileAccess_Xml"></a>XML File</h3>
<div class="paragraph">
<p>Describe the definition method when dealing with XML files.</p>
</div>
<div class="paragraph">
<p>For the conversion process between Bean and XML (O / X (Object / XML) mapping), use the library provided by Spring Framework.<br>
Implementation classes are provided as <code> Marshaller</code> and <code> Unmarshaller</code> using XStream, JAXB, etc. as libraries for converting between XML files and objects.<br>
Use one suitable for your situation.</p>
</div>
<div class="paragraph">
<p>Below are features and points for adopting JAXB and XStream.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JAXB</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Specify the bean to be converted in the bean definition file</p>
</li>
<li>
<p>Validation using a schema file can be performed</p>
</li>
<li>
<p>It is useful when the schema is defined externally and the specification of the input file is strictly determined</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">XStream</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>You can map XML elements and bean fields flexibly in the bean definition file</p>
</li>
<li>
<p>It is useful when you need to flexibly map beans</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here is a sample using JAXB.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_Xml_Input"><a class="anchor" href="#Ch05_FileAccess_Xml_Input"></a>Input</h4>
<div class="paragraph">
<p>For inputting XML file, use <code>org.springframework.batch.item.xml.StaxEventItemReader</code> provided by Spring Batch.<br>
<code>StaxEventItemReader</code> can read the XML file by mapping the XML file to the bean using the specified <code>Unmarshaller</code>.</p>
</div>
<div class="paragraph">
<p>Implement <code>StaxEventItemReader</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>@XmlRootElement</code> to the conversion target class of XML root element</p>
</li>
<li>
<p>Set below property to <code>StaxEventItemReader</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the file to read to property <code>resource</code></p>
</li>
<li>
<p>Set the name of the root element to property <code>fragmentRootElementName</code></p>
</li>
<li>
<p>Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> to property <code>unmarshaller</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below property to <code>Jaxb2Marshaller</code></p>
<div class="ulist">
<ul>
<li>
<p>Set conversion target classs in list format to property <code>classesToBeBound</code></p>
</li>
<li>
<p>To validate using schema file, set the 2 properties as below</p>
<div class="ulist">
<ul>
<li>
<p>Set the schema file for validation to property <code>schema</code></p>
</li>
<li>
<p>Set implementation class of <code>ValidationEventHandler</code> to property <code>validationEventHandler</code> to handle events occured during the validation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the sample setting to read the input file below.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000001<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2016<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>1<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000001<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>1000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000002<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2017<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>2<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000002<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>2000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000003<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2018<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>3<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000003<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>3000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlRootElement</code> for the XML root element.<br>
Set <code>SalesPlanDetail</code> for the tag name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:fragmentRootElementName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="comment">&lt;!-- (5) (6) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:schema</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:files/test/input/ch05/fileaccess/SalesPlanDetail.xsd</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:validationEventHandler-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanDetailValidationEventHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fragmentRootElementName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the name of the root element.<br>
If there are several target objects, use <code>fragmentRootElementNames</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unmarshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the unmarshaller.<br>
Set Bean of <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> when using JAXB.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set shema file for validation.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validationEventHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>ValidationEventHandler</code> to handle events occured during the validation.<br>
Sample implementation of <code>ValidationEventHandler</code> is described later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set conversion target classes in list format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Sample implementation of ValidationEventHandler</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailValidationEventHandler</span> <span class="directive">implements</span> ValidationEventHandler {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPlanDetailValidationEventHandler.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleEvent(ValidationEvent event) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[EVENT [SEVERITY:{}] [MESSAGE:{}] [LINKED EXCEPTION:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [LOCATOR: [LINE NUMBER:{}] [COLUMN NUMBER:{}] [OFFSET:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [OBJECT:{}] [NODE:{}] [URL:{}] ] ]</span><span class="delimiter">&quot;</span></span>,
                event.getSeverity(),
                event.getMessage(),
                event.getLinkedException(),
                event.getLocator().getLineNumber(),
                event.getLocator().getColumnNumber(),
                event.getLocator().getOffset(),
                event.getLocator().getObject(),
                event.getLocator().getNode(),
                event.getLocator().getURL());
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;  <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ValidationEventHandler</code> class and override handleEvent method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get event information from argument&#8217;s event(<code>ValidationEvent</code>), and do any process needed.<br>
In the sample, logging is proceeded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return false to end the search process.
Return true to continue the search process.<br>
Return false to end this operation by generating appropriate <code>UnmarshalException</code>, <code>ValidationException</code> or <code>MarshalException</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Adding dependency library</div>
<div class="paragraph">
<p>Library dependency needs to be added as below when using
Spring Object/Xml Marshalling provided by Spring Framework
such as <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_Xml_Output"><a class="anchor" href="#Ch05_FileAccess_Xml_Output"></a>Output</h4>
<div class="paragraph">
<p>Use <code>org.springframework.batch.item.xml.StaxEventItemWriter</code> provided by Spring Batch for outputting XML file.
<code>StaxEventItemWriter</code> can output an XML file by mapping the bean to XML using the specified <code>Marshaller</code>.</p>
</div>
<div class="paragraph">
<p>Implement <code>StaxEventItemWriter</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do the below setting to conversion target class</p>
<div class="ulist">
<ul>
<li>
<p>Add <code>@XmlRootElement</code> to the class as it is to be the root element of the XML</p>
</li>
<li>
<p>Use <code>@XmlType</code> annotation to set orders for outputting fields</p>
</li>
<li>
<p>If there is a field to be excluded from conversion to XML, add <code>@XmlTransient</code> to the getter method of it&#8217;s field</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below properties to <code>StaxEventItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>Set output target file to property <code>resource</code></p>
</li>
<li>
<p>Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> to property <code>marshaller</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below property to <code>Jaxb2Marshaller</code></p>
<div class="ulist">
<ul>
<li>
<p>Set conversion target classes in list format to property <code>classesToBeBound</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a sample for outputting below file.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div id="Ch05_FileAccess_Xml_Output_format" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About XML file fomatX(line break and indents)</div>
<div class="paragraph">
<p>In the sample above, the output XML file has been formatted(has line break and indents), but the actual XML will not be formatted.</p>
</div>
<div class="paragraph">
<p><code>Jaxb2Marshaller</code> has a function to format it when outputting the XML file, but it does not work as is it expected.<br>
This issue is being discussed in the Spring Forum, and might be fixed in the future.</p>
</div>
<div class="paragraph">
<p>To avoid this and output the formatted XML, set <code>marshallerProperties</code> as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted settings --&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshallerProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry&gt;</span>
                    <span class="tag">&lt;key&gt;</span>
                        <span class="tag">&lt;util:constant</span>
                            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.xml.bind.Marshaller.JAXB_FORMATTED_OUTPUT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/key&gt;</span>
                    <span class="tag">&lt;value</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Boolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/entry&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
<span class="annotation">@XmlType</span>(propOrder={<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerAddress</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">customerTel</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">chargeBranchId</span><span class="delimiter">&quot;</span></span>})  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getCreateDate() { <span class="keyword">return</span> createDate; }

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getUpdateDate() { <span class="keyword">return</span> updateDate; }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlRootElement</code> annotation to make this as the root element of XML.<br>
Set <code>Customer</code> for the tag name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>@XmlType</code> annotation to set field output order.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlTransient</code> to getter method of fileds which is to be excluded from XML conversion.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rootTagName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">records</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:overwriteOutput</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>org.terasoluna.batch.functionaltest.ch05.fileaccess.model.mst.CustomerToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set output file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set character encoding for output file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rootTagName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set XML root tag name.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">overwriteOutput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the output if it is an empty file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="Ch05_Transaction.html#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the marshaller.
Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> when using JAXB.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set conversion target classes in list format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Adding dependency library</div>
<div class="paragraph">
<p>Library dependency needs to be added as below when using
Spring Object/Xml Marshalling provided by Spring Framework
such as <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_XML_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_XML_HeaderFooter"></a>Output Header / Footer</h5>
<div class="paragraph">
<p>For output of header and footer, use the implementation class of <code>org.springframework.batch.item.xml.StaxWriterCallback</code>.</p>
</div>
<div class="paragraph">
<p>Set implementation of <code>headerCallback</code> for header output, and <code>footerCallback</code> for footer output.</p>
</div>
<div class="paragraph">
<p>Below is a sample of output file.<br>
Header is printed right after the root tag&#8217;s openning element, and footer is printed right before the root element&#8217;s closing tag.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
<span class="comment">&lt;!-- Customer list header --&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="comment">&lt;!-- Customer list footer --&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About XML file fomatX(line break and indents)</div>
<div class="paragraph">
<p>In the sample above, the output XML file has been formatted(has line break and indents), but the actual XML will not be formatted.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="#Ch05_FileAccess_Xml_Output_format">About XML file fomatX(line break and indents)</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To output the above file, do the setting as below.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderStaxWriterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterStaxWriterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StaxWriterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StaxWriterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implement <code>StaxWriterCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StaxWriterCallback</code> class and override write method</p>
</li>
<li>
<p>Print header/footer by using the argument&#8217;s <code>XMLEventWriter</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of StaxWriterCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderStaxWriterCallback</span> <span class="directive">implements</span> StaxWriterCallback { <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(XMLEventWriter writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        XMLEventFactory factory = XMLEventFactory.newInstance();
        <span class="keyword">try</span> {
            writer.add(factory.createComment(<span class="string"><span class="delimiter">&quot;</span><span class="content"> Customer list header </span><span class="delimiter">&quot;</span></span>)); <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (XMLStreamException e) {
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>StaxWriterCallback</code> class and override write method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print header/footer by using the argument&#8217;s <code>XMLEventWriter</code><br></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">XML output using XMLEventFactory</div>
<div class="paragraph">
<p>In the output of the XML file using the <code>XMLEventWriter</code> class, you can efficiently generate <code>XMLEvent</code> by using the <code>XMLEventFactory</code> class.</p>
</div>
<div class="paragraph">
<p>The <code>XMLEventWriter</code> class has an add method defined, which takes an XMLEvent object as an argument and outputs an XML file.<br>
Since it is very time consuming to generate an <code>XMLEvent</code> object each time, use the <code>XMLEventFactory</code> class which can easily generate <code>XMLEvent</code>.<br>
In the <code>XMLEventFactory</code> class, methods corresponding to the event to be created are defined, such as <code>createStartDocument</code> method and <code>createStartElement</code> method.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess_MultiFormat"><a class="anchor" href="#Ch05_FileAccess_MultiFormat"></a>Multi format</h3>
<div class="paragraph">
<p>Describe the definition method when dealing with multi format file.</p>
</div>
<div class="paragraph">
<p>As described in <a href="#Ch05_FileAccess_Overview">Overview</a>, multi format is basically (Header N Rows + Data N Rows + Trailer N Rows) * N + Footer N Rows format, but there are other format patterns like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When there is a footer record or not</p>
</li>
<li>
<p>When there are records with different formats in the same record classification</p>
<div class="ulist">
<ul>
<li>
<p>eg) there is a data record that has 5 items and a data record with 6 items in data part</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although there are several patterns to multi format file, implementation method will be the same.</p>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_MultiLine_Input"><a class="anchor" href="#Ch05_FileAccess_MultiLine_Input"></a>Input</h4>
<div class="paragraph">
<p>Use <code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code> provided by Spring Batch for readeing multi format file.<br>
In multi format file, each record needs to be mapped to defferent bean for each format.<br>
<code>PatternMatchingCompositeLineMapper</code> will select the <code>LineTokenizer</code> and <code>FieldSetMapper</code> to use for the record by regular expression.</p>
</div>
<div class="paragraph">
<p>For example, <code>LineTokenizers</code> to use can be selected like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>userTokenizer</code> if the beginning of the record matches to regular expression <code>USER*</code></p>
</li>
<li>
<p>Use <code>lineATokenizer</code> if the beginning of the record matches to regular expression <code>LINEA*</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Restrictions on the format of records when reading multi-format files</div>
<div class="paragraph">
<p>In order to read a multi-format file, it must be in a format that can distinguish record classification by regular expression.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implement <code>PatternMatchingCompositeLineMapper</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define a class with record division for conversino target class, and inherit this class to each classes of each record division</p>
</li>
<li>
<p>Define <code>LineTokenizer</code> and <code>FieldSetMapper</code> to map each record to bean</p>
</li>
<li>
<p>Define <code>PatternMatchingCompositeLineMapper</code></p>
<div class="ulist">
<ul>
<li>
<p>Set <code>LineTokenizer</code> that correspond to each record division to property <code>tokenizers</code></p>
</li>
<li>
<p>Set <code>FieldSetMapper</code> that correspond to each record division to property <code>fieldSetMappers</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Define a class with record division for conversino target class, and inherit this class to each classes of each record division</div>
<div class="paragraph">
<p><code>ItemProcessor</code> has a specification that takes one type as an argument.</p>
</div>
<div class="paragraph">
<p>However, if you simply map <code>PatternMatchingCompositeLineMapper</code> to a multi-format file to a different bean for each record division, <code>ItemProcessor</code> can not handle multiple types as it takes one type as an argument.</p>
</div>
<div class="paragraph">
<p>Therefore, it is possible to solve this by giving an inheritance relation to the class to be converted and specifying a superclass as the type of the argument of <code>ItemProcessor</code>.</p>
</div>
<div class="paragraph">
<p>The class diagram of the conversion target class and the definition sample of <code>ItemProcessor</code> are shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_Conversion_target_class_with_inheritance_relationship.png" alt="Conversion target class definition when loading multiple formats">
</div>
<div class="title">Class diagram of conversion target class</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="comment">// (1)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (2)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (3)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">default</span>:
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the superclass of the class to be converted whose inheritance relation is given as the argument of <code>ItemProcessor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the record division from item.<br>
Actual classes are different depending on each record division, but record divison can be retrieved by polymorphism.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge the record division and process things needed for each record division.<br>
Perform class conversions as needed.</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a setting sample and implementation sample for reading below input file.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is the bean definition sample of conversion target class.</p>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Model of record indicator of sales plan detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailMultiLayoutRecord</span> {

    <span class="directive">protected</span> <span class="predefined-type">String</span> record;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of sales plan detail header.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailHeader</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailData</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailTrailer</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> number;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailEnd</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {
    <span class="comment">// omitted getter/setter</span>

    <span class="directive">private</span> <span class="type">int</span> headNum;
    <span class="directive">private</span> <span class="type">int</span> trailerNum;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailHeader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailData</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailTrailer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailEnd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[inputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMappers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>LineTokenizer</code> corresponding to each record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>LineTokenizer</code> that corresponds to each record.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>FieldSetMapper</code> corresponding to each record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>FieldSetMapper</code> that corresponds to each record.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>LineTokenizer</code> corresponding to each record in map format.<br>
Set regular expression to determine record for <code>key</code>, and set the <code>LineTokenizer</code> to use for <code>value-ref</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>FieldSetMapper</code> corresponding to each record in map format.<br>
Set regular expression to determine record for <code>key</code>, and set the <code>FieldSetMapper</code> to use for <code>value-ref</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_MultiLine_Output"><a class="anchor" href="#Ch05_FileAccess_MultiLine_Output"></a>Output</h4>
<div class="paragraph">
<p>Describe the definition method when dealing with multi format file.</p>
</div>
<div class="paragraph">
<p>For reading multi format file <code>PatternMatchingCompositeLineMapper</code> was provided to determine which <code>LineTokenizer</code> and <code>FieldSetMapper</code> to use for each record division.
However for writing, no similar components are provided.<br></p>
</div>
<div class="paragraph">
<p>Therefore, processing up to conversion target class to record (character string) within <code>ItemProcessor</code> is carried out, and <code>ItemWriter</code> writes the received character string as it is to achieve writing of multi format file .</p>
</div>
<div class="paragraph">
<p>Implement multi format output as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code> converts the conversion target class to a record (character string) and passes it to <code>ItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>In the sample, define <code>LineAggregator</code> and <code>FieldExtractor</code> for each record division and use it by injecting it with <code>ItemProcessor</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ItemWriter</code> writes the received character string as it is to the file</p>
<div class="ulist">
<ul>
<li>
<p>Set <code>PassThroughLineAggregator</code> to property <code>lineAggregator</code> of <code>ItemWriter</code></p>
</li>
<li>
<p><code>PassThroughLineAggregator</code> is <code>LineAggregator</code> which returns <code>item.toString ()</code> result of received item</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a setting sample and implementation sample for writing below output file.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Definition of conversion target class and <code>ItemProcessor</code> sample, notes are the same as <a href="#Ch05_FileAccess_MultiLine_Input">Multi format Input</a>.</p>
</div>
<div class="paragraph">
<p>Settings to output above file is as below.
Bean definition sample for <code>ItemProcessor</code> is written later.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters[outputFile]}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>LineAggregator</code> and <code>FieldExtractor</code> corresponding to each record division</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>LineAggregator</code> and <code>FieldExtractor</code>.<br>
Use <code>LineAggregator</code> by injecting it to <code>ItemProcessor</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implementation sample of <code>ItemProcessor</code> is shown below.<br>
In this sample, only the process of converting the received item to a string and passing it to <code>ItemWriter</code> is performed.</p>
</div>
<div class="listingblock">
<div class="title">Sample Implementation of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; headerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; dataDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; trailerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; endDelimitedLineAggregator;

    <span class="annotation">@Override</span>
    <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (3)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (4)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> headerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> dataDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> trailerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> endDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">default</span>:
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectRecordClassificationException(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Record classification is incorrect.[value:</span><span class="delimiter">&quot;</span></span> + record + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject <code>LineAggregator</code> corresponding to each record division.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the superclass of the class to be converted whose inheritance relation is given as the argument of <code>ItemProcessor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the record division from item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge record division and do any process for each record division.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>LineAggregator</code> corresponding to each record division to convert the conversion target class to a record (character string) and pass it to <code>ItemWriter</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="footer-navi">
  <a href="index.html">index</a>
</div>

<div class="footer-copyright">
 &copy; Copyright 2017-3-17, NTT DATA Corporation.
</div>
</body>
</html>