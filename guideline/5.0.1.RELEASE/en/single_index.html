<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="NTT DATA Corporation.">
<title>TERASOLUNA Batch Framework for Java (5.x) Development Guideline</title>
<link rel="stylesheet" href="./theme/css/readthedocs.css">
<link rel="stylesheet" href="./theme/css/font-awesome.min.css">
<link rel="stylesheet" href="./theme/css/coderay-asciidoctor.css">
<link rel="stylesheet" href="./theme/css/header-footer.css">
<title>TERASOLUNA Batch Framework for Java (5.x) Development Guideline</title>

<div class="common-bg">
  <div class="information">
    TERASOLUNA Batch Framework for Java (5.x) Development Guideline - version 5.0.1.RELEASE, 2017-9-27
  </div>
  <div class="index">
    <a href="#">&gt; INDEX</a>
  </div>
</div>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8VC2LCPQFM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());  gtag('config', 'G-8VC2LCPQFM');
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46550814-2', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>TERASOLUNA Batch Framework for Java (5.x) Development Guideline</h1>
<div class="details">
<span id="author" class="author">NTT DATA Corporation.</span><br>
<span id="revnumber">version 5.0.1.RELEASE,</span>
<span id="revdate">2017-9-27</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#Ch01">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#Ch01_TermsOfUse">1.1. Terms of Use</a></li>
<li><a href="#Ch01_Intro">1.2. Introduction</a>
<ul class="sectlevel3">
<li><a href="#Ch01_Goal">1.2.1. Goal of guideline</a></li>
<li><a href="#Ch01_TargetReaders">1.2.2. Target readers</a></li>
<li><a href="#Ch01_Structure">1.2.3. Structure of guideline</a></li>
<li><a href="#Ch01_HowToReadGuide">1.2.4. How to read guideline</a></li>
<li><a href="#Ch01_TestedEnviroments">1.2.5. Tested environments of guideline</a></li>
</ul>
</li>
<li><a href="#Ch01_ChangeLog">1.3. Change Log</a></li>
</ul>
</li>
<li><a href="#Ch02">2. TERASOLUNA Batch Framework for Java (5.x) concept</a>
<ul class="sectlevel2">
<li><a href="#Ch02_GeneralBatchProcess">2.1. Batch Processing in General</a>
<ul class="sectlevel3">
<li><a href="#Ch02_GeneralBatchProcess_AboutBatchProcess">2.1.1. Introduction to Batch Processing</a></li>
<li><a href="#Ch02_GeneralBatchProcess_Scenario">2.1.2. Requirements for batch processing</a></li>
<li><a href="#Ch02_GeneralBatchProcess_Considerations">2.1.3. Rules and precautions to be considered in batch processing</a></li>
</ul>
</li>
<li><a href="#Ch02_TerasolunaBatchStack">2.2. TERASOLUNA Batch Framework for Java (5.x) stack</a>
<ul class="sectlevel3">
<li><a href="#Ch02_TerasolunaBatchStack_Overview">2.2.1. Overview</a></li>
<li><a href="#Ch02_TerasolunaBatchStack_Stack">2.2.2. TERASOLUNA Batch Framework for Java (5.x) stack</a></li>
<li><a href="#Ch02_TerasolunaBatchStack_Components">2.2.3. Structural elements of TERASOLUNA Batch Framework for Java (5.x)</a></li>
</ul>
</li>
<li><a href="#Ch02_SpringBatchArch">2.3. Spring Batch Architecture</a>
<ul class="sectlevel3">
<li><a href="#Ch02_SpringBatchArch_Overview">2.3.1. Overview</a></li>
<li><a href="#Ch02_SpringBatchArch_Detail">2.3.2. Architecture</a></li>
</ul>
</li>
<li><a href="#Ch02_TerasolunaBatchArch">2.4. Architecture of TERASOLUNA Batch Framework for Java (5.x)</a>
<ul class="sectlevel3">
<li><a href="#Ch02_TerasolunaBatchArch_Overview">2.4.1. Overview</a></li>
<li><a href="#Ch02_TerasolunaBatchArch_JobComponents">2.4.2. Structural elements of job</a></li>
<li><a href="#Ch02_TerasolunaBatchArch_StepImpl">2.4.3. How to implement Step</a></li>
<li><a href="#Ch02_TerasolunaBatchArch_LaunchMethod">2.4.4. Running a job method</a></li>
<li><a href="#Ch02_TerasolunaBatchArch_DecisionPoints">2.4.5. Points to consider while using</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch03">3. Methodology of application development</a>
<ul class="sectlevel2">
<li><a href="#Ch03_CreateProject">3.1. Development of batch application</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateProject_blank">3.1.1. What is blank project</a></li>
<li><a href="#Ch03_CreateProject_HowToCreate">3.1.2. Creation of project</a></li>
<li><a href="#Ch03_CreateProject_ProjectStructure">3.1.3. Project structure</a></li>
<li><a href="#Ch03_CreateProject_Make">3.1.4. Flow of development</a></li>
<li><a href="#Ch03_CreateProject_Make_Resources">3.1.5. Creation of job</a></li>
<li><a href="#Ch03_CreateProject_BuildAndExec">3.1.6. Build and execution of project</a></li>
</ul>
</li>
<li><a href="#Ch03_CreateChunkJob">3.2. Creation of chunk model job</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateChunkJob_Overview">3.2.1. Overview</a></li>
<li><a href="#Ch03_CreateChunkJob_HowToUse">3.2.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch03_CreateTaskletJob">3.3. Creation of tasklet model job</a>
<ul class="sectlevel3">
<li><a href="#Ch03_CreateTaskletJob_Overview">3.3.1. Overview</a></li>
<li><a href="#Ch03_CreateTaskletJob_HowToUse">3.3.2. HowToUse</a></li>
</ul>
</li>
<li><a href="#Ch03_ChunkOrTasklet">3.4. How to choose chunk model or tasklet model</a></li>
</ul>
</li>
<li><a href="#Ch04">4. Running a job</a>
<ul class="sectlevel2">
<li><a href="#Ch04_SyncJob">4.1. Synchronous job</a>
<ul class="sectlevel3">
<li><a href="#Ch04_SyncJob_Overview">4.1.1. Overview</a></li>
<li><a href="#Ch04_SyncJob_HowToUse">4.1.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch04_JobParameter">4.2. Job parameters</a>
<ul class="sectlevel3">
<li><a href="#Ch04_JobParameter_Overview">4.2.1. Overview</a></li>
<li><a href="#Ch04_JobParameter_HowToUse">4.2.2. How to use</a></li>
<li><a href="#Ch04_JobParameter_HowToExtends">4.2.3. How to extend</a></li>
</ul>
</li>
<li><a href="#Ch04_AsyncJobWithDB">4.3. Asynchronous execution (DB polling)</a>
<ul class="sectlevel3">
<li><a href="#Ch04_AsyncJobWithDB_Overview">4.3.1. Overview</a></li>
<li><a href="#Ch04_AsyncJobWithDB_Arch">4.3.2. Architecture</a></li>
<li><a href="#Ch04_AsyncJobWithDB_HowToUse">4.3.3. How to use</a></li>
<li><a href="#Ch04_AsyncJobWithDB_HowToExtend">4.3.4. How to extend</a></li>
<li><a href="#Ch04_AsyncJobWithDB_Appendix">4.3.5. Appendix</a></li>
</ul>
</li>
<li><a href="#Ch04_AsyncJobWithWeb">4.4. Asynchronous execution (Web container)</a>
<ul class="sectlevel3">
<li><a href="#Ch04_AsyncJobWithWeb_Overview">4.4.1. Overview</a></li>
<li><a href="#Ch04_AsyncJobWithWeb_Arch">4.4.2. Architecture</a></li>
<li><a href="#CCh04_AsyncJobWithWeb_HowToUse">4.4.3. How to use</a></li>
<li><a href="#Ch04_AsyncJobWithWeb_HowToExtend">4.4.4. How to extend</a></li>
</ul>
</li>
<li><a href="#Ch04_Listener">4.5. Listener</a>
<ul class="sectlevel3">
<li><a href="#Ch04_Listener_Overview">4.5.1. Overview</a></li>
<li><a href="#Ch04_Listener_HowToUse">4.5.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch05">5. Input/Output of Data</a>
<ul class="sectlevel2">
<li><a href="#Ch05_Transaction">5.1. Transaction control</a>
<ul class="sectlevel3">
<li><a href="#Ch05_Transaction_Overview">5.1.1. Overview</a></li>
<li><a href="#architecture">5.1.2. Architecture</a></li>
<li><a href="#Ch05_Transaction_HowToUse">5.1.3. How to use</a></li>
</ul>
</li>
<li><a href="#Ch05_DBAccess">5.2. Database Access</a>
<ul class="sectlevel3">
<li><a href="#Ch05_DBAccess_Overview">5.2.1. Overview</a></li>
<li><a href="#Ch05_DBAccess_HowToUse">5.2.2. How to use</a></li>
<li><a href="#Ch05_DBAccess_HowToExtend">5.2.3. How To Extend</a></li>
</ul>
</li>
<li><a href="#Ch05_FileAccess">5.3. File Access</a>
<ul class="sectlevel3">
<li><a href="#Ch05_FileAccess_Overview">5.3.1. Overview</a></li>
<li><a href="#Ch05_FileAccess_HowToUse">5.3.2. How To Use</a></li>
<li><a href="#Ch05_FileAccess_HowToExtend">5.3.3. How To Extend</a></li>
</ul>
</li>
<li><a href="#Ch05_ExclusiveControl">5.4. Exclusive Control</a>
<ul class="sectlevel3">
<li><a href="#Ch05_ExclusiveControl_Overview">5.4.1. Overview</a></li>
<li><a href="#Ch05_ExclusiveControl_HowToUse">5.4.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch06">6. Support to abnormal system</a>
<ul class="sectlevel2">
<li><a href="#Ch06_InputValidation">6.1. Input Validation</a>
<ul class="sectlevel3">
<li><a href="#Ch06_InputValidation_Overview">6.1.1. Overview</a></li>
<li><a href="#Ch06_InputValidation_HowToUse">6.1.2. How to use</a></li>
</ul>
</li>
<li><a href="#Ch06_ExceptionHandling">6.2. Exception handling</a>
<ul class="sectlevel3">
<li><a href="#Ch06_ExceptionHandling_Overview">6.2.1. Overview</a></li>
<li><a href="#Ch06_ExceptionHandling_HowToUse">6.2.2. How to use</a></li>
<li><a href="#Ch06_ExceptionHandling_Appendix">6.2.3. Appendix</a></li>
</ul>
</li>
<li><a href="#Ch06_RerunRestart">6.3. Restart processing</a>
<ul class="sectlevel3">
<li><a href="#Ch06_RerunRestart_Overview">6.3.1. Overview</a></li>
<li><a href="#Ch06_RerunRestart_HowToUse">6.3.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch07_JobManagement">7. Job Management</a>
<ul class="sectlevel2">
<li><a href="#Ch07_JobManagement_Overview">7.1. Overview</a>
<ul class="sectlevel3">
<li><a href="#what-is-job-execution-management">7.1.1. What is Job Execution Management?</a></li>
</ul>
</li>
<li><a href="#Ch07_JobManagement_HowToUse">7.2. How to use</a>
<ul class="sectlevel3">
<li><a href="#Ch07_JobManagement_JobStatusManagement">7.2.1. Job Status Management</a></li>
<li><a href="#Ch07_JobManagement_ExitCode">7.2.2. Customizing Exit Codes</a></li>
<li><a href="#Ch07_JobManagement_DuplicateSafe">7.2.3. Double Activation Prevention</a></li>
<li><a href="#Ch07_JobManagement_Logging">7.2.4. Logging</a></li>
<li><a href="#Ch07_JobManagement_MessageManagement">7.2.5. Message Management</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch08">8. Flow control and parallel, multiple processing</a>
<ul class="sectlevel2">
<li><a href="#Ch08_FlowControll">8.1. Flow control</a>
<ul class="sectlevel3">
<li><a href="#Ch08_FCh08_FlowControll_Overview">8.1.1. Overview</a></li>
<li><a href="#Ch08_FCh08_FlowControll_HowToUse">8.1.2. How to use</a></li>
<li><a href="#Ch08_FCh08_FlowControll_HowToExtend">8.1.3. How to extend</a></li>
</ul>
</li>
<li><a href="#Ch08_ParallelAndMultiple">8.2. Parallel processing and multiple processing</a>
<ul class="sectlevel3">
<li><a href="#Ch08_ParallelAndMultiple_Overview">8.2.1. Overview</a></li>
<li><a href="#Ch08_ParallelAndMultiple_HowToUse">8.2.2. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Ch09">9. Tutorial</a>
<ul class="sectlevel2">
<li><a href="#Ch09_Introduction">9.1. Introduction</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Introduction_Purpose">9.1.1. Objective of the tutorial</a></li>
<li><a href="#Ch09_Introduction_Target">9.1.2. Target readers</a></li>
<li><a href="#Ch09_Introduction_Environment">9.1.3. Verification environment</a></li>
<li><a href="#Ch09_Introduction_AboutFrameWork">9.1.4. Overview of framework</a></li>
<li><a href="#Ch09_Introduction_HowToProceed">9.1.5. How to proceed with the tutorial</a></li>
</ul>
</li>
<li><a href="#Ch09_TutorialApplication">9.2. Description of the application to be created</a>
<ul class="sectlevel3">
<li><a href="#Ch09_Application_Overview">9.2.1. Background</a></li>
<li><a href="#Ch09_Application_ProcessingOverview">9.2.2. Process overview</a></li>
<li><a href="#Ch09_Application_BusinessRequirements">9.2.3. Business specifications</a></li>
<li><a href="#Ch09_Application_ImplementationMethod">9.2.4. Learning contents</a></li>
</ul>
</li>
<li><a href="#Ch09_EnvironmentConstruction">9.3. Environment construction</a>
<ul class="sectlevel3">
<li><a href="#Ch09_EnvironmentConstruction_BlankProject">9.3.1. Creating a project</a></li>
<li><a href="#Ch09_EnvironmentConstruction_Import">9.3.2. Import project</a></li>
<li><a href="#Ch09_EnvironmentConstruction_BlankProjectConstruction">9.3.3. Build project</a></li>
<li><a href="#Ch09_EnvironmentConstruction_Setting">9.3.4. Verify / edit setup file</a></li>
<li><a href="#Ch09_EnvironmentConstruction_InputDataPreparation">9.3.5. Preparation of input data</a></li>
<li><a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">9.3.6. Preparation to refer database from STS</a></li>
<li><a href="#Ch09_EnvironmentConstruction_OperationCheck">9.3.7. Verify operations of project</a></li>
</ul>
</li>
<li><a href="#Ch09_JobCoding">9.4. Implementation of batch jobs</a></li>
<li><a href="#Ch09_Conclusion">9.5. Conclusion</a></li>
</ul>
</li>
<li><a href="#Ch99_SummaryOfPoints">10. Summary of points</a>
<ul class="sectlevel2">
<li><a href="#Ch99_SummaryOfPoints_AboutThis">10.1. Notes on TERASOLUNA Batch 5.x</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="Ch01"><a class="anchor" href="#Ch01"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch01_TermsOfUse"><a class="anchor" href="#Ch01_TermsOfUse"></a>1.1. Terms of Use</h3>
<div class="paragraph">
<p>In order to use this document, you are required to agree to abide by the following terms. If you do not agree with the terms, you must immediately delete or destroy this document and all its duplicate copies.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copyrights and all other rights of this document shall belong to NTT DATA or third party possessing such rights.</p>
</li>
<li>
<p>This document may be reproduced, translated or adapted, in whole or in part for personal use. However, deletion of the terms given on this page and copyright notice of NTT DATA is prohibited.</p>
</li>
<li>
<p>This document may be changed, in whole or in part for personal use. Creation of secondary work using this document is allowed. However, “Reference document: TERASOLUNA Batch Framework for Java (5.x) Development Guideline” or equivalent documents may be mentioned in created document and its duplicate copies.</p>
</li>
<li>
<p>Document and its duplicate copies created according to Clause 2 may be provided to third party only if these are free of cost.</p>
</li>
<li>
<p>Use of this document and its duplicate copies, and transfer of rights of this contract to a third party, in whole or in part, beyond the conditions specified in this contract, are prohibited without the written consent of NTT Data.</p>
</li>
<li>
<p>NTT DATA shall not bear any responsibility regarding correctness of contents of this document, warranty of fitness for usage purpose, assurance for accuracy and reliability of usage result, liability for defect warranty, and any damage incurred directly or indirectly.</p>
</li>
<li>
<p>NTT DATA does not guarantee the infringement of copyrights and any other rights of third party through this document. In addition to this, NTT DATA shall not bear any responsibility regarding any claim (Including the claims occurred due to dispute with third party) occurred directly or indirectly due to infringement of copyright and other rights.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Registered trademarks or trademarks of company name and service name, and product name of their respective companies used in this document are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TERASOLUNA is a registered trademark of NTT DATA Corporation.</p>
</li>
<li>
<p>All other company names and product names are the registered trademarks or trademarks of their respective companies.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="Ch01_Intro"><a class="anchor" href="#Ch01_Intro"></a>1.2. Introduction</h3>
<div class="sect3">
<h4 id="Ch01_Goal"><a class="anchor" href="#Ch01_Goal"></a>1.2.1. Goal of guideline</h4>
<div class="paragraph">
<p>This guideline provides best practices to develop high maintainability Batch applications
using full stack framework focusing on Spring Framework, Spring Batch and MyBatis.</p>
</div>
<div class="paragraph">
<p>This guideline helps to proceed with the software development (mainly coding) smoothly.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_TargetReaders"><a class="anchor" href="#Ch01_TargetReaders"></a>1.2.2. Target readers</h4>
<div class="paragraph">
<p>This guideline is written for architects and programmers having software development experience
and knowledge of the following.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic knowledge of DI and AOP of Spring Framework</p>
</li>
<li>
<p>Application development experience using Java</p>
</li>
<li>
<p>Knowledge of SQL</p>
</li>
<li>
<p>Have experiences on using Maven</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guideline is not for beginners.</p>
</div>
<div class="paragraph">
<p>In order to check whether one has enough basic knowledge to understand the document,
refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/Appendix/SpringComprehensionCheck.html">Spring Framework Comprehension Check</a>
If one is not able to answer 40% of the comprehension test, then it is recommended to study the following books separately.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.shoeisha.co.jp/book/detail/9784798142470">Spring徹底入門 (翔泳社) [日本語] </a></p>
</li>
<li>
<p><a href="http://gihyo.jp/book/2016/978-4-7741-8217-9">［改訂新版］Spring入門――Javaフレームワーク・より良い設計とアーキテクチャ [日本語]</a></p>
</li>
<li>
<p><a href="http://www.apress.com/9781430261513">Pro Spring 4th Edition (Apress)</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_Structure"><a class="anchor" href="#Ch01_Structure"></a>1.2.3. Structure of guideline</h4>
<div class="paragraph">
<p>The most important thing is that the guideline is considered as the subset of
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline</a>
(hereafter, referred to as TERASOLUNA Server 5.x Development Guideline).
By using TERASOLUNA Server 5.x Development Guideline, you can eliminate duplication in explanation and reduce the cost of learning as much as possible.
Since it indicates reference to TERASOLUNA Server 5.x Development Guideline everywhere, we would like you to proceed with the development by using both guides.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02">TERASOLUNA Batch Framework for Java (5.x)concept</a></dt>
<dd>
<p>Explains the basic concept of batch processing and the basic concept of TERASOLUNA Batch Framework for Java (5.x) and the overview of Spring Batch.</p>
</dd>
<dt class="hdlist1"><a href="#Ch03">Methodology of application development</a></dt>
<dd>
<p>Explains the knowledge and method to be kept in mind while developing an application using TERASOLUNA Batch Framework for Java (5.x).</p>
</dd>
<dt class="hdlist1"><a href="#Ch04">Running a Job</a></dt>
<dd>
<p>Explains how to running a job as Synchronous, Asynchronous and provide job parameters.</p>
</dd>
<dt class="hdlist1"><a href="#Ch05">Input/output of data</a></dt>
<dd>
<p>Explains how to provide Input/Output to various resources such as Database, File access etc.</p>
</dd>
<dt class="hdlist1"><a href="#Ch06">Handling for abnormal condition</a></dt>
<dd>
<p>Explains how to handle the abnormal conditions like Input checks, Exceptions.</p>
</dd>
<dt class="hdlist1"><a href="#Ch07_JobManagement">Job management</a></dt>
<dd>
<p>Explains how to manage the Job execution.</p>
</dd>
<dt class="hdlist1"><a href="#Ch08">Flow control and parallel/multiple processing</a></dt>
<dd>
<p>Explains the processing of parallel/multiple Job execution.</p>
</dd>
<dt class="hdlist1"><a href="#Ch09">Tutorial</a></dt>
<dd>
<p>Experience batch application development with TERASOLUNA Batch Framework for Java (5.x), through basic batch application development.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_HowToReadGuide"><a class="anchor" href="#Ch01_HowToReadGuide"></a>1.2.4. How to read guideline</h4>
<div class="paragraph">
<p>It is strongly recommended for all the developers to read the following contents for using TERASOLUNA Batch Framework for Java (5.x).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02">TERASOLUNA Batch Framework for Java (5.x) concept</a></p>
</li>
<li>
<p><a href="#Ch03">Methodology of application development</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following contents are usually required, so they should be read in advance.
It is better to select according to the development target.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04">Start of job</a></p>
</li>
<li>
<p><a href="#Ch05">Input/output of data</a></p>
</li>
<li>
<p><a href="#Ch06">Support for abnormal system</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement">Job management</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to the following contents for the first time when proceeding with the implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch08">Flow control and parallel/multiple processing</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Developers who want to experience actual application development by using TERASOLUNA Batch Framework for Java (5.x) are recommended to read following contents.
While experiencing TERASOLUNA Batch Framework for Java (5.x) for the first time, you should read these contents first and then move on to other contents.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch09">Tutorial</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch01_representation"><a class="anchor" href="#Ch01_representation"></a>1.2.4.1. Notations in guideline</h5>
<div class="paragraph">
<p>This section describe for the notations of this guideline.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">About Windows command prompt and Unix terminal</dt>
<dd>
<p>If command syntax in Windows and Unix are different, it describe both.
Otherwise, standardize the notations of Unix.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Prompt sign</dt>
<dd>
<p>Describe as <code>$</code> in Unix.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Prompt notation example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -version</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">About defining properties and constructor of Bean definition</dt>
<dd>
<p>In this guideline, it is described by using namespace of <code>p</code> and <code>c</code>.
The use of namespace helps in simplifying and clarifying the description of Bean definition.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Description wherein namespace is used</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For your reference, the description not using namespace is shown.</p>
</div>
<div class="listingblock">
<div class="title">Description not using namespace</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">names</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This guideline does not force the user to use namespace.
We would like to consider it for simplifying the explanation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch01_TestedEnviroments"><a class="anchor" href="#Ch01_TestedEnviroments"></a>1.2.5. Tested environments of guideline</h4>
<div class="paragraph">
<p>For tested environments of contents described in this guideline,
refer to " <a href="https://github.com/terasoluna-batch/v5-functionaltest/wiki/Tested-Environment">Tested Environment</a>".</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch01_ChangeLog"><a class="anchor" href="#Ch01_ChangeLog"></a>1.3. Change Log</h3>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Modified on</th>
<th class="tableblock halign-left valign-top">Modified locations</th>
<th class="tableblock halign-left valign-top">Modification details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-09-27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Released 5.0.1 RELEASE version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Errors in the guideline (typing errors, simple description errors etc.) modified<br>
・Design of the link on the index for header and footer modified (Management ID#196)<br>
・JDK8 dependent code changed to code prior to JDK7 considering it will be used by persons who do not know JDK8 (Management ID#231)</p>
<p class="tableblock">Description details added<br>
・Version information added to header and footer (Management ID#196)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch02_SpringBatchArch">Spring Batch Architecture</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details added<br>
・Explanation about character string stored in meta data table added (Management ID#233)<br></p>
<p class="tableblock">Description details deleted<br>
・Explanation about job parameter constraints deleted (Management ID#233)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch03_CreateProject">Create project</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Storage directory of Job Bean definition file of blank project changed (Management ID#161)<br>
・Command execution example and output example modified to show command prompt and Bash examples respectively (Management ID#161)<br>
・archetypeVersion specified while creating a project modified to 5.0.1.RELEASE (Management ID#315)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch03_CreateChunkJob">Create chunk model job</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Explanation of id attribute of Bean definition file modified to a simple expression (Management ID#250)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch03_CreateTaskletJob">Create tasklet model job</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Explanation of id attribute of Bean definition file modified to a simple expression (Management ID#250)</p>
<p class="tableblock">Description details added<br>
・Explanation of process units considered at the time of Tasklet implementation added (Management ID#202)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_AsyncJobWithDB_Overview">Asynchronous execution (DB polling)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Suffix of class name modified to Repository (Management ID#241)<br>
・Explanation for job request sequence modified to the details which are not dependent on specific RDBMS products (Management ID#233)</p>
<p class="tableblock">Description details added<br>
・Explanation for character string which is stored in job request table added (Management ID#233)<br>
・Explanation for job request acquisition SQL added (Management ID#233)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_JobParameter">Job start-up parameter</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Example for referencing parameters modified so as to enclose the character string literal with single quotes (Management ID#246)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener">Listener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・JobExecutionListener implementation example modified to present a simpler code example (Management ID#271)</p>
<p class="tableblock">Description details added<br>
・Link for exception handling in ChunkListener explanation added (Management ID#194)<br>
・In case of tasklet model, added precautions to the explanation where the listener is set (Management ID#194)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch05_Transaction">Transaction control</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Code example of intermediate commit method in tasklet model modified to the example which uses jobResourcelessTransactionManager (Management ID#262)</p>
<p class="tableblock">Description details added<br>
・Explanation of jobResourcelessTransactionManager added to intermediate commit method in tasklet model (Management ID#262)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch05_DBAccess">Database access</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details added<br>
・Example to update multiple tables by using CompositeItemWriter added (Management ID#226)<br>
・Notes while using Oracle JDBC in Linux environment added (Management ID#237)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch05_FileAccess">File access</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・FlatFileItemWriter and StaxEventItemWriter property explanation modified (Management ID#198)</p>
<p class="tableblock">Description details added<br>
・Explanation that unintended file deletion is done by combination of FlatFileItemWriter and StaxEventItemWriter property setting is added (Management ID#198)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch05_ExclusiveControl">Exclusive control</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Code example of pessimistic lock in chunk model modified (Management ID#204)<br>
・Code example of exclusive control of file modified so as to fetch file lock before opening file for exclusion (Management ID#225)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch07_JobManagement">Job management</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details deleted<br>
・Description related to Spring Batch Admin along with termination of Spring Batch Admin project deleted (Management ID#209)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch07_JobManagement_ExitCode">Customization of exit codes</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details added<br>
・Explanation for significance of exit codes added to Customization of exit codes  (Management ID#294)<br>
・Code example for changing exit codes of step in tasklet model added to Customization of exit codes (Management ID#294)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch07_JobManagement_MessageManagement">Message management</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description details modified<br>
・Bean definition of ResourceBundleMessageSource modified (Management ID#266)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch09">Tutorial</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New chapter added<br>
・Tutorial added (Management ID#200)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-03-17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Released <code>5.0.0 RELEASE</code> version</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch02"><a class="anchor" href="#Ch02"></a>2. TERASOLUNA Batch Framework for Java (5.x) concept</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch02_GeneralBatchProcess"><a class="anchor" href="#Ch02_GeneralBatchProcess"></a>2.1. Batch Processing in General</h3>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_AboutBatchProcess"><a class="anchor" href="#Ch02_GeneralBatchProcess_AboutBatchProcess"></a>2.1.1. Introduction to Batch Processing</h4>
<div class="paragraph">
<p>The term of "Batch Processing" refers to the execution or process of a series of jobs in a computer program without manual intervention (non-interactive).<br>
It is often a process of reading, processing and writing a large number of records from a database or a file.<br>
Batch processing consists of following features and is a processing method which prioritizes process throughput than the responsiveness, as compared to online processing.</p>
</div>
<div class="ulist">
<div class="title">Commons of batch processing</div>
<ul>
<li>
<p>Process large number of data is collected and processed.</p>
</li>
<li>
<p>Uninterruptible process for certainty of time is done in a fixed sequence.</p>
</li>
<li>
<p>Process runs in accordance with the schedule.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Objective of batch processing is given below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Enhanced throughput</dt>
<dd>
<p>Process throughput can be enhanced by processing the data sets collectively in a batch.<br>
File or database does not input or output data one by one, and instead sums up data of a fixed quantity thus dramatically reducing overheads of waiting for I/O resulting in the increased efficiency.
Even though waiting period for I/O of a single record is insignificant, cumulative accumulation while processing a large amount of data result in fatal delay.</p>
</dd>
<dt class="hdlist1">Ensuring responsiveness</dt>
<dd>
<p>Processes which are not required to be processed immediately are cut for batch processing in order to ensure responsiveness of online processing.<br>
For example, when the process results are not required immediately, the processing is done by online processing till its acceptance and batch processing is performed in the background.
The processing method is generally called "delayed processing".</p>
</dd>
<dt class="hdlist1">Response to time and events</dt>
<dd>
<p>Processes corresponding to specific period and events are naturally implemented by batch processing.<br>
For example, aggregating business data sets per month on the next 1st weekend,<br>
taking backup every Sunday at 2a.m in accordance with the system operation rules,<br>
and so on.</p>
</dd>
<dt class="hdlist1">Restriction for coordination with external system</dt>
<dd>
<p>Batch processing is also used due to restrictions of interface like files with interactions of external systems.<br>
File sent from the external system is a summary of data collected for a certain period.
Batch processing is better suited for the processes which incorporate these files, than the online processing.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is very common to combine various techniques to achieve batch processing. Major techniques are introduced here.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Job Scheduler</dt>
<dd>
<p>A single execution unit of a batch processing is called a job. A job scheduler is a middleware to manage this job.<br>
A batch system rarely has several jobs, and usually the number of jobs can reach hundreds or even thousands at times.
Hence, an exclusive system to define the relation with the job and manage execution schedule becomes indispensable.</p>
</dd>
<dt class="hdlist1">Shell script</dt>
<dd>
<p>One of the methods to implement a job. A process is achieved by combining the commands implemented in OS and middleware.<br>
Although the method can be implemented easily, it is not suitable for writing complex business logic. Hence, it is primarily used in simple processes like copying a file, backup, clearing a table etc.
Further, shell script performs only the pre-start settings and post-execution processing while executing a process implemented in another programming language.</p>
</dd>
<dt class="hdlist1">Programming language</dt>
<dd>
<p>One of the methods to implement a job. Structured code can be written rather than the shell script and is advantageous for securing development productivity, maintainability and quality.
Hence, it is commonly used to implement business logic that processes data of file or database which tend to be relatively complex with logic.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_Scenario"><a class="anchor" href="#Ch02_GeneralBatchProcess_Scenario"></a>2.1.2. Requirements for batch processing</h4>
<div class="paragraph">
<p>Requirements for batch processing in order to implement business process is as given below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performance improvement</p>
<div class="ulist">
<ul>
<li>
<p>A certain quantity of data can be processed in a batch.</p>
</li>
<li>
<p>Jobs can be executed in parallel/in multiple.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Recovery in case of an abnormality</p>
<div class="ulist">
<ul>
<li>
<p>Jobs can be reexecuted (manual/schedule).</p>
</li>
<li>
<p>At the time of reprocessing, it is possible to process only unprocessed records by skipping processed records.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Various activation methods for running jobs</p>
<div class="ulist">
<ul>
<li>
<p>Synchronous execution possible.</p>
</li>
<li>
<p>Asynchronous execution possible.</p>
<div class="ulist">
<ul>
<li>
<p>DB polling, HTTP requests can be used as opportunities for execution.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Various input and output interfaces</p>
<div class="ulist">
<ul>
<li>
<p>Database</p>
</li>
<li>
<p>File</p>
<div class="ulist">
<ul>
<li>
<p>Variable length like CSV or TSV</p>
</li>
<li>
<p>Fixed length</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specific details for the above requirements are given below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">A large amount of data can be efficiently processed using certain resources (Performance improvement)</dt>
<dd>
<p>Processing time is reduced by processing the data collectively. Important part here is <strong>"Certain resources"</strong> part.<br>
Processing can be done by using a CPU and memory for 100 or even 1 million records and the processing time is ideally extended slowly and linearly according to number of records.
Transaction is started and terminated for certain number of records to perform a process collectively. Resources to be  used must be levelled in order to perform I/O collectively.<br>
Still, when a large amount of data is to be handled which is yet to be processed, a system wherein hardware resources are used till the limit going a step further.
Data to be processed is divided into records or groups and multiple processing is done by using multiple processes and multiple threads.
Moving ahead, distributed processing using multiple machines is also implemented.
When resources are used upto the limit, it becomes extremely important to reduce as much as possible.</p>
</dd>
<dt class="hdlist1">Continue the processing as much as possible (Recovery at the time of occurrence of abnormality)</dt>
<dd>
<p>When a large amount of data is to be processed, the countermeasures when an abnormality occurs in input data or system itself must be considered.<br>
A large amount of data takes a long time to finish processing, however if the time till recovery after occurrence of error is prolonged, it is likely to affect the system a great deal.<br>
For example, consider a data consisting of 1 billion records to be processed. Operation schedule would be obviously affected a great deal if error is detected in 999 millionth record and the processing so far is to be performed all over again.<br>
To control this impact, process continuity unique to batch processing becomes very important Hence a system wherein error data skipped and next data record is processed, a system to restart the process and a system which attempts
auto-recovery become necessary. Further, it is important to simplify a job as much as possible and enable its easy execution later.</p>
</dd>
<dt class="hdlist1">Can be executed flexibly according to triggers of execution (various activation methods)</dt>
<dd>
<p>A system to respond to various execution triggers is necessary when triggered by time, or by connecting online or connecting with external system.
various systems are widely known such as synchronous processing wherein processing starts when job scheduler reaches
scheduled time, asynchronous processing wherein the process is kept resident and batch processing
is performed as per the events.</p>
</dd>
<dt class="hdlist1">Handles various input and output interfaces (Various input output interfaces)</dt>
<dd>
<p>It is important to handle various files like CSV/XML as well as databases for linking online and external systems.
Further, if a method which transparently handles respective input and output method exists, implementation becomes easier and to deal with various formats becomes more quickly.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_GeneralBatchProcess_Considerations"><a class="anchor" href="#Ch02_GeneralBatchProcess_Considerations"></a>2.1.3. Rules and precautions to be considered in batch processing</h4>
<div class="paragraph">
<p>Important rules while building a batch processing system and a few considerations are shown.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simplify unit batch processing as much as possible and avoid complex logical structures.</p>
</li>
<li>
<p>Keep process and data in physical proximity (Save data at the location where process is executed).</p>
</li>
<li>
<p>Minimise the use of system resources (especially I/O) and execute operations in in-memory as much as possible.</p>
</li>
<li>
<p>Further, review I/O of application (SQL etc) to avoid unnecessary physical I/O.</p>
</li>
<li>
<p>Do not repeat the same process for multiple jobs.</p>
<div class="ulist">
<ul>
<li>
<p>For example, in case of counting and reporting process, avoid repetition of counting process during reporting process.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Always assume the worst situation related to data consistency. Verify data to check and to maintain consistency.</p>
</li>
<li>
<p>Review backups carefully. Difficulty level of backup will be high especially when system is operational seven days a week.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_TerasolunaBatchStack"><a class="anchor" href="#Ch02_TerasolunaBatchStack"></a>2.2. TERASOLUNA Batch Framework for Java (5.x) stack</h3>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchStack_Overview"><a class="anchor" href="#Ch02_TerasolunaBatchStack_Overview"></a>2.2.1. Overview</h4>
<div class="paragraph">
<p>TERASOLUNA Batch Framework for Java (5.x)configuration is explained and TERASOLUNA Batch Framework for Java (5.x) scope of responsibility.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchStack_Stack"><a class="anchor" href="#Ch02_TerasolunaBatchStack_Stack"></a>2.2.2. TERASOLUNA Batch Framework for Java (5.x) stack</h4>
<div class="paragraph">
<p>Software Framework used in TERASOLUNA Batch Framework for Java (5.x) is a combination of OSS
focusing on <a href="http://projects.spring.io/spring-framework/">Spring Framework</a> (<a href="http://projects.spring.io/spring-batch/">Spring Batch</a>)
A stack schematic diagram of TERASOLUNA Batch Framework for Java (5.x) is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchStack_Stack.png" alt="TERASOLUNA Batch Framework for Java (5.x) Stack">
</div>
<div class="title">TERASOLUNA Batch Framework for Java (5.x) stack - schematic diagram</div>
</div>
<div class="paragraph">
<p>Descriptions for products like job scheduler and database are excluded from this guideline.</p>
</div>
<div class="sect4">
<h5 id="oss-version-to-be-used"><a class="anchor" href="#oss-version-to-be-used"></a>2.2.2.1. OSS version to be used</h5>
<div class="paragraph">
<p>List of OSS versions to be used in 5.0.1.RELEASE of TERASOLUNA Batch Framework for Java (5.x) is given below.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>OSS version to be used in TERASOLUNA Batch Framework for Java (5.x) as a rule conforms to definition of Spring IO platform.
Note that, version of Spring IO platform in 5.0.1.RELEASE is
<a href="http://docs.spring.io/platform/docs/Athens-SR2/reference/htmlsingle/">Athens-SR2</a>.+
For details of Spring IO platform, refer
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/Overview/FrameworkStack.html#oss">OSS version to be used</a> of  TERASOLUNA Server Framework for Java (5.x).</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">OSS version list</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 15%;">
<col style="width: 5%;">
<col style="width: 5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">GroupId</th>
<th class="tableblock halign-left valign-top">ArtifactId</th>
<th class="tableblock halign-left valign-top">Version</th>
<th class="tableblock halign-left valign-top">Spring IO platform</th>
<th class="tableblock halign-left valign-top">Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-aop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-beans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-tx</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-jdbc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.3.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-batch-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.7.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-batch-infrastructure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.7.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">spring-retry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.5.RELEASE</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.batch-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Batch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.ibm.jbatch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.ibm.jbatch-tck-spi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.4.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis-spring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.3.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.mybatis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mybatis-typehandlers-jsr310</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.inject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.inject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log output</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ch.qos.logback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logback-classic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log output</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ch.qos.logback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logback-core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.8</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log output</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jcl-over-slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.22</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log output</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.slf4j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">slf4j-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.7.22</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.validation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validation-api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.0.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate-validator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.2.4.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.0.Final</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.fasterxml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classmate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.3.3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.commons</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">commons-dbcp2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.1.1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.commons</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">commons-pool2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression Language</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.glassfish</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.el</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">In-memory database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.h2database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">h2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4.193</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.thoughtworks.xstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.4.9</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xmlpull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xmlpull</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.3.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xpp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xpp3_min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.4c</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xpp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xpp3_min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.1.4c</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.codehaus.jettison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jettison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">*1</p></td>
</tr>
</tbody>
</table>
<div class="exampleblock">
<div class="title">Remarks</div>
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Libraries which individually depend on libraries supported by Spring IO platform</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchStack_Components"><a class="anchor" href="#Ch02_TerasolunaBatchStack_Components"></a>2.2.3. Structural elements of TERASOLUNA Batch Framework for Java (5.x)</h4>
<div class="paragraph">
<p>Software Framework structural elements of TERASOLUNA Batch Framework for Java (5.x) are explained.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchStack_Stack_Detail.png" alt="TERASOLUNA Batch Framework for Java (5.x) Components of Software Framework">
</div>
<div class="title">Schematic diagram of Software Framework structural elements</div>
</div>
<div class="paragraph">
<p>Overview of each element is shown below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Foundation framework</dt>
<dd>
<p>Spring Framework is used as a framework foundation. Various functions are applied starting with DI container.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.5.RELEASE/spring-framework-reference/htmlsingle/#spring-core">Spring Framework 4.3</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Batch framework</dt>
<dd>
<p>Spring Batch is used as a batch framework.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring-batch/trunk/reference/html/index.html">Spring Batch 3.0</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Asynchronous execution</dt>
<dd>
<p>Following functions are used as a method to execute asynchronous execution.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Periodic activation by using DB polling</dt>
<dd>
<p>A library offered by TERASOLUNA Batch Framework for Java (5.x) is used.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Web container activation</dt>
<dd>
<p>Link with Spring Batch using Spring MVC.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.5.RELEASE/spring-framework-reference/html/mvc.html">Spring MVC 4.3</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">O/R Mapper</dt>
<dd>
<p>Use MyBatis, and use MyBatis-Spring as a library to coordinate with Spring Framework.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.mybatis.org/mybatis-3/">MyBatis 3.4</a></p>
</li>
<li>
<p><a href="http://www.mybatis.org/spring/">MyBatis-Spring</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">File access</dt>
<dd>
<p>In addition to <a href="http://docs.spring.io/spring-batch/trunk/reference/html/readersAndWriters.html#flatFiles">Function offered from Spring Batch</a>,
TERASOLUNA Batch Framework for Java (5.x) is used as an auxiiliary function.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess">"File access"</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Logging</dt>
<dd>
<p>Logger uses SLF4J in API and Logback in the implementation.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.slf4j.org/">SLF4J</a></p>
</li>
<li>
<p><a href="https://logback.qos.ch/">Logback</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Validation</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">Unit item check</dt>
<dd>
<p>Bean Validation is used in unit item check and Hibernate Validator is used for implementation.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://download.oracle.com/otn-pub/jcp/bean_validation-1_1-fr-eval-spec/bean-validation-specification.pdf">Bean Validation 1.1</a></p>
</li>
<li>
<p><a href="http://docs.jboss.org/hibernate/validator/5.2/reference/en-US/html/">Hibernate Validator 5.2</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Correlation check</dt>
<dd>
<p>Bean Validation or Spring Validation is used for correlation check.</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.spring.io/spring/docs/4.3.5.RELEASE/spring-framework-reference/html/validation.html#validator">Spring Validation</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Connection pool</dt>
<dd>
<p>DBCP is used in the connection pool.</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://commons.apache.org/proper/commons-dbcp/">DBCP 2</a></p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-pool/">Commons Pool 2</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect4">
<h5 id="a-function-wherein-terasoluna-batch-framework-for-java-5-x-provides-implementation"><a class="anchor" href="#a-function-wherein-terasoluna-batch-framework-for-java-5-x-provides-implementation"></a>A function wherein TERASOLUNA Batch Framework for Java (5.x) provides implementation</h5>
<div class="paragraph">
<p>A function wherein TERASOLUNA Batch Framework for Java (5.x) provides implementation is given below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">A function list wherein TERASOLUNA Batch Framework for Java (5.x) offers implementation</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Function name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asynchronous execution using DB polling is implemented.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock"><a href="#Ch05_FileAccess">"File access"</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read fixed-length file without line breaks by number of bytes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Break down a fixed length record in individual field by number of bytes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control output of enclosed characters by variable length records.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_SpringBatchArch"><a class="anchor" href="#Ch02_SpringBatchArch"></a>2.3. Spring Batch Architecture</h3>
<div class="sect3">
<h4 id="Ch02_SpringBatchArch_Overview"><a class="anchor" href="#Ch02_SpringBatchArch_Overview"></a>2.3.1. Overview</h4>
<div class="paragraph">
<p>Spring Batch architecture acting as a base for TERASOLUNA Server Framework for Java (5.x) is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_SpringBatch"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_SpringBatch"></a>2.3.1.1. What is Spring Batch</h5>
<div class="paragraph">
<p>Spring Batch, as the name implies is a batch application framework.
Following functions are offered based on DI container of Spring, AOP and transaction control function.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Functions to standardize process flow</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">Tasket model</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">Simple process</dt>
<dd>
<p>It is a method to freely describe a process. It is used in a simple cases like issuing SQL once, issuing a command etc  and the complex cases like performing processing while accessing multiple database or files, which are difficult to standardize.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Chunk model</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1">Efficient processing of large amount of data</dt>
<dd>
<p>A method to collectively input/process/output a fixed amount of data. Process flow of data input/processing and
output is standardized and job can be implemented by implementing only a part of it.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Various activation methods</dt>
<dd>
<p>Execution is achieved by various triggers like command line execution, execution on Servlet and other triggers.</p>
</dd>
<dt class="hdlist1">I/O of various data formats</dt>
<dd>
<p>Input and output for various data resources like file, database, message queue etc can be performed easily.</p>
</dd>
<dt class="hdlist1">Efficient processing</dt>
<dd>
<p>Multiple execution, parallel execution, conditional branching are done based on the settings.</p>
</dd>
<dt class="hdlist1">Job execution control</dt>
<dd>
<p>Permanence of execution, restart operation using data records as a standard can be performed.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_HelloWorld"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_HelloWorld"></a>2.3.1.2. Hello, Spring Batch！</h5>
<div class="paragraph">
<p>If Spring Batch is not covered in understanding of Spring Batch architecture so far,
the official documentation given below should be read.
We would like you to get used to Spring Batch through creating simple application.</p>
</div>
<div class="paragraph">
<p><a href="https://spring.io/guides/gs/batch-processing/">Creating a Batch Service</a></p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Overview_BasicStructure"><a class="anchor" href="#Ch02_SpringBatchArch_Overview_BasicStructure"></a>2.3.1.3. Basic structure of Spring Batch</h5>
<div class="paragraph">
<p>Basic structure of Spring Batch is explained.</p>
</div>
<div class="paragraph">
<p>Spring Batch defines structure of batch process. It is recommended to perform development after understanding the structure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Overview_MainComponents.png" alt="Spring Batch Main Components">
</div>
<div class="title">Primary components appearing in Spring Batch</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Primary components appearing in Spring Batch</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Components</th>
<th class="tableblock halign-left valign-top">Roles</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single execution unit that summarises a series of processes for batch application in Spring Batch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unit of processing which constitutes Job. 1 job can contain 1~N steps<br>
Reusing a process, parallelization, conditional branching can be performed by dividing 1 job process in multiple steps.
Step is implemented by either chunk model or tasket model(will be described later).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobLauncher</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An interface for running a Job.<br>
JobLauncher can be directly used by the user, however, a batch process can be started simply<br>
by starting <code>CommandLineJobRunner</code> from java command.
<code>CommandLineJobRunner</code> undertakes various processes for starting JobLauncher.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">ItemReader<br>
ItemProcessor<br>
ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An interface for dividing into three processes - input/processing/output of data while implementing chunk model.<br>
Batch application consists of processing of these 3 patterns and in Spring Batch, implementation of these interfaces
is utilized primarily in chunk model.<br>
User describes business logic by dividing it according to respective roles.<br>
Since ItemReader and ItemWriter responsible for data input and output are often the processes that perform conversion of database and files to Java objects and vice versa, a standard implementation is provided by Spring Batch.
In general batch applications which perform input and output of data from file and database, conditions
can be satisfied just by using standard implementation of Spring Batch as it is.<br>
ItemProcessor which is responsible for processing data implements input check and business logic.</p>
<p class="tableblock">In Tasket model, ItemReader/ItemProcessor/ItemWriter substitutes a single Tasklet interface implementation. Input-Output, Input check and business logic all must be implemented in Tasklet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobRepository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A system to manage condition of Job and Step. The management information is persisted on the database based on the table schema specified by Spring Batch.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_SpringBatchArch_Detail"><a class="anchor" href="#Ch02_SpringBatchArch_Detail"></a>2.3.2. Architecture</h4>
<div class="paragraph">
<p>Basic structure of Spring Batch is briefly explained in <a href="#Ch02_SpringBatchArch_Overview">Overview</a>.</p>
</div>
<div class="paragraph">
<p>Following points are explained on this basis.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_SpringBatchArch_Detail_ProcessFlow">Overall process flow</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Detail_ExecutionOfJob">Running a Job</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Detail_BusinessLogic">Execution of business logic</a></p>
</li>
<li>
<p><a href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata">Metadata schema of JobRepository</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the end, performance tuning points of batch application which use Spring Batch are explained.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_SpringBatchArch_Detail_Performance">Typical performance tuning points</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Detail_ProcessFlow"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_ProcessFlow"></a>2.3.2.1. Overall process flow</h5>
<div class="paragraph">
<p>Primary components of Spring Batch and overall process flow is explained.
Further, explanation is also given about how to manage meta data of execution status of jobs.</p>
</div>
<div class="paragraph">
<p>Primary components of Spring Batch and overall process flow (chunk model) are shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_ProcessFlow.png" alt="Spring Batch Process Flow">
</div>
<div class="title">Primary components of Spring Batch and overall process flow</div>
</div>
<div class="paragraph">
<p>Main processing flow (black line) and the flow which persists job information (red line) are explained.</p>
</div>
<div class="olist arabic">
<div class="title">Main processing flow</div>
<ol class="arabic">
<li>
<p>JobLauncher is initiated from the job scheduler.</p>
</li>
<li>
<p>Job is executed from JobLauncher.</p>
</li>
<li>
<p>Step is executed from Job.</p>
</li>
<li>
<p>Step fetches input data by using ItemReader.</p>
</li>
<li>
<p>Step processes input data by using ItemProcessor.</p>
</li>
<li>
<p>Step outputs processed data by using ItemWriter.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">A flow for persisting job information</div>
<ol class="arabic">
<li>
<p>JobLauncher registers JobInstance in Database through JobRepository.</p>
</li>
<li>
<p>JobLauncher registers that Job execution has started in Database through JobRepository.</p>
</li>
<li>
<p>JobStep updates miscellaneous information like counts of I/O records and status in Database through JobRepository.</p>
</li>
<li>
<p>JobLauncher registers that Job execution has completed in Database through JobRepository.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Components and JobRepository focusing on persistence are explained freshly again.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Components related to persistence</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Components</th>
<th class="tableblock halign-left valign-top">Roles</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobInstance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Batch indicates "logical" execution of a Job. JobInstance is identified by Job name and arguments.
In other words, execution with identical Job name and argument is identified as execution of identical JobInstance and Job is executed as a continuation from previous activation.<br>
When the target Job supports re-execution and the process was suspended in between due to error in the previous execution, the job is executed from the middle of the process.
On the other hand, when the target job does not support re-execution or when the target JobInstance has already been successfully processed, exception is thrown and Java process is terminated abnormally.
For example, JobInstanceAlreadyCompleteException is thrown when the process has already been completed successfully.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobExecution<br>
ExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecution indicates "physical" execution of Job. Unlike JobInstance, it is termed as another JobExecution even while re-executing identical Job. As a result, JobInstance and JobExecution shows one-to-many relationship.<br>
ExecutionContext is considered as an area for sharing metadata such as progress of a process in identical JobExecution.
ExecutionContext is primarily used for enabling Spring Batch to record framework status, however, means to access ExecutionContext by the application is also provided.<br>
The object stored in the JobExecutionContext must be a class which implements <code>java.io.Serializable</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StepExecution<br>
ExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecution indicates "physical" execution of Step. JobExecution and StepExecution shows one-to-many relationship.<br>
Similar to JobExecution, ExecutionContext is an area for sharing data in Step. From the viewpoint of localization of data, information which is not required to be shared by multiple steps should use ExecutionContext of target step
instead of using ExecutionContext of Job.<br>
The object stored in StepExecutionContext must be a class which implements <code>java.io.Serializable</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JobRepository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A function to manage and persist data for managing execution results and status of batch application like JobExecution or StepExecution is provided.<br>
In general batch applications, the process is started by starting a Java process and Java process is also terminated along with termination of process.
Hence, since the data is likely to be referred across Java process, it is stored in volatile memory as well as permanent layers like database.
When data is to be stored in the database, database objects like table or sequence are required for storing JobExecution or StepExecution.<br>
It is necessary to generate a database object based on schema information provided by Spring Batch.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring Batch heavily manages metadata in order to perform re-execution.
A snapshot at the time of earlier execution must be retained and metadata and JobRepository should be used as a base in order to re-execute a batch process.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Detail_ExecutionOfJob"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_ExecutionOfJob"></a>2.3.2.2. Running a Job</h5>
<div class="paragraph">
<p>How to run a Job is explained.</p>
</div>
<div class="paragraph">
<p>A scenario is considered wherein a batch process is started immediately after starting Java process and Java process is terminated after completing a batch process.
Figure below shows a process flow from starting a Java process till starting a batch process.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_LaunchFlow.png" alt="Job Launch Flow">
</div>
<div class="title">Process flow from starting a Java process till starting a batch process</div>
</div>
<div class="paragraph">
<div class="title">Starting a Java process and starting a Job</div>
<p>A shell script to start Java is generally described to start a Job defined on Spring Batch, along with starting a Java process.
When CommandLineJobRunner offered by Spring Batch is used, Job on Spring Batch defined by the user can be easily started.</p>
</div>
<div class="paragraph">
<p>Start command of the Job which use CommandLineJobRunner is as shown below.</p>
</div>
<div class="listingblock">
<div class="title">Start command when a Bean is defined by using XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -cp ${CLASSPATH} org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; &lt;JobArgumentName1&gt;=&lt;value1&gt; &lt;JobArgumentName2&gt;=&lt;value2&gt; ...</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Specifying a Job parameter</div>
<p>CommandLineJobRunner can pass arguments (job parameters) as well along with Job name to be started.
Arguments are specified in <code>&lt;Job argument name&gt;=&lt;Value&gt;</code> format as per the example described earlier.
All the arguments are stored in JobExecution after conversion to JobParameters after interpreting and checking by CommandLineJobRunner or JobLauncher.
For details, refer to <a href="#Ch04_JobParameter">running parameter of Job</a>.</p>
</div>
<div class="paragraph">
<div class="title">Register and restore JobInstance</div>
<p>JobLauncher fetches Job name from JobRepository and JobInstance matching with the argument from the database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When corresponding JobInstance does not exist, JobInstance is registered as new.</p>
</li>
<li>
<p>When corresponding JobInstance exists, the associated JobExecution is restored.<br></p>
<div class="ulist">
<ul>
<li>
<p>In Spring Batch, for the jobs that can be executed repeatedly like daily execution etc, a method to add arguments only for making the JobInstance unique is listed.
For example, adding system date or random number to arguments are listed.<br>
For the method recommended in this guideline, refer <a href="#Ch04_JobParameter_HowToUse_Converter">parameter conversion class</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Detail_BusinessLogic"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_BusinessLogic"></a>2.3.2.3. Execution of business logic</h5>
<div class="paragraph">
<p>Job is divided into smaller units called steps in Spring Batch.
When Job is started, Job activates already registered steps and generates StepExecution.
Step is a framework for dividing the process till the end and execution of business logic is delegated to Tasket called from Step.</p>
</div>
<div class="paragraph">
<p>Flow from Step to Tasklet is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch02/SpringBatchArchitecture/Ch02_SpringBatchArchitecture_Architecture_StepTaskletFlow.png" alt="Step-Tasklet Flow">
</div>
<div class="title">Process flow from Step to Tasklet</div>
</div>
<div class="paragraph">
<p>A couple of methods can be listed as the implementation methods of Tasklet - "Chunk model" and "Tasket model".
Since the overview has already been explained, the structure will be now explained here.</p>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Detail_BusinessLogic_Chunk"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Chunk"></a>2.3.2.3.1. Chunk model</h6>
<div class="paragraph">
<p>As described above, chunk model is a method wherein the processing is performed in a certain number of units (chunks) rather than processing the data to be processed one by one unit.
ChunkOrientedTasklet acts as a concrete class of Tasklet which supports the chunk processing.
Maximum records of data to be included in the chunk (hereafter referred as "chunk size") can be adjusted by using setup value called commit-interval of this class.
ItemReader, ItemProcessor and ItemWriter are all the interfaces based on chunk processing.</p>
</div>
<div class="paragraph">
<p>Next, explanation is given about how ChunkOrientedTasklet calls the ItemReader, ItemProcessor and ItemWriter.</p>
</div>
<div class="paragraph">
<p>A sequence diagram wherein ChunkOrientedTasklet processes one chunk is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Architecture_Sequence_ChunkOrientedTasklet.png" alt="Sequence of Chunk processing with ChunkOrientedTasklet">
</div>
<div class="title">Chunk processing by using ChunkOrientedTasklet</div>
</div>
<div class="paragraph">
<p>ChunkOrientedTasklet repeatedly executes ItemReader and ItemProcessor by the chunk size, in other words, reading and processing of data.
After completing reading all the data of chunks, data writing process of ItemWriter is called only once and all the processed data in the chunks is passed.
Data update processing is designed to be called once for chunks to enable easy organising like addBatch and executeBatch of JDBC.</p>
</div>
<div class="paragraph">
<p>Next, ItemReader, ItemProcessor and ItemWriter which are responsible for actual processing in chunk processing are introduced.
Although it is assumed that the user handles his own implementation for each interface, it can also be covered by a generic concrete class provided by Spring Batch.</p>
</div>
<div class="paragraph">
<p>Especially, since ItemProcessor describes the business logic itself, the concrete classes are hardly provided by Spring Batch.
ItemProcessor interface is implemented while describing the business logic.
ItemProcessor is designed to allow types of objects used in I/O to be specified in respective generics so that typesafe programming is enabled.</p>
</div>
<div class="paragraph">
<p>An implementation example of a simple ItemProcessor is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MyItemProcessor</span> <span class="directive">implements</span>
      ItemProcessor&lt;MyInputObject, MyOutputObject&gt; {  <span class="comment">// (1)</span>
  <span class="annotation">@Override</span>
    <span class="directive">public</span> MyOutputObject process(MyInputObject item) <span class="directive">throws</span> <span class="exception">Exception</span> {  <span class="comment">// (2)</span>

        MyOutputObject processedObject = <span class="keyword">new</span> MyOutputObject();  <span class="comment">// (3)</span>

        <span class="comment">// Coding business logic for item of input data</span>

    <span class="keyword">return</span> processedObject; <span class="comment">// (4)</span>
  }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement ItemProcessor interface which specifies the types of objects used for input and output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>process</code> method. Argument item is input data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create output object and store business logic results processed for the input data item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return output object.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Various concrete classes are offered by Spring Batch for ItemReader or ItemWriter and these are used quite frequently.
However, when a file of specific format is to be input or output, a concrete class which implements individual ItemReader or ItemWriter can be created and used.</p>
</div>
<div class="paragraph">
<p>For implementation of business logic while developing actual application, refer <a href="Ch03_index.html#Ch03">application development flow</a>.</p>
</div>
<div class="paragraph">
<p>Representative concrete classes of ItemReader, ItemProcessor and ItemWriter offered by Spring Batch are shown in the end.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Representative concrete classes of ItemReader, ItemProcessor and ItemReader offered by Spring Batch</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Interface</th>
<th class="tableblock halign-left valign-top">Concrete class name</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="5"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read flat files (non-structural files) like CSV file. Mapping rules for delimiters and objects can be customised by using Resource object as input.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StaxEventItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read XML file. As the name implies, it is an implementation which reads a XML file based on StAX.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JdbcPagingItemReader<br>
JdbcCursorItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute SQL by using JDBC and read records on the database. When a large amount of data is to be processed on the database, it is necessary to avoid reading all the records on memory, and to read and discard only the data necessary for one processing.<br>
JdbcPagingItemReader is implemented by dividing SELECT SQL for each page by using JdbcTemplate and then issuing the same. On the other hand, JdbcCursorItemReader is implemented by issuing one SELECT SQL by using JDBC cursor.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Using MyBatis is considered as a base in TERASOLUNA Batch 5.x.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MyBatisCursorItemReader<br>
MyBatisPagingItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read records on the database in coordination with MyBatis. Spring coordination library offered by MyBatis is provided by MyBatis-Spring. For the difference between Paging and Cursor, it is same as JdbcXXXItemReader except for using MyBatis for implementation.+
In addition, JpaPagingItemReader, HibernatePagingItemReader and HibernateCursor are provided which reads records on the database by coordinating with ItemReaderJPA implementation or Hibernate.</p>
<p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> Using <code>MyBatisCursorItemReader</code> is considered as a base in TERASOLUNA Batch 5.x.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JmsItemReader<br>
AmqpItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive messages from JMS or AMQP and read the data contained in the same.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="3"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PassThroughItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No operation is performed. It is used when processing and modification of input data is not required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">ValidatingItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Performs input check. It is necessary to implement Spring Batch specific org.springframework.batch.item.validator.Validator for the implementation of input check rules, however,<br>
SpringValidator which is an adaptor of a generalorg.springframework.validation.Validator offered by Spring is provided
and rules of org.springframework.validation.Validator can be used.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Use of ValidatingItemProcessor is prohibited in TERASOLUNA Batch 5.x.<br>
For details, refer <a href="#Ch06_InputValidation">Input check</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">CompositeItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequentially execute multiple ItemProcessor for identical input data. It is enabled when business logic is to be executed after performing input check using ValidatingItemProcessor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" rowspan="5"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FlatFileItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write processed Java object as a flat file like CSV file. Mapping rules for file lines can be customised from delimiters and objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">StaxEventItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write processed Java object as a XML file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JdbcBatchItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute SQL by using JDBC and output processed Java object to database. Internally JdbcTemplate is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MyBatisBatchItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Coordinate with MyBatis and output processed Java object to the database. It is provided by Spring coordination library MyBatis-Spring offered by MyBatis.<br>
<span class="icon"><i class="fa fa-warning"></i></span> JPA implementation or JpaItemWriter and HibernateItemWriter for Hibernate is not used in TERASOLUNA Batch 5.x.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">JmsItemWriter<br>
AmqpItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a message of a processed Java object with JMS or AMQP.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">PassThroughItemProcessor omitted</div>
<div class="paragraph">
<p>When a job is defined in XML, ItemProcessor setting can be omitted.
When it is omitted, input data is passed to ItemWriter without performing any operation similar to PassThroughItemProcessor.</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessor omitted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Detail_BusinessLogic_Tasklet"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Tasklet"></a>2.3.2.3.2. Tasket model</h6>
<div class="paragraph">
<p>Chunk model is a framework suitable for batch applications that read multiple input data one by one and perform a series of processing.
However, a process which does not fit with the type of chunk processing is also implemented.
For example, when system command is to be executed and when only one record of table for control is to be updated.</p>
</div>
<div class="paragraph">
<p>In such a case, merits of efficiency obtained by chunk processing are very less
and demerits owing to difficult design and implementation are significant. Hence, it is rational to use tasket model.</p>
</div>
<div class="paragraph">
<p>It is necessary for the user to implement Tasket interface provided by Spring Batch while using a Tasket model.
Further, following concrete class is provided in Spring Batch, subsequent description is not given in TERASOLUNA Batch 5.x.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Concrete class of Tasket offered by Spring Batch</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Class name</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">SystemCommandTasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasket to execute system commands asynchronously. Command to be specified in the command property is specified.<br>
Since the system command is executed by a thread different from the thread for calling, it is possible to set a timeout and cancel the execution thread of the system command during the process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">MethodInvokingTaskletAdapter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasket for executing specific methods of POJO class. Specify Bean of target class in targetObject property and name of the method to be executed in targetMethod property.<br>
POJO class can return batch process termination status as a return value of the method, however then the ExitStatus described later must be set as a return value.
When a value of another type is returned, the status is considered as "normal termination (ExistStatus: COMPLETED) regardless of the return value.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Detail_JobRepository_Metadata"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata"></a>2.3.2.4. Metadata schema of JobRepository</h5>
<div class="paragraph">
<p>Metadata schema of JobRepository is explained.</p>
</div>
<div class="paragraph">
<p>Note that, overall picture is explained including the contents explained in Spring Batch reference
<a href="http://docs.spring.io/spring-batch/trunk/reference/html/metaDataSchema.html">Appendix B. Meta-Data Schema</a></p>
</div>
<div class="paragraph">
<p>Spring Batch metadata table corresponds to a domain object (Entity object) which are represented by Java.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Correspondence list</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 40%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_INSTANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobInstance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains the string which serialises job name and job parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains job status and execution results.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION_PARAMS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionParams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains job parameters assigned at the startup.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_JOB_EXECUTION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains the context inside the job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains status and execution results of step, number of commits and rollbacks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BATCH_STEP_EXECUTION_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StepExecutionContext</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retains context inside the step.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>JobRepository is responsible for accurately storing the contents stored in each Java object, in the table.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Regarding the character string stored in the meta data table</div>
<div class="paragraph">
<p>Character string stored in the meta data table allows only a restricted number of characters and when this limit is exceeded, character string is truncated.<br>
Note that, multibyte characters are not taken into consideration in Spring Batch and an error is likely to occur in DDL of meta data table offered by Spring Batch even if character string to be stored is within the character limit.
It is necessary to extend the size by encoding using a column of meta data table, and to set the character data type in character count definition, in order to store multibyte characters.</p>
</div>
<div class="paragraph">
<p><code>Oracle Schema</code> provided by Spring Batch offers a DDL for Oracle in TERASOLUNA Batch 5.x that explicitly sets character data type in character count definition
since character data type of database is defined by default number of bytes.<br>
DDL to be offered is included in the org.terasoluna.batch package which is included in jar of TERASOLUNA Batch 5.x.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>6 ERD models of all the tables and interrelations are shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_SpringBatchArchitecture_Architecture_ER.png" alt="ER Diagram">
</div>
<div class="title">ER diagram</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Detail_JobRepository_Metadata_Version"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_Version"></a>2.3.2.4.1. Version</h6>
<div class="paragraph">
<p>Majority of database tables contain version columns.
This column is important since Spring Batch adopts an optimistic locking strategy to handle updates to database.
This record signifies that it is updated when the value of the version is incremented.
When JobRepository updates the value and the version number is changed, an OptimisticLockingFailureException which indicates an occurrence of simultaneous access error is thrown.
Other batch jobs may be running on a different machines, however, all the jobs use the same database, hence this check is required.</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Detail_JobRepository_Metadata_SequenceID"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_SequenceID"></a>2.3.2.4.2. ID (Sequence) definition</h6>
<div class="paragraph">
<p>BATCH_JOB_INSTANCE, BATCH_JOB_EXECUTION and BATCH_STEP_EXECUTION all contain column ending with _ID.
These fields act as a primary key for respective tables.
However, these keys are not generated in the database but are rather generated in a separate sequence.
After inserting one of the domain objects in the database, the keys which assign the domain objects should be set in the actual objects so that they can be uniquely identified in Java.<br>
Sequences may not be supported depending on the database. In this case, a table is used instead of each sequence.</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_SpringBatchArch_Detail_JobRepository_Metadata_TableDefinition"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_TableDefinition"></a>2.3.2.4.3. Table definition</h6>
<div class="paragraph">
<p>Explanation is given for each table item.</p>
</div>
<div class="sect6">
<h7 id="batch_job_instance"><a class="anchor" href="#batch_job_instance"></a>BATCH_JOB_INSTANCE</h7>
<div class="paragraph">
<p>BATCH_JOB_INSTANCE table retains all the information related to JobInstance and is at top level of the overall hierarchy.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_INSTANCE definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INSTANCE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A primary key which is a unique ID identifying an instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refer <a href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_Version">Version</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job name. A non-null value since it is necessary for identifying an instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JobParameters which are serialised for uniquely identifying same job as a different instance.<br>
JobInstances with the same job name must contain different JobParameters (in other words, varying JOB_KEY values).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="batch_job_execution"><a class="anchor" href="#batch_job_execution"></a>BATCH_JOB_EXECUTION</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTION table retains all the information related to JobExecution object.
When a job is executed, new rows are always registered in the table with new JobExecution.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTION definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary key that uniquely identifies this job execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refer <a href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_Version">Version</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_INSTANCE_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key from BATCH_JOB_INSTANCE table which shows an instance wherein the job execution belongs.
Multiple executions are likely to exist for each instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time when the job execution was created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time when the job execution was started.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates the time when the job execution was terminated regardless of whether it was successful or failed.<br>
Even though the job is not running currently, the column value is empty which indicates there are several error types and the framework was unable to perform last save operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which indicates job execution status. It is a character string output by BatchStatus enumeration object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_CODE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which indicates an exit code of job execution. When it is activated by CommandLineJobRunner, it can be converted to a numeric value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which explains job termination status in detail.
When a failure occurs, a character string that includes as many as stack traces as possible is likely.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAST_UPDATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time when job execution of the record was last updated.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="batch_job_execution_params"><a class="anchor" href="#batch_job_execution_params"></a>BATCH_JOB_EXECUTION_PARAMS</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTION_PARAMS table retains all the information related to JobParameters object.
It contains a pair of 0 or more keys passed to the job and the value and records the parameters by which the job was executed.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTION_PARAMS definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key from  BATCH_JOB_EXECUTION table which executes this job wherein the job parameter belongs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TYPE_CD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which indicates that the data type is string, date, long or double.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KEY_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STRING_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter value when data type is string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter value when data type is date.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LONG_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter value when data type is an integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE_VAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter value when data type is a real number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDENTIFYING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A flag which indicates that the parameter is a value to identify that the job instance is unique.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="batch_job_execution_context"><a class="anchor" href="#batch_job_execution_context"></a>BATCH_JOB_EXECUTION_CONTEXT</h7>
<div class="paragraph">
<p>BATCH_JOB_EXECUTION_CONTEXT table retains all the information related to ExecutionContext of Job.
It contains all the job level data required for execution of specific jobs.
The data indicates the status that must be fetched when the process is to be executed again after a job failure and enables the failed job to start from the point where processing has stopped.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_JOB_EXECUTION_CONTEXT definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A foreign key from BATCH_JOB_EXECUTION table which indicates job execution wherein ExecutionContext of Job belongs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string representation of SERIALIZED_CONTEXT.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overall serialised context.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="batch_step_execution"><a class="anchor" href="#batch_step_execution"></a>BATCH_STEP_EXECUTION</h7>
<div class="paragraph">
<p>BATCH_STEP_EXECUTION table retains all the information related to StepExecution object.
This table very similar to BATCH_JOB_EXECUTION table in many ways. When each JobExecution is created, at least one entry exists for each Step.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_STEP_EXECUTION definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary key that uniquely identifies the step execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VERSION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refer <a href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata_Version">Version</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOB_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key from  BATCH_JOB_EXECUTION table which indicates JobExecution wherein StepExecution belongs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">START_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time when step execution was started.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">END_TIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates time when step execution ends regardless of whether it is successful or failed.<br>
Even though the job is not running currently, the column value is empty which indicates there are several error types and the framework was unable to perform last save operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATUS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string that represents status of step execution. It is a string which outputs BatchStatus enumeration object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COMMIT_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of times a transaction is committed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records read by ItemReader.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FILTER_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records filtered by ItemProcessor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records written by ItemWriter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">READ_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records skipped by ItemReader.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WRITE_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records skipped by ItemWriter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PROCESS_SKIP_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data records skipped by ItemProcessor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ROLLBACK_COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of times a transaction is rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_CODE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which indicates exit code for step execution. When it is activated by using CommandLineJobRunner, it can be changed to a numeric value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXIT_MESSAGE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A character string which explains step termination status in detail.
When a failure occurs, a character string that includes as many as stack traces as possible is likely.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAST_UPDATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time when the step execution of the record was last updated.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="batch_step_execution_context"><a class="anchor" href="#batch_step_execution_context"></a>BATCH_STEP_EXECUTION_CONTEXT</h7>
<div class="paragraph">
<p>BATCH_STEP_EXECUTION_CONTEXT table retains all the information related to ExecutionContext of Step.
It contains all the step level data required for execution of specific steps.
The data indicates the status that must be fetched when the process is to be executed again after a job failure and enables the failed job to start from the point where processing has stopped.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">BATCH_STEP_EXECUTION_CONTEXT definition</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STEP_EXECUTION_ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreign key from  BATCH_STEP_EXECUTION table which indicates job execution wherein ExecutionContext of Step belongs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHORT_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String representation of SERIALIZED_CONTEXT.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERIALIZED_CONTEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Overall serialized context.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="ddl-script"><a class="anchor" href="#ddl-script"></a>2.3.2.4.4. DDL script</h6>
<div class="paragraph">
<p>JAR file of Spring Batch Core contains a sample script which creates a relational table corresponding to several database platforms.
These scripts can be used as it is or additional index or constraints can be changed as required.<br>
The script is included in the package of org.springframework.batch.core and the file name is configured by <code>schema-*.sql</code>.
"*" is the short name for Target Database Platform..</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_SpringBatchArch_Detail_Performance"><a class="anchor" href="#Ch02_SpringBatchArch_Detail_Performance"></a>2.3.2.5. Typical performance tuning points</h5>
<div class="paragraph">
<p>Typical performance tuning points in Spring Batch are explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adjustment of chunk size</dt>
<dd>
<p>Chunk size is increased to reduce overhead occurring due to resource output.<br>
However, if chunk size is too large, it increases load on the resources resulting in deterioration in the performance. Hence, chunk size must be adjusted to a moderate value.</p>
</dd>
<dt class="hdlist1">Adjustment of fetch size</dt>
<dd>
<p>Fetch size (buffer size) for the resource is increased to reduce overhead occurring due to input from resources.</p>
</dd>
<dt class="hdlist1">Reading of a file efficiently</dt>
<dd>
<p>When BeanWrapperFieldSetMapper is used, a record can be mapped to the Bean only by sequentially specifying Bean class and property name.
However, it takes time to perform complex operations internally. Processing time can be reduced by using  dedicated FieldSetMapper interface implementation which performs mapping.<br>
For file I/O details, refer <a href="#Ch05_FileAccess">"File access"</a>.</p>
</dd>
<dt class="hdlist1">Parallel processing, Multiple processing</dt>
<dd>
<p>Spring Batch supports parallel processing of Step execution and multiple processing by using data distribution. Parallel processing or multiple processing can be performed and the performance can be improved by running the processes in parallel.
However, if number of parallel processes and multiple processes is too large, load on the resources increases resulting in deterioration of performance. Hence, size must be adjusted to a moderate value.<br>
For details of parallel and multiple processing, refer <a href="#Ch08_ParallelAndMultiple">"parallel processing and multiple processing</a>.</p>
</dd>
<dt class="hdlist1">Reviewing distributed processing</dt>
<dd>
<p>Spring Batch also supports distributed processing across multiple machines. Guidelines are same as parallel and multiple processing.<br>
Distributed processing will not be explained in this guideline since the basic design and operational design are complex.</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch02_TerasolunaBatchArch"><a class="anchor" href="#Ch02_TerasolunaBatchArch"></a>2.4. Architecture of TERASOLUNA Batch Framework for Java (5.x)</h3>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchArch_Overview"><a class="anchor" href="#Ch02_TerasolunaBatchArch_Overview"></a>2.4.1. Overview</h4>
<div class="paragraph">
<p>Overall architecture of TERASOLUNA Batch Framework for Java (5.x) is explained.</p>
</div>
<div class="paragraph">
<p>In TERASOLUNA Batch Framework for Java (5.x), as described in <a href="#Ch02_GeneralBatchProcess">"General batch processing system"</a>, it is implemented
by using OSS combination focused on Spring Batch.</p>
</div>
<div class="paragraph">
<p>A configuration schematic diagram of TERASOLUNA Batch Framework for Java (5.x) including hierarchy architecture of Spring Batch is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchArchitecture_Stack.png" alt="TERASOLUNA Batch Framework for Java (5.x) Stack">
</div>
<div class="title">Configuration schematic diagram of TERASOLUNA Batch Framework for Java (5.x)</div>
</div>
<div class="dlist">
<div class="title">Description of hierarchy architecture of Spring Batch</div>
<dl>
<dt class="hdlist1">Business Application</dt>
<dd>
<p>All job definitions and business logic written by developers.</p>
</dd>
<dt class="hdlist1">spring batch core</dt>
<dd>
<p>A core runtime class required to start and control batch jobs offered by Spring Batch.</p>
</dd>
<dt class="hdlist1">spring batch infrastructure</dt>
<dd>
<p>Implementation of general ItemReader/ItemProcessor/ItemWriter offered by Spring Batch which are used by developers and core framework itself.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchArch_JobComponents"><a class="anchor" href="#Ch02_TerasolunaBatchArch_JobComponents"></a>2.4.2. Structural elements of job</h4>
<div class="paragraph">
<p>A configuration schematic diagram of jobs is shown below in order to explain structural elements of the job.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchArchitecture_JobComponents.png" alt="Job Components">
</div>
<div class="title">Configuration schematic diagram of job</div>
</div>
<div class="paragraph">
<p>This section also talks about guidelines which should be finely configured for job and step.</p>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_Overview_Job"><a class="anchor" href="#Ch02_TerasolunaBatchArch_Overview_Job"></a>2.4.2.1. Job</h5>
<div class="paragraph">
<p>A job is an entity that encapsulates entire batch process and is a container for storing steps.<br>
A job can consist of one or more steps.</p>
</div>
<div class="paragraph">
<p>A job is defined in the Bean definition file by using XML.
Multiple jobs can be defined in the job definition file, however, managing jobs tend to become complex.</p>
</div>
<div class="paragraph">
<p>Hence, TERASOLUNA Batch Framework for Java (5.x) uses following guidelines.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-tags"></i></span> 1 job = 1 job definition file</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_Overview_Step"><a class="anchor" href="#Ch02_TerasolunaBatchArch_Overview_Step"></a>2.4.2.2. Step</h5>
<div class="paragraph">
<p>Step defines information required for controlling a batch process.
A chunk model and a tasket model can be defined in the step.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Chunk model</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>It is configured by ItemReader, ItemProcessor and ItemWriter.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Tasket model</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>It is configured only by Tasklet.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As given in <a href="#Ch02_GeneralBatchProcess_Considerations">"Rules and precautions to be considered in batch processing"</a>,
it is necessary to simplify as much as possible and avoid complex logical structures in a single batch process.</p>
</div>
<div class="paragraph">
<p>Hence, TERASOLUNA Batch Framework for Java (5.x) uses following guidelines.</p>
</div>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-tags"></i></span> 1 step = 1 batch process = 1 business logic</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Distribution of business logic in chunk model</div>
<div class="paragraph">
<p>If a single business logic is complex and large-scale, the business logic is divided into units.
As clear from the schematic diagram, since only one ItemProcessor can be set in 1 step, it looks like the division of business logic is not possible.
However, since CompositeItemProcssor which is an ItemProcessor consisting of multiple ItemProcessors exist,
the business logic can be divided and executed by using this implementation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchArch_StepImpl"><a class="anchor" href="#Ch02_TerasolunaBatchArch_StepImpl"></a>2.4.3. How to implement Step</h4>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_StepImpl_ChunkOriented"><a class="anchor" href="#Ch02_TerasolunaBatchArch_StepImpl_ChunkOriented"></a>2.4.3.1. Chunk model</h5>
<div class="paragraph">
<p>Definition of chunk model and purpose of use are explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Definition</dt>
<dd>
<p>ItemReader, ItemProcessor and ItemWriter implementation and number of chunks are set in ChunkOrientedTasklet. Respective roles are explained.</p>
<div class="ulist">
<ul>
<li>
<p>ChunkOrientedTasklet&#8230;&#8203;Call ItemReader/ItemProcessor and create a chunk. Pass created chunk to ItemWriter.</p>
</li>
<li>
<p>ItemReader&#8230;&#8203;Read input data.</p>
</li>
<li>
<p>ItemProcessor&#8230;&#8203;Process read data.</p>
</li>
<li>
<p>ItemWriter&#8230;&#8203;Output processed data in chunk units.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"></dt>
<dd>
<p>For overview of chunk model, refer <a href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Chunk">"Chunk model"</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">How to set a job in chunk model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Purpose of use</dt>
<dd>
<p>Since it handles a certain amount of data collectively, it is used while handling a large amount of data.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_StepImpl_TaskletOriented"><a class="anchor" href="#Ch02_TerasolunaBatchArch_StepImpl_TaskletOriented"></a>2.4.3.2. Tasket model</h5>
<div class="paragraph">
<p>Definition of tasket model and purpose of use are explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Definition</dt>
<dd>
<p>Only Tasklet implementation is set.<br>
For overview of Tasket model, refer <a href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Tasklet">"Tasket model"</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">How to set a job in Tasket model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exampleStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Purpose of use</dt>
<dd>
<p>It can be used for executing a process which is not associated with I/O like execution of system commands etc.<br>
Further, it can also be used while committing the data in batches.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_StepImpl_diffOfChunkAndTasklet"><a class="anchor" href="#Ch02_TerasolunaBatchArch_StepImpl_diffOfChunkAndTasklet"></a>2.4.3.3. Function difference between chunk model and Tasket model</h5>
<div class="paragraph">
<p>Explanation is given for the function difference between chunk model and Tasket model.
Here, only outline is given. Refer section for each function for details.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of function differences</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Chunk model</th>
<th class="tableblock halign-left valign-top">Tasket model</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Structural elements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configured by ItemReader/ItemProcessor/ItemWriter/ChunkOrientedTasklet.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configured only by Takslet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction is generated in a chunk unit.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processed in 1 transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommended reprocessing method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-run and re-start can be used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As a rule, only re-run is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling process becomes easier by using a listener. Individual implementation is also possible.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Individual implementation is required.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchArch_LaunchMethod"><a class="anchor" href="#Ch02_TerasolunaBatchArch_LaunchMethod"></a>2.4.4. Running a job method</h4>
<div class="paragraph">
<p>Running a job method is explained. This contains following.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Sync">Synchronous execution method</a></p>
</li>
<li>
<p><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async">Asynchronous execution method</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Respective methods are explained.</p>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_LaunchMethod_Sync"><a class="anchor" href="#Ch02_TerasolunaBatchArch_LaunchMethod_Sync"></a>2.4.4.1. Synchronous execution method</h5>
<div class="paragraph">
<p>Synchronous execution method is an execution method wherein the control is not given back to the boot source from job start to job completion.</p>
</div>
<div class="paragraph">
<p>A schematic diagram which starts a job from job scheduler is shown.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchArchitecture_SynchronizedExec.png" alt="Synchronized Execution">
</div>
<div class="title">Schematic diagram for synchronous execution</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start a shell script to run a job from job scheduler.<br>
Job scheduler waits until the exit code (numeric value) is returned.</p>
</li>
<li>
<p>Start <code>CommandLineJobRunner</code> to run a job from shell script.<br>
Shell script waits until <code>CommandLineJobRunner</code> returns an exit code (numeric value).</p>
</li>
<li>
<p><code>CommandLineJobRunner</code> runs a job. Job returns an exit code (string) to <code>CommandLineJobRunner</code> after processing is completed.<br>
<code>CommandLineJobRunner</code> converts exit code (string) returned from the job to exit code (numeric value) and returns it to the shell script.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="Ch02_TerasolunaBatchArch_LaunchMethod_Async"><a class="anchor" href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async"></a>2.4.4.2. Asynchronous execution method</h5>
<div class="paragraph">
<p>Asynchronous execution method is an execution method wherein the control is given back to boot source immediately after running a job, by executing a job on a different execution base than boot source (a separate thread etc).
In this method, it is necessary to fetch job execution results by a means different from that of running a job.</p>
</div>
<div class="paragraph">
<p>Following 2 methods are explained in TERASOLUNA Batch Framework for Java (5.x).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_DB">Asynchronous execution method (DB polling)</a></p>
</li>
<li>
<p><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_Web">Asynchronous execution method (Web container)</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Other asynchronous execution methods</div>
<div class="paragraph">
<p>Asynchronous execution can also be performed by using messages like MQ, however since the job execution points are identical, description will be omitted in TERASOLUNA Batch Framework for Java (5.x).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch02_TerasolunaBatchArch_LaunchMethod_Async_DB"><a class="anchor" href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_DB"></a>2.4.4.2.1. Asynchronous execution method (DB polling)</h6>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a> is a method wherein
a job execution request is registered in the database, polling of the request is done and job is executed.</p>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch Framework for Java (5.x) supports DB polling function. The schematic diagram of start by DB polling offered is shown.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchArchitecture_ASynchronized_DBPolling.png" alt="DB Polling">
</div>
<div class="title">DB polling schematic diagram</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User registers a job request to the database.</p>
</li>
<li>
<p>DB polling function periodically monitors the registration of the job request and executes the corresponding job when the registration is detected.</p>
<div class="ulist">
<ul>
<li>
<p>Run the job from SimpleJobOperator and receive <code>JobExecutionId</code> after completion of the job.</p>
</li>
<li>
<p>JobExecutionId is an ID which uniquely identifies job execution and execution results are browsed from JobRepository by using this ID.</p>
</li>
<li>
<p>Job execution results are registered in JobRepository by using Spring Batch system.</p>
</li>
<li>
<p>DB polling is itself executed asynchronously.</p>
</li>
</ul>
</div>
</li>
<li>
<p>DB polling function updates JobExecutionId returned from SimpleJobOperator and the job request that started the status.</p>
</li>
<li>
<p>Job process progress and results are referred separately by using JobExecutionId.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="Ch02_TerasolunaBatchArch_LaunchMethod_Async_Web"><a class="anchor" href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_Web"></a>2.4.4.2.2. Asynchronous execution method (Web container)</h6>
<div class="paragraph">
<p><a href="#Ch04_AsyncJobWithWeb">"Asynchronous execution (Web container)"</a> is a method
wherein a job is executed asynchronously using the request sent to web application on the web container as a trigger.*
A Web application can return a response immediately after starting without waiting for the job to end.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch02_TerasolunaBatchArchitecture_ASynchronized_WebContainer.png" alt="Web Container">
</div>
<div class="title">Web container schematic diagram</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Send a request from a client to Web application.</p>
</li>
<li>
<p>Web application asynchronously executes the job requested from a request.</p>
<div class="ulist">
<ul>
<li>
<p>Receive <code>`JobExecutionId</code> immediately after starting a job from SimpleJobOperator.</p>
</li>
<li>
<p>Job execution results are registered in JobRepository by using Spring Batch system.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Web application returns a response to the client without waiting for the job to end.</p>
</li>
<li>
<p>Job process progress and results are browsed separately by using JobExecutionId.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Further, it can also be linked with Web application configured by <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/">TERASOLUNA Server Framework for Java (5.x)</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch02_TerasolunaBatchArch_DecisionPoints"><a class="anchor" href="#Ch02_TerasolunaBatchArch_DecisionPoints"></a>2.4.5. Points to consider while using</h4>
<div class="paragraph">
<p>Points to consider while using TERASOLUNA Batch Framework for Java (5.x) are shown.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Running a job method</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Sync">Synchronous execution method</a></dt>
<dd>
<p>It is used when job is run as per schedule and batch processing is carried out by combining multiple jobs.</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_DB">Asynchronous execution method (DB polling)</a></dt>
<dd>
<p>It is used in delayed processing, continuous execution of jobs with a short processing time, aggregation of large quantity of jobs.</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_TerasolunaBatchArch_LaunchMethod_Async_Web">Asynchronous execution method (Web container)</a></dt>
<dd>
<p>Similar to DB polling, however it is used when an immediate action is required for the startup.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Implementation method</dt>
<dd>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch02_TerasolunaBatchArch_StepImpl_ChunkOriented">Chunk model</a></dt>
<dd>
<p>It is used when a large quantity of data is to be processed efficiently.</p>
</dd>
<dt class="hdlist1"><a href="#Ch02_TerasolunaBatchArch_StepImpl_TaskletOriented">Tasket model</a></dt>
<dd>
<p>It is used for simple processing, processing that is difficult to standardize and for the processes wherein data is to be processed collectively.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch03"><a class="anchor" href="#Ch03"></a>3. Methodology of application development</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch03_CreateProject"><a class="anchor" href="#Ch03_CreateProject"></a>3.1. Development of batch application</h3>
<div class="paragraph">
<p>The development of batch application is explained in the following flow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateProject_blank">What is blank project</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_HowToCreate">Creation of project</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_ProjectStructure">Project structure</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_Make">Flow of development</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_BuildAndExec_Build">Build of application</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_blank"><a class="anchor" href="#Ch03_CreateProject_blank"></a>3.1.1. What is blank project</h4>
<div class="paragraph">
<p>Blank project is the template of development project wherein various settings are made in advance such as Spring Batch, MyBatis3
and is the start point of application development.<br>
In this guideline, a blank project with a single project structure is provided.<br>
Refer to <a href="#Ch03_CreateProject_ProjectStructure">Project structure</a> for the explanation of structure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Difference from TERASOLUNA Server 5.x</div>
<div class="paragraph">
<p>Multi-project structure is recommended forTERASOLUNA Server 5.x.
The reason is mainly to enjoy the following merits.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Makes the environmental differences easier to absorb</p>
</li>
<li>
<p>Makes separation of business logic and presentation easier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, in this guideline, a single project structure is provided unlike TERASOLUNA Server 5.x.</p>
</div>
<div class="paragraph">
<p>This point should be considered for batch application also, however,
by providing single project structure, accessing the resources related to one job is given priority.<br>
In case of batch application,
one of the reason is that there are many cases when environment differences can be switched by property file or environment variables.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_HowToCreate"><a class="anchor" href="#Ch03_CreateProject_HowToCreate"></a>3.1.2. Creation of project</h4>
<div class="paragraph">
<p>How to create a project using <code>archetype:generate</code> of <code>Maven Archetype Plugin</code> is explained.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Regarding prerequisites of creating environment</div>
<div class="paragraph">
<p>Prerequisites are explained below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java SE Development Kit 8</p>
</li>
<li>
<p>Apache Maven 3.x</p>
<div class="ulist">
<ul>
<li>
<p>Internet should be connected</p>
</li>
<li>
<p>When connecting to the Internet via proxy, Maven proxy setting should be done</p>
</li>
</ul>
</div>
</li>
<li>
<p>IDE</p>
<div class="ulist">
<ul>
<li>
<p>Spring Tool Suite / Eclipse etc.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Considerations after creating a project</div>
<div class="paragraph">
<p>Version of TERASOLUNA Batch 5.x defined in the generated <code>pom.xml</code> must be changed from <strong>5.0.1-SNAPSHOT</strong> to <strong>5.0.1.RELEASE</strong>.</p>
</div>
<div class="listingblock">
<div class="title">Before modification</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;properties&gt;</span>
    <span class="comment">&lt;!-- omiited --&gt;</span>

    <span class="tag">&lt;terasoluna-batch.version&gt;</span>5.0.1-SNAPSHOT<span class="tag">&lt;/terasoluna-batch.version&gt;</span>

    <span class="comment">&lt;!-- omiited --&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">After modification</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;properties&gt;</span>
    <span class="comment">&lt;!-- omiited --&gt;</span>

    <span class="tag">&lt;terasoluna-batch.version&gt;</span>5.0.1.RELEASE<span class="tag">&lt;/terasoluna-batch.version&gt;</span>

    <span class="comment">&lt;!-- omiited --&gt;</span>
<span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Execute the following commands in the directory where project is created.</p>
</div>
<div class="listingblock">
<div class="title">Command prompt(Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt; mvn archetype:generate ^
  -DarchetypeGroupId=org.terasoluna.batch ^
  -DarchetypeArtifactId=terasoluna-batch-archetype ^
  -DarchetypeVersion=5.0.1.RELEASE</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bash(Unix, Linux, &#8230;&#8203;)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn archetype:generate \
  -DarchetypeGroupId=org.terasoluna.batch \
  -DarchetypeArtifactId=terasoluna-batch-archetype \
  -DarchetypeVersion=5.0.1.RELEASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, set the following to Interactive mode in accordance with the status of the user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>groupId</p>
</li>
<li>
<p>artifactId</p>
</li>
<li>
<p>version</p>
</li>
<li>
<p>package</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example of setting and executing the value is shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of each element of blank project</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item name</th>
<th class="tableblock halign-left valign-top">Setting example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">com.example.batch</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Execution example at command prompt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate ^
More? -DarchetypeGroupId=org.terasoluna.batch ^
More? -DarchetypeArtifactId=terasoluna-batch-archetype ^
More? -DarchetypeVersion=5.0.1.RELEASE
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': com.example.batch
Define value for property 'artifactId': batch
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package' com.example.batch: :
Confirm properties configuration:
groupId: com.example.batch
artifactId: batch
version: 1.0.0-SNAPSHOT
package: com.example.batch
 Y: : y
[INFO] ------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: terasolua-batch-archetype:5.0.1.RELEASE
[INFO] ------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: packageInPathFormat, Value: com/example/batch
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Project created from Archetype in dir: C:\xxx\batch
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 36.952 s
[INFO] Finished at: 2017-07-25T14:23:42+09:00
[INFO] Final Memory: 14M/129M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Execution example at Bash</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn archetype:generate \
&gt; -DarchetypeGroupId=org.terasoluna.batch \
&gt; -DarchetypeArtifactId=terasoluna-batch-archetype \
&gt; -DarchetypeVersion=5.0.1.RELEASE
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': com.example.batch
Define value for property 'artifactId': batch
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package' com.example.batch: :
Confirm properties configuration:
groupId: com.example.batch
artifactId: batch
version: 1.0.0-SNAPSHOT
package: com.example.batch
 Y: : y
[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: terasoluna-batch-archetype:5.0.1-RELEASE
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: packageInPathFormat, Value: com/example/batch
[INFO] Parameter: package, Value: com.example.batch
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: com.example.batch
[INFO] Parameter: artifactId, Value: batch
[INFO] Project created from Archetype in dir: C:\xxx\batch
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 01:19 min
[INFO] Finished at: 2017-07-25T14:20:09+09:00
[INFO] Final Memory: 17M/201M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>The creation of project is completed by the above execution.</p>
</div>
<div class="paragraph">
<p>It can be confirmed whether the project was created properly by the following points.</p>
</div>
<div class="listingblock">
<div class="title">Execution at command prompt (Verify that it was created correctly)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Execution at Bash (Verify that it was created correctly)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
$ java -cp 'lib/*;target/*' \
org.springframework.batch.core.launch.support.CommandLineJobRunner \
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is created properly if the following output is obtained.</p>
</div>
<div class="listingblock">
<div class="title">Output example at command prompt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building TERASOLUNA Batch Framework for Java (5.x) Blank Project 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 11.007 s
[INFO] Finished at: 2017-07-25T14:24:36+09:00
[INFO] Final Memory: 23M/165M
[INFO] ------------------------------------------------------------------------

C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
More? org.springframework.batch.core.launch.support.CommandLineJobRunner ^
More? META-INF/jobs/job01.xml job01

(.. omitted)

[2017/07/25 14:25:22] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]
[2017/07/25 14:25:22] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing step: [job01.step01]
[2017/07/25 14:25:23] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}] and the following status: [COMPLETED]
[2017/07/25 14:25:23] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:25:20 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output example at Bash</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building TERASOLUNA Batch Framework for Java (5.x) Blank Project 1.0.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 10.827 s
[INFO] Finished at: 2017-07-25T14:21:19+09:00
[INFO] Final Memory: 27M/276M
[INFO] ------------------------------------------------------------------------

$ java -cp 'lib/*;target/*' \
&gt; org.springframework.batch.core.launch.support.CommandLineJobRunner \
&gt; META-INF/jobs/job01.xml job01
[2017/07/25 14:21:49] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:21:49 JST 2017]; root of context hierarchy

(.. ommited)

[2017/07/25 14:21:52] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]
[2017/07/25 14:21:52] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing step: [job01.step01]
[2017/07/25 14:21:52] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}] and the following status: [COMPLETED]
[2017/07/25 14:21:52] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Closing org.springframework.context.support.ClassPathXmlApplicationContext@62043840: startup date [Tue Jul 25 14:21:49 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_ProjectStructure"><a class="anchor" href="#Ch03_CreateProject_ProjectStructure"></a>3.1.3. Project structure</h4>
<div class="paragraph">
<p>Project structure that was created above, is explained.
Project structure should be made by considering the following points.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement the job independent of startup method</p>
</li>
<li>
<p>Save the efforts of performing various settings such as Spring Batch, MyBatis</p>
</li>
<li>
<p>Make the environment dependent switching easy</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The structure is shown and each element is explained below.<br>
(It is explained based on the output at the time of executing the above <code>mvn archetype:generate</code> to easily understand.)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch03_CreateProject_BlankProjectDir.png" alt="BlankProject Structure">
</div>
<div class="title">Directory configuration of project</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of each element of blank project</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">root package that stores various classes of the entire batch application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Package that stores various classes of 1 job.<br>
It stores  DTO, implementation of Tasklet and Processor, Mapper interface of MyBatis3.<br>
Since there are no restrictions on how to store in this guideline, refer to this as an example.</p>
<p class="tableblock">You can customize it with reference to default state however,
consider making it easier to judge the resources specific to job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration file of the entire batch application.<br>
In the default state, the settings related to database connection and asynchronous execution are set up.
You can add by referring default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration file of Logback(log output).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration file that defines messages to be displayed when an error occurs during the input check using BeanValidation.<br>
In the default state, after defining default messages of BeanValidation and HibernateValidator that is its implementation,
Comment-out All is done.<br>
In this state, since default messages are used, it should be modified to any message by Comment-in
only when you want to customize the messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper XML file that pairs with Mapper interface of MyBatis3.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property file that defines messages used mainly for log output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory that stores job-specific Bean definition file.<br>
The hierarchical structure can be configured according to the number of jobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory that stores Bean definition file related to the entire batch application.<br>
It is set to start a job regardless of default setting of Spring Batch or MyBatis or start trigger such as synchronous / asynchronous.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file that describes settings related to asynchronous execution (DB polling) function.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file to reduce various settings by importing in a job-specific Bean definition file.<br>
By importing this, the job can absorb the difference in the Bean definition by the start trigger.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file for setting Spring Batch behavior and common jobs.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Relation figure of each file is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch03_CreateProject_FilesRelation.png" alt="Files Relation">
</div>
<div class="title">Relation figure of each file</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_Make"><a class="anchor" href="#Ch03_CreateProject_Make"></a>3.1.4. Flow of development</h4>
<div class="paragraph">
<p>Series of flow of developing job is explained.<br>
Here, we will focus on understanding general flow and not the detailed explanation.</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_Make_ImportToIDE"><a class="anchor" href="#Ch03_CreateProject_Make_ImportToIDE"></a>3.1.4.1. Import to IDE</h5>
<div class="paragraph">
<p>Since the generated project is as per the project structure of Maven,
import as Maven project using various IDEs.<br>
Detailed procedures are omitted.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_Make_Setting"><a class="anchor" href="#Ch03_CreateProject_Make_Setting"></a>3.1.4.2. Setting of entire application</h5>
<div class="paragraph">
<p>Customize as follows depending on user status.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateProject_Make_Setting_POM">Project information of pom.xml</a></p>
</li>
<li>
<p><a href="#Ch03_CreateProject_Make_Setting_DB">Database related settings</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to customize settings other than these by individual functions is explained.</p>
</div>
<div class="sect5">
<h6 id="Ch03_CreateProject_Make_Setting_POM"><a class="anchor" href="#Ch03_CreateProject_Make_Setting_POM"></a>3.1.4.2.1. Project information of pom.xml</h6>
<div class="paragraph">
<p>As the following information is set with temporary values in the POM of the project, values should be set as per the status.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Project name(name element)</p>
</li>
<li>
<p>Project description(description element)</p>
</li>
<li>
<p>Project URL(url element)</p>
</li>
<li>
<p>Project inception year(inceptionYear element)</p>
</li>
<li>
<p>Project license(licenses element)</p>
</li>
<li>
<p>Project organization(organization element)</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch03_CreateProject_Make_Setting_DB"><a class="anchor" href="#Ch03_CreateProject_Make_Setting_DB"></a>3.1.4.2.2. Database related settings</h6>
<div class="paragraph">
<p>Database related settings are at many places, so each place should be modified.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.h2database<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>h2<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>

<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt"># (2)
# Admin DataSource settings.
admin.jdbc.driver=org.h2.Driver
admin.jdbc.url=jdbc:h2:mem:batch-admin;DB_CLOSE_DELAY=-1
admin.jdbc.username=sa
admin.jdbc.password=

# (2)
# Job DataSource settings.
#jdbc.driver=org.postgresql.Driver
#jdbc.url=jdbc:postgresql://localhost:5432/postgres
#jdbc.username=postgres
#jdbc.password=postgres
jdbc.driver=org.h2.Driver
jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
jdbc.username=sa
jdbc.password=

# (3)
# Spring Batch schema initialize.
data-source.initialize.enabled=true
spring-batch.schema.script=classpath:org/springframework/batch/core/schema-h2.sql
terasoluna-batch.commit.script=classpath:org/terasoluna/batch/async/db/schema-commit.sql</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${data-source.initialize.enabled:false}</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">ignore-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${spring-batch.schema.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${terasoluna-batch.commit.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Each element in database related settings is explained</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In pom.xml, define dependency relation of JDBC driver for connecting to the database to be used.<br>
In the default state, H2 Database(in-memory database) and PostgreSQL are set, however add/delete should be performed whenever required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set JDBC driver connection.<br>
- <code>admin.jdbc.xxx</code> is used by Spring Batch and TERASOLUNA Batch 5.x<br>
- <code>jdbc.xxx～</code> is used in individual job<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define whether or not to execute the initialization of database used by Spring Batch or TERASOLUNA Batch 5.x, and the script to be used.<br>
Since Spring Batch accesses <strong>JobRepository</strong> and
TERASOLUNA Batch 5.x accesses <strong>job request table</strong> in the <strong>asynchronous execution(DB Polling)</strong>,
database is mandatory.<br>
Whether to enable it, is based on the following.<br>
- Enable it when H2 Database is to be used. If disabled, <strong>JobRepository<strong>and</strong>job request table</strong>* cannot be accessed and an error occurs.<br>
- When not using H2 Database, disable it to prevent accidents.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set datasource.<br>
Tune the number of connections as necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set MyBatis behavior.<br>
Tune fetch size as necessary.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_Make_Resources"><a class="anchor" href="#Ch03_CreateProject_Make_Resources"></a>3.1.5. Creation of job</h4>
<div class="paragraph">
<p>Refer to the following for how to create a job.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob">Creation of chunk model job</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">Creation of tasklet model job</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateProject_BuildAndExec"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec"></a>3.1.6. Build and execution of project</h4>
<div class="paragraph">
<p>Build and execution of project is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_BuildAndExec_Build"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec_Build"></a>3.1.6.1. Build of application</h5>
<div class="paragraph">
<p>Move to the root directory of the project and execute the following command.</p>
</div>
<div class="listingblock">
<div class="title">Build(Windows/Bash)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn clean dependency:copy-dependencies -DoutputDirectory=lib package</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is generated by this.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;Root directory&gt;/target/[artifactId]-[version].jar</p>
<div class="ulist">
<ul>
<li>
<p>Jar of the created batch application is generated</p>
</li>
</ul>
</div>
</li>
<li>
<p>&lt;Root directory&gt;/lib/(Dependent Jar file)</p>
<div class="ulist">
<ul>
<li>
<p>A set of dependent Jar files is copied</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When deploying to the test environment and the commercial environment, these Jar files can be copied to an arbitrary directory.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateProject_BuildAndExec_BuildPerEnv"><a class="anchor" href="#Ch03_CreateProject_BuildAndExec_BuildPerEnv"></a>3.1.6.2. Switching of configuration file according to the environment</h5>
<div class="paragraph">
<p>In the pom.xml of the project, the following Profile is set as the default value.</p>
</div>
<div class="listingblock">
<div class="title">Profiles settings of pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;profiles&gt;</span>
    <span class="comment">&lt;!-- Including application properties and log settings into package. (default) --&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>IncludeSettings<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;exclude-property</span><span class="tag">/&gt;</span>
            <span class="tag">&lt;exclude-log</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>

    <span class="comment">&lt;!-- Excluding application properties and log settings into package. --&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>ExcludeSettings<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>false<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;exclude-property&gt;</span>batch-application.properties<span class="tag">&lt;/exclude-property&gt;</span>
            <span class="tag">&lt;exclude-log&gt;</span>logback.xml<span class="tag">&lt;/exclude-log&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
<span class="tag">&lt;/profiles&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code> Whether to include environment dependent configuration file </code> is switched.
By utilizing this setting, it is possible to absorb the environmental difference by separately placing the configurationfile at the time of environment deployment.
Moreover, by applying this, it is possible to change the configuration file to be included in Jar in the test environment and the commercial environment.
An example is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Description example of pom.xml for switching configuration file for each environment</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;build&gt;</span>
    <span class="tag">&lt;resources&gt;</span>
        <span class="tag">&lt;resource&gt;</span>
            <span class="tag">&lt;directory&gt;</span>src/main/resources<span class="tag">&lt;/directory&gt;</span>
        <span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;resource&gt;</span>
            <span class="tag">&lt;directory&gt;</span>${project.root.basedir}/${project.config.resource.directory.rdbms}<span class="tag">&lt;/directory&gt;</span>
        <span class="tag">&lt;/resource&gt;</span>
    <span class="tag">&lt;/resources&gt;</span>
<span class="tag">&lt;/build&gt;</span>

<span class="tag">&lt;profiles&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>postgresql9-local<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;activeByDefault&gt;</span>true<span class="tag">&lt;/activeByDefault&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;/dependencies&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;project.config.resource.directory.rdbms&gt;</span>config/rdbms/postgresql9/local<span class="tag">&lt;/project.config.resource.directory.rdbms&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;id&gt;</span>postgresql9-it<span class="tag">&lt;/id&gt;</span>
        <span class="tag">&lt;dependencies&gt;</span>
            <span class="tag">&lt;dependency&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>org.postgresql<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>postgresql<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
            <span class="tag">&lt;/dependency&gt;</span>
        <span class="tag">&lt;/dependencies&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;project.config.resource.directory.rdbms&gt;</span>config/rdbms/postgresql9/it<span class="tag">&lt;/project.config.resource.directory.rdbms&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/profile&gt;</span>
<span class="tag">&lt;/profiles&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maven Profile can be activated at the time of executing command as follows.<br>
Multiple Profiles can be activated. Use effectively whenever required.</p>
</div>
<div class="listingblock">
<div class="title">Example of activating Maven Profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ mvn -P profile-1,profile-2</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="execution-of-application"><a class="anchor" href="#execution-of-application"></a>3.1.6.2.1. Execution of application</h6>
<div class="paragraph">
<p>An example of executing the job based on the above-mentioned build result, is shown.<br>
<code>[artifactId]</code> and <code>[version]</code> should be changed according to the user as set by <a href="#Ch03_CreateProject_HowToCreate">Creation of project</a>.</p>
</div>
<div class="listingblock">
<div class="title">Command prompt(Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt; java -cp &quot;target\[artifactId]-[version].jar;lib\*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bash(Unix, Linux, &#8230;&#8203;)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -cp 'target/[artifactId]-[version].jar;lib/*' \
org.springframework.batch.core.launch.support.CommandLineJobRunner \
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Necessity to handle exit code returned by java command</div>
<div class="paragraph">
<p>In the actual system,
rather than issuing a java command directly when issuing a job from the job scheduler,
It is common to start by inserting shell script for starting java.<br></p>
</div>
<div class="paragraph">
<p>This is for setting the environment variables before starting the java command and for handling the exit code of the java command.
It is recommended that <code> Handling of the exit code of the java command </code> should always be done for the following reasons.<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The normal exit code of the java command is <code> 0</code> and abnormal is <code> 1</code>. The job scheduler judges the success / failure of the job within the range of the exit code.
Depending on the settings of the job scheduler, it judges as 'Normal end' irrespective of the fact that the java commandended abnormally.</p>
</li>
<li>
<p>The exit code that can be handled by OS and job scheduler has finite range.</p>
<div class="ulist">
<ul>
<li>
<p>It is important to define the range of the exit code to be used by the user according to the specifications of the OS and job scheduler.</p>
</li>
<li>
<p>Generally, it is in the range of 0 to 255 which is defined by the POSIX standards.</p>
<div class="ulist">
<ul>
<li>
<p>In {batch 5 _ shortname}, it is set to return the normal exit code as <code> 0</code> or otherwise,<code> 255</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example of handling exit code is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Example of handling exit code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash

# ..omitted.

java -cp ...
RETURN_CODE=$?
if [ $RETURN_CODE = 1 ]; then
   return 255
else
   return $RETURN_CODE
fi</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_CreateChunkJob"><a class="anchor" href="#Ch03_CreateChunkJob"></a>3.2. Creation of chunk model job</h3>
<div class="sect3">
<h4 id="Ch03_CreateChunkJob_Overview"><a class="anchor" href="#Ch03_CreateChunkJob_Overview"></a>3.2.1. Overview</h4>
<div class="paragraph">
<p>How to create chunk model job is explained.
Refer to <a href="#">Spring Batch architecture</a> for the architecture of chunk model.</p>
</div>
<div class="paragraph">
<p>The components of chunk model job is explained here.</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_Overview_Components"><a class="anchor" href="#Ch03_CreateChunkJob_Overview_Components"></a>3.2.1.1. Components</h5>
<div class="paragraph">
<p>The components of chunk model job are shown below.
Implement 1 job by combining these components in job Bean definition file.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Components of chunk model job</caption>
<colgroup>
<col style="width: 5.2631%;">
<col style="width: 21.0526%;">
<col style="width: 52.6315%;">
<col style="width: 10.5263%;">
<col style="width: 10.5265%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Role</th>
<th class="tableblock halign-left valign-top">Mandatory settings</th>
<th class="tableblock halign-left valign-top">Mandatory implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface to fetch data from various resources.<br>
Since implementation for flat files and database is provided by Spring Batch,<br>
there is no need for the user to create it.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface for processing data from input to output.<br>
The user <code>implements</code> this interface whenever required and implements  business logic.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface for the output of data to various resources.<br>
An interface paired with <code>ItemReader</code>.<br>
Since implementation for flat files and database is provided by Spring Batch,<br>
there is no need for the user to create it.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-minus"></i></span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The points in this table are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the data is to be only transferred from input resource to output resource in a simple way, it can be implemented only by setting.</p>
</li>
<li>
<p><code>ItemProcessor</code> should be implemented whenever required.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hereafter, how to implement the job using these components, is explained.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateChunkJob_HowToUse"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse"></a>3.2.2. How to use</h4>
<div class="paragraph">
<p>How to implement chunk model job is explained in the following order here.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob_HowToUse_JobConfig">Job configuration</a></p>
</li>
<li>
<p><a href="#Ch03_CreateChunkJob_HowToUse_Components">Implementation of components</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_HowToUse_JobConfig"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_JobConfig"></a>3.2.2.1. Job configuration</h5>
<div class="paragraph">
<p>Define a way to combine the elements that constitutes chunk model job in the Bean definition file.
An example is shown below and the relation between components is explained.</p>
</div>
<div class="listingblock">
<div class="title">Example of Bean definition file (Chunk model)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:p</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/p</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:mybatis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://mybatis.org/schema/mybatis-spring</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span>
             <span class="content">http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:annotation-config</span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.common</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst.CustomerRepository.findAll</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="comment">&lt;!-- Item Processor --&gt;</span>
    <span class="comment">&lt;!-- Item Processor in order that based on the Bean defined by the annotations, not defined here --&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobCustomerList01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (9) --&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobCustomerList01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (11) --&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (12) --&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Configuration of ItemProcessor implementation class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (6)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;Customer, Customer&gt; {
  <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Import the settings to always read the required Bean definition when using TERASOLUNA Batch 5.x.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable Bean definition using annotation. Use it with (3) when implementing ItemProcessor, Listener etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set base package of component scan target. When defining Bean using annotation, use it with (2).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis-Spring settings.<br>
For details of MyBatis-Spring settings, refer <a href="#Ch05_DBAccess">Database access</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader configuration.<br>
For the details of ItemReader,
refer to <a href="#Ch05_DBAccess">Database access</a> and
<a href="#Ch05_FileAccess">File access</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor can be defined by annotation in (2), (3), so there is no need to define in the Bean definition file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter configuration.<br>
For the details of ItemWriter,
refer to <a href="#Ch05_DBAccess">Database access</a> and
<a href="#Ch05_FileAccess">File access</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job configuration.<br>
<code>id</code> attribute must be unique for all the jobs included in 1 batch application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRepository</code> configuration.<br>
The value set in the <code> job-repository</code> attribute should be fixed to <code> jobRepository</code> unless there is a special reason.<br>
This will allow all the jobs to be managed by 1 <code>JobRepository</code>.
Resolve Bean definition of <code>jobRepository</code> by (1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step configuration.<br>
Although it is not necessary to use a unique <code>id</code> attribute for all the jobs in 1 batch application, a unique id is used for enabling easy tracking at the time of failure occurrence.<br>
A format of [step+serial number] is used for id attribute specified in (8) unless for a specific reason to use a different format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet configuration.<br>
The value set in the <code>transaction-manager</code> attribute should be fixed to <code>jobTransactionManager</code> unless there is a special reason.<br>
This will allow the transaction to be managed for each <code>commit-interval</code> of (12).
For details, refer to <a href="#">Transaction control</a>.<br>
Resolve Bean definition of <code>jobTransactionManager</code> by (1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chunk model job configuration.<br>
Specify Bean ID of <code>ItemReader</code> and <code>ItemWriter</code> defined in the previous section, in respective <code>reader</code> and <code>writer</code> attributes.<br>
Specify Bean ID of implementation class of ItemProcessor, in  <code>processor</code> attribute.<br>
Set input data count per chunk in <code>commit-interval</code> attribute.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Tuning of commit-interval</div>
<div class="paragraph">
<p><code>commit-interval</code> is the performance tuning point in chunk model job.</p>
</div>
<div class="paragraph">
<p>In the above example, 10 records are used however, exact count differs with the characteristics of available machine resource and job.
In case of a job that processes data by accessing multiple resources, the process throughput may reach to 100 records from 10 records. If input/output resource is of 1:1 correspondence and there is a job of transferring data,
then the process throughput may increase to 5000 records or even to 10000 records.</p>
</div>
<div class="paragraph">
<p>Temporarily set <code>commit-interval`</code> to 100 records at the time of implementing the job,
and then perform tuning of each job as per the result of performance measurement.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateChunkJob_HowToUse_Components"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_Components"></a>3.2.2.2. Implementation of components</h5>
<div class="paragraph">
<p>How to implement mainly ItemProcessor is explained here.</p>
</div>
<div class="paragraph">
<p>Refer to the following for other components.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemReader、ItemWriter</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_DBAccess">Database access</a>、
<a href="#Ch05_FileAccess">File access</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Listener</p>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_Listener">Listener</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Ch03_CreateChunkJob_HowToUse_Components_Processor"><a class="anchor" href="#Ch03_CreateChunkJob_HowToUse_Components_Processor"></a>3.2.2.2.1. Implementation of ItemProcessor</h6>
<div class="paragraph">
<p>How to implement ItemProcessor is explained.</p>
</div>
<div class="paragraph">
<p>ItemProcessor is responsible for creating <strong>1 record</strong> data for the output resource
based on the <strong>1 record</strong> data fetched from the input resource as shown in the interface below.
In other words, ItemProcessor is where business logic for <strong>1 record</strong> data is implemented.</p>
</div>
<div class="listingblock">
<div class="title">ItemProcessor interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessor</span>&lt;I, O&gt; {
    O process(I item) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The interface indicating <code>I</code> and <code>O</code> can be of same type or of different type as shown below.
Same type means modifying input data partially.
Different type means to generate output data based on the input data.</p>
</div>
<div class="listingblock">
<div class="title">Example of implementation of ItemProcessor(Input/Output is of same type)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountUpdateItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        item.setAmount(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of implementation of ItemProcessor(Input/Output is of different type)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromDBProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {
        Customer customer = customerRepository.findOne(readItem.getCustomerId());

        SalesPlanDetail writeItem = <span class="keyword">new</span> SalesPlanDetail();
        writeItem.setBranchId(customer.getChargeBranchId());
        writeItem.setYear(readItem.getYear());
        writeItem.setMonth(readItem.getMonth());
        writeItem.setCustomerId(readItem.getCustomerId());
        writeItem.setAmount(readItem.getAmount());
        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Explanation of return of null from ItemProcessor</div>
<div class="paragraph">
<p>Return of null from ItemProcessor means the data is not passed to the subsequent process (Writer).
In other words, the data is filtered.
This can be effectively used to validate the input data.
For detail, refer to <a href="#">Input check</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">To increase process throughput of ItemProcessor</div>
<div class="paragraph">
<p>As shown in the previous implementation example, the implementation class of ItemProcessor should access resources such as DB and files.
Since ItemProcessor is executed for each record of input data, even if there is small I/O, large I/O occurs in the entire job,
so it is important to suppress I/O as much as possible for increasing process throughput.</p>
</div>
<div class="paragraph">
<p>One method is to store the required data in memory in advance by utilizing Listener to be mentioned later
and implement most of the processing in ItemProcessor so that it completes between CPU/ memory.
However, since it consumes a large amount of memory per job, its not that anything can be stored in the memory.
The data to be stored in memory based on I/O frequency and data size should be studied.</p>
</div>
<div class="paragraph">
<p>This point is introduced even in <a href="Ch05_index.html#Ch05">Input/Output of data</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Use multiple ItemProcessors at the same time</div>
<div class="paragraph">
<p>If a general ItemProcessor is provided to apply to each job,
it can be implemented by using <code>CompositeItemProcessor</code> provided by Spring Batch and linking it.</p>
</div>
<div class="listingblock">
<div class="title">Linking of multiple ItemProcessor by CompositeItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">commonItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">businessLogicItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that it is processed in the order specified in the delegates attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_CreateTaskletJob"><a class="anchor" href="#Ch03_CreateTaskletJob"></a>3.3. Creation of tasklet model job</h3>
<div class="sect3">
<h4 id="Ch03_CreateTaskletJob_Overview"><a class="anchor" href="#Ch03_CreateTaskletJob_Overview"></a>3.3.1. Overview</h4>
<div class="paragraph">
<p>How to create tasklet model job is explained.
Refer to <a href="#">Spring Batch architecture</a> for the architecture of tasklet model.</p>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_Overview_Components"><a class="anchor" href="#Ch03_CreateTaskletJob_Overview_Components"></a>3.3.1.1. Components</h5>
<div class="paragraph">
<p>Tasklet model job does not register multiple components.
It only implements <code>org.springframework.batch.core.step.tasklet.Tasklet</code> and sets it in Bean definition.
<code> ItemReader</code> and <code> ItemWriter</code> which are components of the chunk model can also be used as components as the advanced implementation means.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch03_CreateTaskletJob_HowToUse"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse"></a>3.3.2. HowToUse</h4>
<div class="paragraph">
<p>How to implement tasklet model job is explained in the following order here.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_JobConfig">Job configuration</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_Implements">Implementation of tasklet</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_JobConfig"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_JobConfig"></a>3.3.2.1. Job configuration</h5>
<div class="paragraph">
<p>Define tasklet model job in Bean definition file.
An example is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Example of Bean definition file (Tasklet model)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/context</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:batch</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/batch</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
             <span class="content">http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</span>
             <span class="content">http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;context:annotation-config</span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;context:component-scan</span>
          <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.common</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simpleJobTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (7) --&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of tasklet implementation class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.functionaltest.app.common</span>;

<span class="annotation">@Component</span> <span class="comment">// (3)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleJobTasklet</span> <span class="directive">implements</span> Tasklet {
  <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">S. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Import the settings to always read the required Bean definition when using TERASOLUNA Batch 5.x.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable Bean definition using annotation. Use it with (3).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set base package of component-scan target. Use it with (2).<br>
In the tasklet model, Bean is defined by annotation however, Bean definition of tasklet implementation class is not required in XML.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job configuration.<br>
<code>id</code> attribute must be unique for all the jobs included in 1 batch application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobRepository</code> configuration.<br>
The value set in the <code> job-repository</code> attribute should be fixed to <code> jobRepository</code> unless there is a special reason.<br>
This will allow all the jobs to be managed in one <code>JobRepository</code>.
Resolve Bean definition of <code>jobRepository</code> by (1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step configuration.<br>
Although it is not necessary to use a unique <code>id</code> attribute for all the jobs in 1 batch application, a unique id is used for enabling easy tracking at the time of failure occurrence.<br>
A format of [step+serial number] is used for id attribute specified in (4) unless for a specific reason to use a different format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet configuration.<br>
The value set in the <code>transaction-manager</code> attribute should be fixed to <code>jobTransactionManager</code> unless there is a special reason.<br>
This will manage the processes of the entire tasklet in one transaction.
For details, refer to <a href="#">Transaction control</a>.<br>
Resolve Bean definition of <code>jobTransactionManager</code> by (1).<br></p>
<p class="tableblock">Also, <code>ref</code> attribute specifies a Bean ID of Tasklet implementation class to be resolved by (3).<br>
<code>SimpleJobTasklet</code>, the tasklet implementation class name should be <code>simpleJobTasklet</code> with the first letter in lower case.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Bean name when using annotation</div>
<div class="paragraph">
<p>Bean name when using <code>@Component</code> annotation is generated through
<code>org.springframework.context.annotation.AnnotationBeanNameGenerator</code>.
Refer to Javadoc of this class when you want to confirm the naming rules.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_Implements"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_Implements"></a>3.3.2.2. Implementation of tasklet</h5>
<div class="paragraph">
<p>First, understand the overview with simple implementation, then proceed to implementation using the components of the chunk model.</p>
</div>
<div class="paragraph">
<p>It is explained in the following order.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_Implements_Simple">Implementation of simple tasklet</a></p>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob_HowToUse_Implements_InOut">Implementation of tasklet using the components of chunk model</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_Implements_Simple"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_Implements_Simple"></a>3.3.2.3. Implementation of simple tasklet</h5>
<div class="paragraph">
<p>Basic points are explained through tasklet implementation only for log output.</p>
</div>
<div class="listingblock">
<div class="title">Example of simple tasklet implementation class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.functionaltest.app.common</span>;

<span class="comment">// omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleJobTasklet</span> <span class="directive">implements</span> Tasklet { <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SimpleJobTasklet.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {  <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">called tasklet.</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (3)</span>
        <span class="keyword">return</span> RepeatStatus.FINISHED; <span class="comment">// (4)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>org.springframework.batch.core.step.tasklet.Tasklet</code> interface using <code>implements</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>execute</code> method to be defined by <code>Tasklet</code> interface.
Arguments <code>StepContribution</code>, <code>ChunkContext</code> are used however, they are not explained here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement any process. INFO log is output here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return whether or not the tasklet process is completed.<br>
Always specify as <code>return RepeatStatus.FINISHED;</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch03_CreateTaskletJob_HowToUse_Implements_InOut"><a class="anchor" href="#Ch03_CreateTaskletJob_HowToUse_Implements_InOut"></a>3.3.2.4. Implementation of tasklet using the components of chunk model</h5>
<div class="paragraph">
<p>Spring Batch does not mention using various components of chunk model during tasklet implementation.
In TERASOLUNA Batch 5.x, you may select this depending on the following situations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When multiple resources are combined and processed, it is difficult to be as per the chunk model format</p>
</li>
<li>
<p>When processes are implemented at various places in the chunk model, tasklet model is better to understand the overall image easily</p>
</li>
<li>
<p>When recovery is made simple and you want to use batch commit of tasklet model instead of intermediate commit of chunk model</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, processing units should also be considered to implement Tasklet by using components of chunk model.
Following 3 patterns can be considered as units of output records.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Units and features of output records</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 85%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Output records</th>
<th class="tableblock halign-left valign-top">Features</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since data is input, processed and output one by one for each record, processing images is easy.<br>
It must be noted that performance deterioration is likely to occur due to frequent I/O in case of large amount of data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">All records</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data is input and processed one by one for each record and stored in the memory, all records are output together in the end.<br>
Data consistency can be ensured and performance can be improved in case of small amount of data.
However, it must be noted that high load is likely to be applied on resources (CPU, memory) in case of large amount of data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed records</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data is input and processed one by one for each record and stored in the memory, data is output when a certain number of records are reached.<br>
Performance improvement is anticipated by efficiently processing large amount of data with certain resources (CPU, memory).<br>
Also, since the data is processed for a fixed number of records, intermediate commit can also be employed by implementing transaction control.
However, it must be noted that, processed and unprocessed data are likely to exist together in the recovery if the job has terminated abnormally, in case of intermediate commit method.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The tasklet implementation that uses <code> ItemReader</code> and <code> ItemWriter</code> which are the components of the chunk model is explained below.</p>
</div>
<div class="paragraph">
<p>The implementation example shows processing data one by one for each record.</p>
</div>
<div class="listingblock">
<div class="title">Tasklet implementation example that uses the components of chunk model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>()
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanChunkTranTask</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>) <span class="comment">// (2)</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; itemReader; <span class="comment">// (3)</span>

    <span class="annotation">@Inject</span>
    SalesPlanDetailRepository repository; <span class="comment">// (4)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        SalesPlanDetail item;

        <span class="keyword">try</span> {
            itemReader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext()); <span class="comment">// (5)</span>

            <span class="keyword">while</span> ((item = itemReader.read()) != <span class="predefined-constant">null</span>) { <span class="comment">// (6)</span>

                <span class="comment">// do some processes.</span>

                repository.create(item); <span class="comment">// (7)</span>
            }
        } <span class="keyword">finally</span> {
            itemReader.close(); <span class="comment">// (8)</span>
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition example 1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;context:annotation-config</span><span class="tag">/&gt;</span>

<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.plan</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.transaction.component</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.plan</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (10) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (11) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createSalesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createSalesPlanChunkTranTask.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the same step scope as the Bean scope of ItemReader to be used in this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access input resources (flat files in this example) through <code>ItemReader</code>.<br>
Specify Bean name as <code>detailCSVReader</code> but it is optional for clarity purpose.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the type as <code>ItemStreamReader</code> that is sub-interface of <code>ItemReader</code>.<br>
This is because it is necessary to open/close the resource of (5), (8).
It is supplemented later.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access output resources (database in this example) through Mapper of MyBatis.<br>
Mapper is directly used for the sake of simplicity. There is no need to always use <code>ItemWriter</code>.
Of course, <code>MyBatisBatchItemWriter</code> can be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open input resource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop all input resources sequentially.<br>
<code>ItemReader#read</code> returns <code>null</code> when it reads all the input data and reaches the end.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output to database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource should be closed without fail.<br>
Exception handling should be implemented.
When an exception occurs, the transactions of the entire tasklet are rolled-backed,
stack trace of exception is output and the job terminates abnormally.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyBatis-Spring settings.<br>
For details of MyBatis-Spring settings, refer <a href="#Ch05_DBAccess">Database access</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To enter from file, add Bean definition of <code>FlatFileItemReader</code>. The details are not explained here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since all the components are resolved by annotation,<br>
it is same as <a href="#Ch03_CreateTaskletJob_HowToUse_Implements_Simple">Implementation of simple tasklet</a>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">On unification of scope</div>
<div class="paragraph">
<p>The scope of tasklet implementation class and Bean to be Injected should have the same scope.</p>
</div>
<div class="paragraph">
<p>For example,  if <code> FlatFileItemReader</code> receives an input file path from an argument, the Bean scope should be <code> step</code>.
In this case, the scope of tasklet implementation class should also be <code>step</code>.</p>
</div>
<div class="paragraph">
<p>If the scope of tasklet implementation class is set to <code>singleton</code> temporarily,
after instantiating the tasklet implementation class at the time of generating <code>ApplicationContext</code> at application startup
if it tries to Inject by resolving the instance of <code>FlatFileItemReader</code>,
<code>FlatFileItemReader</code> will be in the <code>step</code> scope, however will not exist yet. because it is to be generated at the time of step execution.
As the result, the tasklet implementation class cannot be instantiated and fails to generate <code> ApplicationContext</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Regarding the type of field assigned with @Inject</div>
<div class="paragraph">
<p>Any one of the following type depending on the implementation class to be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemReader/ItemWriter</p>
<div class="ulist">
<ul>
<li>
<p>Used when there is no need to open/close the target resource.</p>
</li>
</ul>
</div>
</li>
<li>
<p>ItemSteamReader/ItemStreamWriter</p>
<div class="ulist">
<ul>
<li>
<p>Used when there is a need to open/close the target resource.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It should be decided which type to use after confirming javadoc. Typical examples are shown below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">In case of FlatFileItemReader/Writer</dt>
<dd>
<p>handle by ItemSteamReader/ItemStreamWriter</p>
</dd>
<dt class="hdlist1">In case of MyBatisCursorItemReader</dt>
<dd>
<p>handle by ItemStreamReader</p>
</dd>
<dt class="hdlist1">In case of MyBatisBatchItemWriter</dt>
<dd>
<p>handle by ItemWriter</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation example imitates a chunk model to process a certain number of records</p>
</div>
<div class="listingblock">
<div class="title">Tasklet implementation example 2 that uses the components of chunk model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {


    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPerformanceDetail&gt; reader;

    <span class="annotation">@Inject</span>
    ItemWriter&lt;SalesPerformanceDetail&gt; writer; <span class="comment">// (1)</span>

    <span class="type">int</span> chunkSize = <span class="integer">10</span>; <span class="comment">// (2)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(chunkSize); <span class="comment">// (2)</span>
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; chunkSize; i++) { <span class="comment">// (3)</span>
                    item = reader.read();
                    <span class="keyword">if</span> (item == <span class="predefined-constant">null</span>) {
                        <span class="keyword">break</span>;
                    }
                    <span class="comment">// Pseudo operation of ItemProcessor</span>
                    <span class="comment">// do some processes.</span>

                    items.add(item);
                }

                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="keyword">if</span> (!items.isEmpty()) {
                    writer.write(items); <span class="comment">// (4)</span>
                    items.clear();
                }
            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition example 2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/job-base-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;context:annotation-config</span><span class="tag">/&gt;</span>
<span class="tag">&lt;context:component-scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.common,</span>
        <span class="content">org.terasoluna.batch.functionaltest.app.performance,</span>
        <span class="content">org.terasoluna.batch.functionaltest.ch06.exceptionhandling</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.performance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.performance.SalesPerformanceDetailRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>


<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfTasklet.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPerformanceTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>MyBatisBatchItemWriter</code> as the implementation of <code>ItemWriter</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code> outputs a fixed number of records collectively.<br>
It processes and output 10 records each.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As per the behavior of chunk model,<br>
it should be read&#8594;process&#8594;read&#8594;process&#8594;&#8230;&#8203;&#8594;write.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output through <code>ItemWriter</code> collectively.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Decide each time whether to use the implementation class of <code>ItemReader</code> or <code>ItemWriter</code>.
For file access, the implementation class of <code>ItemReader</code> and <code>ItemWriter</code> can be used.
For other than this such as database access, there is no need to use compulsorily. It can be used to improve performance.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch03_ChunkOrTasklet"><a class="anchor" href="#Ch03_ChunkOrTasklet"></a>3.4. How to choose chunk model or tasklet model</h3>
<div class="paragraph">
<p>Here, how to choose chunk model and tasklet model is explained by organizing each feature.
Refer to the following chapters which are explained in detail appropriately.</p>
</div>
<div class="paragraph">
<p>Understand the following contents as examples of concepts without any constraints or recommendations.
Refer to it while creating a job depending on the characteristics of the users and systems.</p>
</div>
<div class="paragraph">
<p>The main differences between the chunk model and the tasklet model are given below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Comparison of chunk model and tasklet model.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 45%;">
<col style="width: 45%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Chunk</th>
<th class="tableblock halign-left valign-top">Tasklet</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Components</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It consists of 3 components mainly <code>ItemReader</code>, <code>ItemProcessor</code> and <code>ItemWriter</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is consolidated in one <code>Tasklet</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A certain number of records are processed by issuing intermediate commit. Batch commit cannot be done.<br>
It can be processed by specific machine resources regardless of the data count.<br>
If an error occurs in the midway, then unprocessed data and processed data will get mixed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The data is entirely processed by batch commit. There is a need for the user to implement intermediate commit.<br>
If the data to be processed is large, machine resources may get exhausted.<br>
If an error occurs in the midway, only the unprocessed data is rolled back.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Restart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It can be restarted based on the record count.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It cannot be restarted based on the record count.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Based on this, we will introduce some examples of using each one as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">To make recovery as simple as possible</dt>
<dd>
<p>When the job having error, is to be recovered by only re-running the target job,
tasklet model can be chooseed to make recovery simple.<br>
In chunk model, it should be dealt by returning the processed data
to the state before executing the job and
by creating a job to process only the unprocessed data.</p>
</dd>
<dt class="hdlist1">To consolidate the process contents</dt>
<dd>
<p>When you want to prioritize the outlook of job such as 1 job in 1 class, tasklet can be chooseed.</p>
</dd>
<dt class="hdlist1">To process large data stably</dt>
<dd>
<p>When performing batch process of 10 million records, consider to use chunk model in case the record count that influences the resources is the target.
It means stabilizing the process by intermediate commit.
Even in tasklet model, intermediate commit can be used, but it is simpler to implement in chunk model.</p>
</dd>
<dt class="hdlist1">To restart based on the record count for the recovery after error</dt>
<dd>
<p>When batch window is difficult and you want to resume from error data onwards,
chunk model should be chooseed to use restart based on the record count provided by Spring Batch.
This eliminates the need to create that mechanism for each job.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Chunk model and tasklet model are basically used in combination.<br>
It is not necessary to implement only one model in all jobs in the batch system.<br>
Use one model based on the characteristics of jobs of the entire system and use the other model in accordance with the situation.</p>
</div>
<div class="paragraph">
<p>For example, in most cases it is to choose a tasklet model if there is a margin in the number of processesing records and processing time.
In a very small number of cases, choosing a chunk model for jobs that process large numbers of records.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch04"><a class="anchor" href="#Ch04"></a>4. Running a job</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch04_SyncJob"><a class="anchor" href="#Ch04_SyncJob"></a>4.1. Synchronous job</h3>
<div class="sect3">
<h4 id="Ch04_SyncJob_Overview"><a class="anchor" href="#Ch04_SyncJob_Overview"></a>4.1.1. Overview</h4>
<div class="paragraph">
<p>Synchronous job is explained.
Synchronous job is the execution method of launching a new process through shell by job scheduler and returning the execution result of the job to the caller.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_syncJob_overview.png" alt="overview of sync job">
</div>
<div class="title">Overview of synchronous job</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_syncjob_seq.png" alt="sequence of sync job">
</div>
<div class="title">Sequence of synchronous job</div>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_SyncJob_HowToUse"><a class="anchor" href="#Ch04_SyncJob_HowToUse"></a>4.1.2. How to use</h4>
<div class="paragraph">
<p>How to running a job by <code>CommandLineJobRunner</code> is explained.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="#Ch03_CreateProject">Create project</a> for building and executing the application.
Refer to <a href="#">Job parameters</a> for how to specify and use job parameters.
Some explanation given in the above reference and in this section overlap however, the elements of synchronous job are mainly explained.</p>
</div>
<div class="sect4">
<h5 id="Ch04_SyncJob_HowToUse_Run"><a class="anchor" href="#Ch04_SyncJob_HowToUse_Run"></a>4.1.2.1. How to run</h5>
<div class="paragraph">
<p>In TERASOLUNA Batch 5.x, run the synchronous job using <code>CommandLineJobRunner</code> provided by Spring Batch.
Start <code>CommandLineJobRunner</code> by issuing java command as shown below.</p>
</div>
<div id="Ch04_SyncJob_HowToUse_Run_Syntax" class="listingblock">
<div class="title">CommandLineJobRunner syntax</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;options&gt; &lt;jobIdentifier&gt; &lt;jobParameters&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items to be specified by the arguments</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 80%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Items to be specified</th>
<th class="tableblock halign-left valign-top">Explanation</th>
<th class="tableblock halign-left valign-top">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobPath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file path where the settings of the job to be run are described. Specify by relative path from classpath.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">options</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify various options (stop, restart etc.) at the time of launching.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobIdentifier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify job name in Bean definition or job run ID after job execution as the job identifier.
Normally, specify job name. Specify job run ID only when specifying stop and restart options.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jobParameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify job arguments. Specify in <code>key=value</code> format.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The execution example when only the required items are specified, is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Execution example 1 of CommandLineJobRunner</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -cp 'target/[artifactId]-[version].jar:lib/*' \ # (1)
    org.springframework.batch.core.launch.support.CommandLineJobRunner \ # (2)
    META-INF/jobs/job01.xml job01 # (3)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Settings of Bean definition(Abstract)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">employeeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the batch application jar and dependent jar in <code>classpath</code> at the time of executing <code>java</code> command.
 Here, it is specified by command arguments however, environment variables can also be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>CommandLineJobRunner</code> with FQCN in the class to be run.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass the run arguments along the <code>CommandLineJobRunner</code>.
Here, 2 job names are specified as <code>jobPath</code> and <code>jobIdentifier</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Execution example when launch parameters are specified as the optional items, is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Execution example 2 of CommandLineJobRunner</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ java -cp 'target/[artifactId]-[version].jar:lib/*' \
    org.springframework.batch.core.launch.support.CommandLineJobRunner \
    META-INF/jobs/setupJob.xml setupJob target=server1 outputFile=/tmp/result.csv # (1)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>target=server1</code> and <code>outputFile=/tmp/result.csv</code> are specified as job running parameters.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_SyncJob_HowToUse_Options"><a class="anchor" href="#Ch04_SyncJob_HowToUse_Options"></a>4.1.2.2. Options</h5>
<div class="paragraph">
<p>Supplement the options indicated in <a href="#Ch04_SyncJob_HowToUse_Run_Syntax">CommandLineJobRunner syntax</a>.</p>
</div>
<div class="paragraph">
<p>In <code>CommandLineJobRunner</code>, the following 4 launch options can be used.
Here, only the overview of each option is explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-restart</dt>
<dd>
<p>Restarts the failed job. Refer to <a href="#">Reprocessing</a> for the details.</p>
</dd>
<dt class="hdlist1">-stop</dt>
<dd>
<p>Stops a running job. Refer to <a href="#">Job management</a> for the details.</p>
</dd>
<dt class="hdlist1">-abandon</dt>
<dd>
<p>Abandons a stopped job. The abandoned job cannot be restarted.
In TERASOLUNA Batch 5.x, there is no case of using this option, hence it is not explained.</p>
</dd>
<dt class="hdlist1">-next</dt>
<dd>
<p>Runs the job executed once in the past, again. However, in TERASOLUNA Batch 5.x, this option is not used.<br>
In TERASOLUNA Batch 5.x, it is for avoiding the restriction "Running the job by the same parameter is recognized as the same job and the same job can be executed only once"
that is given by default in Spring Batch.<br>
The details are explained in <a href="#Ch04_JobParameter_HowToUse_Converter">regarding parameter conversion class</a>.<br>
For using this option, implementation class of <code>JobParametersIncrementer</code> interface is required,
it is not set inTERASOLUNA Batch 5.x.<br>
Therefore, when this option is specified and launched, an error occurs because the required Bean definition does not exist.</p>
</dd>
</dl>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_JobParameter"><a class="anchor" href="#Ch04_JobParameter"></a>4.2. Job parameters</h3>
<div class="sect3">
<h4 id="Ch04_JobParameter_Overview"><a class="anchor" href="#Ch04_JobParameter_Overview"></a>4.2.1. Overview</h4>
<div class="paragraph">
<p>This section explains about using the job parameter (hereafter referred to as 'parameter').</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="paragraph">
<p>A parameter is used to flexibly switch the operation of the job according to the execution environment and execution timing as shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>File path of process target</p>
</li>
<li>
<p>System operation date and time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following explanation is about assigning parameters.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch04_JobParameter_HowToUse_CLIArgs">Assign from command-line arguments</a></p>
</li>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_FromFile">Redirect from file to standard input</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The specified parameters can be referred in Bean definition or in Java under Spring management.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_JobParameter_HowToUse"><a class="anchor" href="#Ch04_JobParameter_HowToUse"></a>4.2.2. How to use</h4>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_Converter"><a class="anchor" href="#Ch04_JobParameter_HowToUse_Converter"></a>4.2.2.1. Regarding parameter conversion class</h5>
<div class="paragraph">
<p>In Spring Batch, the received parameters are processed in the following sequence.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The implementation class of <code>JobParametersConverter</code> convert to <code>JobParameters</code>.</p>
</li>
<li>
<p>Refer to the parameters from <code>JobParameters</code> in Bean definition and Java under Spring management.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Regarding implementation class of parameter conversion class</div>
<p>Multiple implementation classes of the above mentioned <code>JobParametersConverter</code> are provided.
The features of each class are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DefaultJobParametersConverter</p>
<div class="ulist">
<ul>
<li>
<p>It can specify the data type of parameters(4 types; String, Long, Date, Double).</p>
</li>
</ul>
</div>
</li>
<li>
<p>JsrJobParametersConverter</p>
<div class="ulist">
<ul>
<li>
<p>It cannot specify the data type of parameters (Only String).</p>
</li>
<li>
<p>It assigns ID (RUN_ID) that identifies job execution to parameter with the name <code>jsr_batch_run_id</code> automatically.</p>
<div class="ulist">
<ul>
<li>
<p>It increments the RUN_ID each time the job is executed. Since it uses SEQUENCE (name is <code> JOB_SEQ</code>) of the database for incrementing, the name does not overlap.</p>
</li>
<li>
<p>In Spring Batch, runnaing the job by the same parameters is identified as the same job and the same job can be executed only once.
Whereas, adding a unique value to the parameter name <code>jsr_batch_run_id</code> will recognize it as a separate job.
Refer to <a href="#Ch02_SpringBatchArch">Spring Batch architecture</a> for details.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Spring Batch, when the implementation class of <code>JobParametersConverter</code> to be used in Bean definition, is not specified, <code>DefaultJobParametersConverter</code> is used.<br>
However, in TERASOLUNA Batch 5.x, <code>DefaultJobParametersConverter</code> is not used due to the following reasons.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is common to run one job by the same parameter at different timing.</p>
</li>
<li>
<p>It is possible to specify the time stamp of the start time and manage them as different jobs, but it is complicated to specify job parameters only for that purpose.</p>
</li>
<li>
<p><code>DefaultJobParametersConverter</code> can specify data types for parameters, but handling becomes complicated when type conversion fails.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In TERASOLUNA Batch 5.x, by using <code>JsrJobParametersConverter</code>, RUN_ID is automatically assigned without the user knowledge.
By this, the same job is handled as a different job in Spring Batch as seen by the user.</p>
</div>
<div class="paragraph">
<div class="title">About setting of parameter conversion class</div>
<p>In TERASOLUNA Batch 5.x, it is set in advance so as to use <code>JsrJobParametersConverter</code> in <code>launch-context.xml</code>.<br>
Therefore, when TERASOLUNA Batch 5.x is used with the recommended setting, there is no need to set <code> JobParametersConverter</code>.</p>
</div>
<div class="listingblock">
<div class="title">META-INF\spring\launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.jsr.JsrJobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobOperator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobExplorer-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExplorer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobParametersConverter-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobLauncher-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following description assumes that JsrJobParametersConverter is used.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_CLIArgs"><a class="anchor" href="#Ch04_JobParameter_HowToUse_CLIArgs"></a>4.2.2.2. Assign from command-line arguments</h5>
<div class="paragraph">
<p>Firstly, how to assign from the most basic command-line arguments, is explained.</p>
</div>
<div class="paragraph">
<div class="title">Assignment of parameters</div>
<p>Command-line arguments are enumerated in the <code>&lt;Parameter name&gt;=&lt;Value&gt;</code> format after 3rd argument of <code>CommandLineJobRunner</code>.</p>
</div>
<div class="paragraph">
<p>The number and length of parameters are not restricted in Spring Batch and {batch 5 _ shortname}.
However, there are restrictions in the length of command arguments in the OS.<br>
Therefore, when a large number of arguments is required, the method of <a href="#Ch04_JobParameter_HowToUse_FromFile">Redirect from file to standard input</a> and
<a href="#Ch04_JobParameter_HowToExtends_PropertyConbination">Using parameters and properties together</a> should be used.</p>
</div>
<div class="listingblock">
<div class="title">Example of setting parameters as command-line arguments</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=abc outputFileName=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Refer to parameters</div>
<p>Parameters can be referred in Bean definition or in Java as shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Refer in Bean definition</p>
<div class="ulist">
<ul>
<li>
<p>It can be referred by <code>#{jobParameters['xxx']}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Refer in Java</p>
<div class="ulist">
<ul>
<li>
<p>It can be referred by <code>@Value("#{jobParameters['xxx']}")</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">The scope of the Bean that refers to JobParameters should be Step scope</div>
<div class="paragraph">
<p>When referring to <code> JobParameters</code>, the scope of the Bean to be referred should be set to <code> Step</code> scope.
This is for using the mechanism of <strong>late binding</strong> of Spring Batch when <code> JobParameters</code> is to be referred.</p>
</div>
<div class="paragraph">
<p>As its name implies, <strong>late binding</strong> is setting of the delayed value.
<code> ApplicationContext</code> of Spring Framework generates an instance of <code> ApplicationContext</code> after resolving the properties of various Beans by default.
Spring Batch does not resolve the property at the time of generating an instance of <code> ApplicationContext</code>. It has a function
to resolve the property when various Beans are required. This is what the word <strong>Delay</strong> means.
With this function, after generating and executing <code> ApplicationContext</code> required for executing the Spring Batch itself,
it is possible to alter the behavior of various Beans according to parameters.</p>
</div>
<div class="paragraph">
<p><code>Step</code> scope is a unique scope of Spring Batch and a new instance is generated for each Step execution.
The value with <strong>late binding</strong> can be resolved by using SpEL expression in Bean definition.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">@StepScope annotation cannot be used for specifying Step scope</div>
<div class="paragraph">
<p>In Spring Batch, <code>@StepScope</code> is provided as the annotation that specifies <code>Step</code> scope. However,
this is an annotation that can only be used in JavaConfig.</p>
</div>
<div class="paragraph">
<p>Therefore, specify the  <code> Step</code> scope in TERASOLUNA Batch 5.x by any one of the following methods.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In Bean definition, assign <code>scope="step"</code> to Bean.</p>
</li>
<li>
<p>In Java, assign <code>@Scope("step")</code> to class.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example of referring to the parameter assigned by the command-line arguments in Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify scope as scope attribute in bean tag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameter to be referred.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example of referring to the parameter assigned by the command-line arguments in Java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ParamRefInJavaTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">/**
     * Holds a String type value
     */</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['str']}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> str;

    <span class="comment">// omitted execute()</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify scope by assigning <code>@Scope</code> annotation in class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameter to be referred by using <code>@Value</code> annotation.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_FromFile"><a class="anchor" href="#Ch04_JobParameter_HowToUse_FromFile"></a>4.2.2.3. Redirect from file to standard input</h5>
<div class="paragraph">
<p>How to redirect from file to standard input is explained.</p>
</div>
<div class="paragraph">
<div class="title">Creation of file for defining parameters</div>
<p>Define the parameters in the files as follows.</p>
</div>
<div class="listingblock">
<div class="title">params.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">param1=abc
outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Redirect the files wherein parameters are defined to standard input</div>
<p>Redirect the files wherein parameters are defined as command-line arguments.</p>
</div>
<div class="listingblock">
<div class="title">Execution method</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID &lt; params.txt</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Refer to parameters</div>
<p>How to refer to the parameters is same as the <a href="#Ch04_JobParameter_HowToUse_CLIArgs">Assign from command-line arguments</a> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_DefaultValue"><a class="anchor" href="#Ch04_JobParameter_HowToUse_DefaultValue"></a>4.2.2.4. Set the default value of parameter</h5>
<div class="paragraph">
<p>When parameters are optional, default values can be set in the following format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#{jobParameters['Parameter name'] ?: Default value}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, in the item where the value is set using parameters, the default values can also differ with the environment and execution timing  same as the parameters.</p>
</div>
<div class="paragraph">
<p>Firstly, how to hardcode the default values in source code is explained.
However, there are many cases where it is better to use <a href="#Ch04_JobParameter_HowToExtends_PropertyConbination">Using parameters and properties together</a>, so refer them also.</p>
</div>
<div class="paragraph">
<div class="title">Refer to the parameter wherein default value is set</div>
<p>When the relevant parameter is not set, the value set as the default value is referred.</p>
</div>
<div class="listingblock">
<div class="title">Example of referring to the parameter assigned by the command-line arguments in Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParamaters[inputFile] ?: /input/sample.csv}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        // omitted settings
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the scope as scope attribute in the bean tag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameter to be referred.<br>
<code>/input/sample.csv</code> is set as the default value.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example of referring to the parameter assigned by the command-line arguments in Java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ParamRefInJavaTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">/**
     * Holds a String type value
     */</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['str'] ?: 'xyz'}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> str;

    <span class="comment">// omitted execute()</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the scope by assigning <code>@Scope</code> annotation in class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameter to be referred by using <code>@Value</code> annotation.<br>
<code>xyz</code> is set as the default value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToUse_ParamsValidation"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation"></a>4.2.2.5. Validation of parameters</h5>
<div class="paragraph">
<p>Validation of the parameters is required at job launch in order to prevent operation errors or unintended behavior.<br>
Validation of parameters can be implemented by using the <code>JobParametersValidator</code> provided by Spring Batch.</p>
</div>
<div class="paragraph">
<p>Since parameters are referred at various places such as ItemReader/ItemProcessor/ItemWriter,
validation is performed immediately after the job is launched.</p>
</div>
<div class="paragraph">
<p>There are two ways to verify the validity of a parameter, and it differs with the degree of complexity of the verification.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default">Simple validation</a></p>
<div class="ulist">
<ul>
<li>
<p>Application example</p>
<div class="ulist">
<ul>
<li>
<p>Verify that the required parameters are set</p>
</li>
<li>
<p>Verify that the unspecified parameters are not set</p>
</li>
</ul>
</div>
</li>
<li>
<p>Validator to be used</p>
<div class="ulist">
<ul>
<li>
<p><code>DefaultJobParametersValidator</code> provided by Spring Batch</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin">Complex validation</a></p>
<div class="ulist">
<ul>
<li>
<p>Application example</p>
<div class="ulist">
<ul>
<li>
<p>Numerical value range verification and complex verification such as correlation check between parameters</p>
</li>
<li>
<p>Verification that cannot be done by <code>DefaultJobParametersValidator</code> provided by Spring Batch</p>
</li>
</ul>
</div>
</li>
<li>
<p>Validator to be used</p>
<div class="ulist">
<ul>
<li>
<p>Class wherein <code>JobParametersValidator</code> is implemented independently</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to verify the validity of <a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default">Simple validation</a> and <a href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin">Complex validation</a> is explained respectively.</p>
</div>
<div class="sect5">
<h6 id="Ch04_JobParameter_HowToUse_ParamsValidation_Default"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation_Default"></a>4.2.2.5.1. Simple validation</h6>
<div class="paragraph">
<p>Spring Batch provides <code>DefaultJobParametersValidator</code> as the default implementation of <code>JobParametersValidator</code>.<br>
This validator can verify the following as per the settings.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Required parameters should be set</p>
</li>
<li>
<p>Parameters other than required or optional should not be specified</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Definition example is shown as follows.</p>
</div>
<div class="listingblock">
<div class="title">Definition of validation that uses DefaultJobParametersValidator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requiredKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>jsr_batch_run_id<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;value&gt;</span>inputFileName<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>outputFileName<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optionalKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>param1<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>param2<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseDefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseDefaultJobParametersValidator.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
  <span class="tag">&lt;batch:validator</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Bean for <code>DefaultJobParametersValidator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the required parameters to property <code>requiredKeys</code>.<br>
Multiple parameter names of the required parameters can be specified using list tag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>jsr_batch_run_id</code> to the required parameters.<br>
In TERASOLUNA Batch 5.x, this setting is mandatory when using <code>DefaultJobParametersValidator</code>.<br>
The reason for making the setting mandatory is explained later.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set optional parameters to property <code>optionalKeys</code>.<br>
Multiple parameter names of the optional parameters can be specified using list tag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apply the validator to the job using validator tag in the job tag.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Required parameters that cannot be omitted in TERASOLUNA Batch 5.x</div>
<div class="paragraph">
<p><code> JsrJobParametersConverter</code> is used for parameter conversion in {batch 5 _ shortname}, so the following parameters are always set.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jsr_batch_run_id</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, <code>jsr_batch_run_id</code> should be included in the <code>requiredKeys</code>.<br>
Refer to <a href="#Ch04_JobParameter_HowToUse_Converter">Regarding parameter conversion class</a> for detailed explanation.</p>
</div>
<div class="listingblock">
<div class="title">Example of parameter definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">requiredKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>jsr_batch_run_id<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- mandatory --&gt;</span>
        <span class="tag">&lt;value&gt;</span>inputFileName<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>outputFileName<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optionalKeys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
        <span class="tag">&lt;value&gt;</span>param1<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>param2<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">OK case and NG case when DefaultJobParametersValidator is used</div>
<p>An example when the verification result is OK and NG are shown to understand the verification possible conditions in <code>DefaultJobParametersValidator</code>.</p>
</div>
<div class="listingblock">
<div class="title">DefaultJobParametersValidator definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobParametersValidator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.job.DefaultJobParametersValidator</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:requiredKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputFileName</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:optionalKeys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">param1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NG case1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=aaa</code></pre>
</div>
</div>
<div class="paragraph">
<p>NG as the required parameter <code>outputFile</code> is not set.</p>
</div>
<div class="listingblock">
<div class="title">NG case 2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID outputFileName=/tmp/result.csv param2=aaa</code></pre>
</div>
</div>
<div class="paragraph">
<p>NG as the parameter <code> param2</code> which is not specified for either the required parameter or the optional parameter is set.</p>
</div>
<div class="listingblock">
<div class="title">OK case 1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=aaa outputFileName=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK as the parameters specified as required and optional are set.</p>
</div>
<div class="listingblock">
<div class="title">OK case 2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID fileoutputFilename=/tmp/result.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK as the required parameters are set and there is no need to set optional parameters.</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_JobParameter_HowToUse_ParamsValidation_Origin"><a class="anchor" href="#Ch04_JobParameter_HowToUse_ParamsValidation_Origin"></a>4.2.2.5.2. Complex validation</h6>
<div class="paragraph">
<p>Implementing <code>JobParametersValidator</code> interface independently
helps in verifying the parameters as per requirements.</p>
</div>
<div class="paragraph">
<p>Implement <code>JobParametersValidator</code> class as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>JobParametersValidator</code> class and override validate method</p>
</li>
<li>
<p>Implement validate method as follows</p>
<div class="ulist">
<ul>
<li>
<p>Fetch each parameter from <code>JobParameters</code> and verify</p>
<div class="ulist">
<ul>
<li>
<p>If the verification result is OK, there is no need to perform any operation</p>
</li>
<li>
<p>If verification result is NG, throw <code>JobParametersInvalidException</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementation example of <code>JobParametersValidator</code> class is shown.
In this case, it is verified that the length of the string specified by <code> str</code> is less than or equal to the number specified by <code> num</code>.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of JobParametersValidator interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ComplexJobParametersValidator</span> <span class="directive">implements</span> JobParametersValidator {  <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> validate(JobParameters parameters) <span class="directive">throws</span> JobParametersInvalidException {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, JobParameter&gt; params = parameters.getParameters();  <span class="comment">// (2)</span>

        <span class="predefined-type">String</span> str = params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">str</span><span class="delimiter">&quot;</span></span>).getValue().toString();  <span class="comment">// (3)</span>
        <span class="type">int</span> num = <span class="predefined-type">Integer</span>.parseInt(params.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">num</span><span class="delimiter">&quot;</span></span>).getValue().toString()); <span class="comment">// (4)</span>

        <span class="keyword">if</span>(str.length() &gt; num){
            <span class="keyword">throw</span> <span class="keyword">new</span> JobParametersInvalidException(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">The str must be less than or equal to num. [str:</span><span class="delimiter">&quot;</span></span>
                    + str + <span class="string"><span class="delimiter">&quot;</span><span class="content">][num:</span><span class="delimiter">&quot;</span></span> + num + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (5)</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>JobParametersValidator</code> class and override validate method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive the parameters as arguments in <code>JobParameters</code> type.<br>
By setting <code>parameters.getParameters()</code>, it is easier to refer the parameters by fetching them in Map format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get parameters by specifying key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert parameters to int type. When handling parameters of other than String type, they should be appropriately converted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation result is NG when the string length of the parameter <code>str</code> exceeds the value of parameter <code>num</code>.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Job definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseComplexJobParametersValidator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobUseComplexJobParametersValidator.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sampleTasklet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:validator&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch04.jobparameter.ComplexJobParametersValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:validator&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apply validator in the job by using validator tag in the job tag.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Regarding validation of parameters at asynchronous start</div>
<div class="paragraph">
<p>By the asynchronous start method (DB polling and Web container), it is possible to verify the parameters at the job launch in the same way,
however, it is desirable to verify them before launching the job at the following timing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DB polling</p>
<div class="ulist">
<ul>
<li>
<p>Before INSERTing to job request table</p>
</li>
</ul>
</div>
</li>
<li>
<p>Web container</p>
<div class="ulist">
<ul>
<li>
<p>At the time of calling Controller (assign @Validated)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In case of asynchronous start, since it is necessary to confirm the result separately, errors such as parameter settings
should be responded quickly and job requests should be rejected.</p>
</div>
<div class="paragraph">
<p>For validation in this case, there is no need to use <code>JobParametersValidator</code>.
The function to INSERT to the job request table and the controller in the Web container
mostly should not depend on Spring Batch and
it is better to avoid depending on Spring Batch since only <code>JobParametersValidator</code> is used.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_JobParameter_HowToExtends"><a class="anchor" href="#Ch04_JobParameter_HowToExtends"></a>4.2.3. How to extend</h4>
<div class="sect4">
<h5 id="Ch04_JobParameter_HowToExtends_PropertyConbination"><a class="anchor" href="#Ch04_JobParameter_HowToExtends_PropertyConbination"></a>4.2.3.1. Using parameters and properties together</h5>
<div class="paragraph">
<p>Spring Framework based on Spring Batch is equipped with the property management function to enable it
to handle the values set in the environment variables and property files.
For details, refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/GeneralFuncDetail/PropertyManagement.html">Property management</a> of TERASOLUNA Server 5.x Development Guideline.</p>
</div>
<div class="paragraph">
<p>By combining properties and parameters, it is possible to overwrite some parameters after making common settings for most jobs in the property file.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About when parameters and propertis are resolved</div>
<div class="paragraph">
<p>As mentioned above, parameters and properties are different components that provide the function.<br>
Spring Batch has a function of parameter management and Spring Framework has a function of property management.<br>
This difference appears in the description method.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In case of function possessed by Spring Batch</p>
<div class="ulist">
<ul>
<li>
<p><code>#{jobParamaters[xxx]}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>In case of function possessed by Spring Framework</p>
<div class="ulist">
<ul>
<li>
<p><code>@Value("${xxx}")</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The timing of resolving each value is different.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In case of function possessed by Spring Batch</p>
<div class="ulist">
<ul>
<li>
<p>It is set when the job is executed after generating Application Context.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In case of function possessed by Spring Framework</p>
<div class="ulist">
<ul>
<li>
<p>It is set at the time of generating Application Context.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, the parameter value is given priority by Spring Batch.<br>
Note that since the application is effective when they are combined together, both of them should be treated individually</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How to set by combining properties and parameters, is explained.</p>
</div>
<div class="paragraph">
<div class="title">In addition to the setting by environment variables, when additional settings is done by command-line arguments</div>
<p>In addition to the setting by environment variables, how to set the parameters using command-line arguments, is explained.<br>
It is possible to refer to it in the same manner as Bean definition.</p>
</div>
<div class="listingblock">
<div class="title">Example of setting parameters by command-line arguments in addition to environment variables</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export env1=aaa
$ export env2=bbb

# Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param3=ccc outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of referring environment variables and parameters in Java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env1}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">private</span> <span class="predefined-type">String</span> param1;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env2}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">private</span> <span class="predefined-type">String</span> param2;

<span class="directive">private</span> <span class="predefined-type">String</span> param3;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param3']</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">void</span> setParam3(<span class="predefined-type">String</span> param3) {
    <span class="local-variable">this</span>.param3 = param3;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the environment variables to be referred by using <code>@Value</code> annotation.<br>
The format for reference is <code>${Environment variable name}</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameters to be referred by using <code>@Value</code> annotation.<br>
The format for reference is <code>#{jobParameters['Parameter name']</code>.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example when environment variables are default</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export env1=aaa

# Execute job
$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    JobDefined.xml JOBID param1=bbb outputFile=/tmp/result.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of referring parameters by setting default values for environment variables in Java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param1'] ?: '${env1}'}</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">void</span> setParam1(<span class="predefined-type">String</span> param1) {
    <span class="local-variable">this</span>.param1 = param1;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Items list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the parameters to be referred by using <code>@Value</code> annotation by setting default values in environment variables.<br>
When parameters are not set, the value of environment variables are set.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">How to set incorrect default values</div>
<div class="paragraph">
<p>When the following is defined and param1 is not set by command-line arguments,
note that null is set in param1 irrespective of the fact that you want to set env1 value.</p>
</div>
<div class="listingblock">
<div class="title">Setting method example of incorrect default value</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">${env1}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">String</span> param1;

<span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['param1']}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">void</span> setParam1(<span class="predefined-type">String</span> param1) {
  <span class="local-variable">this</span>.param1 = param1;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_AsyncJobWithDB"><a class="anchor" href="#Ch04_AsyncJobWithDB"></a>4.3. Asynchronous execution (DB polling)</h3>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Overview"><a class="anchor" href="#Ch04_AsyncJobWithDB_Overview"></a>4.3.1. Overview</h4>
<div class="paragraph">
<p>Running a job using DB polling is explained.</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="sect4">
<h5 id="what-is-asynchronous-execution-by-using-db-polling"><a class="anchor" href="#what-is-asynchronous-execution-by-using-db-polling"></a>4.3.1.1. What is asynchronous execution by using DB polling?</h5>
<div class="paragraph">
<p>A dedicated table which registers jobs to be executed asynchronously (hereafter referred to as Job-request-table) is monitored periodically and job is asynchronously executed based on the registered information.<br>
In TERASOLUNA Batch 5.x, a module which monitors the table and starts the job is defined with the name asynchronous batch daemon.
Asynchronous batch daemon runs as a single Java process and executes by assigning threads in the process for each job.</p>
</div>
<div class="sect5">
<h6 id="functions-offered-by-terasoluna-batch-5-x"><a class="anchor" href="#functions-offered-by-terasoluna-batch-5-x"></a>4.3.1.1.1. Functions offered by TERASOLUNA Batch 5.x</h6>
<div class="paragraph">
<p>TERASOLUNA Batch 5.x offers following functions as <strong>Asynchronous execution (DB polling)</strong>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of asynchronous execution (DB polling) functions</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asynchronous batch daemon function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A function which permanently executes Job-request-table polling function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job-request-table polling function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A function which asynchronously executes the job based on information registered in the Job-request-table.<br>
It also offers a table definition of Job-request-table.</p></td>
</tr>
</tbody>
</table>
<div class="sect6">
<h7 id="usage-premise"><a class="anchor" href="#usage-premise"></a>Usage premise</h7>
<div class="paragraph">
<p>Only job requests are managed in Job-request-table. Execution status and results of requested job is entrusted to <code>JobRepository</code>.
It is assumed that job status is managed through these two factors.<br></p>
</div>
<div class="paragraph">
<p>Further, if in-memory database is used in <code>JobRepository</code>, <code>JobRepository</code> is cleared after terminating asynchronous batch daemon and job execution status and results cannot be referred.
Hence, it is assumed that a database that is ensured to be persistent is used in <code>JobRepository</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Using in-memory database</div>
<div class="paragraph">
<p>When job execution results success or failure can be obtained without referring <code>JobRepository</code>, in-memory database can be used.<br>
When long term continuous operations are performed in in-memory database, a large quantity of memory resources are likely to get consumed resulting in adverse effect on job execution.<br>
In other words, in-memory database is not suitable for long term continuous operations and should be restarted periodically.<br>
However, if it is to be used for long term continuous operations, maintenance work like deleting data periodically from <code>JobRepository</code> is necessary.<br>
In case of a restart, if initialization is enabled, it gets recreated at the time of restart. Hence, maintenance is not required.
For initialization, refer <a href="#Ch03_CreateProject_Make_Setting_DB">Database related settings</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="usage-scene"><a class="anchor" href="#usage-scene"></a>4.3.1.1.2. Usage scene</h6>
<div class="paragraph">
<p>A few scenes which use asynchronous execution (DB polling).</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of application scenes</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Usage scene</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delayed processing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When it is not necessary to complete the operation immediately in coordination with online processing and the operation which takes time to process is to be extracted as a job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Continuous execution of jobs with short processing time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When continuous processing is done for a few seconds or a few tens of seconds for 1 job.<br>
It is possible to avoid compression of resources by start and stop of Java process for 1 job, by using asynchronous execution (DB polling).
Further, since it leads to omission of start and end processing, it is possible to reduce execution time of the job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregation of large number of jobs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as continuous execution of jobs with short processing time.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Points to choose asynchronous execution(DB polling) instead of asynchronous execution (Web container)</div>
<div class="paragraph">
<p>Points to choose asynchronous execution(DB polling) instead of <a href="#Ch04_AsyncJobWithWeb">"Asynchronous execution (Web container)"</a> are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A hurdle in the introduction of WebAP server in batch processing</p>
</li>
<li>
<p>Consider only database while ensuring availability</p>
<div class="ulist">
<ul>
<li>
<p>Alternatively, since the access is concentrated in the database, scale is not likely to be like asynchronous execution (Web container).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Reasons not to use Spring Batch Integration</div>
<div class="paragraph">
<p>The same function can be implemented by using Spring Batch Integration.<br>
However, when Spring Batch Integration is used, it is necessary to understand and fetch technical elements including the elements other than that of asynchronous execution.<br>
Accordingly, application of Spring Batch Integration is deferred in order to avoid difficulty in understanding / use / customization of this function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Precautions in asynchronous execution (DB polling)</div>
<div class="paragraph">
<p>When a large number of super short batches which are less than several seconds for 1 job are to be executed, database including <code>JobRepository</code> is accessed every time.
Since performance degradation can occur at this point of time, mass processing of super short batches is not suitable for asynchronous execution (DB polling).
This point must be adequately reviewed while using this function to check whether target performance is met.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Arch"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch"></a>4.3.2. Architecture</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Sequence"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Sequence"></a>4.3.2.1. Processing sequence of DB polling</h5>
<div class="paragraph">
<p>Processing sequence of DB polling is explained.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithDB_Sequence_db_polling.png" alt="sequence of DB polling">
</div>
<div class="title">Processing sequence diagram of DB polling</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch <code>AsyncBatchDaemon</code> from sh etc.</p>
</li>
<li>
<p><code>AsyncBatchDaemon</code> reads all Bean definition files which defines the jobs at the startup.</p>
</li>
<li>
<p><code>AsyncBatchDaemon</code> starts <code>TaskScheduler</code> for polling at regular intervals.</p>
<div class="ulist">
<ul>
<li>
<p><code>TaskScheduler</code> starts a specific process at regular interval.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>TaskScheduler</code> starts <code>JobRequestPollTask</code> (a process which performs polling of Job-request-table).</p>
</li>
<li>
<p><code>JobRequestPollTask</code> fetches a record for which the polling status is "not executed" (INIT), from Job-request-table.</p>
<div class="ulist">
<ul>
<li>
<p>Fetch a fixed number of records collectively. Default is 3 records.</p>
</li>
<li>
<p>When the target record does not exist, perform polling at regular intervals. Default is 5 seconds interval.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>JobRequestPollTask</code> allocates jobs to thread and executes them based on information of records.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> updates polling status of the Job-request-table to "polled" (POLLED).</p>
<div class="ulist">
<ul>
<li>
<p>When number of synchronous execution jobs is achieved, the record which cannot be activated from the fetched records is discarded and the record is fetched again at the time of next polling process.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Job assigned to the thread run a job with <code>JobOperator</code>.</p>
</li>
<li>
<p>Fetch job execution ID of executed jobs (Job execution id).</p>
</li>
<li>
<p><code>JobRequestPollTask</code> updates the polling status of the Job-request-table to "Executed" (EXECUTED) based on job execution ID fetched at the time of job execution.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Supplement of processing sequence</div>
<div class="paragraph">
<p>Spring Batch reference shows that asynchronous execution can be implemented by setting <code>AsyncTaskExecutor</code> in <code>JobLauncher</code>.
However, when this method is adopted, <code>AsyncTaskExecutor</code> cannot detect the state wherein job execution cannot be performed.
This issue occurs when there is no thread assigned to the  job and it is likely to lead to following events.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Even though the job cannot be executed, it tries to run the job and continues to perform unnecessary operation.</p>
</li>
<li>
<p>The job does not run in the polling sequence but appears to be started randomly on the Job-request-table depending on the time when the thread is free.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The processing sequence described earlier is used in order to avoid this phenomenon.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_RequireTable"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_RequireTable"></a>4.3.2.2. About the table to be polled</h5>
<div class="paragraph">
<p>Explanation is given about table which performs polling in asynchronous execution (DB polling).</p>
</div>
<div class="paragraph">
<p>Following database objects are necessary.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job-request-table (Required)</p>
</li>
<li>
<p>Job sequence (Required for some database products)</p>
<div class="ulist">
<ul>
<li>
<p>It is necessary when database does not support auto-numbering of columns.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="job-request-table-structure"><a class="anchor" href="#job-request-table-structure"></a>4.3.2.2.1. Job-request-table structure</h6>
<div class="paragraph">
<p>PostgreSQL from database products corresponding to TERASOLUNA Batch 5.x is shown.
For other databases, refer DDL included in jar of TERASOLUNA Batch 5.x.</p>
</div>
<div class="olist IMPORTANT">
<ol class="IMPORTANT">
<li>
<p>Regarding character string stored in the job request table</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Similar to meta data table, job request table column provides a DDL which explicitly sets character data type in character count definition.</p>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">batch_job_request (In case of PostgreSQL)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column Name</th>
<th class="tableblock halign-left valign-top">Data type</th>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_seq_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigserial</p>
<p class="tableblock">(Use bigint to define a separate sequence)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL<br>
PRIMARY KEY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A number to determine the sequence of jobs to be executed at the time of polling.<br>
Use auto-numbering function of database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(100)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job name to be executed.<br>
Required parameters for job execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(200)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameters to be passed to jobs to be executed.</p>
<p class="tableblock">Single parameter format is same as synchronous execution, however, when multiple parameters are to be specified,
each parameter must be separated by a comma (see below) unlike blank delimiters of synchronous execution.<br></p>
<p class="tableblock">{Parameter name}={parameter value},{Parameter name}={Parameter value}&#8230;&#8203;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">job_execution_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bigint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID to be paid out at the time of job execution.<br>
Refer <code>JobRepository</code> using ID as a key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polling_status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Polling process status.<br>
INIT : Not executed<br>
POLLED: Polled<br>
EXECUTED : Job executed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time when the record of the job request is registered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update_date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date and time when the record of job request is updated.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>DDL is as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="job-request-sequence-structure"><a class="anchor" href="#job-request-sequence-structure"></a>4.3.2.2.2. Job request sequence structure</h6>
<div class="paragraph">
<p>When the database does not support auto-numbering of database columns, numbering according to sequence is required.<br>
A PostgreSQL from database products corresponding to TERASOLUNA Batch 5.x is shown.<br>
For other databases, refer DDL included in jar of TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>DDL is as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> SEQUENCE batch_job_request_seq MAXVALUE <span class="integer">9223372036854775807</span> NO CYCLE;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A job request sequence is not defined in DDL included in jar of TERASOLUNA Batch 5.x, for databases supporting auto-numbering of columns.
When you want to change maximum value in the sequence, it is preferable to define the job request sequence besides changing data type
of <code>job_seq_id</code> from auto-numbering definition to numeric data type
(In case of PostgreSQL, from <code>bigserial</code> to <code>bigint</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="transition-pattern-of-polling-status-polling_status"><a class="anchor" href="#transition-pattern-of-polling-status-polling_status"></a>4.3.2.2.3. Transition pattern of polling status (polling_status)</h6>
<div class="paragraph">
<p>Transition pattern of polling status is shown in the table below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Transition pattern list of polling status</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Transition source</th>
<th class="tableblock halign-left valign-top">Transition destination</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the number of synchronous executions has been achieved and execution of job is denied, status remains unchanged.<br>
It acts as a record for polling at the time of next polling.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POLLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transition is done when the job is successfully started.<br>
Status when the job is running.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">POLLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transition occurs when job execution is completed.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="job-request-fetch-sql"><a class="anchor" href="#job-request-fetch-sql"></a>4.3.2.2.4. Job request fetch SQL</h6>
<div class="paragraph">
<p>Number to be fetched by job request fetch SQL is restricted in order to fetch job request for number of synchronously executed jobs.<br>
Job request fetch SQL varies depending on the database product and version to be used.
Hence, it may not be possible to handle with SQL provided by TERASOLUNA Batch 5.x.<br>
In that case, SQLMap of <code>BatchJobRequestMapper.xml</code> should be redefined
using <a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable">Customising Job-request-table</a> as a reference.<br>
For SQL offered, refer <code>BatchJobRequestMapper.xml</code> included in jar of TERASOLUNA Batch 5.x.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_JobLaunching"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_JobLaunching"></a>4.3.2.3. About job running</h5>
<div class="paragraph">
<p>Running method of job is explained.</p>
</div>
<div class="paragraph">
<p>Job is run by <code>start</code> method of <code>JobOperator</code> offered by Spring Batch in Job-request-table polling function of
TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>With TERASOLUNA Batch 5.x, guidelines explain the restart of jobs started by asynchronous execution (DB polling) from the command line.
Hence, <code>JobOperator</code> also contains startup methods like <code>restart</code> etc besides <code>start</code>, however,
only <code>start</code> method is used.</p>
</div>
<div class="dlist">
<div class="title">Arguments of start method</div>
<dl>
<dt class="hdlist1">jobName</dt>
<dd>
<p>Set the value registered in <code>job_name</code> of Job-request-table.</p>
</dd>
<dt class="hdlist1">jobParametrers</dt>
<dd>
<p>Set the value registered in <code>job_parameters</code> of Job-request-table.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_OnError"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_OnError"></a>4.3.2.4. When abnormality is detected in DB polling process.</h5>
<div class="paragraph">
<p>Explanation is given for when an abnormality is detected in DB polling process.</p>
</div>
<div class="sect5">
<h6 id="database-connection-failure"><a class="anchor" href="#database-connection-failure"></a>4.3.2.4.1. Database connection failure</h6>
<div class="paragraph">
<p>Describe behaviour for the processing performed at the time of failure occurrence.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When records of Job-request-table are fetched</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobRequestPollTask</code> results in an error, however, <code>JobRequestPollTask</code> is executed again in next polling.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">While changing the polling status from INIT to POLLED</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobRequestPollTask</code> terminates with an error prior to executing job by <code>JobOperator</code>. Polling status remains unchanged as INIT.</p>
</li>
<li>
<p>In the polling process performed after connection failure recovery, the job becomes a target for execution as there is no change in the Job-request-table and the job is executed at the next polling.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">While changing polling status from POLLED to EXECUTED</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>JobRequestPollTask</code> terminates with an error since the job execution ID cannot be updated in the Job-request-table. Polling status remains unchanged as POLLED.</p>
</li>
<li>
<p>It is out of the scope for the polling process to be performed after connection failure recovery and the job at the time of failure is not executed.</p>
</li>
<li>
<p>Since a job execution ID cannot be identified from a Job-request-table, final status of the job is determined from log or <code>JobRepository</code> and re-execute the job as a process of recovery when required.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if an exception occurs in <code>JobRequestPollTask</code>, it is not restored immediately. Reason is given below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Since <code>JobRequestPollTask</code> is started at regular intervals, auto-restoration is possible (not immediate) by delegating the operation to <code>JobRequestPollTask</code>.</p>
</li>
<li>
<p>It is very rare to be able to recover after retrying immediately at the time of failure occurrence, in addition, it is likely to generate load due to attempt of retry.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="abnormal-termination-of-asynchronous-batch-daemon-process"><a class="anchor" href="#abnormal-termination-of-asynchronous-batch-daemon-process"></a>4.3.2.4.2. Abnormal termination of asynchronous batch daemon process</h6>
<div class="paragraph">
<p>When a process of asynchronous batch daemon terminates abnormally, transaction of the job being executed is rolled back implicitly.<br>
State of the polling status is same as status at the time of database connection failure.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Shutdown"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Shutdown"></a>4.3.2.5. Stopping DB polling process</h5>
<div class="paragraph">
<p>Asynchronous batch daemon (<code>AsyncBatchDaemon</code>) stops by generation of a file.
After confirming that the file has been generated, make the polling process idle, wait as long as possible to job being started and then stop the process.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Arch_Components"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Components"></a>4.3.2.6. About  application configuration specific to asynchronous execution</h5>
<div class="paragraph">
<p>Configuration specific to asynchronous execution is explained.</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_AppCtx"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_AppCtx"></a>4.3.2.6.1. ApplicationContext configuration</h6>
<div class="paragraph">
<p>Asynchronous batch daemon reads <code>async-batch-daemon.xml</code> dedicated to asynchronous execution as ApplicationContext.
Configuration below is added besides <code>launch-context.xml</code> used in synchronous execution as well.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Asynchronous execution settings</dt>
<dd>
<p>A Bean necessary for asynchronous execution like <code>JobRequestPollTask</code> etc. is defined.</p>
</dd>
<dt class="hdlist1">Job registration settings</dt>
<dd>
<p>Job executed as an asynchronous execution registers by <code>org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</code>.
Context for each job is modularized by using <code>AutomaticJobRegistrar</code>.
When modularization is done, it does not pose an issue even of Bean ID used between the jobs is duplicated.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">What is modularization</div>
<div class="paragraph">
<p>Modularization is a hierarchical structure of "Common definition - Definition of each job" and the Bean defined in each job belongs to an independent context between jobs.
If a reference to a Bean which is not defined in each job definition exists, it refers to a Bean defined in common definition.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_Arch_Config"><a class="anchor" href="#Ch04_AsyncJobWithDB_Arch_Config"></a>4.3.2.6.2. Bean definition structure</h6>
<div class="paragraph">
<p>Bean definition of a job can be same as Bean definition of synchronous execution. However, following precautions must be taken.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When job is to be registered by <code>AutomaticJobRegistrar</code>, Bean ID of the job is an identifier, and hence should not be duplicated.</p>
</li>
<li>
<p>It is also desirable to not to duplicate Bean ID of step.</p>
<div class="ulist">
<ul>
<li>
<p>Only the job ID should be uniquely designed by designing naming rules of Bean ID as <code>{Job ID}.{Step ID}</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Import of <code>job-base-context.xml</code> in the Bean definition of job varies for synchronous and asynchronous execution.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In synchronous execution, <code>launch-context.xml</code> is imported from <code>job-base-context.xml</code>.</p>
</li>
<li>
<p>In asynchronous execution, <code>launch-context.xml</code> is not imported from <code>job-base-context.xml</code>.
Alternatively,  import <code>launch-context.xml</code> from <code>async-batch-daemon.xml</code> which AsyncBatchDaemon loads.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is because various Beans required for starting Spring Batch need not be instantiated for each job.
Only one bean should be created in common definition (<code>async-batch-daemon.xml</code>) which acts as a parent for each job, from various Beans required for starting Spring Batch.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_HowToUse"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse"></a>4.3.3. How to use</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Config"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Config"></a>4.3.3.1. Various settings</h5>
<div class="sect5">
<h6 id="settings-for-polling-process"><a class="anchor" href="#settings-for-polling-process"></a>4.3.3.1.1. Settings for polling process</h6>
<div class="paragraph">
<p>Use <code>batch-application.properties</code> for settings required for asynchronous execution.</p>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">#(1)
# Admin DataSource settings.
admin.jdbc.driver=org.postgresql.Driver
admin.jdbc.url=jdbc:postgresql://localhost:5432/postgres
admin.jdbc.username=postgres
admin.jdbc.password=postgres

# TERASOLUNA AsyncBatchDaemon settings.
# (2)
async-batch-daemon.schema.script=classpath:org/terasoluna/batch/async/db/schema-postgresql.sql
# (3)
async-batch-daemon.job-concurrency-num=3
# (4)
async-batch-daemon.polling-interval=5000
# (5)
async-batch-daemon.polling-initial-delay=1000
# (6)
async-batch-daemon.polling-stop-file-path=/tmp/end-async-batch-daemon</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Setup details item list</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection settings for database wherein Job-request-table is stored.<br>
<code>JobRepository</code> settings are used by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A path for DDL which defines Job-request-table.<br>
It is auto-generated when Job-request-table does not exist at the time of starting asynchronous batch daemon.<br>
This is primarily a test function and execution can be set by <code>data-source.initialize.enabled</code> of+
<code>batch-application.properties</code>.<br>
For detailed definition, refer <code>&lt;jdbc:initialize-database&gt;&gt;</code> in <code>async-batch-daemon.xml</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Setting for records which are fetched collectively at the time of polling. This setup value is also used as a synchronous parallel number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Polling cycle settings. Unit is milliseconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Polling initial start delay time settings. Unit is milliseconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exit file path settings.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Changing setup value using environment variable</div>
<div class="paragraph">
<p>Setup value of <code>batch-application.properties</code> can be changed by defining environment variable with same name.<br>
When an environment variable is set, it is prioritized over property value.<br>
This happens due to Bean definition below.</p>
</div>
<div class="listingblock">
<div class="title">Settings for launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context:property-placeholder</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:batch-application.properties</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">system-properties-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OVERRIDE</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">ignore-resource-not-found</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">ignore-unresolvable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">order</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For details, refer
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/GeneralFuncDetail/PropertyManagement.html#technical-details-label">How to define a property file</a> of TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Config_Job"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Config_Job"></a>4.3.3.1.2. Job settings</h6>
<div class="paragraph">
<p>Job to be executed asynchronously is set in <code>automaticJobRegistrar</code> of <code>async-batch-daemon.xml</code>.<br>
Default settings are shown below.</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/**/*.xml<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Setting details item list</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A path for Bean definition of a job executed asynchronously.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About registered jobs</div>
<div class="paragraph">
<p>For registering jobs, jobs which are designed and implemented on the premise that they are executed asynchronously should be specified.
If the jobs which are not supposed to be executed asynchronously are included, exceptions may occur due to unintended references at the time of job registration.</p>
</div>
<div class="listingblock">
<div class="title">Example of Narrowing down</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="comment">&lt;!-- For the async directory and below --&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/aysnc/**/*.xml<span class="tag">&lt;/value&gt;</span>
                    <span class="comment">&lt;!-- For a specific job --&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/CASE100/SpecialJob.xml<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Input value verification for job parameters</div>
<div class="paragraph">
<p><code>JobPollingTask</code> does not validate the records obtained from Job-request-table.<br>
Hence, the job name and job parameter must be verified for the table registration.<br>
If the job name is incorrect, job is not detected even if it has started and an exception occurs.<br>
If the job parameter is incorrect, an erroneous operation is performed even if the job has started.<br>
Only job parameters can be verified once the job is started. For verification of job parameters, refer
<a href="#Ch04_JobParameter_HowToUse_ParamsValidation">"Validity verification of parameters"</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Job design considerations</div>
<div class="paragraph">
<p>As a characteristic of asynchronous execution (DB polling), the same job can be executed in parallel. It is necessary to prevent the same job to create an impact when the jobs are run in parallel.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Daemon"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon"></a>4.3.3.2. From start to end of asynchronous execution</h5>
<div class="paragraph">
<p>Start and end of asynchronous batch daemon and how to register in Job-request-table are explained.</p>
</div>
<div class="sect5">
<h6 id="start-of-asynchronous-batch-daemon"><a class="anchor" href="#start-of-asynchronous-batch-daemon"></a>4.3.3.2.1. Start of asynchronous batch daemon</h6>
<div class="paragraph">
<p>Start <code>AsyncBatchDaemon</code> offered by TERASOLUNA Batch 5.x.</p>
</div>
<div class="listingblock">
<div class="title">Start of AsyncBatchDaemon</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, <code>META-INF/spring/async-batch-daemon.xml</code> is read and various Beans are generated.</p>
</div>
<div class="paragraph">
<p>Further, when <code>async-batch-daemon.xml</code> customised separately, it is implemented by specifying first argument and starting <code>AsyncBatchDaemon</code>.<br>
Bean definition file specified in the argument must be specified as a relative path from the class path.<br>
Note that, the second and subsequent arguments are ignored.</p>
</div>
<div class="listingblock">
<div class="title">When customised META-INF/spring/customized-async-batch-daemon.xml is used,</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon \
    META-INF/spring/customized-async-batch-daemon.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Customisation of <code>async-batch-daemon.xml</code> can be modified directly by changing some of the settings.<br>
However, when significant changes are added or when multiple settings are managed in <a href="#Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon">Multiple runnings</a>described later,
it is easier to manage and create separate files.<br>
It should be choosed according to user&#8217;s situation..</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is assumed that jar expressions necessary for execution are stored under dependency.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="job-request"><a class="anchor" href="#job-request"></a>4.3.3.2.2. Job request</h6>
<div class="paragraph">
<p>Register in Job-request-table by issuing SQL of INSERT statement.</p>
</div>
<div class="listingblock">
<div class="title">In case of PostgreSQL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> batch_job_request(job_name,job_parameter,polling_status,create_date)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">JOB01</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">param1=dummy,param2=100</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">INIT</span><span class="delimiter">'</span></span>, current_timestamp);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToUse_Daemon_stop"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_stop"></a>4.3.3.2.3. Stopping asynchronous batch daemon</h6>
<div class="paragraph">
<p>Keep exit file set in <code>batch-application.properties</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ touch /tmp/end-async-batch-daemon</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">When the exit file exists prior to starting asynchronous batch daemon</div>
<div class="paragraph">
<p>When the exit file exists prior to starting asynchronous batch daemon, asynchronous batch daemon terminates immediately.
Asynchronous batch daemon must be started in the absence of exit file.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_RefStatus"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_RefStatus"></a>4.3.3.3. Confirm job status</h5>
<div class="paragraph">
<p>Job status management is performed with <code>JobRepository</code> offered by Spring Batch and the job status is not managed in the Job-request-table.
Job-request-table has a column of <code>job_execution_id</code> and job status corresponding to individual requests can be confirmed by the value stored in this column.
Here, a simple example wherein SQL is issued directly and job status is confirmed is shown.
For details of job status confirmation, refer <a href="#Ch07_JobManagement_JobStatusManagement_Retrieve">"Status confirmation"</a>.</p>
</div>
<div class="listingblock">
<div class="title">In case of PostgreSQL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> job_execution_id <span class="keyword">FROM</span> batch_job_request <span class="keyword">WHERE</span> job_seq_id = <span class="integer">1</span>;

job_execution_id
<span class="comment">----------------</span>
              <span class="integer">2</span>
(<span class="integer">1</span> <span class="type">row</span>)

<span class="class">SELECT</span> * <span class="keyword">FROM</span> batch_job_execution <span class="keyword">WHERE</span> job_execution_id = <span class="integer">2</span>;

job_execution_id | version | job_instance_id |       create_time       |       start_time        |        end_time         |  status   | exit_code | exit_message |
ocation
<span class="comment">------------------+---------+-----------------+-------------------------+-------------------------+-------------------------+-----------+-----------+--------------+-</span>
<span class="comment">--------</span>
              <span class="integer">2</span> |       <span class="integer">2</span> |               <span class="integer">2</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.263</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.295</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-06</span> <span class="integer">20</span>:<span class="integer">54</span>:<span class="float">02.428</span> | COMPLETED | COMPLETED |              |
(<span class="integer">1</span> <span class="type">row</span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Recovery"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Recovery"></a>4.3.3.4. Recovery after a job is terminated abnormally</h5>
<div class="paragraph">
<p>For basic points related to recovery of a job which is terminated abnormally, refer <a href="#Ch06_RerunRestart">"Re-execution of process"</a>. Here, points specific to asynchronous execution are explained.</p>
</div>
<div class="sect5">
<h6 id="re-run"><a class="anchor" href="#re-run"></a>4.3.3.4.1. Re-run</h6>
<div class="paragraph">
<p>Job which is terminated abnormally is re-run by inserting it as a separate record in Job-request-table.</p>
</div>
</div>
<div class="sect5">
<h6 id="restart"><a class="anchor" href="#restart"></a>4.3.3.4.2. Restart</h6>
<div class="paragraph">
<p>When the job which is terminated abnormally is to be restarted, it is executed as a synchronous execution job from the command line.
The reason for executing from the command line is "since it is difficult to determine whether the restart is intended or whether it is an unintended duplicate execution resulting in chaotic operation."<br>
For restart methods, refer <a href="#Ch06_RerunRestart_HowToUse_Restart">"Job restart"</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="termination"><a class="anchor" href="#termination"></a>4.3.3.4.3. Termination</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When the process has not terminated even after exceeding the expected processing time, attempt terminating the operation from the command line.
For methods of termination, refer <a href="#Ch07_JobManagement_JobStatusManagement_JobStop">"Job stop"</a>.</p>
</li>
<li>
<p>When the termination is not accepted even from a command line, asynchronous batch daemon should be terminated by <a href="#Ch04_AsyncJobWithDB_HowToUse_Daemon_stop">Stopping asynchronous batch daemon</a>.</p>
</li>
<li>
<p>If even an asynchronous batch daemon cannot be terminated, process of asynchronous batch daemon should be forcibly terminated.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Adequate care should be taken not to impact other jobs when an asynchronous batch daemon is being terminated.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Env"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Env"></a>4.3.3.5. About environment deployment</h5>
<div class="paragraph">
<p>Building and deploying job is same as a synchronous execution. However, it is important to narrow down the jobs which are executed asynchronously as shown in <a href="#Ch04_AsyncJobWithDB_HowToUse_Config_Job">Job settings</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToUse_Evacuation_Cumulative_Data"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToUse_Evacuation_Cumulative_Data"></a>4.3.3.6. Evacuation of cumulative data</h5>
<div class="paragraph">
<p>If you run an asynchronous batch daemon for a long time, a huge amount of data is accumulated in JobRepository and the Job-request-table.
It is necessary to clear this cumulative data for the following reasons.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performance degradation when data is retrieved or updated for a large quantity of data</p>
</li>
<li>
<p>Duplication of ID due to circulation of ID numbering sequence</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For evacuation of table data and resetting a sequence, refer manual for the database to be used.</p>
</div>
<div class="paragraph">
<p>List of tables and sequences for evacuation is shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List for evacuation</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Table/Sequence</th>
<th class="tableblock halign-left valign-top">Framework offered</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_request</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">TERASOLUNA Batch 5.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_request_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_instance</p></td>
<td class="tableblock halign-left valign-top" rowspan="9"><p class="tableblock">Spring Batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution_params</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_exeution_context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_exeution</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_exeution_context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_job_execution_seq</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch_step_execution_seq</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Auto-numbering column sequence</div>
<div class="paragraph">
<p>Since a sequence is created automatically for an auto-numbering column, remember to include this sequence while evacuating data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About database specific specifications</div>
<div class="paragraph">
<p>Note that Oracle uses database-specific data types in some cases, such as using CLOB for data types.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_HowToExtend"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend"></a>4.3.4. How to extend</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable"></a>4.3.4.1. Customising Job-request-table</h5>
<div class="paragraph">
<p>Job-request-table can be customised by adding a column in order to change extraction conditions of fetched records.
However, only <code>BatchJobRequest</code> can be passed as an item while issuing SQL from <code>JobRequestPollTask</code>.</p>
</div>
<div class="paragraph">
<p>Extension procedure by customising the Job-request-table is shown below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Customising Job-request-table</p>
</li>
<li>
<p>Creating an extension interface of <code>BatchJobRequestRepository</code> interface</p>
</li>
<li>
<p>Defining SQLMap which uses customised table</p>
</li>
<li>
<p>Modifying Bean definition of <code>async-batch-daemon.xml</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Examples of customization are as below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority">Example of controlling job execution sequence by priority column</a></p>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID">Distributed processing by multiple processes using a group ID</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hereafter, the extension procedure will be described for these two examples.</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority"></a>4.3.4.1.1. Example of controlling job execution sequence by priority column</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Customising Job-request-table</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Add a priority column (priority) in Job-request-table.</p>
</div>
<div class="listingblock">
<div class="title">Adding a priority column (In case of PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    priority <span class="predefined-type">int</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Create extension interface of <code>BatchJobRequestRepository</code> interface</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An interface which extends <code>BatchJobRequestRepository</code> interface is created.</p>
</div>
<div class="listingblock">
<div class="title">Extension interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CustomizedBatchJobRequestRepository</span> <span class="directive">extends</span> BatchJobRequestRepository {
    <span class="comment">// (2)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Extension points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extend <code>BatchJobRequestRepository</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not add a method.</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Definition of SQLMap which use a customised table</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Define SQL in SQLMap with group ID as a condition for extraction.</p>
</div>
<div class="listingblock">
<div class="title">SQLMap definition (CustomizedBatchJobRequestRepository.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">find</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.model.BatchJobRequest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            job_seq_id AS jobSeqId,
            job_name AS jobName,
            job_parameter AS jobParameter,
            job_execution_id AS jobExecutionId,
            polling_status AS pollingStatus,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            batch_job_request
        WHERE
            polling_status = 'INIT'
        ORDER BY
            priority ASC,   <span class="comment">&lt;!--(2) --&gt;</span>
            job_seq_id ASC
        LIMIT #{pollingRowLimit}
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateStatus</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        UPDATE
            batch_job_request
        SET
            polling_status = #{batchJobRequest.pollingStatus},
            job_execution_id = #{batchJobRequest.jobExecutionId},
            update_date = #{batchJobRequest.updateDate}
        WHERE
            job_seq_id = #{batchJobRequest.jobSeqId}
        AND
            polling_status = #{pollingStatus}
    <span class="tag">&lt;/update&gt;</span>

<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Extension points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set extended interface of <code>BatchJobRequestRepository</code>in namespace by FQCN.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add priority to ORDER clause.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not change updated SQL.</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Modifying Bean definition of <code>async-batch-daemon.xml</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Set extended interface created in (2) in <code>batchJobRequestRepository</code>.</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!--(1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.mapper.MapperFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:mapperInterface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Extension points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set extended interface of <code>BatchJobRequestRepository</code> in <code>mapperInterface</code> property by FQCN.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_GroupID"></a>4.3.4.1.2. Distributed processing by multiple processes using a group ID</h6>
<div class="paragraph">
<p>Specify group ID by using environment variable while starting <code>AsyncBatchDaemon</code> and narrow down the target job.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Customizing Job-request-table</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Add group ID column (group_id) to Job-request-table.</p>
</div>
<div class="listingblock">
<div class="title">Adding group ID column (In case of PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> batch_job_request (
    job_seq_id bigserial <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    job_name <span class="predefined-type">varchar</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_parameter <span class="predefined-type">varchar</span>(<span class="integer">200</span>),
    group_id <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    job_execution_id <span class="predefined-type">bigint</span>,
    polling_status <span class="predefined-type">varchar</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    create_date <span class="predefined-type">timestamp</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    update_date <span class="predefined-type">timestamp</span>
);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Creating extended interface of <code>BatchJobRequestRepository</code> interface</p>
<div class="ulist">
<ul>
<li>
<p>Same as <a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable_Priority">Example of controlling job execution sequence by priority column</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Definition of SQLMap which use customised table</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Define SQL in SQLMap with  the group ID as the extraction condition.</p>
</div>
<div class="listingblock">
<div class="title">SQLMap definition (CustomizedBatchJobRequestRepository.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">find</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.model.BatchJobRequest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        SELECT
            job_seq_id AS jobSeqId,
            job_name AS jobName,
            job_parameter AS jobParameter,
            job_execution_id AS jobExecutionId,
            polling_status AS pollingStatus,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            batch_job_request
        WHERE
            polling_status = 'INIT'
        AND
            group_id = #{groupId}  <span class="comment">&lt;!--(2) --&gt;</span>
        ORDER BY
            job_seq_id ASC
        LIMIT #{pollingRowLimit}
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Extension points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set extended interface of <code>BatchJobRequestRepository</code> in namespace by FQCN.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add groupId to extraction conditions.</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Modifying Bean definition of <code>async-batch-daemon.xml</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Set extended interface created in (2) in <code>batchJobRequestRepository</code> and
set the group ID assigned by environment variable in <code>jobRequestPollTask</code> as a query parameter.</p>
</div>
<div class="listingblock">
<div class="title">async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="comment">&lt;!--(1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.mapper.MapperFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:mapperInterface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.extend.repository.CustomizedBatchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRequestPollTask</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.async.db.JobRequestPollTask</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:transactionManager-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminTransactionManager</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:jobOperator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobOperator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:batchJobRequestRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchJobRequestRepository</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:daemonTaskExecutor-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">daemonTaskExecutor</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">c:automaticJobRegistrar-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:optionalPollingQueryParams-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pollingQueryParam</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>

   <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pollingQueryParam</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.beans.factory.config.MapFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">groupId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${GROUP_ID}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Extension points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set extended interface of <code>BatchJobRequestRepository</code> in <code>mapperInterface</code> property by FQCN..</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set Map defined in (3), in <code>optionalPollingQueryParams</code> property of <code>JobRequestPollTask</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set group ID assigned by environment variable (GROUP_ID) in group ID (groupId) of query parameter.</p></td>
</tr>
</tbody>
</table>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Set group ID in environment variable and start <code>AsyncBatchDaemon</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Starting AsyncBatchDaemon</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Set environment variables
$ export GROUP_ID=G1

# Start AsyncBatchDaemon
$ java -cp dependency/* org.terasoluna.batch.async.db.AsyncBatchDaemon</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon"><a class="anchor" href="#Ch04_AsyncJobWithDB_HowToExtend_MultiDaemon"></a>4.3.4.2. Multiple runnings</h5>
<div class="paragraph">
<p>Asynchronous batch daemon is run on multiple servers for the following purposes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enhanced availability</p>
<div class="ulist">
<ul>
<li>
<p>It suffices if an asynchronous batch job can be executed on one of the servers, and it is to eliminate the situation that the job can not be run.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enhanced performance</p>
<div class="ulist">
<ul>
<li>
<p>When batch processing load is to be distributed across multiple servers</p>
</li>
</ul>
</div>
</li>
<li>
<p>Effective use of resources</p>
<div class="ulist">
<ul>
<li>
<p>When a specific job is to be distributed on a server with optimal resources when a variation is observed in the server performance</p>
<div class="ulist">
<ul>
<li>
<p>Equivalent to dividing a job node based on group ID shown in <a href="#Ch04_AsyncJobWithDB_HowToExtend_CustomTable">Customising Job-request-table</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An operational design must be adopted considering whether it can be used based on the viewpoints given above.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithDB_MultipleActivation.png" alt="Ch04 AsyncJobWithDB MultipleActivation">
</div>
<div class="title">Schematic diagram for multiple starts</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">When multiple asynchronous batch daemons fetch identical job request records</div>
<div class="paragraph">
<p>Since <code>JobRequestPollTask</code> performs exclusive control using optimistic locking, it can execute the job of the record fetched by asynchronous batch daemon which can update the polling status from INIT to POLLED.
Other exclusive asynchronous batch daemons fetch next job request record.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithDB_Appendix"><a class="anchor" href="#Ch04_AsyncJobWithDB_Appendix"></a>4.3.5. Appendix</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithDB_Appendix_Modular"><a class="anchor" href="#Ch04_AsyncJobWithDB_Appendix_Modular"></a>4.3.5.1. About modularization of job definition</h5>
<div class="paragraph">
<p>Although it is briefly explained in <a href="#Ch04_AsyncJobWithDB_Arch_AppCtx">ApplicationContext configuration</a>, following events can be avoided by using <code>AutomaticJobRegistrar</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When same BeanID (BeanName) is used, Bean is overwritten and the job shows unintended behaviour.</p>
<div class="ulist">
<ul>
<li>
<p>Accordingly, there is a high risk of occurrence of unintended errors.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Naming should be performed to make all Bean IDs in the job unique, to avoid these errors.</p>
<div class="ulist">
<ul>
<li>
<p>As the number of job increases, it becomes difficult to manage the same resulting in unnecessary troubles.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An event when <code>AutomaticJobRegistrar</code> is not used is explained.
Since the contents explained here pose the issues given above, it is not used in asynchronous execution.</p>
</div>
<div class="listingblock">
<div class="title">Job1.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Reader --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.terasoluna.batch.job.repository.EmployeeRepositoy.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/employee.csv</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="comment">&lt;!-- Job --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job1.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Job2.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Reader --&gt;</span>
<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/invoice.csv</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jp.terasoluna.batch.job.repository.InvoiceRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Job --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">job2.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
  <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Definition wherein BeanId is overwritten</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">automaticJobRegistrar</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/other/async/*.xml<span class="tag">&lt;/value&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.JobRegistryBeanPostProcessor</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:/META-INF/jobs/async/*.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setup points</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In Job1, ItemReader which reads from the database is defined by a Bean ID - <code>reader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In Job1, ItemWriter which writes in a file is defined by a Bean ID - <code>writer</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In Job2, ItemReader which reads from the file is defined by a Bean ID - <code>reader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In Job2, ItemWriter which writes to a database is defined by a Bean ID - <code>writer</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AutomaticJobRegistrar</code> is set so as to read job definitions other than target jobs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use import of Spring and enable reading of target job definition.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this case, if Job1.xml and Job2.xml are read in the sequence, reader and writer to be defined by Job1.xml will be overwritten by Job2.xml definition.<br>
As a result, when Job1 is executed, reader and writer of Job2 are used and intended processing cannot be performed.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_AsyncJobWithWeb"><a class="anchor" href="#Ch04_AsyncJobWithWeb"></a>4.4. Asynchronous execution (Web container)</h3>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_Overview"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Overview"></a>4.4.1. Overview</h4>
<div class="paragraph">
<p>A method to execute the job asynchronously in Web container is explained.</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="paragraph">
<div class="title">What is Asynchronous execution of jobs by Web container</div>
<p>Web application that contains a job is deployed in a Web container
and the job is executed based on information of sent request.<br>
Since one thread is allocated for each job execution and operation is run in parallel,
it can be executed independent of processes for other jobs and requests.</p>
</div>
<div class="paragraph">
<div class="title">Function offered</div>
<p>TERASOLUNA Batch 5.x does not offer implementation for asynchronous execution (Web container).<br>
Only methods of implementation will be provided in this guideline.<br>
This is because the start timing of the Web application is various such as HTTP / SOAP / MQ,
and hence it is determined that the implementation should be appropriately done by the user.</p>
</div>
<div class="ulist">
<div class="title">Usage premise</div>
<ul>
<li>
<p>A Web container is required besides the application.</p>
</li>
<li>
<p>Besides implementation of job, required Web application and client are separately implemented according to the operation requirements.</p>
</li>
<li>
<p>Execution status and results of the job is entrusted to <code>JobRepository</code>.
Further, a permanently residing database is used instead of in-memory database to enable execution status and results
of job to be referred from  <code>JobRepository</code> even after stopping Web container.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Usage scene</div>
<p>It is same as <a href="#Ch04_AsyncJobWithDB_Overview">"Asynchronous execution (DB polling) - Overview"</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Difference with asynchronous execution (DB polling)</div>
<div class="paragraph">
<p>On the architecture front, immediacy at the time of asynchronous execution and presence or absence of request management table are different.<br>
<a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a> performs asynchronous execution of multiple jobs registered in the request management table.<br>
On the other hand, this function does not require request management table and accepts asynchronous execution on the Web container instead.<br>
It is suitable for a short batch which requires immediacy till the start of the operation in order to execute the operation immediately by sending a Web request.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_Arch"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch"></a>4.4.2. Architecture</h4>
<div class="paragraph">
<p>Asynchronous jobs by using this method are operated as applications (war) deployed on the Web container, however, the job itself runs asynchronously (another thread) from the request processing of Web container.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_Sequence.png" alt="sequence of async web">
</div>
<div class="title">Process sequence diagram of asynchronous execution (Web container)</div>
</div>
<div class="olist arabic">
<div class="title">Running a job</div>
<ol class="arabic">
<li>
<p>Web client requests Web container to execute the job.</p>
</li>
<li>
<p><code>JobController</code> asks <code>JobOperator</code> of Spring Batch to start the execution of the job.</p>
</li>
<li>
<p>Execute the job asynchronously by using <code>ThreadPoolTaskExecutor</code>.</p>
</li>
<li>
<p>Return a job execution ID  (<code>job execution id</code>) for uniquely identifying an executed target job.</p>
</li>
<li>
<p><code>JobController</code> returns a response including job execution ID for the Web client.</p>
</li>
<li>
<p>Execute target job.</p>
<div class="ulist">
<ul>
<li>
<p>Job results are reflected in <code>JobRepository</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>Job</code> returns execution results. It cannot be notified directly to the client.</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Confirm job execution results</div>
<ol class="arabic" start="8">
<li>
<p>Web client sends job execution ID and <code>JobController</code> to Web container.</p>
</li>
<li>
<p><code>JobController</code> asks <code>JobExplorer</code> for execution results of job by using a job execution ID.</p>
</li>
<li>
<p><code>JobExplorer</code> returns job execution results.</p>
</li>
<li>
<p><code>JobController</code> returns a response for Web client.</p>
<div class="ulist">
<ul>
<li>
<p>Set Job execution ID in the response.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After receiving a request using Web container, operation is synchronised with the request processing till job execution ID payout, however subsequent job execution is performed asynchronously in a thread pool
different from that of Web container.<br>
As long as the query is not sent again by sending a request, it signifies that execution status of asynchronous job cannot be detected on Web client side.</p>
</div>
<div class="paragraph">
<p>Hence, the request should be sent once at the time of "running a job" on the Web client side during one job execution.
When "confirmation of results" is necessary, request must be sent once again to the Web container.<br>
Abnormality detection which looks different from  first "running a job" will be explained later in
<a href="#Ch04_AsyncJobWithWeb_Arch_OnError">About detection of abnormality occurrence at the time of running a job</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Job execution status can be checked by referring direct RDBMS, by using <code>JobRepository</code> and <code>JobExplorer</code>.
For details of the function which refer to job execution status and results, refer <a href="#Ch07_JobManagement">Job management</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About handling job execution ID (job execution id)</div>
<div class="paragraph">
<p>Job execution ID generates a different sequence value for each job even though job and job parameters are identical.<br>
Job execution ID accepted by sending a request is persisted in external RDBMS by <code>JobRepository</code>.<br>
However, when this ID is lost due to failure of Web client, specifying or tracking job execution status becomes difficult.<br>
Hence, adequate preparations must be made on Web client side to cope with loss of job execution ID like logging the job execution ID returned as a response.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_Arch_OnError"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_OnError"></a>4.4.2.1. About detection of abnormality occurrence at the time of running a job</h5>
<div class="paragraph">
<p>After sending a job run request from Web client, abnormality detection appearance varies along with job execution ID payout.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Abnormality can be detected immediately by the response at the time of running a job</p>
<div class="ulist">
<ul>
<li>
<p>Job to be activated does not exist.</p>
</li>
<li>
<p>Invalid job parameter format.</p>
</li>
</ul>
</div>
</li>
<li>
<p>After running a job, queries regarding job execution status and results for Web container are necessary</p>
<div class="ulist">
<ul>
<li>
<p>Job execution status</p>
</li>
<li>
<p>Job start failure due to depletion of thread pool used in asynchronous job execution</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>"Job running error" can be detected as an exception occurring in Spring MVC controller.
Since the explanation is omitted here, refer
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebServiceDetail/REST.html#resthowtouseexceptionhandling">Implementation of exception handling</a> of TERASOLUNA Server 5.x Development Guideline described separately.</p>
</div>
<div class="paragraph">
<p>Further, input check of the request used as a job parameter is performed in the Spring MVC controller as required.<br>
For basic implementation methods, refer
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html">Input check</a> of TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Job start failure occurring due to depletion of thread pool cannot be captured at the time of running a job.</div>
<div class="paragraph">
<p>Job start failure due to depletion of thread pool is not generated from <code>JobOperator</code>, hence it must be checked separately.
One of the methods of confirmation include using <code>JobExplorer</code> while checking execution status of job and checking whether the following conditions are satisfied.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Status is <code>FAILED</code></p>
</li>
<li>
<p>Exception stack trace of <code>org.springframework.core.task.TaskRejectedException</code> is recorded in
<code>jobExecution.getExitStatus().getExitDescription()</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_Arch_Components"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_Components"></a>4.4.2.2. Application configuration of asynchronous execution (Web container)</h5>
<div class="paragraph">
<p>The function is same as <a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a> and use
<code>async</code> and <code>AutomaticJobRegistrar</code> of Spring profile as a configuration specific to asynchronous execution.</p>
</div>
<div class="paragraph">
<p>On the other hand, prior knowledge and some specific settings are required in order to use these functions asynchronously (Web container).
Refer <a href="#Ch04_AsyncJobWithWeb_Arch_AppCtx">"ApplicationContext configuration"</a>.<br>
For configuration methods of basic <code>async</code> profile and <code>AutomaticJobRegistrar</code>,
<a href="#Ch04_AsyncJobWithWeb_How_to_implements">"How to implement applications using asynchronous execution (Web container)"</a> will be described later.</p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_Arch_AppCtx"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Arch_AppCtx"></a>4.4.2.2.1. ApplicationContext configuration</h6>
<div class="paragraph">
<p>As described above, multiple application modules are included as application configuration of asynchronous execution (Web container).<br>
It is necessary to understand respective application contexts, types of Bean definitions and their relationships.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_Package.png" alt="Package structure of async web">
</div>
<div class="title">ApplicationContext configuration</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_BeanDefinitions.png" alt="BeanDefinitions structure of async web">
</div>
<div class="title">Bean definition file configuration</div>
</div>
<div class="paragraph">
<p><code>ApplicationContext</code> of batch application is incorporated in the context, in <code>ApplicationContext</code> during asynchronous execution (Web container).<br>
Individual job contexts are modularised from  Web context using <code>AutomaticJobRegistrar</code> and
it acts as a sub-context of Web context.</p>
</div>
<div class="paragraph">
<p>Bean definition file which constitute respective contexts are explained.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of Bean definition files</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common Bean definition file.<br>
It acts as a parent context in the application and is uniquely shared among jobs acting as sub-contexts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file which is always imported from job Bean definitions.<br>
If Spring profile is <code>async</code> specified at the time of asynchronous execution, <code>launch-context.xml</code> of (1) is not read.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition file created for each job.<br>
It is modularized by <code>AutomaticJobRegistrar</code> and are used as respective independent sub-contexts in the application.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is read from <code>DispatcherServlet</code>.<br>
Define the Beans unique to asynchronous execution such as <code>AutomaticJobRegistrar</code> which performs modularization of job Bean definition and <code>taskExecutor</code> which is a thread pool used in asynchronous and parallel execution of jobs.<br>
Further, in asynchronous execution, <code>launch-context.xml</code> of (1) is imported directly<br>
and uniquely shared as parent contexts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It acts as a parent context shared within the Web application by using <code>ContextLoaderListener</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="CCh04_AsyncJobWithWeb_HowToUse"><a class="anchor" href="#CCh04_AsyncJobWithWeb_HowToUse"></a>4.4.3. How to use</h4>
<div class="paragraph">
<p>Here, explanation is given using TERASOLUNA Server Framework for Java (5.x), as an implementation example of Web application.<br>
Kindly remember that only explanation is offered and TERASOLUNA Server 5.x is not a necessary requirement of asynchronous execution (Web container).</p>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_How_to_implements"><a class="anchor" href="#Ch04_AsyncJobWithWeb_How_to_implements"></a>4.4.3.1. Overview of implementation of application by asynchronous execution (Web container)</h5>
<div class="paragraph">
<p>Explanation is given based on following configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web application project and batch application project are independent
and a batch application is referred from a web application.</p>
<div class="ulist">
<ul>
<li>
<p>war file generated from Web application project contains
jar file generated from batch application project</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementation of asynchronous execution is performed in accordance with <a href="#Ch04_AsyncJobWithWeb_Arch">Architecture</a> wherein Spring
MVC controller in the Web application starts the job by using <code>JobOperator</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About isolation of Web/batch application project</div>
<div class="paragraph">
<p>Final deliverable of application build is a war file of Web application, however,
a development project should be implemented by separating Web/batch applications.<br>
Since it is a library which can be operated by a batch application alone, it helps in identifying work boundary
and library dependency besides making the development project testing easier to implement.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Web/batch development is explained now assuming the use of 2 components below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Batch application project by TERASOLUNA Batch 5.x</p>
</li>
<li>
<p>Web application project by TERASOLUNA Server 5.x</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For how to create a batch application project and how to implement a basic job, refer
<a href="#Ch03_CreateProject_HowToCreate">"How to create a project"</a>,
<a href="#Ch03_CreateTaskletJob">"Creation of tasklet model job"</a>,
<a href="#Ch03_CreateChunkJob">"Creation of chunk model job"</a>.</p>
</div>
<div class="paragraph">
<p>Here, we will focus on starting a batch application from a Web application.</p>
</div>
<div class="paragraph">
<p>Here, explanation is given by creating a batch application project,
by using Maven archetype:generate.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">How to create a job project</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.sample</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">asyncbatch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.sample</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A job registered from the beginning for a blank project is used for convenience of explanation.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Job used for explanation</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">job01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">param1=value1</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Precautions for asynchronous execution (Web container) job design</div>
<div class="paragraph">
<p>Individual jobs are completed in a short period of time as a characteristic of asynchronous execution (Web container)
 and are operated in a stateless manner on the Web container.<br>
Further, it is necessary to build a job definition with only a single step to avoid complexity and it is desirable not
 to define flow branching by using exit codes of step and parallel/multiple processing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a Web application as a state wherein a jar file including a job implementation can be created.</p>
</div>
<div class="paragraph">
<div class="title">Implementation of Web application</div>
<p>How to implement a Web application is explained by using a blank project offered by TERASOLUNA Server 5.x.
For details, refer TERASOLUNA Server 5.x Development Guideline
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ImplementationAtEachLayer/CreateWebApplicationProject.html">Creating a development project for Web application</a>.</p>
</div>
<div class="paragraph">
<p>Here, similar to asynchronous execution application project, explanation is given below creating with the following names.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">How to create a Web container project</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.sample</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">asyncapp</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.sample</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About naming of groupId</div>
<div class="paragraph">
<p>Although naming a project is optional, when a batch application as a Maven multiproject is considered as a sub-module,
it is easy to manage if <code>groupId<code> is integrated.<br>
Here, </code>groupId<code> of both is considered as </code>org.terasoluna.batch.sample`</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_Config"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_Config"></a>4.4.3.2. Various settings</h5>
<div class="paragraph">
<div class="title">Include batch application as a part of Web application</div>
<p>Edit pom.xml and include batch application as a part of Web application.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Batch application is registered in NEXUS or Maven local repository as <code>jar</code>
This process is not required while setting a separate project from that of Web application.<br>
However, target to be built by Maven is a separate project and it will not be reflected while building the web application even if the batch application is modified.<br>
It should be registered in the same repository in order to reflect the modification of batch application in the Web application.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_DirectoryStructure.png" alt="directory structure">
</div>
<div class="title">Directory structure</div>
</div>
<div class="listingblock">
<div class="title">asyncapp/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;modules&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-domain<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-env<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-initdb<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-web<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncapp-selenium<span class="tag">&lt;/module&gt;</span>
    <span class="tag">&lt;module&gt;</span>asyncbatch<span class="tag">&lt;/module&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="tag">&lt;/modules&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">asyncapp/asyncbatch/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="tag">&lt;modelVersion&gt;</span>4.0.0<span class="tag">&lt;/modelVersion&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.terasoluna.batch.sample<span class="tag">&lt;/groupId&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>asyncbatch<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="tag">&lt;parent&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.terasoluna.batch.sample<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>asyncapp<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;relativePath&gt;</span>../pom.xml<span class="tag">&lt;/relativePath&gt;</span>
  <span class="tag">&lt;/parent&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Deleted / added contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add settings for considering the Web application as a parent and batch application as a child.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete unnecessary description with deletion of child or sub-module.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Addition of dependent library</div>
<p>Add a batch application as a dependent library of Web application.</p>
</div>
<div class="listingblock">
<div class="title">asyncapp/async-web/pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>${project.groupId}<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>asyncbatch<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>${project.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
  <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/project&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Details added</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a batch application as a dependent library of Web application.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp"></a>4.4.3.3. Implementation of Web application</h5>
<div class="paragraph">
<p>Here, a RESTful Web service is created as a Web application using TERASOLUNA Server 5.x Development Guideline as a reference below.</p>
</div>
<div class="paragraph">
<p>Setting for enabling Spring MVC component which is necessary for <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebServiceDetail/REST.html">RESTful Web Service</a></p>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Config"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Config"></a>4.4.3.3.1. Web application settings</h6>
<div class="paragraph">
<p>At first, add, delete and edit various configuration files from the blank project of Web application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the explanation, an implementation which use RESTful Web Service as an implementation status of batch application is given.<br>
Procedure will be same even when conventional Web application (Servlet/JSP) or SOAP is used. Read accordingly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_AsyncJobWithWebContainer_AppendBeanDefinitionsOnBlank.png" alt="AppendBeanDefinitionsOnBlank">
</div>
<div class="title">Bean definition file to be added/deleted from a blank project</div>
</div>
<div class="listingblock">
<div class="title">Description example of asyncapp/asyncapp-web/src/main/resources/META-INF/spring/spring-mvc-rest.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/spring/launch-context.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jsonMessageConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.http.converter.json.MappingJackson2HttpMessageConverter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:objectMapper-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">objectMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">objectMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dateFormat</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.fasterxml.jackson.databind.util.StdDateFormat</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;mvc:annotation-driven&gt;</span>
  <span class="tag">&lt;mvc:message-converters</span> <span class="attribute-name">register-defaults</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jsonMessageConverter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/mvc:message-converters&gt;</span>
<span class="tag">&lt;/mvc:annotation-driven&gt;</span>

<span class="tag">&lt;mvc:default-servlet-handler</span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;context:component-scan</span> <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.sample.app.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.AutomaticJobRegistrar</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applicationContextFactories</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.ClasspathXmlApplicationContextsFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                  <span class="tag">&lt;value&gt;</span>classpath:/META-INF/jobs/**/*.xml<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLoader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.configuration.support.DefaultJobLoader</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:jobRegistry-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRegistry</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobLauncher</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJobLauncher</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:jobRepository-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:taskExecutor-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Description example of asyncapp/asyncapp-web/src/main/webapp/WEB-INF/web.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;servlet&gt;</span>
    <span class="tag">&lt;servlet-name&gt;</span>restApiServlet<span class="tag">&lt;/servlet-name&gt;</span>
    <span class="tag">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/servlet-class&gt;</span>
    <span class="tag">&lt;init-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>contextConfigLocation<span class="tag">&lt;/param-name&gt;</span>
        <span class="comment">&lt;!-- (6) --&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>classpath*:META-INF/spring/spring-mvc-rest.xml<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/init-param&gt;</span>
    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;init-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>spring.profiles.active<span class="tag">&lt;/param-name&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>async<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/init-param&gt;</span>
    <span class="tag">&lt;load-on-startup&gt;</span>1<span class="tag">&lt;/load-on-startup&gt;</span>
<span class="tag">&lt;/servlet&gt;</span>

<span class="tag">&lt;servlet-mapping&gt;</span>
    <span class="tag">&lt;servlet-name&gt;</span>restApiServlet<span class="tag">&lt;/servlet-name&gt;</span>
    <span class="tag">&lt;url-pattern&gt;</span>/api/v1/*<span class="tag">&lt;/url-pattern&gt;</span>
<span class="tag">&lt;/servlet-mapping&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">RESTful Web Service validation example</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Import <code>launch-context.xml</code> which is in the batch application and incorporate required Bean definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describe package for dynamically scanning the controller.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describe a Bean definition of <code>AutomaticJobRegistrar</code> which dynamically loads as a child or sub context by modularizing each Bean definition file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>TaskExecutor</code> which executes the job asynchronously.<br>
Asynchronous execution can be performed by setting <code>AsyncTaskExecutor</code> implementation class in <code>TaskExecutor</code> of JobLauncher.
Use <code>ThreadPoolTaskExecutor</code> which is one of the components of <code>AsyncTaskExecutor</code> implementation class.</p>
<p class="tableblock">Further, multiplicity of threads which can be operated in parallel can be specified.<br>
In this example, 3 threads are assigned to the job execution and requests exceeding this number are queued upto 10.
Queued job is in "not started" state, however REST request is considered to be successful.+
In addition, job requests that exceed the queuing limit generate <code>`org.springframework.core.task.TaskRejectedException</code>
and job run request is rejected.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Override <code>jobLauncher</code> defined in <code>launch-context.xml</code> to enable <code>taskExecutor</code> of (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>spring-mvc-rest.xml</code> described above as a Bean definition<br>
read by <code>DispatcherServlet</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>async</code> which shows an asynchronous batch, as a profile of Spring Framework.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">When async profile is not specified</div>
<div class="paragraph">
<p>In this case, a Bean defined in <code>launch-context.xml</code> which should be shared across Web applications is duplicated for each job.<br>
Even in case of duplication, since the operation takes place at the functional level, it is difficult to notice an error and it may result in unexpected resource exhaustion and performance degradation.
Must be specified.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Thread pool sizing</div>
<div class="paragraph">
<p>When the upper limit of thread pool is in excess, an enormous amount of jobs run in parallel resulting
in deterioration of entire thread pool.
Sizing should be done and appropriate upper value must be determined.<br>
Besides thread pool of asynchronous execution, request thread of Web container and
other applications working in the same enclosure must also be considered.</p>
</div>
<div class="paragraph">
<p>Further, a separate request must be sent from Web client for checking occurrence of <code>TaskRejectException</code> due to
thread pool exhaustion and its re-execution.
Hence, <code>queue-capacity</code> which waits for job to start must be set at the time of thread pool exhaustion.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Implementation of RESTful Web Service API</div>
<p>Here, "Running a job" and "Job status check" are defined as 2 examples of requests used in REST API.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">REST API Definition example</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 15%;">
<col style="width: 25%;">
<col style="width: 10%;">
<col style="width: 15%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">API</th>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">HTTP method</th>
<th class="tableblock halign-left valign-top">Request/Response</th>
<th class="tableblock halign-left valign-top">Message format</th>
<th class="tableblock halign-left valign-top">Message details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Running a job</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">/api/v1/job/<em>Job name</em></p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">POST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job parameter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job execution ID<br>
Job name<br>
Message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Job execution status check</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">/api/v1/job/<em>Job execution ID</em></p></td>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">GET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job execution ID<br>
Job name<br>
Job execution status<br>
Job exit code<br>
Step execution ID<br>
Step name<br>
Step exit code</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_JavaBeans"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_JavaBeans"></a>4.4.3.3.2. Implementation of JavaBeans used in Controller</h6>
<div class="paragraph">
<p>Create following 3 classes that are returned to REST client as JSON message.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job run operation <code><code>JobOperationResource</code></code></p>
</li>
<li>
<p>Job execution status <code><code>JobExecutionResource</code></code></p>
</li>
<li>
<p>Step execution status <code>StepExecutionResource</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These classes are implementations for reference except for job execution ID  (<code>job execution id</code>) of <code>JobOperationResource</code> and implementation of field is optional.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of job run operation information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/org/terasoluna/batch/sample/app/api/jobinfo/JobOperationResource.java</span>
<span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.sample.app.api.jobinfo</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">JobOperationResource</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> jobName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> jobParams = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">Long</span> jobExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> errorMessage = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="exception">Exception</span> error = <span class="predefined-constant">null</span>;

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of job execution information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/org/terasoluna/batch/sample/app/api/jobinfo/JobExecutionResource.java</span>
<span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.sample.app.api.jobinfo</span>;

<span class="comment">// omitted.</span>

<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionResource</span> {

    <span class="directive">private</span> <span class="predefined-type">Long</span> jobExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> jobName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">Long</span> stepExecutionId = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> stepName = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;StepExecutionResource&gt; stepExecutions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="directive">private</span> <span class="predefined-type">String</span> status = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> exitStatus = <span class="predefined-constant">null</span>;

    <span class="directive">private</span> <span class="predefined-type">String</span> errorMessage;

    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; failureExceptions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of step execution information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/org/terasoluna/batch/sample/app/api/jobinfo/StepExecutionResource.java</span>
<span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.sample.app.api.jobinfo</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">StepExecutionResource</span> {

  <span class="directive">private</span> <span class="predefined-type">Long</span> stepExecutionId = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">String</span> stepName = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">String</span> status = <span class="predefined-constant">null</span>;

  <span class="directive">private</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; failureExceptions = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="comment">// Getter and setter are omitted.</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller"></a>4.4.3.3.3. Implementation of controller</h6>
<div class="paragraph">
<p>A controller of RESTful Web Service is implemented by using <code>@RestController</code>.<br>
in order to simplify, <code>JobOperator</code> is injected in the controller and running a job and execution status are fetched.
Of course, <code>JobOperator</code> can also be started by using Service from the controller in accordance with TERASOLUNA Server 5.x.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About job parameters that are passed at the time of running a job</div>
<div class="paragraph">
<p>The job parameter passed in the second argument of <code>JobOperator#start()</code> at running a job is <code>String</code>.
When there are multiple job parameters, they should be separated by using a comma unlike <code>CommandLineJobRunner</code> of synchronous execution.
Basically the format is as below.<br>
<code>{Job parameter 1}={Value 1},{Job parameter 2}={Value 2},&#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>This is same as the method of specifying job parameters in <a href="#Ch04_AsyncJobWithDB">"Asynchronous execution (DB polling)"</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example of implementing a controller</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/org/terasoluna/batch/sample/app/api/JobController.java</span>
<span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.sample.app.api</span>;

<span class="comment">// omitted.</span>

<span class="comment">// (1)</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RestController</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobController</span> {

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    JobOperator jobOperator;

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    JobExplorer jobExplorer;

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">{jobName}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.POST)
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; launch(<span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobName</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> jobName,
            <span class="annotation">@RequestBody</span> JobOperationResource requestResource) {

        JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
        responseResource.setJobName(jobName);
        <span class="keyword">try</span> {
            <span class="comment">// (3)</span>
            <span class="predefined-type">Long</span> jobExecutionId = jobOperator.start(jobName, requestResource.getJobParams());
            responseResource.setJobExecutionId(jobExecutionId);
            <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
        } <span class="keyword">catch</span> (NoSuchJobException | JobInstanceAlreadyExistsException | JobParametersInvalidException e) {
            responseResource.setError(e);
            <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
        }
    }

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">{jobExecutionId}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.GET)
    <span class="annotation">@ResponseStatus</span>(HttpStatus.OK)
    <span class="directive">public</span> JobExecutionResource getJob(<span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

        JobExecutionResource responseResource = <span class="keyword">new</span> JobExecutionResource();
        responseResource.setJobExecutionId(jobExecutionId);

        <span class="comment">// (4)</span>
        JobExecution jobExecution = jobExplorer.getJobExecution(jobExecutionId);

        <span class="keyword">if</span> (jobExecution == <span class="predefined-constant">null</span>) {
            responseResource.setErrorMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Job execution not found.</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
            mappingExecutionInfo(jobExecution, responseResource);
        }

        <span class="keyword">return</span> responseResource;
    }

    <span class="directive">private</span> <span class="type">void</span> mappingExecutionInfo(JobExecution src, JobExecutionResource dest) {
      dest.setJobName(src.getJobInstance().getJobName());
      <span class="keyword">for</span> (StepExecution se : src.getStepExecutions()) {
          StepExecutionResource ser = <span class="keyword">new</span> StepExecutionResource();
          ser.setStepExecutionId(se.getId());
          ser.setStepName(se.getStepName());
          ser.setStatus(se.getStatus().toString());
          <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : se.getFailureExceptions()) {
              ser.getFailureExceptions().add(th.toString());
          }
          dest.getStepExecutions().add(ser);
      }
      dest.setStatus(src.getStatus().toString());
      dest.setExitStatus(src.getExitStatus().toString());
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Implementation of controller</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>@RestController</code>.
Further, when servlet mapping of <code>web.xml</code> is done by using <code>@RequestMapping("job")</code>,
base path of REST API is <code><em>contextName</em>/api/v1/job/</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describe field injections of <code>JobOperator</code> and <code>JobExplorer</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>JobOperator</code> and start a new asynchronous job.<br>
Receive job execution ID as a return value and return to REST client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>JobExplorer</code> and fetch job execution status (<code>JobExecution</code>) based on job execution ID.<br>
Return it to REST client after converting it to a pre-designed message.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_integration_configs"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_integration_configs"></a>4.4.3.3.4. Integration of Web/batch application module setting</h6>
<div class="paragraph">
<p>Batch application module (<code>asyncbatch</code>) operates as a stand-alone application.
Hence, batch application module (<code>asyncbatch</code>) consists of settings which are in conflict and overlapping with settings of Web application module (<code>asyncapp-web</code>).
These settings must be integrated as required.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Integration of log configuration file <code>logback.xml</code><br>
When multiple Logback definition files are defined in Web/batch, they do not work appropriately.<br>
The contents of <code>asyncbatch/src/main/resources/logback.xml</code> are integrated into same file of <code>asyncapp-env/src/main/resources/</code> and then the file is deleted.</p>
</li>
<li>
<p>Data source and MyBatis configuration file are not integrated<br>
Definitions of data source and MyBatis configuration file are not integrated between Web/batch since the definition of application context is independent due to following relation.</p>
<div class="ulist">
<ul>
<li>
<p><code>asyncbatch</code> module of the batch is defined in the servlet as a closed context.</p>
</li>
<li>
<p><code>asyncapp-domain</code> and <code>asyncapp-env</code> modules of Web are defined as contexts used by entire application.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Cross-reference of data source and MyBatis settings by Web and batch modules</div>
<div class="paragraph">
<p>Since the scope of context for Web and batch modules is different,
data source, MyBatis settings and Mapper interface cannot be referred especially from Web module.<br>
Since initialization of RDBMS schema is also carried out independently based on the different settings of respective
modules, adequate care must be taken not to perform unintended initialization due to mutual interference.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">CSRF countermeasures specific to REST controller</div>
<div class="paragraph">
<p>When a request is sent for REST controller in the initialization settings of Web blank project, it results in a CSRF
error and execution of job is rejected.
Hence, explanation is given here assuming that CSRF countermeasures are disabled by the following method.</p>
</div>
<div class="paragraph">
<p><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebServiceDetail/REST.html#csrf">CSRF countermeasures</a></p>
</div>
<div class="paragraph">
<p>Web application created here is not published on the internet and CSRF countermeasures are disabled on the premise that
REST request is not sent from a third party who can exploit CSRF as a means of attack.
Please note that necessity may differ in the actual Web application depending on the operating environment.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Build"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Build"></a>4.4.3.3.5. Build</h6>
<div class="paragraph">
<p>Build Maven command and create a war file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ cd asyncapp
$ ls
asyncbatch/  asyncapp-web/  pom.xml
$ mvn clean package
[INFO] Scanning for projects...
[INFO] ------------------------------------------------------------------------
[INFO] Reactor Build Order:
[INFO]
[INFO] TERASOLUNA Server Framework for Java (5.x) Web Blank Multi Project (MyBatis3)
[INFO] TERASOLUNA Batch Framework for Java (5.x) Blank Project
[INFO] asyncapp-web
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building TERASOLUNA Server Framework for Java (5.x) Web Blank Multi Project (MyBatis3) 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------

(omitted)

[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO]
[INFO] TERASOLUNA Server Framework for Java (5.x) Web Blank Multi Project (MyBatis3) SUCCESS [  0.226 s]
[INFO] TERASOLUNA Batch Framework for Java (5.x) Blank Project SUCCESS [  6.481s]
[INFO] asyncapp-web ....................................... SUCCESS [  5.400 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 12.597 s
[INFO] Finished at: 2017-02-10T22:32:43+09:00
[INFO] Final Memory: 38M/250M
[INFO] ------------------------------------------------------------------------
$</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Deploy"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Deploy"></a>4.4.3.3.6. Deploy</h6>
<div class="paragraph">
<p>Start a Web container like Tomcat and deploy <code>war</code> file generated in the build.
Detailed process is omitted.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToUse_WebApp_Run"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Run"></a>4.4.3.4. Job start and confirmation of execution results using REST Client</h5>
<div class="paragraph">
<p>Here, curl command is used as a REST client and an asynchronous job is started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ curl -v \
  -H &quot;Accept: application/json&quot; -H &quot;Content-type: application/json&quot; \
  -d '{&quot;jobParams&quot;: &quot;param1=value1&quot;}' \
  http://localhost:8080/asyncapp-web/api/v1/job/job01
* timeout on name lookup is not supported
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8088 (#0)
&gt; POST /asyncapp-web/api/v1/job/job01 HTTP/1.1
&gt; Host: localhost:8088
&gt; User-Agent: curl/7.51.0
&gt; Accept: application/json
&gt; Content-type: application/json
&gt; Content-Length: 30
&gt;
* upload completely sent off: 30 out of 30 bytes
&lt; HTTP/1.1 200
&lt; X-Track: 0267db93977b4552880a4704cf3e4565
&lt; Content-Type: application/json;charset=UTF-8
&lt; Transfer-Encoding: chunked
&lt; Date: Fri, 10 Feb 2017 13:55:46 GMT
&lt;
{&quot;jobName&quot;:&quot;job01&quot;,&quot;jobParams&quot;:null,&quot;jobExecutionId&quot;:3,&quot;error&quot;:null,&quot;errorMessag
e&quot;:null}* Curl_http_done: called premature == 0
* Connection #0 to host localhost left intact
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the above, it can be confirmed that job is executed with a job execution ID <code>jobExecutionId = 3</code>.<br>
Subsequently, job execution results are fetched by using job execution ID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ curl -v http://localhost:8080/asyncapp-web/api/v1/job/3
* timeout on name lookup is not supported
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 8088 (#0)
&gt; GET /asyncapp-web/api/v1/job/3 HTTP/1.1
&gt; Host: localhost:8088
&gt; User-Agent: curl/7.51.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200
&lt; X-Track: 7d94bf4d383745efb20cbf37cb6a8e13
&lt; Content-Type: application/json;charset=UTF-8
&lt; Transfer-Encoding: chunked
&lt; Date: Fri, 10 Feb 2017 14:07:44 GMT
&lt;
{&quot;jobExecutionId&quot;:3,&quot;jobName&quot;:&quot;job01&quot;,&quot;stepExecutions&quot;:[{&quot;stepExecutionId&quot;:5,&quot;st
epName&quot;:&quot;job01.step01&quot;,&quot;status&quot;:&quot;COMPLETED&quot;,&quot;failureExceptions&quot;:[]}],&quot;status&quot;:&quot;C
OMPLETED&quot;,&quot;exitStatus&quot;:&quot;exitCode=COMPLETED;exitDescription=&quot;,&quot;errorMessage&quot;:null
}* Curl_http_done: called premature == 0
* Connection #0 to host localhost left intact
$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>exitCode=COMPLETED</code>, it can be confirmed that the job is completed successfully.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">When execution results of curl are to be determined by a shell script etc</div>
<div class="paragraph">
<p>In the example above, it is displayed upto the response message using REST API.
When only HTTP status is to be confirmed by curl command, HTTP status can be displayed in standard output by considering <code>curl -s URL -o /dev/null -w "%{http_code}\n"</code>.<br>
However, since job execution ID need to analyse JSON of response body part, REST
client application must be created as required.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_AsyncJobWithWeb_HowToExtend"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToExtend"></a>4.4.4. How to extend</h4>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_HowToExtend_Stop_And_Restart"><a class="anchor" href="#Ch04_AsyncJobWithWeb_HowToExtend_Stop_And_Restart"></a>4.4.4.1. Stopping and restarting jobs</h5>
<div class="paragraph">
<p>It is necessary to stop and restart asynchronous jobs from the multiple jobs that are being executed.
Further, when jobs of identical names are running in parallel, it is necessary to target only those jobs with the issues.
Hence, job execution to be targeted must be identified and the status of the job must be confirmed.<br>
When this premise is met, an implementation for stopping and restarting asynchronous executions is explained here.</p>
</div>
<div class="paragraph">
<p>Further, a method to add job stopping (stop) and restarting (restart) is explained
for <code>JobController</code> of <a href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp_Controller">Implementation of controller</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Job stopping and restarting can also be implemented without using <code>JobOperator</code>.<br>
For details, refer <a href="#Ch07_JobManagement">Job management</a> and identify a method suitable for this objective.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Implementation example of stop and restart</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// asyncapp/asyncapp-web/src/main/java/org/terasoluna/batch/sample/app/api/JobController.java</span>
<span class="keyword">package</span> <span class="namespace">org.terasoluna.batch.sample.app.api</span>;

<span class="comment">// omitted.</span>

<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">job</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RestController</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobController</span> {

    <span class="comment">// omitted.</span>

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">stop/{jobExecutionId}</span><span class="delimiter">&quot;</span></span>, method = RequestMethod.PUT)
    <span class="annotation">@Deprecated</span>
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; stop(
            <span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

      JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
      responseResource.setJobExecutionId(jobExecutionId);
      <span class="type">boolean</span> result = <span class="predefined-constant">false</span>;
      <span class="keyword">try</span> {
          <span class="comment">// (1)</span>
          result = jobOperator.stop(jobExecutionId);
          <span class="keyword">if</span> (!result) {
              responseResource.setErrorMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">stop failed.</span><span class="delimiter">&quot;</span></span>);
              <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
          }
          <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
      } <span class="keyword">catch</span> (NoSuchJobExecutionException | JobExecutionNotRunningException e) {
          responseResource.setError(e);
          <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
      }
    }

    <span class="annotation">@RequestMapping</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">restart/{jobExecutionId}</span><span class="delimiter">&quot;</span></span>,
                    method = RequestMethod.PUT)
    <span class="annotation">@Deprecated</span>
    <span class="directive">public</span> ResponseEntity&lt;JobOperationResource&gt; restart(
            <span class="annotation">@PathVariable</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionId</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Long</span> jobExecutionId) {

        JobOperationResource responseResource = <span class="keyword">new</span> JobOperationResource();
        responseResource.setJobExecutionId(jobExecutionId);
        <span class="keyword">try</span> {
            <span class="comment">// (2)</span>
            <span class="predefined-type">Long</span> id = jobOperator.restart(jobExecutionId);
            responseResource.setJobExecutionId(id);
            <span class="keyword">return</span> ResponseEntity.ok().body(responseResource);
        } <span class="keyword">catch</span> (JobInstanceAlreadyCompleteException |
                  NoSuchJobExecutionException | NoSuchJobException |
                  JobRestartException | JobParametersInvalidException e) {
            responseResource.setErrorMessage(e.getMessage());
            <span class="keyword">return</span> ResponseEntity.badRequest().body(responseResource);
        }
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Implementation example of stop / restart using controller</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify "stop" for job being executed by calling <code>JobOperator#stop()</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-execute from the step where the job has terminated abnormally or stopped by calling <code>JobOperator#restart()</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch04_AsyncJobWithWeb_Multiple_Launch"><a class="anchor" href="#Ch04_AsyncJobWithWeb_Multiple_Launch"></a>4.4.4.2. Multiple running</h5>
<div class="paragraph">
<p>Multiple running signify that a Web container is started for multiple times and waits for respective job requests.</p>
</div>
<div class="paragraph">
<p>Execution of asynchronous jobs is controlled by external RDBMS so as to connect to each application.
By sharing an external RDBMS, it is possible to wait for an asynchronous job to be started across the same enclosure or another enclosure.</p>
</div>
<div class="paragraph">
<p>Applications include load balancing and redundancy for specific jobs.
However, as described in <a href="#Ch04_AsyncJobWithWeb_HowToUse_WebApp">Implementation of Web application</a>,
these effects cannot be obtained easily just by starting multiple Web containers or enhancing parallel operations.
Sometimes measures similar to a general Web application need to be taken in order to obtain the effect.
An example is given below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 request processing operates in a stateless manner according to the characteristics of Web application, however,
asynchronous execution of batch is likely to have a reduced failure tolerance unless it is designed in combination with job start results and confirmation.<br>
For example, even when Web container for starting a job is made redundant, it is difficult to confirm the progress
and results of the job when the job execution ID  is lost after starting a job due to failure on the client side.</p>
</li>
<li>
<p>A function to distribute request destinations on the client side must be implemented and a load balancer must be
introduced in order to distribute the load on multiple Web containers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this way, adequacy of multiple starts cannot be necessarily determined.
Hence, using load balancer and reviewing a control method to send requests by Web client should be considered based on the purpose and use.
A design which does not degrade the performance and fault tolerance of the asynchronous execution application is required.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch04_Listener"><a class="anchor" href="#Ch04_Listener"></a>4.5. Listener</h3>
<div class="sect3">
<h4 id="Ch04_Listener_Overview"><a class="anchor" href="#Ch04_Listener_Overview"></a>4.5.1. Overview</h4>
<div class="paragraph">
<p>A listener is an interface for inserting processing before and after executing a job or a step.</p>
</div>
<div class="paragraph">
<p>Since this function works differently for chunk model and tasket model, respective explanations are given.</p>
</div>
<div class="paragraph">
<p>A listener consists of multiple interfaces, respective roles are explained here.
Subsequently, how to set and implement a listener is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_Overview_Types"><a class="anchor" href="#Ch04_Listener_Overview_Types"></a>4.5.1.1. Types of listener</h5>
<div class="paragraph">
<p>A lot of listener interfaces are defined in Spring Batch.
All will not be explained here, however we will focus on the interface with highest usage frequency.</p>
</div>
<div class="paragraph">
<p>A listener is roughly divided into 2 types.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JobListener</dt>
<dd>
<p>An interface to insert the processing for execution of the job</p>
</dd>
<dt class="hdlist1">StepListener</dt>
<dd>
<p>An interface to insert the processing for execution of the step</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About JobListener</div>
<div class="paragraph">
<p>An interface called <code>JobListener</code> does not exist in Spring Batch.
It is conveniently described in this guideline for the comparison with <code>StepListener</code>.<br>
Java Batch(jBatch) consists of an interface called <code>javax.batch.api.listener.JobListener</code>, hence care should be taken at the time of implementation to avoid mistakes.
Further, <code>StepListener</code> also consists of interface with same name but different signature (<code>javax.batch.api.listener.StepListener</code>), so it is necessary to take adequate precautions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_Overview_Types_JobListener"><a class="anchor" href="#Ch04_Listener_Overview_Types_JobListener"></a>4.5.1.1.1. JobListener</h6>
<div class="paragraph">
<p><code>JobListener</code> interface consists of only one <code>JobExecutionListener</code>.</p>
</div>
<div id="Ch04_Listener_Overview_Types_JobExecutionListener" class="dlist">
<dl>
<dt class="hdlist1">JobExecutionListener</dt>
<dd>
<p>Process is inserted prior to starting a job and after terminating a job.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">JobExecutionListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">JobExecutionListener</span> {
  <span class="type">void</span> beforeJob(JobExecution jobExecution);
  <span class="type">void</span> afterJob(JobExecution jobExecution);
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_Overview_Types_StepListener"><a class="anchor" href="#Ch04_Listener_Overview_Types_StepListener"></a>4.5.1.1.2. StepListener</h6>
<div class="paragraph">
<p><code>StepListener</code> interface is of multiple types as below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">StepListener</dt>
<dd>
<p>Marker interfaces of various listeners will be introduced later.</p>
</dd>
</dl>
</div>
<div id="Ch04_Listener_Overview_Types_StepExecutionListener" class="dlist">
<dl>
<dt class="hdlist1">StepExecutionListener</dt>
<dd>
<p>Process is inserted prior to starting a step and after terminating a job.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">StepExecutionListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">StepExecutionListener</span> <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeStep(StepExecution stepExecution);
  ExitStatus afterStep(StepExecution stepExecution);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ChunkListener" class="dlist">
<dl>
<dt class="hdlist1">ChunkListener</dt>
<dd>
<p>A process is inserted between before and after processing of one chunk and when an error occurs.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ChunkListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ChunkListener</span> <span class="directive">extends</span> StepListener {
  <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ROLLBACK_EXCEPTION_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">sb_rollback_exception</span><span class="delimiter">&quot;</span></span>;
  <span class="type">void</span> beforeChunk(ChunkContext context);
  <span class="type">void</span> afterChunk(ChunkContext context);
  <span class="type">void</span> afterChunkError(ChunkContext context);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Uses of ROLLBACK_EXCEPTION_KEY</div>
<div class="paragraph">
<p>It is used when the exception occurred is to be fetched by <code>afterChunkError</code> method.
If an error occurs during chunk process, Spring Batch uses <code>sb_rollback_exception</code> key in <code>ChunkContext</code> to call
<code>ChunkListener</code> after storing the exception which can be accessed as below.</p>
</div>
<div class="listingblock">
<div class="title">Usage example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext context) {
    logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context,
            context.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY));
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For exception handling, refer <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_ChunkListener">Exception handling using ChunkListener interface</a></p>
</div>
<div id="Ch04_Listener_Overview_Types_ItemReadListener" class="dlist">
<dl>
<dt class="hdlist1">ItemReadListener</dt>
<dd>
<p>Insert a process before and after fetching 1 data record by ItemReader and when an error occurs.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemReadListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemReadListener</span>&lt;T&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeRead();
  <span class="type">void</span> afterRead(T item);
  <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ItemProcessListener" class="dlist">
<dl>
<dt class="hdlist1">ItemProcessListener</dt>
<dd>
<p>Insert a process before and after processing 1 data record by ItemProcessor and when an error occurs.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemProcessListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemProcessListener</span>&lt;T, S&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeProcess(T item);
  <span class="type">void</span> afterProcess(T item, S result);
  <span class="type">void</span> onProcessError(T item, <span class="exception">Exception</span> e);
}</code></pre>
</div>
</div>
<div id="Ch04_Listener_Overview_Types_ItemWriteListener" class="dlist">
<dl>
<dt class="hdlist1">ItemWriteListener</dt>
<dd>
<p>Insert a process before and after output of 1 chunk by ItemWriter and when an error occurs.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">ItemWriteListener interface</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ItemWriteListener</span>&lt;S&gt; <span class="directive">extends</span> StepListener {
  <span class="type">void</span> beforeWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
  <span class="type">void</span> afterWrite(<span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
  <span class="type">void</span> onWriteError(<span class="exception">Exception</span> exception, <span class="predefined-type">List</span>&lt;? <span class="directive">extends</span> S&gt; items);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This guideline does not explain following listeners.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retry type listener</p>
</li>
<li>
<p>Skip type listener</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These listeners are intended to be used for exception handling, however, the policy of these
guidelines is not to perform exception handling using these listeners.
For details, refer <a href="#Ch06_ExceptionHandling">Exception handling</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch04_Listener_HowToUse"><a class="anchor" href="#Ch04_Listener_HowToUse"></a>4.5.2. How to use</h4>
<div class="paragraph">
<p>Explanation is given about how to implement and set a listener.</p>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_Impl"><a class="anchor" href="#Ch04_Listener_HowToUse_Impl"></a>4.5.2.1. Implementation of a listener</h5>
<div class="paragraph">
<p>Explanation is given about how to implement and set a listener.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement the listener interface with <code>implements</code>.</p>
</li>
<li>
<p>Implement components with method-based annotation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The type of implementation to use will be choosed on the role of the listener. Criteria will be described later.</p>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_HowToUse_WithoutAnnotation"><a class="anchor" href="#Ch04_Listener_HowToUse_WithoutAnnotation"></a>4.5.2.1.1. When an interface is to be implemented</h6>
<div class="paragraph">
<p>Various listener interfaces are implemented by using <code>implements</code>. Multiple interfaces can be implemented at the same time based on requirement.
Implementation example is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example for JobExecutionListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionLoggingListener</span> <span class="directive">implements</span> JobExecutionListener { <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobExecutionLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) { <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job started. [JobName:{}]</span><span class="delimiter">&quot;</span></span>, jobExecution.getJobInstance().getJobName());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) { <span class="comment">// (3)</span>

        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job finished.[JobName:{}][ExitStatus:{}]</span><span class="delimiter">&quot;</span></span>, jobExecution.getJobInstance().getJobName(),
                jobExecution.getExitStatus().getExitCode());
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Configuration example of listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListener.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">processor</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;batch:listeners&gt;</span>
                 <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingEachProcessInStepListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/batch:listeners&gt;</span>
         <span class="tag">&lt;/batch:tasklet&gt;</span>
     <span class="tag">&lt;/batch:step&gt;</span>
     <span class="tag">&lt;batch:listeners&gt;</span>
         <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
     <span class="tag">&lt;/batch:listeners&gt;</span>
 <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>JobExecutionListener</code> using <code>implements</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>beforeJob</code> method defined by <code>JobExecutionListener</code>.<br>
In this example, job start log is output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>afterJob</code> method defined by <code>JobExecutionListener</code>.<br>
In this example, job end log is output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the listener implemented in (1), in <code>&lt;listeners&gt;</code> tag of Bean definition.<br>
Details of setup method are explained in <a href="#Ch04_Listener_HowToUse_Configuration">Listener settings</a>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Listener support class</div>
<div class="paragraph">
<p>When multiple listener interfaces are set to <code>implements</code>, blank implementation is required to be done for the components which are not necessary for the process.
Support classes wherein blank implementation is performed are provided in Spring Batch in order to simplify this operation.
Please note that support classes may be used instead of interfaces, and <code>extends</code> is used instead of <code>implements</code>.</p>
</div>
<div class="ulist">
<div class="title">Support class</div>
<ul>
<li>
<p><code>org.springframework.batch.core.listener.ItemListenerSupport</code></p>
</li>
<li>
<p><code>org.springframework.batch.core.listener.StepListenerSupport</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch04_Listener_HowToUse_WithAnnotation"><a class="anchor" href="#Ch04_Listener_HowToUse_WithAnnotation"></a>4.5.2.1.2. When annotations are assigned</h6>
<div class="paragraph">
<p>Annotations corresponding to various listener interfaces are assigned. Multiple annotations can also be implemented as required.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Correspondence table with listener interface</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Listener interface</th>
<th class="tableblock halign-left valign-top">Annotation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_JobExecutionListener">JobExecutionListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@beforeJob</code><br>
<code>@afterJob</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeStep</code><br>
<code>@AfterStep</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeChunk</code><br>
<code>@AfterChunk</code><br>
<code>@afterChunkError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemReadListener">ItemReadListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeRead</code><br>
<code>@AfterRead</code><br>
<code>@OnReadError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@beforeProcess</code><br>
<code>@afterProcess</code><br>
<code>@onProcessError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch04_Listener_Overview_Types_ItemWriteListener">ItemWriteListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@BeforeWrite</code><br>
<code>@AfterWrite</code><br>
<code>@OnWriteError</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These annotations work for the target scope by assigning them to the implementation method which is divided into components.
Implementation example is given below.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example for ItemProcessor wherein the annotation is assigned</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AnnotationAmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(AnnotationAmountCheckProcessor.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">if</span> (item.getAmount().signum() == -<span class="integer">1</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount is negative.</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> item;
    }

    <span class="comment">// (1)</span>
    <span class="comment">/*
    @BeforeProcess
    public void beforeProcess(Object item) {
        logger.info(&quot;before process. [Item :{}]&quot;, item);
    }
    */</span>

    <span class="comment">// (2)</span>
    <span class="annotation">@AfterProcess</span>
    <span class="directive">public</span> <span class="type">void</span> afterProcess(<span class="predefined-type">Object</span> item, <span class="predefined-type">Object</span> result) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">after process. [Result :{}]</span><span class="delimiter">&quot;</span></span>, result);
    }

    <span class="comment">// (3)</span>
    <span class="annotation">@OnProcessError</span>
    <span class="directive">public</span> <span class="type">void</span> onProcessError(<span class="predefined-type">Object</span> item, <span class="exception">Exception</span> e) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">on process error.</span><span class="delimiter">&quot;</span></span>, e);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Configuration example of listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListenerAnnotation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJobWithListenerAnnotation.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotationAmountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="error">&lt;</span>! -- (4) --<span class="error">&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the annotation is to be used for implementation, only the annotations of the timing required for the processing should be assigned.<br>
In this example, since no operation is required prior to processing of ItemProcess, the implementation wherein <code>@beforeProcess</code> is assigned, becomes unnecessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement the process to be performed after the processing of ItemProcess.<br>
In this example, process results are output in a log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement processing when an error occurs in ItemProcess.<br>
Exception generated in this example is output in a log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set ItemProcess wherein the listener is implemented by using annotation in <code>&lt;chunk&gt;</code> tag.<br>
Unlike listener interface, the listener is automatically registered even when it is not set in <code>&lt;listener&gt;</code> tag.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Constraints for the method which assigns the annotations</div>
<div class="paragraph">
<p>Any method cannot be used as a method to assign the annotation.
The signature must match with the method of corresponding listener interface.
This point is clearly mentioned in javadoc of respective annotations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Precautions while implementing JobExecutionListener by an annotation</div>
<div class="paragraph">
<p>Since JobExecutionListener has a different scope than the other listeners, listener is not automatically registered in the configuration above.
Hence, it is necessary to explicitly set in the <code>&lt;listener&gt;</code> tag. For details ,refer <a href="#Ch04_Listener_HowToUse_Configuration">Listener settings</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Implementation of a listener to Tasklet implementation by using annotation</div>
<div class="paragraph">
<p>When a listener is implemented in Tasklet implementation by using an annotation, Note that listener does not start with the following settings.</p>
</div>
<div class="listingblock">
<div class="title">In case of Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerAnnotation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJobWithListenerAnnotation.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotationSalesPlanDetailRegisterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In case of Tasket model, the listener interface should be used in accordance with <a href="#Ch04_Listener_HowToUse_SelectionCriteria">How to choose an interface or an annotation</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_Configuration"><a class="anchor" href="#Ch04_Listener_HowToUse_Configuration"></a>4.5.2.2. Listener settings</h5>
<div class="paragraph">
<p>Listeners are set by <code>&lt;listeners&gt;</code>.<code>&lt;listener&gt;</code> tag of Bean definition.
Although it can be described at various locations by XML schema definition, some operations do not work as intended based on the type of interface.
Set it to the following position.</p>
</div>
<div class="listingblock">
<div class="title">Position where listener is set</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- for chunk mode --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(1)</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(2)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(3)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- for tasklet mode --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(2)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(3)</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description of configuration value</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the component which includes the implementation attributing to <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>, performed by using an annotation.<br>
In case of an annotation, it will be inevitably set to this location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set listener interface implementation attributing to <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>.
In case of tasklet model, <code>ItemReadListener</code>, <code>ItemProcessListener</code> and <code>ItemWriteListener</code> cannot be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set listener attributing to <a href="#Ch04_Listener_Overview_Types_JobListener">JobListener</a>.<br>
Either of interface or annotations must be implemented here.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="setting-multiple-listeners"><a class="anchor" href="#setting-multiple-listeners"></a>4.5.2.2.1. Setting multiple listeners</h6>
<div class="paragraph">
<p>Multiple listeners can be set in <code>&lt;batch:listeners&gt;</code> tag.</p>
</div>
<div class="paragraph">
<p>The sequence in which the listeners are started while registering multiple listeners is shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ItemProcessListener implementation</p>
<div class="ulist">
<ul>
<li>
<p>listenerA, listenerB</p>
</li>
</ul>
</div>
</li>
<li>
<p>JobExecutionListener implementation</p>
<div class="ulist">
<ul>
<li>
<p>listenerC, listenerD</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Configuration example of multiple listeners</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pocessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerA</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">listenerD</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch04_Listener_composite.png" alt="Listener execution order">
</div>
<div class="title">Listener startup sequence</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Processing corresponding to pre-processing is started in the sequence of listener registration.</p>
</li>
<li>
<p>Processing corresponding to post-processing or error processing is started in the reverse sequence of listener registration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch04_Listener_HowToUse_SelectionCriteria"><a class="anchor" href="#Ch04_Listener_HowToUse_SelectionCriteria"></a>4.5.2.3. How to choose an interface or an annotation</h5>
<div class="paragraph">
<p>How to choose listener used a interface or listener used an annotation is explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listener interface</dt>
<dd>
<p>It is used in case of cross-sectional processes which are shared across job, step and chunk.</p>
</dd>
<dt class="hdlist1">Annotation</dt>
<dd>
<p>It is used when business logic specific process is to be performed.<br>
As a rule, it is implemented only for ItemProcessor.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch05"><a class="anchor" href="#Ch05"></a>5. Input/Output of Data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch05_Transaction"><a class="anchor" href="#Ch05_Transaction"></a>5.1. Transaction control</h3>
<div class="sect3">
<h4 id="Ch05_Transaction_Overview"><a class="anchor" href="#Ch05_Transaction_Overview"></a>5.1.1. Overview</h4>
<div class="paragraph">
<p>In this section, transaction control in jobs will be described in the following order.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_Transaction_Overview_TxType">About the pattern of transaction control in general batch processing</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_architecture_UnderSpringBatch">Transaction control in Spring Batch</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_HowToUse">"How to process resources like database and file transactionally"</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Since this function is different in usage between chunk model and tasklet model, each will be explained.</p>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_Overview_TxType"><a class="anchor" href="#Ch05_Transaction_Overview_TxType"></a>5.1.1.1. About the pattern of transaction control in general batch processing</h5>
<div class="paragraph">
<p>Generally, since batch processing is processing a large number of cases, if any errors are thrown at the end of the processing and all processing need to be done again,
the batch system schedule will be adversely affected.<br>
In order to avoid this, the influence at the time of error occurrence is often localized by advancing the process
while confirming the transaction for each fixed number of data within the processing of one job.<br>
(Hereafter, we call the "intermediate commit method" as the method of commiting the transaction for every fixed number of data,
 and the "chunk" as the one grouping the data in the commit unit.)</p>
</div>
<div class="paragraph">
<p>The points of the intermediate commit method are summarized below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Localize the effects at the time of error occurrence.</p>
<div class="ulist">
<ul>
<li>
<p>Even if an error occurs, the processing till the chunk just before the error part is confirmed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Only use a certain amount of resources.</p>
<div class="ulist">
<ul>
<li>
<p>Regardless of whether the data to be processed is large or small, only resources for chunks are used, so they are stable.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, the intermediate commit method is not a valid method in every situation.<br>
Processed data and unprocessed data are mixed in the system even though it is temporary.
As a result, since it is necessary to identify unprocessed data at the time of recovery processing, there is a possibility that the recovery becomes complicated.
In order to avoid this, all of the cases must be confirmed with one transaction, and not use the intermediate commit method.<br>
(Hereinafter, the method of determining all transactions in one transaction is called "single commit method".)</p>
</div>
<div class="paragraph">
<p>Nevertheless, if you process a large number of such as tens of thousands of items in a single commit method,
you will get a heavy load trying to reflect all the databases when committing.
Therefore, although the single commit method is suitable for small-scale batch processing, care must be taken when adopting it in a large-scale batch.
So this method is not a versatile method too.</p>
</div>
<div class="paragraph">
<p>In other words, there is a trade-off between "localization of impact" and "ease of recovery".
Which one of "intermediate commit method" and "single commit method" is used depends on the nature of the job and decides which one should be prioritized.<br>
Of course, it is not necessary to implement all the jobs in the batch system on either side.
It is natural to basically use "intermediate commit method" and use "single commit method" for special jobs (or the other way).</p>
</div>
<div class="paragraph">
<p>Below is the summary of advantages, disadvantages and adoption points of "intermediate commit method" and "single commit method".</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Features list by method</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Commit method</th>
<th class="tableblock halign-left valign-top">Advantage</th>
<th class="tableblock halign-left valign-top">Disadvantage</th>
<th class="tableblock halign-left valign-top">Adoption point</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">intermediate commit method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Localize the effect at the time of error occurrence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recovery processing may be complicated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When you want to process large amounts of data with certain machine resources</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">single commit method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure data integrity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There is a possibility of high work-load when processing a large number of cases</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When you want to set the processing result for the persistent resource to All or Nothing<br>
Suitable for small batch processing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes on inputting and outputting to the same table in the database</div>
<div class="paragraph">
<p>In terms of the structure of the database,
care is required when handling large amounts of data in processing to input and output to the same table regardless of the commit method.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As information that guarantees reading consistency is lost due to output (issuance of UPDATE),
errors may occur at the input (SELECT).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to avoid this, the following measures are taken.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increase the area to secure information.</p>
<div class="ulist">
<ul>
<li>
<p>When expanding, please consider it carefully in resource design.</p>
</li>
<li>
<p>Since the extension method depends on the database to be used, refer to the manual.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Divides input data and performs multiplexing processing.</p>
<div class="ulist">
<ul>
<li>
<p>Refer to <a href="#Ch08_ParallelAndMultiple_Partitioning">"Partitioning Step (Multiple processing)"</a> for multiple processing.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architecture"><a class="anchor" href="#architecture"></a>5.1.2. Architecture</h4>
<div class="sect4">
<h5 id="Ch05_Transaction_architecture_UnderSpringBatch"><a class="anchor" href="#Ch05_Transaction_architecture_UnderSpringBatch"></a>5.1.2.1. Transaction control in Spring Batch</h5>
<div class="paragraph">
<p>Job transaction control leverages the mechanism of Spring Batch.</p>
</div>
<div class="paragraph">
<p>Two kinds of transactions are defined below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Framework transaction</dt>
<dd>
<p>Transaction controlled by Spring Batch</p>
</dd>
<dt class="hdlist1">User transaction</dt>
<dd>
<p>Transactions controlled by the user</p>
</dd>
</dl>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_architecture_ChunkModel"><a class="anchor" href="#Ch05_Transaction_architecture_ChunkModel"></a>5.1.2.1.1. Transaction control mechanism in chunk model</h6>
<div class="paragraph">
<p>Transaction control in the chunk model is only the intermediate commit method.
A single commit method can not be done.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The single commit method in the chunk model is reported in JIRA.<br>
<a href="https://jira.spring.io/browse/BATCH-647" class="bare">https://jira.spring.io/browse/BATCH-647</a><br>
As a result, it is solved by customizing <code>chunk completion policy</code> and dynamically changing the chunk size.
However, with this method, since all data is stored in one chunk and memory is compressed, it can not be adopted as a method.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A feature of this method is that transactions are repeatedly performed for each chunk.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in normal process</dt>
<dd>
<p>Transaction control in normal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlChunkModel_commit.png" alt="Transaction Control Chunk Model Normal Process">
</div>
<div class="title">Sequence diagram of normal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The subsequent processing is repeated until there is no input data.</p>
</li>
<li>
<p>Start a framework transaction on a per chunk basis.</p>
</li>
<li>
<p>Repeat steps 2 to 5 until the chunk size is reached.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step obtains input data from <code>ItemReader</code>.</p>
</li>
<li>
<p><code>ItemReader</code> returns the input data to the step.</p>
</li>
<li>
<p>In the step, <code>ItemProcessor</code> processes input data.</p>
</li>
<li>
<p><code>ItemProcessor</code> returns the processing result to the step.</p>
</li>
<li>
<p>The step outputs data for chunk size with <code>ItemWriter</code>.</p>
</li>
<li>
<p><code>ItemWriter</code> will output to the target resource.</p>
</li>
<li>
<p>The step commits the framework transaction.</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in abnormal process</dt>
<dd>
<p>Transaction control in abnormal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlChunkModel_rollback.png" alt="Transaction Control Chunk Model Abnormal Process">
</div>
<div class="title">Sequence diagram of abnormal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The subsequent processing is repeated until there is no input data.</p>
</li>
<li>
<p>Start a framework transaction on a per chunk basis.</p>
</li>
<li>
<p>Repeat steps 2 to 5 until the chunk size is reached.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step obtains input data from <code>ItemReader</code>.</p>
</li>
<li>
<p><code>ItemReader</code> returns the input data to the step.</p>
</li>
<li>
<p>In the step, <code>ItemProcessor</code> processes input data.</p>
</li>
<li>
<p><code>ItemProcessor</code> returns the processing result to the step.</p>
</li>
<li>
<p>The step outputs data for chunk size with <code>ItemWriter</code>.</p>
</li>
<li>
<p><code>ItemWriter</code> will output to the target resource.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If any <strong>exception occurs</strong> between the process from 2 to 7,</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>The step rolls back the framework transaction.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_architecture_TaskletModel"><a class="anchor" href="#Ch05_Transaction_architecture_TaskletModel"></a>5.1.2.1.2. Mechanism of transaction control in tasklet model</h6>
<div class="paragraph">
<p>For transaction control in the tasklet model,
either the single commit method or the intermediate commit method can be used.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">single commit method</dt>
<dd>
<p>Use the transaction control mechanism of Spring Batch</p>
</dd>
<dt class="hdlist1">Intermediate commit method</dt>
<dd>
<p>Manipulate the transaction directly with the user</p>
</dd>
</dl>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_architecture_TaskletModel_SingleTransaction"><a class="anchor" href="#Ch05_Transaction_architecture_TaskletModel_SingleTransaction"></a>single commit method in tasklet model</h7>
<div class="paragraph">
<p>Explain the mechanism of transaction control by Spring Batch.</p>
</div>
<div class="paragraph">
<p>A feature of this method is to process data repeatedly within one transaction.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in normal process</dt>
<dd>
<p>Transaction control in normal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_SingleTransaction_commit.png" alt="Single Transaction Control Tasklet Model Normal Process">
</div>
<div class="title">Sequence diagram of normal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The step starts a framework transaction.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step executes the tasklet.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 3 to 7 until there is no more input data.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tasklet gets input data from <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will return input data to tasklet.</p>
</li>
<li>
<p>Tasklets process input data.</p>
</li>
<li>
<p>Tasklets pass output data to <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will output to the target resource.</p>
</li>
<li>
<p>The tasklet returns the process end to the step.</p>
</li>
<li>
<p>The step commits the framework transaction.</p>
</li>
</ol>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in abnormal process</dt>
<dd>
<p>Transaction control in abnormal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_SingleTransaction_rollback.png" alt="Single Transaction Control Tasklet Model Abormal Process">
</div>
<div class="title">Sequence diagram of abnormal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The step starts a framework transaction.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step executes the tasklet.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 3 to 7 until there is no more input data.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tasklet gets input data from <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will return input data to tasklet.</p>
</li>
<li>
<p>Tasklets process input data.</p>
</li>
<li>
<p>Tasklets pass output data to <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will output to the target resource.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If any <strong>exception occurs</strong> between the process from 2 to 7,</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>The tasklet throws an exception to the step.</p>
</li>
<li>
<p>The step rolls back the framework transaction.</p>
</li>
</ol>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_Transaction_architecture_TaskletModel_ChunkTransaction"><a class="anchor" href="#Ch05_Transaction_architecture_TaskletModel_ChunkTransaction"></a>Intermediate commit method in tasklet model</h7>
<div class="paragraph">
<p>A mechanism for directly operating a transaction by a user will be described.</p>
</div>
<div class="paragraph">
<p>Feature of this method is that resource transactions are handled only by user transactions, by using framework transactions that can manipulate resources.
Specify <code>org.springframework.batch.support.transaction.ResourcelessTransactionManager</code> without resources, in <code>transaction-manager</code> attribute.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in normal process</dt>
<dd>
<p>Transaction control in normal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_ChunkTransaction_commit.png" alt="Chunk Transaction Control Tasklet Model Normal Process">
</div>
<div class="title">Sequence diagram of normal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The step starts <strong>framework transaction</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step executes the tasklet.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 3 to 10 until there is no more input data.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The tasklet starts <strong>user transaction</strong> via <code>TransacitonManager</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 4 to 6 until the chunk size is reached.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tasklet gets input data from <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will return input data to tasklet.</p>
</li>
<li>
<p>Tasklets process input data.</p>
</li>
<li>
<p>Tasklets pass output data to <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will output to the target resource.</p>
</li>
<li>
<p>The tasklet commits the <strong>user transaction</strong> via <code> TransacitonManager</code>.</p>
</li>
<li>
<p><code>TransacitonManager</code> issues a commit to the target resource.</p>
</li>
<li>
<p>The tasklet returns the process end to the step.</p>
</li>
<li>
<p>The step commits the <strong>framework transaction</strong>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this case, each item is output to a resource, but like the chunk model,
it is also possible to update the processing throughput collectively by chunk unit and improve the processing throughput.
At that time, you can also use BatchUpdate by setting <code>executorType</code> of <code>SqlSessionTemplate</code> to <code>BATCH</code>.
This is the same behavior as using MyBatis' ItemWriter, so you can update it using MyBatis' ItemWriter.
For details of MyBatis' ItemWriter, refer to
<a href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter">Database access with ItemWriter</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Transaction control in abnormal process</dt>
<dd>
<p>Transaction control in abnormal process will be explained.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_TransactionControlTaskletModel_ChunkTransaction_rollback.png" alt="Chunk Transaction Control Tasklet Model Abormal Process">
</div>
<div class="title">Sequence diagram of abnormal process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>Steps are executed from the job.</p>
<div class="ulist">
<ul>
<li>
<p>The step starts <strong>framework transaction</strong>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The step executes the tasklet.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 3 to 11 until there is no more input data.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The tasklet starts <strong>user transaction</strong> from <code>TransacitonManager</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Repeat steps 4 to 6 until the chunk size is reached.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tasklet gets input data from <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will return input data to tasklet.</p>
</li>
<li>
<p>Tasklets process input data.</p>
</li>
<li>
<p>Tasklets pass output data to <code>Repository</code>.</p>
</li>
<li>
<p><code>Repository</code> will output to the target resource.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If any <strong>exception occurs</strong> between the process from 3 to 8,</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>The tasklet processes the exception that occurred.</p>
</li>
<li>
<p>The tasklet performs a rollback of <strong>user transaction</strong> via <code>TransacitonManager</code>.</p>
</li>
<li>
<p><code>TransacitonManager</code> issues a rollback to the target resource.</p>
</li>
<li>
<p>The tasklet throws an exception to the step.</p>
</li>
<li>
<p>The step rolls back <strong>framework transaction</strong>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About processing continuation</div>
<div class="paragraph">
<p>Here, although processing is abnormally terminated after handling exceptions and rolling back the processing,
it is possible to continue processing the next chunk.
In either case, it is necessary to notify the subsequent processing by changing the status / end code of the step that an error has occurred during that process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About framework transactions</div>
<div class="paragraph">
<p>In this case, although the job is abnormally terminated by throwing an exception after rolling back the user transaction,
it is also possible to return the processing end to the step and terminate the job normally.
In this case, the framework transaction is <strong>committed</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="selection-policy-for-model-specific-transaction-control"><a class="anchor" href="#selection-policy-for-model-specific-transaction-control"></a>5.1.2.1.3. Selection policy for model-specific transaction control</h6>
<div class="paragraph">
<p>In Spring Batch that is the basis of TERASOLUNA Batch 5.x, only the intermediate commit method can be implemented in the chunk model.
However, in the tasklet model, either the intermediate commit method or the single commit method can be implemented.</p>
</div>
<div class="paragraph">
<p>Therefore, in TERASOLUNA Batch 5.x, when the single commit method is necessary, it is to be implemented in the tasklet model.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_Overview_DiffLaunching"><a class="anchor" href="#Ch05_Transaction_Overview_DiffLaunching"></a>5.1.2.2. Difference in transaction control for each execution method</h5>
<div class="paragraph">
<p>Depending on the execution method, a transaction that is not managed by Spring Batch occurs before and after the job is executed.
This section explains transactions in two asynchronous execution processing schemes.</p>
</div>
<div class="sect5">
<h6 id="about-transaction-of-db-polling"><a class="anchor" href="#about-transaction-of-db-polling"></a>5.1.2.2.1. About transaction of DB polling</h6>
<div class="paragraph">
<p>Regarding processing to the Job-request-table performed by the DB polling, transaction processing other than Spring Batch managed will be performed.
Also, regarding exceptions that occurred in the job, since correspondence is completed within the job, it does not affect transactions performed by <code>JobRequestPollTask</code>.</p>
</div>
<div class="paragraph">
<p>A simple sequence diagram focusing on transactions is shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_AsyncWithDB_Transaction_Difference.png" alt="With Database polling transaction">
</div>
<div class="title">Transaction of DB polling</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p><code>JobRequestPollTask</code> is executed periodically from asynchronous batch daemon.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will start a transaction other than Spring Batch managed.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will retreive an asynchronous batch to execute from Job-request-table.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will commit the transaction other than Spring Batch managed.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will start a transaction other than Spring Batch managed.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will update the status of Job-request-table&#8217;s polling status from INIT to POLLED.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will commit the transaction other than Spring Batch managed.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will execute the job.</p>
</li>
<li>
<p>Inside the job, transaction control for DB for Management(<code>JobRepository</code>) will be managed by Spring Batch.</p>
</li>
<li>
<p>Inside the job, transaction control for DB for Job will be managed by Spring Batch.</p>
</li>
<li>
<p>job_execution_id is returned to <code>JobRequestPollTask</code></p>
</li>
<li>
<p><code>JobRequestPollTask</code> will start a transaction other than Spring Batch managed.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will update the status of Job-request-table&#8217;s polling status from INIT to EXECUTE.</p>
</li>
<li>
<p><code>JobRequestPollTask</code> will commit the transaction other than Spring Batch managed.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About Commit at SELECT Issuance</div>
<div class="paragraph">
<p>Some databases may implicitly start transactions when SELECT is issued.
Therefore, by explicitly issuing a commit, the transaction is confirmed so that the transaction is clearly distinguished from other transactions and is not influenced.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="about-the-transaction-of-webap-server-process"><a class="anchor" href="#about-the-transaction-of-webap-server-process"></a>5.1.2.2.2. About the transaction of WebAP server process</h6>
<div class="paragraph">
<p>As for processing to resources targeted by WebAP, transaction processing outside Spring Batch managed is performed.
Also, regarding exceptions that occurred in the job, since correspondence is completed within the job, it does not affect transactions performed by WebAP.</p>
</div>
<div class="paragraph">
<p>A simple sequence diagram focusing on transactions is shown in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_AsyncWithWeb_Transaction_Difference.png" alt="With Web Application transaction">
</div>
<div class="title">Transaction of WebAP server process</div>
</div>
<div class="olist arabic">
<div class="title">Description of the Sequence Diagram</div>
<ol class="arabic">
<li>
<p>WebAP processing is executed by the request from the client</p>
</li>
<li>
<p>WebAP will start the transaction managed outside of Spring Batch.</p>
</li>
<li>
<p>WebAP reads from and writes to resources in WebAP before job execution.</p>
</li>
<li>
<p>WebAP executes the job.</p>
</li>
<li>
<p>Within a job, Spring Batch carries out transaction management to the Management DB (<code>JobRepository</code>).</p>
</li>
<li>
<p>Within a job, Spring Batch carries out transaction management to the Job DB.</p>
</li>
<li>
<p>job_execution_id is returned to WebAP</p>
</li>
<li>
<p>WebAP reads from and writes to resources in WebAP after job execution.</p>
</li>
<li>
<p>WebAP will commit the transaction managed outside of Spring Batch.</p>
</li>
<li>
<p>WebAP returns a response to the client.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_Transaction_HowToUse"><a class="anchor" href="#Ch05_Transaction_HowToUse"></a>5.1.3. How to use</h4>
<div class="paragraph">
<p>Here, transaction control in one job will be explained separately in the following cases.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_Transaction_HowToUse_SingleDataSource">For a single data source</a></p>
</li>
<li>
<p><a href="#Ch05_Transaction_HowToUse_MultiDataSource">For multiple data sources</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The data source refers to the data storage location (database, file, etc.).
A single data source refers to one data source, and multiple data sources refers to two or more data sources.</p>
</div>
<div class="paragraph">
<p>In the case of processing a single data source, the case of processing database data is representative.<br>
There are some variations in the case of processing multiple data sources as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>multiple databases</p>
</li>
<li>
<p>databases and files</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_HowToUse_SingleDataSource"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource"></a>5.1.3.1. For a single data source</h5>
<div class="paragraph">
<p>Transaction control of jobs input / output to one data source will be described.</p>
</div>
<div class="paragraph">
<p>Below is a sample setting with TERASOLUNA Batch 5.x.</p>
</div>
<div class="listingblock">
<div class="title">DataSource setting(META-INF/spring/launch-context.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Job-common definitions --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">TransactionManager setting(META-INF/spring/launch-context.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rollbackOnCommitFailure</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean definition of TransactionManager.<br>
Set <code>jobDataSource</code> defined above for the data source.<br>
It has been set to roll back if commit fails.</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_SingleDataSource_Tx"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx"></a>5.1.3.1.1. Implement transaction control</h6>
<div class="paragraph">
<p>The control method differs depending on the job model and the commit method.</p>
</div>
<div class="sect6">
<h7 id="in-case-of-chunk-model"><a class="anchor" href="#in-case-of-chunk-model"></a>In case of chunk model</h7>
<div class="paragraph">
<p>In the case of the chunk model, it is an intermediate commit method, leaving transaction control to Spring Batch.
Do not control the transaction at all by the user.</p>
</div>
<div class="listingblock">
<div class="title">Setting sample(job definition)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>jobTransactionManager</code> which is already defined in <code>transaction-manager</code> attribute of <code>&lt;batch:tasklet&gt;</code> tag.<br>
The intermediate commit method transaction is controlled by the transaction manager set here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set chunk size to <code>commit-interval</code> attribute. In this sample, commit once for every 10 processing.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="for-the-tasklet-model"><a class="anchor" href="#for-the-tasklet-model"></a>For the tasklet model</h7>
<div class="paragraph">
<p>In the case of the tasklet model, the method of transaction control differs depending on whether the method is single commit method or the intermediate commit method.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">single commit method</dt>
<dd>
<p>Spring Batch control transaction.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Setting sample(job definition)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanSingleTranTask</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>jobTransactionManager</code> which is already defined in <code>transaction-manager</code> attribute of <code>&lt;batch:tasklet&gt;</code> tag.<br>
The single commit method transaction is controlled by the transaction manager set here.</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">intermediate commit method</dt>
<dd>
<p>Control transaction by user.</p>
<div class="ulist">
<ul>
<li>
<p>If you want to commit in the middle of processing, inject the <code>TransacitonManager</code> and operate manually.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Setting sample(job definition)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobResourcelessTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanChunkTranTask</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>()
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanChunkTranTask</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; itemReader;

     <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>)
    PlatformTransactionManager transactionManager;

    <span class="annotation">@Inject</span>
    SalesPlanDetailRepository repository;

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">int</span> CHUNK_SIZE = <span class="integer">10</span>;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
                                ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        DefaultTransactionDefinition definition = <span class="keyword">new</span> DefaultTransactionDefinition();
        TransactionStatus status = <span class="predefined-constant">null</span>;

        <span class="keyword">try</span> {
            <span class="comment">// omitted.</span>

            itemReader.open(executionContext);

            <span class="keyword">while</span> ((item = itemReader.read()) != <span class="predefined-constant">null</span>) {

                <span class="keyword">if</span> (count % CHUNK_SIZE == <span class="integer">0</span>) {
                    status = transactionManager.getTransaction(definition); <span class="comment">// (3)</span>
                }
                count++;

                <span class="comment">// omitted.</span>

                repository.create(item);
                <span class="keyword">if</span> (count % CHUNK_SIZE == <span class="integer">0</span>) {
                    transactionManager.commit(status);  <span class="comment">// (4)</span>
                }
            }
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while reading.</span><span class="delimiter">&quot;</span></span>, e);
            transactionManager.rollback(status);    <span class="comment">// (5)</span>
            <span class="keyword">throw</span> e;
        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (!status.isCompleted()) {
                transactionManager.commit(status);   <span class="comment">// (6)</span>
            }
            itemReader.close();
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>jobResourcelessTransactionManager</code> which is already defined in <code>transaction-manager</code> attribute of <code>&lt;batch:tasklet&gt;</code> tag.<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject the transaction manager.<br>
In the @Named annotation, specify <code>jobTransactionManager</code> to identify the bean to use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start transaction at the beginning of chunk.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Commit the transaction at the end of the chunk.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When an exception occurs, roll back the transaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For the last chunk, commit the transaction.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Updating by ItemWriter</div>
<div class="paragraph">
<p>In the above example, although Repository is used, it is possible to update data using ItemWriter.
Using ItemWriter has the effect of simplifying implementation, especially FlatFileItemWriter should be used when updating files.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_SingleDataSource_NonTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_SingleDataSource_NonTx"></a>5.1.3.1.2. Note for non-transactional data sources</h6>
<div class="paragraph">
<p>In the case of files, no transaction setting or operation is necessary.</p>
</div>
<div class="paragraph">
<p>When using <code>FlatFileItemWriter</code>, pseudo transaction control can be performed.
This is implemented by delaying the writing to the resource and actually writing out at the commit timing.
Normally, when it reaches the chunk size, it outputs chunk data to the actual file, and if an exception occurs, data output of the chunk is not performed.</p>
</div>
<div class="paragraph">
<p><code>FlatFileItemWriter</code> can switch transaction control on and off with <code>transactional</code> property. The default is true and transaction control is enabled.
If the <code>transactional</code> property is false, <code>FlatFileItemWriter</code> will output the data regardless of the transaction.</p>
</div>
<div class="paragraph">
<p>When adopting the single commit method, it is recommend to set the <code>transactional</code> property to false.
As described above, since data is written to the resource at the commit timing, until then, all the output data is held in the memory.
Therefore, when the amount of data is large, there is a high possibility that the memory becomes insufficient and an error will occur.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">On TransacitonManager settings in jobs that only handle files</div>
<div class="paragraph">
<p>As in the following job definition, the <code>transaction-manager</code> attribute of <code>batch: tasklet</code> is mandatory in the xsd schema and can not be omitted.</p>
</div>
<div class="listingblock">
<div class="title">Excerpt of TransacitonManager setting part</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:tasklet&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore, always specify <code>jobTransactionManager</code>. At this time, the following behaviors are obtained.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>transactional</code> is true</p>
<div class="ulist">
<ul>
<li>
<p>Synchronize with specified TransacitonManager and output to resource.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If <code>transactional</code> is false</p>
<div class="ulist">
<ul>
<li>
<p>Transaction processing of the specified TransacitonManager is idle and it outputs to the resource regardless of the transaction.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this time, transactions are issued to the resource (eg, database) referred to by <code>jobTransactionManager</code>,
but since there is no table access, there is no actual damage.</p>
</div>
<div class="paragraph">
<p>If you do not want to issue transactions to refer to even if it is idle or in case of actual damage, you can use <code>ResourcelessTransactionManager</code> which does not require resources.
<code>ResourcelessTransactionManager</code> is defined as <code>jobResourcelessTransactionManager</code> in <code>launch-context.xml</code>.</p>
</div>
<div class="listingblock">
<div class="title">Sample usage of ResourcelessTransactionManager</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobResourcelessTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:tasklet&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_Transaction_HowToUse_MultiDataSource"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource"></a>5.1.3.2. For multiple data sources</h5>
<div class="paragraph">
<p>Transaction control of jobs input / output to multiple data sources will be described.
Since consideration points are different between input and output, they will be explained separately.</p>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_Input"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_Input"></a>5.1.3.2.1. Input from multiple data source</h6>
<div class="paragraph">
<p>When retrieving data from multiple data sources, the data that is the axis of the process and it&#8217;s additional data should be retrieved separately.
Hereinafter, the data as the axis of processing is referred to as the process target record, and the additional data accompanying it is referred to as accompanying data.</p>
</div>
<div class="paragraph">
<p>Because of the structure of Spring Batch, ItemReader is based on the premise that it retriedves a process target record from one resource.
This is the same way of thinking regardless of the type of resource.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retriving process target record</p>
<div class="ulist">
<ul>
<li>
<p>Get it by ItemReader.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Retriving accompanying data</p>
<div class="ulist">
<ul>
<li>
<p>In the accompanying data, it is necessary to select the following retreiving method according to the presence or absence of change to the data and the number of cases. This is not an option, and it may be used in combination.</p>
<div class="ulist">
<ul>
<li>
<p>Batch retrieval before step execution</p>
</li>
<li>
<p>Retrieve each time according to the record to be processed</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="when-retrieving-all-at-once-before-step-execution"><a class="anchor" href="#when-retrieving-all-at-once-before-step-execution"></a>When retrieving all at once before step execution</h7>
<div class="paragraph">
<p>Implement Listener to do the following and refer to data from the following Step.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retrieve data collectively</p>
</li>
<li>
<p>Store the information in the bean whose scope is <code>Job</code> or <code>Step</code></p>
<div class="ulist">
<ul>
<li>
<p><code>ExecutionContext</code> of Spring Batch can be used,
but a diffferent class can be created to store data considering the readability and maintainability.
For the sake of simplicity, the sample will be explained using <code>ExecutionContext</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This method is adopted when reading data that does not depend on data to be processed such as master data.
However, even if it is a master data, if there is a large number of items which may give an impact to the  memory, retrieving each time should be considered.</p>
</div>
<div class="listingblock">
<div class="title">Implementation of Listener for collective retrieve</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchMasterReadStepListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {   <span class="comment">// (2)</span>

        <span class="predefined-type">List</span>&lt;Branch&gt; branches = branchRepository.findAll(); <span class="comment">//(3)</span>

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt; map = branches.stream()
                .collect(Collectors.toMap(Branch::getBranchId,
                        UnaryOperator.identity()));  <span class="comment">// (4)</span>

        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">branches</span><span class="delimiter">&quot;</span></span>, map); <span class="comment">// (5)</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Definition of Listener for collective retrieve</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outputAllCustomerList01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retrieveBranchFromContextItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchMasterReadStepListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (6) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">An example of referring data collectively retrieved by the ItemProcessor of the subsequent step</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RetrieveBranchFromContextItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;Customer, CustomerWithBranch&gt; {

    <span class="directive">private</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt; branches;

    <span class="annotation">@BeforeStep</span>       <span class="comment">// (7)</span>
    <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        branches = (<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Branch&gt;) stepExecution.getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">branches</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (8)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CustomerWithBranch process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        CustomerWithBranch newItem = <span class="keyword">new</span> CustomerWithBranch(item);
        newItem.setBranch(branches.get(item.getChargeBranchId()));    <span class="comment">// (9)</span>
        <span class="keyword">return</span> newItem;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>StepExecutionListener</code> interface.<br>
In order to simplify the implementation here, it is an extension from <code>StepExecutionListenerSupport</code> which implements the <code>StepExecutionListener</code> interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement the <code>beforeStep</code> method to get data before step execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement processing to retrieve master data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert from List type to Map type so that it can be used easily in subsequent processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the acquired master data in the context of the step as <code>branches</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register the created Listener to the target job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In order to acquire master data before step execution of ItemProcessor, set up Listener with @BeforeStep annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In the method given the @BeforeStep annotation, obtain the master data set in (5) from the context of the step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In the process method of ItemProcessor, data is retrieved from the master data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Object to store in context</div>
<div class="paragraph">
<p>The object to be stored in the context(<code>ExecutionContext</code>) must be a class that implements <code>java.io.Serializable</code>.
This is because <code>ExecutionContext</code> is stored in <code>JobRepository</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="retrieving-each-time-according-to-the-record-to-be-processed"><a class="anchor" href="#retrieving-each-time-according-to-the-record-to-be-processed"></a>Retrieving each time according to the record to be processed</h7>
<div class="paragraph">
<p>Apart from ItemProcessor of business processing, it retrieves by ItemProcessor designated just for retrieving every time.
This simplifies processing of each ItemProcessor.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define ItemProcessor designated just for retrieving every time, and separate it from business process.</p>
<div class="ulist">
<ul>
<li>
<p>At this time, use MyBatis as it is when accessing the table.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Concatenate multiple ItemProcessors using CompositeItemProcessor.</p>
<div class="ulist">
<ul>
<li>
<p>Note that ItemProcessor is processed in the order specified in the delegates attribute.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Sample implementation of ItemProcessor designated just for retrieving every time</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">RetrieveBranchFromRepositoryItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;Customer, CustomerWithBranch&gt; {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository;  <span class="comment">// (1)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> CustomerWithBranch process(Customer item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        CustomerWithBranch newItem = <span class="keyword">new</span> CustomerWithBranch(item);
        newItem.setBranch(branchRepository.findOne(
                item.getChargeBranchId())); <span class="comment">// (2)</span>
        <span class="keyword">return</span> newItem; <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Definition sample of ItemProcessor designated just for retrieving every time and ItemProcessor for business process</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeItemProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retrieveBranchFromRepositoryItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">businessLogicItemProcessor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject Repository for retrieving every time using MyBatis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accompaniment data is retrieved from the Repository for input data(process target record).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return data with processing target record and accompanying data together.<br>
Notice that this data will be the input data to the next ItemProcessor.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set ItemProcessor for retrieving every time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set ItemProcessor for business logic.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_IndividualTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_IndividualTx"></a>5.1.3.2.2. Output to multiple data sources(multiple steps)</h6>
<div class="paragraph">
<p>Process multiple data sources throughout the job by dividing the steps for each data source and processing a single data source at each step.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data processed at the first step is stored in a table, and at the second step, it is outputted to a file.</p>
</li>
<li>
<p>Although each step is simple and easy to recover, there is a possibility that it may be troublesome twice.</p>
<div class="ulist">
<ul>
<li>
<p>As a result, in the case of causing the following harmful effects, consider processing multiple data sources in one step.</p>
<div class="ulist">
<ul>
<li>
<p>Processing time increases</p>
</li>
<li>
<p>Business logic becomes redundant</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_Transaction_HowToUse_MultiDataSource_SingleTx"><a class="anchor" href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx"></a>5.1.3.2.3. Output to multiple data sources(single step)</h6>
<div class="paragraph">
<p>Generally, when transactions for a plurality of data sources are combined into one, a distributed transaction based on 2 phase-commit is used.
However, it is also known that there are the following disadvantages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Middleware must be compatible with distributed transaction API such as XAResource, and special setting based on it is required</p>
</li>
<li>
<p>In standalone Java like a batch program, you need to add a JTA implementation library for distributed transactions</p>
</li>
<li>
<p>Recovery in case of failure is difficult</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although it is possible to utilize distributed transactions also in Spring Batch, the method using global transaction by JTA requires performance overhead due to the characteristics of the protocol.
As a method to process multiple data sources collectively more easily, <strong>Best Efforts 1PC pattern</strong> is recommended.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">What is Best Efforts 1PC pattern</dt>
<dd>
<p>Briefly, it refers to the technique of handling multiple data sources as local transactions and issuing sequential commits at the same timing.
The conceptual diagram is shown in the figure below.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_transaction_Best_Efforts_1PC.png" alt="Best Efforts 1PC Overview">
</div>
<div class="title">Conceptual diagram of Best Efforts 1PC pattern</div>
</div>
<div class="olist arabic">
<div class="title">Description of figure</div>
<ol class="arabic">
<li>
<p>The user instructs <code>ChainedTransactionManager</code> to start the transaction.</p>
</li>
<li>
<p><code>ChainedTransactionManager</code> starts a transaction sequentially with registered transaction managers.</p>
</li>
<li>
<p>The user performs transactional operations on each resource.</p>
</li>
<li>
<p>The user instructs <code>ChainedTransactionManager</code> to commit.</p>
</li>
<li>
<p><code>ChainedTransactionManager</code> issues sequential commits on registered transaction managers.</p>
<div class="ulist">
<ul>
<li>
<p>Commit(or roll back) in reverse order of transaction start</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Since this method is not a distributed transaction, there is a possibility that data consistency may not be maintained
if a failure(exception) occurs at commit / rollback in the second and subsequent transaction managers.
Therefore, although it is necessary to design a recovery method when a failure occurs at a transaction boundary, there is an effect that the recovery frequency can be reduced and the recovery procedure can be simplified.</p>
</div>
<div class="sect6">
<h7 id="when-processing-multiple-transactional-resources-at-the-same-time"><a class="anchor" href="#when-processing-multiple-transactional-resources-at-the-same-time"></a>When processing multiple transactional resources at the same time</h7>
<div class="paragraph">
<p>Use it on cases such as when processing multiple databases simultaneously, when processing databases and MQ, and so on.</p>
</div>
<div class="paragraph">
<p>Process as 1 phase-commit by defining multiple transaction managers as one using <code>ChainedTransactionManager</code> as follows.
Note that <code>ChainedTransactionManager</code> is a class provided by Spring Data.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="comment">&lt;!-- omitted --&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.springframework.data<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>spring-data-commons<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependencies&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample usage of chainedTransactionManager</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Chained Transaction Manager --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chainedTransactionManager</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.data.transaction.ChainedTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;constructor-arg&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/constructor-arg&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPlan01.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chainedTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a dependency to use <code>ChainedTransactionManager</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the bean of <code>ChainedTransactionManager</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define multiple transaction managers that you want to summarize in a list.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the bean ID defined in (1) for the transaction manager used by the job.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="when-processing-transactional-and-nontransactional-resources-simultaneously"><a class="anchor" href="#when-processing-transactional-and-nontransactional-resources-simultaneously"></a>When processing transactional and nontransactional resources simultaneously</h7>
<div class="paragraph">
<p>This method is used when processing databases and files at the same time.</p>
</div>
<div class="paragraph">
<p>For database it is the same as <a href="#Ch05_Transaction_HowToUse_SingleDataSource">For a single data source</a>.</p>
</div>
<div class="paragraph">
<p>For files, setting FlatFileItemWriter&#8217;s <code>transactional</code> property to true provides the same effect as the "Best Efforts 1PC pattern" described above.<br>
For details, refer to <a href="#Ch05_Transaction_HowToUse_SingleDataSource_NonTx">Note for non-transactional data sources</a>.</p>
</div>
<div class="paragraph">
<p>This setting delays writing to the file until just before committing the transaction of the database, so it is easy to synchronize with the two data sources.
However, even in this case, if an error occurs during file output processing after committing to the database, there is a possibility that data consistency can not be maintained,
It is necessary to design a recovery method.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="notes-on-intermediate-method-commit"><a class="anchor" href="#notes-on-intermediate-method-commit"></a>5.1.3.3. Notes on intermediate method commit</h5>
<div class="paragraph">
<p>Although it is deprecated, when processing data is skipped in ItemWriter, the chunk size setting value is forcibly changed.
Note that this has a very big impact on transactions. Refer to
<a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip">Skip</a> for details.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_DBAccess"><a class="anchor" href="#Ch05_DBAccess"></a>5.2. Database Access</h3>
<div class="sect3">
<h4 id="Ch05_DBAccess_Overview"><a class="anchor" href="#Ch05_DBAccess_Overview"></a>5.2.1. Overview</h4>
<div class="paragraph">
<p>MyBatis3 (hereafter, called [MyBatis]) is used for database access in TERASOLUNA Batch 5.x.
Please refer below TERASOLUNA Server 5.x Development Guideline for basic usage of database access using MyBatis.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html">Database Access (Common)</a></p>
</li>
<li>
<p><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html">Database Access (MyBatis3)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter mainly explain how to use database access as TERASOLUNA Batch 5.x specifically.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes for how to use Oracle JDBC in Linux environment</div>
<div class="paragraph">
<p>While using Oracle JDBC in Linux environment, locking of random generator number of OS used by Oracle JDBC occurs.
Hence, even though jobs are attempted to be executed in parallel, events for sequential execution and events for one connection timeout occur.<br>
2 patterns for how to avoid these events are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set following in system properties while executing Java command.</p>
<div class="ulist">
<ul>
<li>
<p><code>-Djava.security.egd=file:///dev/urandom</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Change <code>securerandom.source=/dev/random</code> in <code>${JAVA_HOME}/jre/lib/security/java.security</code> to <code>securerandom.source=/dev/urandom</code>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_DBAccess_HowToUse"><a class="anchor" href="#Ch05_DBAccess_HowToUse"></a>5.2.2. How to use</h4>
<div class="paragraph">
<p>Explain how to use database access as TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>It must be remembered that how to access database varies for chunk model and tasklet model.</p>
</div>
<div class="paragraph">
<p>There are following 2 ways to use database access in TERASOLUNA Batch 5.x.<br>
Please choose them based on the components accessing the database.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use ItemReader and ItemWriter for MyBatis.</p>
<div class="ulist">
<ul>
<li>
<p>For Input/Output by using database access as chunk model.</p>
<div class="ulist">
<ul>
<li>
<p>org.mybatis.spring.batch.MyBatisCursorItemReader</p>
</li>
<li>
<p>org.mybatis.spring.batch.MyBatisBatchItemWriter</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Use Mapper interface</p>
<div class="ulist">
<ul>
<li>
<p>For bussiness logic processing as chunk model.</p>
<div class="ulist">
<ul>
<li>
<p>With ItemProcessor implementation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For whole database access as tasklet model.</p>
<div class="ulist">
<ul>
<li>
<p>With Tasklet implementation.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Config"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config"></a>5.2.2.1. Common Settings</h5>
<div class="paragraph">
<p>Explain common settings required for database access.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_DataSource">DataSource Setting</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig">MyBatis Setting</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_MapperXML">Mapper XML definition</a></p>
</li>
<li>
<p><a href="#Ch05_DBAccess_HowToUse_Config_Scan">MyBatis-Spring setting</a></p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_DataSource"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_DataSource"></a>5.2.2.1.1. DataSource Setting</h6>
<div class="paragraph">
<p>It assumes two data sources in TERASOLUNA Batch 5.x.
Show 2 default data sources in <code>launch-context.xml</code>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Data source list</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Data source name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adminDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data source used by Spring Batch and TERASOLUNA Batch 5.x<br>
It is used in JobRepository and <a href="#Ch04_AsyncJobWithDB">Asynchronous execution(DB polling)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jobDataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data source used by job</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Show the property of connection information and launch-context.xml below.<br></p>
</div>
<div class="paragraph">
<p>Set these settings according to the user&#8217;s environment.</p>
</div>
<div class="listingblock">
<div class="title">resources\META-INF\spring\launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${admin.h2.jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.commons.dbcp2.BasicDataSource</span><span class="delimiter">&quot;</span></span><span class="error">　</span>
      <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">close</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:driverClassName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.driver}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:url</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.url}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:username</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.username}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jdbc.password}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxTotal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:minIdle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:maxWaitMillis</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:defaultAutoCommit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># (3)
# Admin DataSource settings.
admin.jdbc.driver=org.h2.Driver
admin.jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
admin.jdbc.username=sa
admin.jdbc.password=

# (4)
# Job DataSource settings.
jdbc.driver=org.postgresql.Driver
jdbc.url=jdbc:postgresql://localhost:5432/postgres
jdbc.username=postgres
jdbc.password=postgres</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>adminDataSource</code> definition. Connection information of (3) is set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jobDataSource</code> definition. Connection information of (4) is set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection information to database used by <code>adminDataSource</code><br>
H2 is used in this example.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection information to database used by <code>jobDataSource</code><br>
PostgreSQL is used in this example.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_MyBatisConfig"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig"></a>5.2.2.1.2. MyBatis Setting</h6>
<div class="paragraph">
<p>Important points for setting MyBatis on TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>One of the important points in implementing batch processing is "to efficiently process large amounts of data with certain resources"<br>
Explain the setting.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fetchSize</code></p>
<div class="ulist">
<ul>
<li>
<p>In general batch processing, it is mandatory to specify the appropriate <code>fetchSize</code> for the JDBC driver
to reduce the communication cost of processing large amounts of data.
<code>fetchSize</code> is a parameter that sets the number of data to be acquired by one communication between the JDBC driver and the database.
It is desirable to set this value as large as possible. However, if it is too large, it presses memory. So please be careful.
user has to tune the parameter.</p>
</li>
<li>
<p>In MyBatis, user can set <code>defaultFetchSize</code> as a common setting for all queries, and can override it with <code>fetchSize</code> setting for each query.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>executorType</code></p>
<div class="ulist">
<ul>
<li>
<p>In general batch processing, the same SQL is executed within the same transaction for the number of <code>total data count/fetchSize</code>.
At this time, it is possible to process efficiently by reusing a statement instead of creating it each time.</p>
</li>
<li>
<p>In the MyBatis setting, it can reuse statements by setting <code>REUSE</code> in <code>defaultExecutorType</code>
and contributes to improved processing throughput.</p>
</li>
<li>
<p>When updating a large amount of data at once, performance improvement can be expected by using batch update of JDBC.<br>
Therefore, <code>SqlSessionTemplate</code> used in <code>MyBatisBatchItemWriter</code><br>
is set to <code>BATCH</code> (not <code>REUSE</code>) in <code>executorType</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In TERASOLUNA Batch 5.x, two different <code>ExecutorType</code> exists at the same time.
It is assumed that it is often implemented by one <code>ExecutorType</code>, but special attention is required when using them together.
The detail will be explained in <a href="#Ch05_DBAccess_HowToUse_Processor">Database Access other than ItemReader・ItemWriter</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Other parameter of MyBatis</div>
<div class="paragraph">
<p>For other parameters, refer to the following links and make settings that match the application characteristics.<br>
<a href="http://www.mybatis.org/mybatis-3/configuration.html" class="bare">http://www.mybatis.org/mybatis-3/configuration.html</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Show the default setting below.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:executorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BATCH</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Various setting of MyBatis<br>
fetchSize is set to 1000 by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <code>MyBatisBatchItemWriter</code>, <code>executorType</code> defines <code>SqlSessionTemplate</code> of <code>BATCH</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">For the definition of SqlSessionFactory using adminDataSource</div>
<div class="paragraph">
<p>When performing synchronous execution, <code>SqlSessionFactory</code> using adminDataSource is unnecessary and is not defined.
When performing <a href="#Ch04_AsyncJobWithDB">Asynchronous execution(DB polling)</a>,
it is defined in <code>META-INF/spring/async-batch-daemon.xml</code> to access the Job-request-table.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/spring/async-batch-daemon.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminSqlSessionFactory</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.SqlSessionFactoryBean</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:dataSource-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adminDataSource</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">configuration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.apache.ibatis.session.Configuration</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:localCacheScope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STATEMENT</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:lazyLoadingEnabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:aggressiveLazyLoading</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultFetchSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:defaultExecutorType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REUSE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_MapperXML"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_MapperXML"></a>5.2.2.1.3. Mapper XML definition</h6>
<div class="paragraph">
<p>Please refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtodababaseaccess">Implementation of database access process</a> in TERASOLUNA Server 5.x Development Guideline,
because there are no specific description about TERASOLUNA Batch 5.x.</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Config_Scan"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Config_Scan"></a>5.2.2.1.4. MyBatis-Spring setting</h6>
<div class="paragraph">
<p>When using ItemReader and ItemWriter provided by MyBatis-Spring, it is necessary to set Mapper XML used in Mapper&#8217;s Config.</p>
</div>
<div class="paragraph">
<p>As the setting method, there are following 2 methods.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Register Mapper XML to be used for all jobs as a common setting.</p>
<div class="ulist">
<ul>
<li>
<p>All Mapper XML has to be described in <code>META-INF/spring/launch-context.xml</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Register Mapper XML to be used for each job as individual setting.</p>
<div class="ulist">
<ul>
<li>
<p>Mapper XML required by each job has to be described in bean definition under <code>META-INF/jobs/</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>If common settings are made, the following adverse effects arise because not only Mapper XML of jobs executed, but also Mapper XML used by other jobs are also read when executing synchronous execution.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It takes time to start the job</p>
</li>
<li>
<p>Consumption of memory resources increases</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid it, TERASOLUNA Batch 5.x adopts a setting method that specifies only Mapper XML that the job requires for each job definition as individual setting.</p>
</div>
<div class="paragraph">
<p>For the basic setting method,
please refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtousesettingsmybatis-spring">MyBatis-Spring settings</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
<div class="paragraph">
<p>In TERASOLUNA Batch 5.x, since multiple <code>SqlSessionFactory</code> and <code>SqlSessionTemplate</code> are defined,
it is necessary to explicitly specify which one to use.<br>
Basically, specify <code>jobSqlSessionFactory</code></p>
</div>
<div class="paragraph">
<p>Show setting example below.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/jobs/common/jobCustomerList01.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>jobSqlSessionFactory</code> in <code>factory-ref</code> attribute of <code>&lt;mybatis:scan&gt;</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Input"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Input"></a>5.2.2.2. Database access with ItemReader</h5>
<div class="paragraph">
<p>Explain Database access with ItemReader here.</p>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Input_MyBatisItemReader"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader"></a>5.2.2.2.1. ItemReader of MyBatis</h6>
<div class="paragraph">
<p>MyBatis-Spring provides the following two ItemReader.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.mybatis.spring.batch.MyBatisCursorItemReader</code></p>
</li>
<li>
<p><code>org.mybatis.spring.batch.MyBatisPagingItemReader</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MyBatisPagingItemReader</code> is an ItemReader
that uses the mechanism described
in <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#entity-sql">Pagination search for Entity (SQL refinement method)</a> of TERASOLUNA Server 5.x Development Guideline<br>
Since SQL is issued again after acquiring a certain number of cases, there is a possibility that data consistency may not be maintained.
Therefore, it is dangerous to use it in batch processing, so TERASOLUNA Batch 5.x does not use it in principle.<br>
TERASOLUNA Batch 5.x uses only <code>MyBatisCursorItemReader</code>.</p>
</div>
<div class="paragraph">
<p>In TERASOLUNA Batch 5.x, as explained in <a href="#Ch05_DBAccess_HowToUse_Config_Scan">MyBatis-Spring setting</a>,
It adopts a method of dynamically registering Mapper XML with <code>mybatis:scan</code>.
Therefore, it is necessary to prepare an interface corresponding to Mapper XML.
For details, please refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtodababaseaccess">Implementation of database access process</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
<div class="paragraph">
<p>Show an example of usage of <code>MyBatisCursorItemReader</code> below.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/jobs/common/jobCustomerList01.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst.CustomerRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org/terasoluna/batch/functionaltest/app/repository/mst/CustomerRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.mst.CustomerRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.mst.Customer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        SELECT
            customer_id AS customerId,
            customer_name AS customerName,
            customer_address AS customerAddress,
            customer_tel AS customerTel,
            charge_branch_id AS chargeBranchId,
            create_date AS createDate,
            update_date AS updateDate
        FROM
            customer_mst
        ORDER by
            charge_branch_id ASC, customer_id ASC
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.terasoluna.batch.functionaltest.app.repository.mst.CustomerRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CustomerRepository</span> {
    <span class="comment">// (7)</span>
    <span class="predefined-type">List</span>&lt;Customer&gt; findAll();

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register Mapper XML.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MyBatisCursorItemReader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the SQL ID defined in (6) with <code>namespace</code> + <code>&lt;method name&gt;</code> of (5) to the property of <code>queryId</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>SqlSessionFactory</code> of the database to be accessed in <code>sqlSessionFactory-ref</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Mapper XML. Match the value of namespace with the FQCN of the interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define SQL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the method corresponding to the SQL ID defined in (6) for the interface.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Output"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output"></a>5.2.2.3. Database Access with ItemWriter</h5>
<div class="paragraph">
<p>Explain database access with ItemWriter in here.</p>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MyBatisItemWriter"></a>5.2.2.3.1. ItemWriter of MyBatis</h6>
<div class="paragraph">
<p>MyBatis-Spring provides only one following ItemWriter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.mybatis.spring.batch.MyBatisBatchItemWriter</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The basic setting is the same as <a href="#Ch05_DBAccess_HowToUse_Input_MyBatisItemReader">ItemReader of MyBatis</a>.
<code>MyBatisBatchItemWriter</code> needs to specify <code>batchModeSqlSessionTemplate</code>
described in <a href="#Ch05_DBAccess_HowToUse_Config_MyBatisConfig">MyBatis Setting</a>.</p>
</div>
<div class="paragraph">
<p>Show an example definition of <code>MyBatisBatchItemWriter</code> below.</p>
</div>
<div class="listingblock">
<div class="title">META-INF/jobs/common/jobSalesPlan01.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
    <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.plan</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org/terasoluna/batch/functionaltest/app/repository/plan/SalesPlanDetailRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;insert</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        INSERT INTO
            sales_plan_detail(branch_id, year, month, customer_id, amount)
        VALUES (
            #{branchId}, #{year}, #{month}, #{customerId}, #{amount}
        )
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/insert&gt;</span>

    <span class="comment">&lt;!-- omitted --&gt;</span>
<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">org.terasoluna.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SalesPlanDetailRepository</span> {

    <span class="comment">// (7)</span>
    <span class="type">void</span> create(SalesPlanDetail salesPlanDetail);

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register Mapper XML.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MyBatisBatchItemWriter</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the SQL ID defined in (6) with <code>namespace</code> + <code>&lt;method name&gt;</code> of (5) to the property of <code>statementId</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify <code>SessionTemplate</code> of the database to be accessed in <code>sqlSessionTemplate-ref</code> property.<br>
The specified <code>SessionTemplate</code> is mandatory that <code>executorType</code> is set to <code>BATCH</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Mapper XML. Match the value of namespace with the FQCN of the interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define SQL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the method corresponding to the SQL ID defined in (6) for the interface.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_DBAccess_HowToUse_Processor"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Processor"></a>5.2.2.4. Database Access other than ItemReader・ItemWriter</h5>
<div class="paragraph">
<p>Explain database access except for ItemReader・ItemWriter.</p>
</div>
<div class="paragraph">
<p>To access the database except for ItemReader・ItemWriter, use the Mapper interface.
In using the Mapper interface, TERASOLUNA Batch 5.x has the following restrictions.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">The available points of Mapper interface.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Process</th>
<th class="tableblock halign-left valign-top">ItemProcessor</th>
<th class="tableblock halign-left valign-top">Tasklet</th>
<th class="tableblock halign-left valign-top">Listner</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Available</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditionally available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Available</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unavailable</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Restrictions in ItemProcessor</dt>
<dd>
<p>There is a restriction that it should not be executed with two or more <code>ExecutorType</code> within the same transaction in MyBatis.<br>
If "use <code>MyBatisBatchItemWriter</code> for ItemWriter" and "use ItemProcessor to update and reference the Mapper interface"
are satisfied at the same time, it conflicts with this restriction.<br>
To avoid this restriction,
database is accessed by using Mapper interface that <code>ExecutorType</code> is <code>BATCH</code> in ItemProcessor.<br>
In addition, <code>MyBatisBatchItemWriter</code> checks whether it is SQL issued by itself with the status check after executing SQL
but naturally it can not manage SQL execution by ItemProcessor and an error will occur.<br>
Therefore, if <code>MyBatisBatchItemWriter</code> is used, updating with the Mapper interface will not be possible and only reference.</p>
</dd>
</dl>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It can set to invalidate the error check of <code>MyBatisBatchItemWriter</code>, but the setting is prohibited because there is a possibility that unexpected behavior may occur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Restrictions in Tasklet</dt>
<dd>
<p>In Tasklet, since it is basic to use the Mapper interface, there is no influence like ItemProcessor.<br>
It is possible to use <code>MyBatisBatchItemWriter</code> by Inject, but in that case Mapper interface itself can be processed with <code>BATCH</code> setting.
In other words, there is basically no need to use <code>MyBatisBatchItemWriter</code> by Inject.</p>
</dd>
<dt class="hdlist1">Restrictions in Listener</dt>
<dd>
<p>Even at the listener, the same restriction as that of ItemProcessor is established.
In addition, for listeners, use cases requiring updates are difficult to think. Therefore, update processing is prohibited at the listner.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Replacement of update processing assumed by the listner</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Job state management</dt>
<dd>
<p>It is done by JobRepository of Spring Batch</p>
</dd>
<dt class="hdlist1">Log output to database</dt>
<dd>
<p>It should be done in the log Appender. It is necessary to manage it separately from the transaction of the job.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_ItemProcess"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_ItemProcess"></a>5.2.2.4.1. Database access with ItemProcessor</h6>
<div class="paragraph">
<p>Show an example of database access with ItemProcessor.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example with ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromDBProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (2)</span>
        Customer customer = customerRepository.findOne(readItem.getCustomerId());

        <span class="comment">// (3)</span>
        SalesPlanDetail writeItem = <span class="keyword">new</span> SalesPlanDetail();
        writeItem.setBranchId(customer.getChargeBranchId());
        writeItem.setYear(readItem.getYear());
        writeItem.setMonth(readItem.getMonth());
        writeItem.setCustomerId(readItem.getCustomerId());
        writeItem.setAmount(readItem.getAmount());
        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.performance.SalesPerformanceDetailRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.plan.SalesPlanDetailRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemProcessor.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateItemFromDBProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mapper interface and Mapper XML are omitted.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr. No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register Mapper XML.<br>
By specifying <code>batchModeSqlSessionTemplate</code> set as <code>BATCH</code> in <code>template-ref</code> attribute,
database access with ItemProcessor is <code>BATCH</code>.
if you set <code>factory-ref="jobSqlSessionFactory"</code>, it conflicts with the above restriction
and an exception is thrown when <code>MyBatisBatchItemWriter</code> is executed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MyBatisBatchItemWriter</code><br>
Specify <code>batchModeSqlSessionTemplate</code> set as <code>BATCH</code> in <code>sqlSessionTemplate-ref</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set ItemProcessor that injected Mapper interface.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Supplement of MyBatisCursorItemReader setting</div>
<div class="paragraph">
<p>Different <code>ExecutorType</code> can be used for MyBatisCursorItemReader and MyBatisBatchItemWriter like the definition example below.
This is because the opening of the resource by MyBatisCursorItemReader is done before the start of the transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xxx</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">yyy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_Tasklet"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_Tasklet"></a>5.2.2.4.2. Database Access with Tasklet</h6>
<div class="paragraph">
<p>Show an example of database access in Tasklet.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example with Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OptimisticLockTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    ExclusiveControlRepository repository;

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        Branch branch = repository.branchFindOne(branchId); <span class="comment">// (2)</span>
        ExclusiveBranch exclusiveBranch = <span class="keyword">new</span> ExclusiveBranch();

        exclusiveBranch.setBranchId(branch.getBranchId());
        exclusiveBranch.setBranchName(branch.getBranchName() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        exclusiveBranch.setBranchAddress(branch.getBranchAddress() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> - </span><span class="delimiter">&quot;</span></span> + identifier);
        exclusiveBranch.setBranchTel(branch.getBranchTel());
        exclusiveBranch.setCreateDate(branch.getUpdateDate());
        exclusiveBranch.setUpdateDate(<span class="keyword">new</span> <span class="predefined-type">Timestamp</span>(<span class="predefined-type">System</span>.currentTimeMillis()));
        exclusiveBranch.setOldBranchName(branch.getBranchName());

        <span class="type">int</span> result = repository.branchExclusiveUpdate(exclusiveBranch); <span class="comment">// (3)</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.exclusivecontrol.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">factory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">taskletOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optimisticLockTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mapper interface and Mapper XML are omitted.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr. No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute the search process with the Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute the update process with the Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register Mapper XML<br>
Specify <code>jobSqlSessionFactory</code> set as <code>REUSE</code> in <code>factory-ref</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject Mapper interface and set Tasklet.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Use batchModeSqlSessionTemplate</div>
<div class="paragraph">
<p>If there are many updating processes with the tasklet model, set <code>batchModeSqlSessionTemplate</code> in <code>factory-ref</code> attribute.
As a result, batch update processing is performed, so performance improvement can be expected.
However, be aware that executing batch updates requires <code>flush</code> explicitly.
For details,
please refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#dataaccessmybatis3howtoextendexecutortypebatchnotes">Precautions when using batch mode Repository</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_listener"><a class="anchor" href="#Ch05_DBAccess_HowToUse_Output_MyBatisMapperInterface_listener"></a>5.2.2.4.3. Database Access with Listener</h6>
<div class="paragraph">
<p>Database access with listener is often linked with other components.
Depending on the listener to be used and the implementation method,
It is necessary to prepare additional mechanism to hand over to other components.</p>
</div>
<div class="paragraph">
<p>Show an example in which <a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a>
acquires data before step execution and uses the data acquired by ItemProcessor.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example with Listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CacheSetListener</span> <span class="directive">extends</span> StepExecutionListenerSupport {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    CustomerRepository customerRepository;

    <span class="comment">// (2)</span>
    <span class="annotation">@Inject</span>
    CustomerCache cache;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (3)</span>
        <span class="keyword">for</span>(Customer customer : customerRepository.findAll()) {
            cache.addCustomer(customer.getCustomerId(), customer);
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Application example with ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UpdateItemFromCacheProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPlanDetail&gt; {

    <span class="comment">// (4)</span>
    <span class="annotation">@Inject</span>
    CustomerCache cache;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPerformanceDetail readItem) <span class="directive">throws</span> <span class="exception">Exception</span> {
        Customer customer = cache.getCustomer(readItem.getCustomerId());  <span class="comment">// (5)</span>

        SalesPlanDetail writeItem = <span class="keyword">new</span> SalesPlanDetail();

        <span class="comment">// omitted.</span>
        writerItem.setCustomerName(customer.getCustomerName); <span class="comment">// (6)</span>

        <span class="keyword">return</span> writeItem;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Cache class</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (7)</span>
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerCache</span> {

    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, Customer&gt; customerMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

    <span class="directive">public</span> Customer getCustomer(<span class="predefined-type">String</span> customerId) {
        <span class="keyword">return</span> customerMap.get(customerId);
    }

    <span class="directive">public</span> <span class="type">void</span> addCustomer(<span class="predefined-type">String</span> id, Customer customer) {
        customerMap.put(id, customer);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;mybatis:scan</span>
        <span class="attribute-name">base-package</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">template-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheSetListener</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.CacheSetListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemListener</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DBAccessByItemListener.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">updateItemFromCacheProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (10) --&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheSetListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr. No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject a bean for caching data acquired from the Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get data from the Mapper interface and cache it at the listener.<br>
In this case, I/O is reduced and processing efficiency is improved by creating a cache
before step execution with <code>StepExecutionListener#beforeStep</code> and referring to the cache in the subsequent processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject the same bean as the cache set in (2).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get corresponding data from the cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reflect the data from the cache in the update data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement the cache class as a component.<br>
The Bean scope is <code>singleton</code> in here. Please set according to job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register Mapper XML<br>
Specify <code>batchModeSqlSessionTemplate</code> set as <code>BATCH</code> in <code>template-ref</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the listener that uses the Mapper interface.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify ItemProcessor that uses cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register the listener defined in (9).</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Using SqlSessionFactory with the Listener</div>
<div class="paragraph">
<p>In the above example, <code>batchModeSqlSessionTemplate</code> is set, but <code>jobSqlSessionFactory</code> also can be set.</p>
</div>
<div class="paragraph">
<p>For listeners that run outside the scope of chunks,
since it is processed outside the transaction, setting <code>jobSqlSessionFactory</code> does not matter.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_DBAccess_HowToExtend"><a class="anchor" href="#Ch05_DBAccess_HowToExtend"></a>5.2.3. How To Extend</h4>
<div class="sect4">
<h5 id="updating-multiple-tables-with-compositeitemwriter"><a class="anchor" href="#updating-multiple-tables-with-compositeitemwriter"></a>5.2.3.1. Updating multiple tables with CompositeItemWriter</h5>
<div class="paragraph">
<p>In a chunk model, when multiple tables are to be updated for 1 input data, it can be achieved by using <code>CompositeItemWriter</code> provided by Spring Batch
and linking <code>MyBatisBatchItemWriter</code> corresponding to each table.</p>
</div>
<div class="paragraph">
<p>An implementation example wherein two tables of sales plan and actual sales are updated is shown here.</p>
</div>
<div class="listingblock">
<div class="title">How to implement <code>ItemProcessor</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;SalesPlanDetail, SalesDTO&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesDTO process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> { <span class="comment">// (1)</span>

        SalesDTO salesDTO = <span class="keyword">new</span> SalesDTO();

        <span class="comment">// (2)</span>
        SalesPerformanceDetail spd = <span class="keyword">new</span> SalesPerformanceDetail();
        spd.setBranchId(item.getBranchId());
        spd.setYear(item.getYear());
        spd.setMonth(item.getMonth());
        spd.setCustomerId(item.getCustomerId());
        spd.setAmount(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0L</span>));
        salesDTO.setSalesPerformanceDetail(spd);

        <span class="comment">// (3)</span>
        item.setAmount(item.getAmount().add(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">1L</span>)));
        salesDTO.setSalesPlanDetail(item);

        <span class="keyword">return</span> salesDTO;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation of DTO</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesDTO</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// (4)</span>
    <span class="directive">private</span> SalesPlanDetail salesPlanDetail;

    <span class="comment">// (5)</span>
    <span class="directive">private</span> SalesPerformanceDetail salesPerformanceDetail;

    <span class="comment">// omitted</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">How to implement MapperXML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapper</span> <span class="attribute-name">namespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.repository.SalesRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        SELECT
            branch_id AS branchId, year, month, customer_id AS customerId, amount
        FROM
            sales_plan_detail
        ORDER BY
            branch_id ASC, year ASC, month ASC, customer_id ASC
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/select&gt;</span>

    <span class="comment">&lt;!-- (6) --&gt;</span>
    <span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.SalesDTO</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        UPDATE
            sales_plan_detail
        SET
            amount = #{salesPlanDetail.amount}
        WHERE
            branch_id = #{salesPlanDetail.branchId}
        AND
            year = #{salesPlanDetail.year}
        AND
            month = #{salesPlanDetail.month}
        AND
            customer_id = #{salesPlanDetail.customerId}
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/update&gt;</span>

    <span class="comment">&lt;!-- (7) --&gt;</span>
    <span class="tag">&lt;insert</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.SalesDTO</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="inline-delimiter">&lt;![CDATA[</span>
        INSERT INTO
            sales_performance_detail(
                branch_id,
                year,
                month,
                customer_id,
                amount
            )
        VALUES (
            #{salesPerformanceDetail.branchId},
            #{salesPerformanceDetail.year},
            #{salesPerformanceDetail.month},
            #{salesPerformanceDetail.customerId},
            #{salesPerformanceDetail.amount}
        )
        <span class="inline-delimiter">]]&gt;</span>
    <span class="tag">&lt;/insert&gt;</span>

<span class="tag">&lt;/mapper&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">How to apply <code>CompositeItemWriter</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- reader using MyBatisCursorItemReader --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.findAll</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- writer MyBatisBatchItemWriter --&gt;</span>
<span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.update</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.dbaccess.repository.SalesRepository.create</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (10) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- (11)--&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (12) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useCompositeItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useCompositeItemWriter.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr. No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ItemProcessor</code> with DTO as output which retains each entity for updating both the tables for input data.<br>
Since different objects cannot be passed in <code>ItemWriter</code> for updating 2 tables, a DTO which consolidates objects necessary for update is defined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create an entity for creating a new actual sales record (SalesPerformanceDetail) and store in DTO.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update input data for updating sales plan which is also input data (SalesPlanDetail) and store it in DTO.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define DTO(SalesPlanDetail) so as to retain a sales plan.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define DTO(SalesPerformanceDetail) so as to retain actual sales record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a SQL to update sales plan table (sales_plan_detail) in sales plan fetched from DTO (SalesPlanDetail).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a SQL to create a new actual sales table (sales_performance_detail) in actual sales fetched from DTO (SalesPlanDetail).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MyBatisBatchItemWriter</code> which updates sales plan table (sales_plan_detail).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MyBatisBatchItemWriter</code> which creates a new actual sales table (sales_performance_detail).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>CompositeItemWriter</code> in order to execute (9) and (10) sequentially.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set (9) and (10) in <code>&lt;list&gt;</code> tag. ItemWriter is executed in the specified order.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the Bean defined in (10), in <code>writer</code> attribute of chunk. Specify ItemProcessor of (1) in <code>processor</code> attribute.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It can also be updated for multiple data sources by using it together with <code>org.springframework.data.transaction.ChainedTransactionManager</code>
which is explained in <a href="#Ch05_Transaction_HowToUse_MultiDataSource_SingleTx">Output to multiple data sources (1 step)</a>.</p>
</div>
<div class="paragraph">
<p>Further, since CompositeItemWriter can be linked in case of ItemWriter implementation,
it can be done along with database output and file output by setting MyBatisBatchItemWriter and FlatFileItemWriter.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_FileAccess"><a class="anchor" href="#Ch05_FileAccess"></a>5.3. File Access</h3>
<div class="sect3">
<h4 id="Ch05_FileAccess_Overview"><a class="anchor" href="#Ch05_FileAccess_Overview"></a>5.3.1. Overview</h4>
<div class="paragraph">
<p>This chapter describes how to input and output files.</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Overview_FileType"><a class="anchor" href="#Ch05_FileAccess_Overview_FileType"></a>5.3.1.1. Type of File which can be handled</h5>
<div class="paragraph">
<div class="title">Type of File which can be handled</div>
<p>The type of files that can be handled with TERASOLUNA Batch 5.x are ones decribed as below.<br>
This is the same for which Spring Batch can handle.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Flat File</p>
</li>
<li>
<p>XML</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here it will explain how to handle flat file first,
and then explain about XML in <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>.</p>
</div>
<div class="paragraph">
<p>First, show the types of Flat File which can be used with TERASOLUNA Batch 5.x.<br>
Each row inside the flat file will be called <code>record</code>,
and type of file is determined by the record&#8217;s format.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Record Format</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable-length Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record format which each items are separated by a delimiter, such as CSV and TSF. Each item&#8217;s length can be variable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed-length Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record format which each items are separeted by the items length(bytes). Each item&#8217;s length are fixed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single String Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 Record will be handled as 1 String item.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">File Structure which can be handled</div>
<p>The basic structure for Flat File is constructed by these 2 points.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Record Division</p>
</li>
<li>
<p>Record Format</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Elements to construct format of Flat File</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Record Division</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A division will indicate the type of record, such as Header Record, Data Record, and Trailer Record.<br>
Details will be described later.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Record Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The format will have informations of the record such as how many rows there is for Header, Data, and Trailer, how many times eace record will repeat, and so on.<br>
There is also Single Format and Multi Format.Details will be described later.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>With TERASOLUNA Batch 5.x, Flat File with Single Format of Multi Format which includes each record division can be handles.</p>
</div>
<div class="paragraph">
<p>Here it willl explain about the record division and the record formats.</p>
</div>
<div class="paragraph">
<p>The overview of each record devision is explained as below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Characteristic of each Record Division</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Record Division</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the beginning of the file(data part).<br>
It has items such as field names, common matters of the file, and summary of the data part.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is a record having data to be processed as a main object of the file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trailer/Footer Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the end of the file if the file(data part).<br>
It has items such as common matters of the file and summary of the data part.<br>
For Single Format file, it is called a Fotter Record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Footer/End Record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is mentioned at the end of the file if the file is a Multi Format.<br>
It has items such as common matters of the file and summary of the data part.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About the field that indicates the record division</div>
<div class="paragraph">
<p>A flat file having a header record or a trailer record may have a field indicating a record division.<br>
In TERASOLUNA Batch 5.x, especially in the processing of multi-format files, the record division field is utilized, for example when different processing is performed for each record division.<br>
Refer to <a href="#Ch05_FileAccess_MultiFormat">Multi format</a> for the implementation when selecting the processing to be executed by record classification.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About the name of file format</div>
<div class="paragraph">
<p>Depending on the definition of the file format in each system,
There are cases where names are different from this guideline such as calling Footer Record as End Record.<br>
Must be read as appropriate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A summary of Single Format and Multi Format is shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Overview of Single Format and Multi Format</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Overview</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A format with Header N Rows + Data N Rows + Trailer N Rows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A format with (Header N Rows + Data N Rows + Trailer N Rows) * N + Footer N Rows.<br>
A format in which a Footer Record is added after repeating a Single Format a plurality of times.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Multi Format record structure is shown in the figure as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FileFormat_multi.png" alt="Multi format file layout">
</div>
<div class="title">Multi Format Rrecord Structure Diagram</div>
</div>
<div class="paragraph">
<p>An example of a Single Format and Multi Format flat file is shown below.<br>
<code>// </code> is used as a comment-out character for the description of the file.</p>
</div>
<div class="listingblock">
<div class="title">Example of Single Format, flat file(CSV format) without record division</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">branchId,year,month,customerId,amount  // (1)
000001,2016,1,0000000001,100000000  // (2)
000001,2016,1,0000000002,200000000  // (2)
000001,2016,1,0000000003,300000000  // (2)
000001,3,600000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of file contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Descriptions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A header record<br>
Field name of the data part is described.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A data record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A trailer record.<br>
It holds summary information of the data part.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Example of Multi Format, flat file(CSV format) with record division</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">// (1)
H,branchId,year,month,customerId,amount  // (2)
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,branchId,year,month,customerId,amount  // (2)
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,branchId,year,month,customerId,amount  // (2)
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
F,3,9,4500000000  // (3)</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of file contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Descriptions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It has a field indicating the record division at the beginning of the record.<br>
Each record division is defined as below.<br>
<code>H</code>：Header Record<br>
<code>D</code>：Data Record<br>
<code>T</code>：Trailer Record<br>
<code>F</code>：Footer Record</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Every time branchId changes, it repeats header, data, trailer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A footer record.<br>
It holds summary information for the whole file.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Assumptions on format of data part</div>
<div class="paragraph">
<p>In <a href="#Ch05_FileAccess_HowToUse">How To Use</a>, it will explain on the premise that the layout of the data part is the same format.<br>
This means that all the records of the data part are mapped to the same conversion target class</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About explanation of Multi Format file</div>
<div class="ulist">
<ul>
<li>
<p>In <a href="#Ch05_FileAccess_HowToUse">How To Use</a>, it will describe about the Single Format file.</p>
</li>
<li>
<p>For flat files having Multi Format or a structure including a footer part in the above structure, refer to <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Overview_FileAccessComponents"><a class="anchor" href="#Ch05_FileAccess_Overview_FileAccessComponents"></a>5.3.1.2. A component that inputs and outputs a flat file</h5>
<div class="paragraph">
<p>Describe a class for handling flat file.</p>
</div>
<div class="paragraph">
<div class="title">Input</div>
<p>The relationships of classes used for inputting flat files are as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_class.png" alt="Component relationship FlatFileItemReader class diagram">
</div>
<div class="title">Relationship of classes used for inputting flat files</div>
</div>
<div class="paragraph">
<p>The calling relationship of each component is as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemReader_component_relationship_sequence.png" alt="Component relationship FlatFileItemReader sequence diagram">
</div>
<div class="title">Calling relationship of each component</div>
</div>
<div class="paragraph">
<p>Details of each component are shown below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemReader</dt>
<dd>
<p>Implementation class of <code>ItemReader</code> to use for loading flat files. Use the following components.<br>
The flow of simple processing is as follows.<br>
1.Use <code>BufferedReaderFactory</code> to get <code>BufferedReader</code>.<br>
2.Read one record from the flat file using the acquired <code>BufferedReader</code>.<br>
3.Use <code>LineMapper</code> to map one record to the target bean.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.BufferedReaderFactory</dt>
<dd>
<p>Generate <code>BufferedReader</code> to read the file.</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.LineMapper</dt>
<dd>
<p>One record is mapped to the target bean. Use the following components.<br>
The flow of simple processing is as follows.<br>
1.Use <code>LineTokenizer</code> to split one record into each item.<br>
2.Mapping items split by <code>FieldSetMapper</code> to bean properties.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineTokenizer</dt>
<dd>
<p>Divide one record acquired from the file into each item.<br>
Each partitioned item is stored in <code>FieldSet</code> class.</p>
</dd>
<dt class="hdlist1">org.springframework.batch.item.file.mapping.FieldSetMapper</dt>
<dd>
<p>Map each item in one divided record to the property of the target bean.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Output</div>
<p>Relationships of classes used for outputting flat files are as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_class.png" alt="Component relationship FlatFileItemWriter class diagram">
</div>
<div class="title">Relationship of classes used for outputting flat files</div>
</div>
<div class="paragraph">
<p>The calling relationship of each component is as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_FlatFileItemWriter_component_relationship_sequence.png" alt="Component relationship FlatFileItemWriter sequence diagram">
</div>
<div class="title">Calling relationship of each component</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.FlatFileItemWriter</dt>
<dd>
<p>Implementation class of <code>ItemWriter</code> for exporting to a flat file. Use the following components.
<code>LineAggregator</code> Mapping the target bean to one record.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.LineAggregator</dt>
<dd>
<p>It is used to map the target bean to one record.
The mapping between the properties of the bean and each item in the record is done in <code>FieldExtractor</code>.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">org.springframework.batch.item.file.transform.FieldExtractor</dt>
<dd>
<p>Map the property of the target bean to each item in one record.</p>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToUse"><a class="anchor" href="#Ch05_FileAccess_HowToUse"></a>5.3.2. How To Use</h4>
<div class="paragraph">
<p>Descriptoins for how to use flat file according to the record format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_VariableLength">Variable-length record</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_FixedLength">Fixed-length record</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_PathhThrough">Single String record</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, the following items are explained.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_HeaderFooter">Header and Footer</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_MultiFile">Multiple Files</a></p>
</li>
<li>
<p><a href="#Ch05_FileAccess_Output_ControlBreak">Control Break</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_VariableLength"><a class="anchor" href="#Ch05_FileAccess_VariableLength"></a>5.3.2.1. Variable-length record</h5>
<div class="paragraph">
<p>Describe the definition method when dealing with variable-length record file.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_VariableLength_Input"><a class="anchor" href="#Ch05_FileAccess_VariableLength_Input"></a>5.3.2.1.1. Input</h6>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="comment">&lt;!-- (6) (7) (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:quoteCharacter</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of the character code of the component offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemWriter is "UTF-8").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM&#8217;s default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>.<br>
<code>DefaultLineMapper</code> is <code>LineMapper</code> which provides the basic operation of converting records to the class to be converted using the defined <code>LineTokenizer</code> and <code>FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.DelimitedLineTokenizer</code>.<br>
<code>DelimitedLineTokenizer</code> is an implementation class of <code>LineTokenizer</code> that separates records by specifying delimiters.<br>
It corresponds to the reading of escaped line feeds, delimiters, and enclosed characters defined in the specification of RFC-4180, which is a general format of CSV format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record.<br>
Each item can be retrieved using the name set in <code>FieldSet</code> used in <code>FieldSetMapper</code>.<br>
Set each name from the beginning of the record with a comma separator.<br>
When using <code>BeanWrapperFieldSetMapper</code> it is mandatory setting.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set delimiter</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">quoteCharacter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set enclosing character</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing such as character strings and numbers is unnecessary, use <code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>,
and specify the class to be converted to property <code>targetType</code>.
By doing this, an instance that automatically sets the value in the field that matches the name of each item set in (5) will be created.<br>
If conversion processing is necessary, set the implementation class of <code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a> for the case of implementing FieldSetMapper yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to enter TSV format file</div>
<div class="paragraph">
<p>When reading the TSV file, it can be realized by setting a tab as a delimiter.</p>
</div>
<div class="listingblock">
<div class="title">TSV file loading: Example of delimiter setting (setting by constant)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, it may be as follows.</p>
</div>
<div class="listingblock">
<div class="title">TSV file reading: Example of delimiter setting (setting by character reference)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_VariableLength_Output"><a class="anchor" href="#Ch05_FileAccess_VariableLength_Output"></a>5.3.2.1.2. Output</h6>
<div class="paragraph">
<p>An example of setting for writing the following output file is shown.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">001,CustomerName001,CustomerAddress001,11111111111,001
002,CustomerName002,CustomerAddress002,11111111111,002
003,CustomerName003,CustomerAddress003,11111111111,003</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Customer</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="comment">&lt;!-- (11) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId,customerName,customerAddress,customerTel,chargeBranchId</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code of the components offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemReader is "default character set of JavaVM").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set record break (line feed code).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, add to the existing file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> If true, it must be noted that setting value of shouldDeleteIfExists is invalidated.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> If appendAllowed is true, it is recommended not to specify property since the property is invalidated.<br>
If true, delete if the file already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete file for output when output count is 0. <br>
<span class="icon"><i class="fa fa-warning"></i></span> Since unintended behaviour is likely to happen by combining with other properties, it is recommended not to set it to true. For details, refer <a href="#Ch05_FileAccess_VariableLength_Output_about-shouldDeleteIfEmpty">Described later</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code>.<br>
To enclose a field around it, set <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>.<br>
Usage of <code>EnclosableDelimitedLineAggregator</code> will be described later.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the delimiter.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for strings and numbers is unnecessary, you can use <code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>.<br>
If conversion processing is necessary, set implementation class of <code>org.springframework.batch.item.file.transform.FieldExtractor</code>.<br>
An example for implementatiion of <code>FieldExtractor</code>, refer to <a href="#Ch05_FileAccess_FixedLength_Output">Output of Fixed-length record</a> where a sample is described using full-width character.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record. Set each name from the beginning of the record with a comma separator.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div id="Ch05_FileAccess_VariableLength_Output_about-shouldDeleteIfEmpty" class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">It is recommended not to set true for shouldDeleteIfEmpty property of FlatFileItemWriter.</div>
<div class="paragraph">
<p>For FlatFileItemWriter, unintended files are deleted when the properties are configured by the combinations as shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>p:shouldDeleteIfEmpty="true"</code></p>
</li>
<li>
<p><code>p:shouldDeleteIfExists="false"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Reasons are as given below.<br>
When shouldDeleteIfEmpty is set to true, file for output is deleted when output count is 0.<br>
The "output count is 0" also includes a case wherein file for output already exists with shouldDeleteIfExists set to false.</p>
</div>
<div class="paragraph">
<p>Hence, when properties are specified by combinations above, file for output is deleted if it exists already.<br>
This becomes the unintended behaviour when preferably an exception should be thrown and the process should be terminated in case a file for output exists.</p>
</div>
<div class="paragraph">
<p>It is recommended not to set shouldDeleteIfEmpty property to true since it results in unintended operation.</p>
</div>
<div class="paragraph">
<p>Further, when subsequent processing like deletion of file is to be done if output count is 0, implementation should be done by using OS command or Listener instead of shouldDeleteIfEmpty property.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">How to use EnclosableDelimitedLineAggregator</div>
<p>To enclose a field around it, use <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code> provided by TERASOLUNA Batch 5.x.<br>
The specification of <code>EnclosableDelimitedLineAggregator</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optional specification of enclosure character and delimiter character</p>
<div class="ulist">
<ul>
<li>
<p>Default is the following value commonly used in CSV format</p>
<div class="ulist">
<ul>
<li>
<p>Enclosed character: <code>"</code>(double quote)</p>
</li>
<li>
<p>Separator: <code>, </code> (comma)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If the field contains a carriage return, line feed, enclosure character, or delimiter, enclose the field with an enclosing character</p>
<div class="ulist">
<ul>
<li>
<p>When enclosing characters are included, the enclosing character will be escaped by adding an enclosing character right before this enclosing characters.</p>
</li>
<li>
<p>All fields can be surrounded by characters by setting</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The usage of <code>EnclosableDelimitedLineAggregator</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">&quot;001&quot;,&quot;CustomerName&quot;&quot;001&quot;&quot;&quot;,&quot;CustomerAddress,001&quot;,&quot;11111111111&quot;,&quot;001&quot;
&quot;002&quot;,&quot;CustomerName&quot;&quot;002&quot;&quot;&quot;,&quot;CustomerAddress,002&quot;,&quot;11111111111&quot;,&quot;002&quot;
&quot;003&quot;,&quot;CustomerName&quot;&quot;003&quot;&quot;&quot;,&quot;CustomerAddress,003&quot;,&quot;11111111111&quot;,&quot;003&quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Same as above example</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition example(only settings for lineAggregator)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
  <span class="comment">&lt;!-- (2) (3) (4) --&gt;</span>
  <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:delimiter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:enclosure</span>=<span class="string"><span class="delimiter">'</span><span class="content">&quot;</span><span class="delimiter">'</span></span>
        <span class="attribute-name">p:allEnclosing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
      <span class="tag">&lt;/property&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delimiter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the delimiter.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comma</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enclosure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the enclosing character.<br>
If the enclosing character is included in the field, it is replaced with a concatenated character as an escape process.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allEnclosing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, all fields are enclosed in an enclosing character.<br>
If false, only fields containing carriage return (CR), line-leading (LF), delimiter, and enclosing characters will be enclosed.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>TERASOLUNA Batch 5.x provides the extension class <code>org.terasoluna.batch.item.file.transform.EnclosableDelimitedLineAggregator</code> to satisfy the specification of RFC-4180.</p>
</div>
<div class="paragraph">
<p>The <code>org.springframework.batch.item.file.transform.DelimitedLineAggregator</code> provided by Spring Batch does not correspond to the enclosing process of the field, therefore it can not satisfy the specification of RFC-4180.
Refer to <a href="https://jira.spring.io/browse/BATCH-2463">Spring Batch/BATCH-2463</a> .</p>
</div>
<div class="paragraph">
<p>The format of the CSV format is defined as follows in RFC-4180 which is a general format of CSV format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the field does not contain line breaks, enclosing characters, or delimiters, each field can be enclosed in double quotes (enclosing characters) or not enclosed</p>
</li>
<li>
<p>Fields that contain line feed (CRLF), double quote (enclosing character), comma (delimiter) should be enclosed in double quotes</p>
</li>
<li>
<p>If the field is enclosed in double quotes (enclosing characters), the double quotes contained in the value of the field must be escaped with a single double quote immediately before it</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to output TSV format file</div>
<div class="paragraph">
<p>When outputting a TSV file, it can be realized by setting a tab as a delimiter.</p>
</div>
<div class="listingblock">
<div class="title">Setting example of delimiter when outputting TSV file (setting by constant)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;util:constant</span>
            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, it may be as follows.</p>
</div>
<div class="listingblock">
<div class="title">Example of delimiter setting when TSV file is output (setting by character reference)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delimiter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#09;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_FixedLength"><a class="anchor" href="#Ch05_FileAccess_FixedLength"></a>5.3.2.2. Fixed-length record</h5>
<div class="paragraph">
<p>Describe how to define fixed length record files.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_FixedLength_Input"><a class="anchor" href="#Ch05_FileAccess_FixedLength_Input"></a>5.3.2.2.1. Input</h6>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown.</p>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.x corresponds to a format in which record delimitation is judged by line feed and format judged by the number of bytes.</p>
</div>
<div class="listingblock">
<div class="title">Input file example 1 (record breaks are line feeds)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Sale012016 1   00000011000000000
Sale022017 2   00000022000000000
Sale032018 3   00000033000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Input file example 2 (record delimiter is byte number, 32 bytes is 1 record)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Sale012016 1   00000011000000000Sale022017 2   00000022000000000Sale032018 3   00000033000000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Input file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Number of bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.DefaultBufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span>
                <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="comment">&lt;!-- (9) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:ranges</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1-6, 7-10, 11-12, 13-22, 23-32</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">c:charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code for the components offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemWriter is "UTF-8").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bufferedReaderFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To decide record breaks by line breaks, use the default value <code>org.springframework.batch.item.file.DefaultBufferedReaderFactory</code>.
<code>BufferedReader</code> generated by <code>DefaultBufferedReaderFactory</code> acquires up to a newline as one record.</p>
<p class="tableblock">To judge the delimiter of a record by the number of bytes, set <code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code> provided by TERASOLUNA Batch 5.x.
<code>BufferedReader</code> generated by <code>FixedByteLengthBufferedReaderFactory</code> acquires up to the specified number of bytes as one record.<br>
Detailed specifications and usage of <code>FixedByteLengthBufferedReaderFactory</code> will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultBufferedReaderFactory</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.DefaultLineMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineTokenizer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.terasoluna.batch.item.file.transform.FixedByteLengthLineTokenizer</code> provided by TERASOLUNA Batch 5.x.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record.<br>
Each item can be retrieved using the name set in <code>FieldSet</code> used in <code>FieldSetMapper</code>. <br>
Set each name from the beginning of the record with a comma separator.<br>
When using <code> BeanWrapperFieldSetMapper</code> it is mandatory setting.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ranges<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the break position. Set the delimiter position from the beginning of the record, separated by commas.<br>
The unit of each delimiter position is byte, and it is specified in <code>start position - end position</code> format.<br>
The range specified from the record is acquired in the order in which the delimiter positions are set, and stored in <code>FieldSet</code>.<br>
When names of (6) are specified, the delimiter positions are stored in <code> FieldSet</code> in correspondence with names in the order in which they are set.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">charset<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the same character code as (2).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldSetMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for character strings and numbers is unnecessary, use <code>org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</code>,
 and specify the conversion target class as property <code>targetType</code>.
By doing this, we create an instance that automatically sets the value in the field that matches the name of each item set in (6).<br>
If conversion processing is necessary, set the implementation class of <code>org.springframework.batch.item.file.mapping.FieldSetMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a> for the case of implementing FieldSetMapper yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">How to use FixedByteLengthBufferedReaderFactory</div>
<p>To read a file that judges record delimiter by byte count, use <code>org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</code> provided by TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>By using <code>FixedByteLengthBufferedReaderFactory</code>, it is possible to acquire up to the number of bytes specified as one record.<br>
The specification of <code>FixedByteLengthBufferedReaderFactory</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify byte count of record as constructor argument</p>
</li>
<li>
<p>Generate <code>FixedByteLengthBufferedReader</code> which reads the file with the specified number of bytes as one record</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use of <code>FixedByteLengthBufferedReader</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reads a file with one byte length specified at instance creation</p>
</li>
<li>
<p>If there is a line feed code, do not discard it and read it by including it in the byte length of one record</p>
</li>
<li>
<p>The file encoding to be used for reading is the value set for <code>FlatFileItemWriter</code>, and it will be used when <code>BufferedReader</code> is generated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method of defining <code> FixedByteLengthBufferedReaderFactory</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bufferedReaderFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.item.file.FixedByteLengthBufferedReaderFactory</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">c:byteLength</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>

<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byteLength<br>
(Constructor argument)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of bytes per record.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Components to use when handling Fixed-length files</div>
<div class="paragraph">
<p>When dealing with Fixed-length files, it is based on using the component provided by TERASOLUNA Batch 5.x.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FixedByteLengthBufferedReaderFactory</dt>
<dd>
<p><code>BufferedReader</code> generation class that reads one record from the fixed-length file without line break by the number of bytes of the specified character code</p>
</dd>
<dt class="hdlist1">FixedByteLengthLineTokenizer</dt>
<dd>
<p>The <code>FixedLengthTokenizer</code> extension class, separated by the number of bytes corresponding to the multibyte character string</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Processing records containing multibyte character strings</div>
<div class="paragraph">
<p>When processing records containing multibyte character strings, be sure to use <code>FixedByteLengthLineTokenizer</code>.<br>
The <code> FixedLengthTokenizer</code> provided by Spring Batch separates the record by the number of characters instead of the number of bytes, so there is a possibility that the item will not be extracted as expected.</p>
</div>
<div class="paragraph">
<p>Since this issue is already reported to JIRA <a href="https://jira.spring.io/browse/BATCH-2540">Spring Batch/BATCH-2540</a>, it might be unnecessary in the future.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the implementation of FieldSetMapper, refer to <a href="#Ch05_FileAccess_HowToExtend">How To Extend</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_FixedLength_Output"><a class="anchor" href="#Ch05_FileAccess_FixedLength_Output"></a>5.3.2.2.2. Output</h6>
<div class="paragraph">
<p>An example of setting for writing the following output file is shown.</p>
</div>
<div class="paragraph">
<p>In order to write a fixed-length file, it is necessary to format the value obtained from the bean according to the number of bytes of the field.<br>
The format execution method differs as follows depending on whether double-byte characters are included or not.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If double-byte characters is not included(single-byte characters only and the number of bytes of characters is constant)</p>
<div class="ulist">
<ul>
<li>
<p>Format using <code>FormatterLineAggregator</code>.</p>
</li>
<li>
<p>The format is set by the format used in the <code> String.format</code> method.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If double-byte characters is included(The number of bytes of characters is not constant depending on the character code)</p>
<div class="ulist">
<ul>
<li>
<p>Format with implementation class of <code>FieldExtractor</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, a setting example in the case where double-byte characters are not included in the output file is shown, followed by a setting example in the case where double-byte characters are included.</p>
</div>
<div class="paragraph">
<p>The setting when double-byte characters are not included in the output file is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
   0022017 20000000002  20000000
   0032018 30000000003  30000000</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Output file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Number of bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If the field&#8217;s value is less than the number of bytes specified, the rest of the field will be filled with halfwidth space.</p>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%6s%4s%2s%10s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (9) --&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (10) --&gt;</span>
              <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code for the components offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemReader is "Default character set of JavaVM").<br>
Hence, it is recommended to explicitly set the character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code).<br>
To make it without line breaks, set <code>(empty string)</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, add to the existing file. <br>
<span class="icon"><i class="fa fa-warning"></i></span> If true, it must be noted that setting value of shouldDeleteIfExists is invalidated.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> If appendAllowed is true, it is recommended not to specify a property since this property is invalidated.<br>
If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file for output if the output count is 0.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Since unintended behaviour is likely to happen by combining with other properties, it is recommended not to set it to true. For details, refer <a href="#Ch05_FileAccess_VariableLength_Output_about-shouldDeleteIfEmpty">Notes for how to output variable length record</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output format with the format used in the <code>String.format</code> method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If special conversion processing for strings and numbers is unnecessary, you can use <code>org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</code>.</p>
<p class="tableblock">If conversion processing is necessary, set implementation class of <code>org.springframework.batch.item.file.transform.FieldExtractor</code>.<br>
An example for implementatiion of <code>FieldExtractor</code> to format double-byte characters is written later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Give a name to each item of one record. Set the names of each field from the beginning of the record with a comma.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About PassThroughFieldExtractor</div>
<div class="paragraph">
<p>Deafult value for property <code>fieldExtractor</code> of <code>FormatterLineAggregator</code> is <code>org.springframework.batch.item.file.transform.PassThroughFieldExtractor</code>.</p>
</div>
<div class="paragraph">
<p><code>PassThroughFieldExtractor</code> is a class to return the original item without processing anything, and is used when <code>FieldExtractor</code> will not process anything.</p>
</div>
<div class="paragraph">
<p>If the item is an array or a collection, it is returned as is, otherwise it is wrapped in an array of single elements.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Example of how to format a field with double-byte character</div>
<p>When formatting for double-byte characters, since the number of bytes per character differs depending on the character code, use the implementation class of <code>FieldExtractor</code> instead of <code>FormatterLineAggregator</code>.</p>
</div>
<div class="paragraph">
<p>Implementation class of <code>FieldExtractor</code> is to be done as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FieldExtractor</code> and override extract method.</p>
</li>
<li>
<p>extract method is to be implemented as below</p>
<div class="ulist">
<ul>
<li>
<p>get the value from the item(target bean), and perform the conversion as needed</p>
</li>
<li>
<p>set the value to an array of object and return it.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The format of a field that includes double-byte characters is to be done in the implementation class of <code>FieldExtractor</code> by the following way.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get the number of bytes for the character code</p>
</li>
<li>
<p>Format the value by trimming or padding it according to be number of bytes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is a setting example for formatting a field including double-byte characters.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">   0012016 10000000001  10000000
  番号2017 2 売上高002  20000000
 番号32018 3   売上003  30000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use of the output file is the same as the example above.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition(settings of lineAggregator only)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.FormatterLineAggregator</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">p:format</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">%s%4s%2s%s%10s</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.plan.SalesPlanFixedLengthFieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.FormatterLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output format with the format used in the <code>String.format</code> method.<br>
The number of digits is specified only for fields that do not contain double-byte characters.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fieldExtractor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FieldExtractor</code>.<br>
An implementation example will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PassThroughFieldExtractor</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample implementation of FieldExtractor to format double-byte characters</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanFixedLengthFieldExtractor</span> <span class="directive">implements</span> FieldExtractor&lt;SalesPlanDetail&gt; {
    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span><span class="type">[]</span> extract(SalesPlanDetail item) {
        <span class="predefined-type">Object</span><span class="type">[]</span> values = <span class="keyword">new</span> <span class="predefined-type">Object</span>[<span class="integer">5</span>];  <span class="comment">// (2)</span>

        <span class="comment">// (3)</span>
        values[<span class="integer">0</span>] = fillUpSpace(item.getBranchId(), <span class="integer">6</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">1</span>] = item.getYear();
        values[<span class="integer">2</span>] = item.getMonth();
        values[<span class="integer">3</span>] = fillUpSpace(item.getCustomerId(), <span class="integer">10</span>);  <span class="comment">// (4)</span>
        values[<span class="integer">4</span>] = item.getAmount();

        <span class="keyword">return</span> values; <span class="comment">// (7)</span>
    }

    <span class="comment">// It is a simple impl for example</span>
    <span class="directive">private</span> <span class="predefined-type">String</span> fillUpSpace(<span class="predefined-type">String</span> val, <span class="type">int</span> num) {
        <span class="predefined-type">String</span> charsetName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>;
        <span class="type">int</span> len;
        <span class="keyword">try</span> {
            len = val.getBytes(charsetName).length;  <span class="comment">// (5)</span>
        } <span class="keyword">catch</span> (<span class="exception">UnsupportedEncodingException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="predefined-type">String</span> fillStr = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; (num - len); i++) { <span class="comment">// (6)</span>
            fillStr += <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>;
        }

        <span class="keyword">return</span> fillStr + val;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FieldExtractor</code> class and override extract method.<br>
Set the conversion target class as the type argument of <code>FieldExtractor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a Object type array to store data after the conversion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the value from the item(target bean), and perform the conversion as needed, set the value to an array of object.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format the field that includes double-byte character.<br>
Refer to (5) and (6) for the details of format process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the number of bytes for the character code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Format the value by trimming or padding it according to be number of bytes.<br>
In the implementation example, white space characters are added before the character string up to the specified number of bytes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns an array of Object type holding the processing result.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_PathhThrough"><a class="anchor" href="#Ch05_FileAccess_PathhThrough"></a>5.3.2.3. Single String record</h5>
<div class="paragraph">
<p>Describe the definition method when dealing with a single character string record file.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_PathhThrough_Input"><a class="anchor" href="#Ch05_FileAccess_PathhThrough_Input"></a>5.3.2.3.1. Input</h6>
<div class="paragraph">
<p>An example of setting for reading the following input file is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Input file sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PassThroughLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the input file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code for the components offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemWriter is "UTF-8").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaVM default character set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.PassThroughLineMapper</code>.<br>
<code>PassThroughLineMapper</code> is a implementation class of <code>LineMapper</code>, and it will return the String value of passed record as it is.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_PathhThrough_Output"><a class="anchor" href="#Ch05_FileAccess_PathhThrough_Output"></a>5.3.2.3.2. Output</h6>
<div class="paragraph">
<p>The setting for writing the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">Summary1:4,000,000,000
Summary2:5,000,000,000
Summary3:6,000,000,000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Writer --&gt;</span>
<span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the output file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the character code of the output file.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code for the components offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemReader is "Default character set of JavaVM").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code)<br></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">appendAllowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, add to existing file. <br>
<span class="icon"><i class="fa fa-warning"></i></span> If true, it must be noted that setting value of shouldDeleteIfExists is invalidated.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfExists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> If appendAllowed is true, it is recommended not to specify the property since the property is invalidated.<br>
If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete file for output if output count is 0.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Since unintended behaviour is likely to happen by combining with other properties, it is recommended not to set it to true. For details, refer <a href="#Ch05_FileAccess_VariableLength_Output_about-shouldDeleteIfEmpty">Notes for how to output variable length records</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>.<br>
<code>PassThroughLineAggregator</code> is the implementation class of <code>LineAggregator</code> that will return the converted String value of the item(target Bean) as it is by processing <code>item.toString()</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter"></a>5.3.2.4. Header and Footer</h5>
<div class="paragraph">
<p>Explain the input / output method when there is a header / footer.</p>
</div>
<div class="paragraph">
<p>Here, a method of skipping the header footer by specifying the number of lines will be explained.<br>
When the number of records of header / footer is variable and it is not possible to specify the number of lines, use <code>PatternMatchingCompositeLineMapper</code> with reference to <a href="#Ch05_FileAccess_MultiLine_Input">Multi format input</a></p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HeaderFooter_Input"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input"></a>5.3.2.4.1. Input</h6>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Input_SkipHeaders"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_SkipHeaders"></a>Skipping Header</h7>
<div class="paragraph">
<p>There are 2 ways to skip the header record.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the number of lines to skip to property <code>linesToSkip</code> of <code>FlatFileItemReader</code></p>
</li>
<li>
<p>Remove header record in preprocessing by OS command</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Input file sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_11
branchId,year,month,customerId,amount
000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first 2 lines is the header record.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>The setting for reading the above file is as follows.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Skip by using linesToSkip</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="attribute-value">value</span><span class="error">=</span><span class="error">&quot;</span><span class="attribute-name">2</span><span class="error">&quot;</span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of header record lines to skipl.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Skip by using OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in header from the top of input file
tail -n +`expr 2 + 1` input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the tail command and get the 3rd line and after from input.txt, and then write it out to output.txt.
Please note that the value specified for option <code>-n + K</code> of tail command is the number of header records + 1.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">OS command to skip header record and footer record</div>
<div class="paragraph">
<p>By using the head and tail commands, it is possible to skip the header record and footer record by specifying the number of lines.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">How to skip the header record</dt>
<dd>
<p>Execute the tail command with option <code>-n +K</code>, and get the lines after <code>K</code> from the target file.</p>
</dd>
<dt class="hdlist1">How to skip the footer record</dt>
<dd>
<p>Execute the head command with option <code>-n -K</code>, and get the lines befor <code>K</code> from the target file.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A sample of shell script to skip header record and footer record can be written as follows.<br></p>
</div>
<div class="listingblock">
<div class="title">An example of a shell script that removes a specified number of lines from a header / footer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">#!/bin/bash

if [ $# -ne 4 ]; then
  echo &quot;The number of arguments must be 4, given is $#.&quot; 1&gt;&amp;2
  exit 1
fi

# Input file.
input=$1

# Output file.
output=$2

# Number of lines in header.
header=$3

# Number of lines in footer.
footer=$4

# Remove number of lines in header from the top of input file
# and number of lines in footer from the end,
# and save to output file.
tail -n +`expr ${header} + 1` ${input} | head -n -${footer} &gt; ${output}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Arguments</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of lines to skip for header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of lines to skip for footer</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Input_AccessHeaders"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders"></a>Retrieving header information</h7>
<div class="paragraph">
<p>Here shows how to recognize and retrive the header record.</p>
</div>
<div class="paragraph">
<p>The extraction of header information is implemented as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Settings</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Write the process for header record in implementation class of <code>org.springframework.batch.item.file.LineCallbackHandler</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the information retrieved in <code>LineCallbackHandler#handleLine()</code> to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set implementation class of <code>LineCallbackHandler</code> to property skippedLinesCallback<code> of </code>FlatFileItemReader``</p>
</li>
<li>
<p>Set the number of lines to skip to property <code>linesToSkip</code> of <code>FlatFileItemReader</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Reading files and retrieving header information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>For each line which is skipped by the setting of <code>linesToSkip</code>, <code>LineCallbackHandler#handleLine()</code> is executed</p>
<div class="ulist">
<ul>
<li>
<p>Header information is set to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Use retrieved header information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Get header information from <code>stepExecutionContext</code> and use it in the processing of the data part</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An example of implementation for retrieving header record information is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.HoldHeaderLineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:linesToSkip</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:skippedLinesCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;batch:listeners&gt;</span>
                <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
            <span class="tag">&lt;/batch:listeners&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linesToSkip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of lines to skip.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">skippedLinesCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>LineCallbackHandler</code>.<br>
An implementation sample will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StepExecutionListener</code>.<br>
This setting is needed sinche the <code>LineCallbackHandler</code> set to property <code>skippedLinesCallback</code> of <code>FlatFileItemReader</code> will not be automatically registered as the <code>Listener</code>.<br>
The detailed reason will be described later.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About the listener</div>
<div class="paragraph">
<p>Since the following two cases are not automatically registered as <code> Listener</code>, it is necessary to add a definition to <code> Listeners</code> at the time of job definition.<br>
(If listener definitions are not added, <code> StepExecutionListener # beforeStep () </code> will not be executed)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StepExecutionListener</code> of <code>LineCallbackHandler</code> which is set to <code>skippedLinesCallback</code> of <code>FlatFileItemReader</code></p>
</li>
<li>
<p><code>StepExecutionListener</code> implemented to implementation class of <code>Tasklet</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadCsvSkipAndReferHeader.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingHeaderRecordItemProcessor</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;batch:listeners&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingItemReaderListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="comment">&lt;!-- mandatory --&gt;</span>
                    <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineCallbackHandler</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:listeners&gt;</span>
            <span class="tag">&lt;/batch:tasklet&gt;</span>
        <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LineCallbackHandler</code> should be implemented as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener#beforeStep()</code></p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener#beforeStep()</code> by either ways shown below</p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StepExecutionListener</code> class and override beforeStep method</p>
</li>
<li>
<p>Implement beforeStep method and annotate with <code>@BeforeStep</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Get <code> StepExecution</code> in the beforeStep method and save it in the class field</p>
</li>
</ul>
</div>
</li>
<li>
<p>Implement <code>LineCallbackHandler#handleLine()</code></p>
<div class="ulist">
<ul>
<li>
<p>Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code></p>
<div class="ulist">
<ul>
<li>
<p>Note that <code>handleLine</code> method will be executed each time skip is proceeded</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get <code>stepExecutionContext</code> from <code>StepExecution</code> and set header information to <code>stepExecutionContext</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample implementation of LineCallbackHandler</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">HoldHeaderLineCallbackHandler</span> <span class="directive">implements</span> LineCallbackHandler {  <span class="comment">// (!)</span>
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (2)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (4)</span>
    }

    <span class="annotation">@Override</span>  <span class="comment">// (5)</span>
    <span class="directive">public</span> <span class="type">void</span> handleLine(<span class="predefined-type">String</span> line) {
        <span class="local-variable">this</span>.stepExecution.getExecutionContext().putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>, line);  <span class="comment">// (6)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a field to save <code>StepExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>beforeStep</code> method and annotate it with <code>@BeforeStep</code>.<br>
The signature will be <code>void beforeStep(StepExecution stepExecution)</code>.<br>
It is also possible to implement the <code>StepExecutionListener</code> class and override <code>beforeStep</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the <code>StepExecution</code> and save it to the class field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>LineCallbackHandler</code> class and override <code>handleLine</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>stepExecutionContext</code> from <code>StepExecution</code>, set header information to <code>stepExecutionContext</code> by using key <code>header</code>.<br>
Here, for simplicity, only the last one line of two lines to be skipped is stored.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here is a sample of getting the header information from <code>stepExecutionContext</code> and using it for processing of data part.<br>
A sample of using header information in <code>ItemProcessor</code> will be described as an example.<br>
The same can be done when using header information in other components.</p>
</div>
<div class="paragraph">
<p>The implementation of using header information is done as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As like the sample of implementing <code>LineCallbackHandler</code>, implement <code>StepExecutionListener#beforeStep()</code></p>
</li>
<li>
<p>Get <code>StepExecution</code> in beforeStep method and save it to the class field</p>
</li>
<li>
<p>Get <code>stepExecutionContext</code> and the header information from <code>StepExecution</code> and use it</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample of how to use header information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoggingHeaderRecordItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetail, SalesPlanDetail&gt; {
    <span class="directive">private</span> StepExecution stepExecution;  <span class="comment">// (1)</span>

    <span class="annotation">@BeforeStep</span>  <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;  <span class="comment">// (3)</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(SalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> headerData = <span class="local-variable">this</span>.stepExecution.getExecutionContext()
                .getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (4)</span>
        <span class="comment">// omitted business logic</span>
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a field to save <code>StepExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>beforeStep</code> method and annotate it with <code>@BeforeStep</code>.<br>
The signature will be <code>void beforeStep(StepExecution stepExecution)</code>.<br>
It is also possible to implement the <code>StepExecutionListener</code> class and override <code>beforeStep</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the <code>StepExecution</code> and save it to the class field.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>stepExecutionContext</code> from <code>StepExecution</code>, set header information to <code>stepExecutionContext</code> by using key <code>header</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About the use of ExecutionContext of Job/Step</div>
<div class="paragraph">
<p>In retrieving header (footer) information, the method is to store the read header information in <code>ExecutionContext</code> of <code>StepExecution</code>, and retrieves it from <code>ExecutionContext</code> when using it.</p>
</div>
<div class="paragraph">
<p>In the example below, header information is stored in <code>ExecutionContext</code> of <code>StepExecution</code> in order to obtain and use header information within one step.
If step is divided by retreiving and using the header information, use <code>ExecutionContext</code> of <code>JobExecution</code>.</p>
</div>
<div class="paragraph">
<p>For details about <code>ExecutionContext</code> of Job/Step, refer to <a href="#Ch02_SpringBatchArch">Architecture of Spring Batch</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Input_SkipFooters"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_SkipFooters"></a>Skipping Footer</h7>
<div class="paragraph">
<p>Since Spring Batch nor TERASOLUNA Batch 5.x does not support skipping footer record, it needs to be done by OS command.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last 2 lines is the footer record.</p>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Skipping by OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Remove number of lines in footer from the end of input file
head -n -2 input.txt &gt; output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use head command, get the lines above the second line from the last from input.txt, and write it out to output.txt.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is reported to JIRA <a href="https://jira.spring.io/browse/BATCH-2539">Spring Batch/BATCH-2539</a> that Spring Batch does not have a functions to skip the footer record.<br>
Hence, there is a possibility that not only by OS command, but Spring Batch will be able to skip the footer record in the future.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Input_AccessFooters"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Input_AccessFooters"></a>Retrieving footer information</h7>
<div class="paragraph">
<p>In Spring Batch and TERASOLUNA Batch 5.x, functions for skipping footer record retreiving footer information is not provided.</p>
</div>
<div class="paragraph">
<p>Therefore, it needs to be divided into preprocessing OS command and 2 steps as described below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Divide footer record by OS command</p>
</li>
<li>
<p>In 1st step, read the footer record and set footer information to <code>ExecutionContext</code></p>
</li>
<li>
<p>In 2nd step, retrive footer information from <code>ExecutionContext</code> and use it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retreiving footer information will be implemented as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Divide footer record by OS command</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Use OS command to divide the input file to footer part and others</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">1st step, read the footer record and get footer information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Read the footer record and set it to <code>jobExecutionContext</code></p>
<div class="ulist">
<ul>
<li>
<p>Since the steps are different in storing and using footer information, store it in <code>jobExecutionContext</code>.</p>
</li>
<li>
<p>The use of <code>jobExecutionContext</code> is same as the <code>stepExecutionContext</code> explained in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>, execpt for the scope of Job and Step.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">2nd step, use the retrieved footer information</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Get the footer information from  <code>jobExecutionContext</code> and use it for processing of data part.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An example will be described in which footer information of the following file is taken out and used.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000
number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last 2 lines is footer record.</p>
</div>
<div class="paragraph">
<div class="title">Divide footer record by OS command</div>
<p>The setting to divide the above file into footer part and others by OS command is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Skipping by OS command</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Extract non-footer record from input file and save to output file.
head -n -2 input.txt &gt; input_data.txt

# Extract footer record from input file and save to output file.
tail -n 2 input.txt &gt; input_footer.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use head command, write footer part of input.txt to input_footer.txt, and others to input_data.txt.</p>
</div>
<div class="paragraph">
<p>Output file sample is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Output file example(input_data.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">000001,2016,1,0000000001,1000000000
000002,2017,2,0000000002,2000000000
000003,2018,3,0000000003,3000000000</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output file example(input_footer.txt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">number of items,3
total of amounts,6000000000</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Get/Use footer information</div>
<p>Explain how to get and use footer information from a footer record divided by OS command.<br></p>
</div>
<div class="paragraph">
<p>The step of reading the footer record is divided into the preprocessing and main processing.<br>
Refer to <a href="#Ch08_FlowControll">Flow Controll</a> for details of step dividing.</p>
</div>
<div class="paragraph">
<p>In the example below, a sample is shown in which footer information is retreived and stored in <code>jobExecutionContext</code>.<br>
Footer information can be used by retreiving it from <code>jobExecutionContext</code> like the same way described in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p>
</div>
<div class="listingblock">
<div class="title">Class to set information of data record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to set information of footer record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Define the Bean like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define <code>ItemReader</code> to read footer record</p>
</li>
<li>
<p>Define <code>ItemReader</code> to read data record</p>
</li>
<li>
<p>Define business logic to retreive footer record</p>
<div class="ulist">
<ul>
<li>
<p>In the sample below, it is done by implementing <code>Tasklet</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Define a job</p>
<div class="ulist">
<ul>
<li>
<p>Define a step with a preprocess to get footer information and a main process to read data records.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- ItemReader for reading footer records --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['footerInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- ItemReader for reading data records --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['dataInputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted other settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;!-- omitted settings --&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- Tasklet for reading footer records --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.ReadFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step01</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (4) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobReadAndWriteCsvWithFooter.step02</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">readFooterTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>ItemReader</code> to read a file with footer record.<br>
Used by injecting it to <code>readFooterTasklet</code> which is executed when retreiving footer information.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>ItemReader</code> to read a file with data record.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">preprocess step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a step to get the footer information.<br>
Implemented at <code>readFooterTasklet</code>. Implementation sample is written later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">main process step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A step of retreiving data information and using footer information is defined.<br>
Use <code>dataReader</code> for <code>reader</code>.<br>
In the sample, method to get footer information from <code>jobExecutionContext</code> such as <code>ItemProcessor</code> is not implemented.<br>
Footer information can be retreived and used the same way described in <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">listeners</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>readFooterTasklet</code>.<br>
Without this setting, <code>JobExecutionListener#beforeJob()</code> implemented in <code>readFooterTasklet</code> will not be executed.<br>
For details, refer to <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An example for reading a file with footer record and storing it to <code>jobExecutionContext</code>is shown below.</p>
</div>
<div class="paragraph">
<p>The way to make it as the implementation class of <code>Tasklet</code> is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inject the bean defined <code>footerReader</code> by name using <code>@Inject@</code> and <code>@Named</code></p>
</li>
<li>
<p>Set the footer information to <code>jobExecutionContext</code></p>
<div class="ulist">
<ul>
<li>
<p>The realization method is the same as <a href="#Ch05_FileAccess_HeaderFooter_Input_AccessHeaders">Retrieving header information</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Getting footer information</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ReadFooterTasklet</span> <span class="directive">implements</span> Tasklet {
    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">footerReader</span><span class="delimiter">&quot;</span></span>)
    ItemStreamReader&lt;SalesPlanDetailFooter&gt; itemReader;

    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

        <span class="comment">// (2)</span>
        itemReader.open(chunkContext.getStepContext().getStepExecution()
                .getExecutionContext());

        SalesPlanDetailFooter footer;
        <span class="keyword">while</span> ((footer = itemReader.read()) != <span class="predefined-constant">null</span>) {
            footers.add(footer);
        }

        <span class="comment">// (3)</span>
        jobExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>, footers);

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject the bean defined <code>footerReader</code> by name using <code>@Inject@</code> and <code>@Named</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>footerReader</code> to read the file with footer record and get the footer information.<br>
To use <code>ItemReader</code> bean defined in implementation class of <code>Tasklet</code>, refer to <a href="#Ch03_CreateTaskletJob_HowToUse_Implements">Creating a tasklet-oriented job</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>jobExecutionContext</code> from <code>JobExecution</code>, set the footer information to <code>jobExecutionContext</code> by key <code>footers</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_HeaderFooter_Output"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output"></a>5.3.2.4.2. Output</h6>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Output_Headers"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output_Headers"></a>Output header information</h7>
<div class="paragraph">
<p>To output header information to a flat file, implement as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>org.springframework.batch.item.file.FlatFileHeaderCallback</code></p>
</li>
<li>
<p>Set the implemented <code>FlatFileHeaderCallback</code> to property <code>headerCallback</code> of <code>FlatFileItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>By setting <code>headerCallback</code>, <code>FlatFileHeaderCallback#writeHeader()</code> will be executed at first when processing <code>FlatFileItemWriter</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implement <code>FlatFileHeaderCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FlatFileHeaderCallback</code> class and override <code>writeHeader</code>.</p>
</li>
<li>
<p>Write the header information using <code>Writer</code> from the argument.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sample implementation of <code>FlatFileHeaderCallback</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Sample implementation of FlatFileHeaderCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileHeaderCallback {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeHeader(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="comment">// (2)</span>
        writer.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">omitted</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FlatFileHeaderCallback</code> class and override writeHeader method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write the header information using <code>Writer</code> from the argument.<br>
Write method of <code>FlatFileItemWriter</code> will be executed right after the execution of <code>FlatFileHeaderCallback#writeHeader()</code>.<br>
Therefore, printing line break at the end of header information is not needed.
The line feed that is printed is the one set when <code>FlatFileItemWriter</code> bean was defined.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:lineSeparator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="entity">&amp;#x0A;</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FlatFileHeaderCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineSeparator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the record break(line feed code)<br></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>line.separator</code> of system&#8217;s property</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">When implementing FlatFileHeaderCallback, printing line feed at the end of header information is not necessary</div>
<div class="paragraph">
<p>Right after executing <code>FlatFileHeaderCallback#writeHeader()</code> in <code>FlatFileItemWriter</code>, line feed is printed according to the bean definition, so the line feed at the end of header information does not need to be printed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_HeaderFooter_Output_Footers"><a class="anchor" href="#Ch05_FileAccess_HeaderFooter_Output_Footers"></a>Output footer information</h7>
<div class="paragraph">
<p>To output footer information to a flat file, implement as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>org.springframework.batch.item.file.FlatFileFooterCallback</code></p>
</li>
<li>
<p>Set the implemented <code>FlatFileFooterCallback</code> to property <code>footerCallback</code> of <code>FlatFileItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>By setting <code>footerCallback</code>, <code>FlatFileHeaderCallback#writeFooter()</code> will be executed at first when processing <code>FlatFileItemWriter</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A method of outputting footer information with a flat file will be described.</p>
</div>
<div class="paragraph">
<p>Implement <code>FlatFileFooterCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Output footer information using <code>Writer</code> from the argument.</p>
</li>
<li>
<p>Implement <code>FlatFileFooterCallback</code> class and override <code>writeFooter</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is an implementation sample of <code>FlatFileFooterCallback</code> class for a Job to get footer information from <code>ExecutionContext</code> and write it out to a file.</p>
</div>
<div class="listingblock">
<div class="title">Class to set information of footer record</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailFooter</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">// omitted serialVersionUID</span>

    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> <span class="predefined-type">String</span> value;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of FlatFileFooterCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteFooterFlatFileFooterCallback</span> <span class="directive">implements</span> FlatFileFooterCallback {  <span class="comment">// (1)</span>
    <span class="directive">private</span> JobExecution jobExecution;

    <span class="annotation">@BeforeJob</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="local-variable">this</span>.jobExecution = jobExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> writeFooter(<span class="predefined-type">Writer</span> writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unchecked</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt; footers = (<span class="predefined-type">ArrayList</span>&lt;SalesPlanDetailFooter&gt;) <span class="local-variable">this</span>.jobExecution.getExecutionContext().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">footers</span><span class="delimiter">&quot;</span></span>);  <span class="comment">// (2)</span>

        <span class="predefined-type">BufferedWriter</span> bufferedWriter = <span class="keyword">new</span> <span class="predefined-type">BufferedWriter</span>(writer);  <span class="comment">// (3)</span>
        <span class="comment">// (4)</span>
        <span class="keyword">for</span> (SalesPlanDetailFooter footer : footers) {
            bufferedWriter.write(footer.getName() +<span class="string"><span class="delimiter">&quot;</span><span class="content"> is </span><span class="delimiter">&quot;</span></span> + footer.getValue());
            bufferedWriter.newLine();
            bufferedWriter.flush();
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FlatFileFooterCallback</code> class and override writeFooter method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get footer information form <code>ExecutionContext</code> of the Job using key <code>footers</code>.<br>
In the sample, it uses ArrayList to get several footer informations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In the sample, in order to use <code>BufferedWriter.newLine()</code> for printing line feed, it is using <code>Writer</code> from the argument as a parameter to generate <code>BufferedWriter</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the <code>Writer</code> of argument to print footer information.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterFlatFileFooterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>FlatFileFooterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_MultiFile"><a class="anchor" href="#Ch05_FileAccess_MultiFile"></a>5.3.2.5. Multiple Files</h5>
<div class="paragraph">
<p>Describe how to handle multiple files.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_MultiFile_Input"><a class="anchor" href="#Ch05_FileAccess_MultiFile_Input"></a>5.3.2.5.1. Input</h6>
<div class="paragraph">
<p>To read multiple files of the same record format, use <code>org.springframework.batch.item.file.MultiResourceItemReader</code>.<br>
<code> MultiResourceItemReader</code> can use the specified <code> ItemReader</code> to read multiple files specified by regular expressions.</p>
</div>
<div class="paragraph">
<p>Implement <code>MultiResourceItemReader</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define bean of <code>MultiResourceItemReader</code></p>
<div class="ulist">
<ul>
<li>
<p>Set file to read to property <code>resources</code></p>
<div class="ulist">
<ul>
<li>
<p>user regular expression to read multiple files</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set <code>ItemReader</code> to read files to property <code>delegate</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is a definition example of <code>MultiResourceItemReader</code> to read multiple files with the following file names.</p>
</div>
<div class="listingblock">
<div class="title">File to be read (file name)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">sales_plan_detail_01.csv
sales_plan_detail_02.csv
sales_plan_detail_03.csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:input/sales_plan_detail_*.csv</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set multiple input files with regular expressions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>ItemReader</code> where it has the actual file read implementation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemReader</code> with the actual file read implementation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since property <code>resource</code> is set automatically from <code>MultiResourceItemReader</code>, it is not necessary to set it in Bean definition.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">It is unnecessary to specify resource for ItemReader used by MultiResourceItemReader</div>
<div class="paragraph">
<p>Since <code>resource</code> of <code>ItemReader</code> delegated from <code>MultiResourceItemReader</code> is automatically set from <code>MultiResourceItemReader</code>, it is not necessary to set it in Bean definition.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_MultiFile_Output"><a class="anchor" href="#Ch05_FileAccess_MultiFile_Output"></a>5.3.2.5.2. Output</h6>
<div class="paragraph">
<p>Explain how to define multiple files.</p>
</div>
<div class="paragraph">
<p>To output to a different file for a certain number of cases, use <code>org.springframework.batch.item.file.MultiResourceItemWriter</code>.</p>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code> can output to multiple files for each number specified using the specified <code>ItemWriter</code>.<br>
It is necessary to make the output file name unique so as not to overlap, but <code>ResourceSuffixCreator</code> is provided as a mechanism for doing it.<br>
<code>ResourceSuffixCreator</code> is a class that generates a suffix that makes the file name unique.<br></p>
</div>
<div class="paragraph">
<p>For example, if you want to make the output target file a file name <code>outputDir / customer_list_01.csv</code> (<code>01</code> part is serial number), set it as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set <code>outputDir/customer_list_</code> to <code>MultiResourceItemWriter</code></p>
</li>
<li>
<p>Implement a code to generate suffix <code>01.csv</code>(<code>01</code> part is serial number) at <code>ResourceSuffixCreator</code></p>
<div class="ulist">
<ul>
<li>
<p>Serial numbers can use the value automatically incremented and passed from <code>MultiResourceItemWriter</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>outputDir/customer_list_01.csv</code> is set to the <code>ItemWriter</code> that is actually used</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>MultiResourceItemWriter</code> is defined as follows. How to implement <code>ResourceSuffixCreator</code> is described later.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define implementation class of <code>ResourceSuffixCreator</code></p>
</li>
<li>
<p>Define bean for <code>MultiResourceItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>Set output file to property <code>resources</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the file name up to the suffix given to implementation class of <code>ResourceSuffixCreator</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set implementation class of <code>ResourceSuffixCreator</code> that generates suffix to property <code>resourceSuffixCreator</code></p>
</li>
<li>
<p>Set <code>ItemWrite</code> which is to be used to read file to property <code>delegate</code></p>
</li>
<li>
<p>Set the number of output per file to property <code>itemCountLimitPerResource</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.MultiResourceItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputDir']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resourceSuffixCreator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:itemCountLimitPerResource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (5) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.module.CustomerListResourceSuffixCreator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (6) --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the state before adding the suffix of the output target file.<br>
A file name with suffix given automatically by <code>MultiResourceItemWriter</code> is set to <code>ItemWriter</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourceSuffixCreator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>ResourceSuffixCreator</code>.<br>
Default is <code>org.springframework.batch.item.file.SimpleResourceSuffixCreator</code> whice generates suffix <code>"." + index</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleResourceSuffixCreator</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a <code>ItemWriter</code> which actually reads the file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">itemCountLimitPerResource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the number of output per file.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Integer.MAX_VALUE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ItemWriter</code> which actually reads the file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since property <code>resource</code> is automatically set from <code>MultiResourceItemWriter</code>, it is not necessary to set it in Bean definition.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Setting of resource of ItemWrite used by MultiResourceItemWriter is not necessary</div>
<div class="paragraph">
<p>Since <code>Resource</code> of <code>ItemWriter</code> delegated from <code>MultiResourceItemWriter</code> is automatically set from <code>MultiResourceItemWriter</code>, it is not necessary to set it in the bean definition.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implement <code>ResourceSuffixCreator</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>ResourceSuffixCreator</code> and override getSuffix method</p>
</li>
<li>
<p>Use argument&#8217;s <code>index</code> and generate suffix to return</p>
<div class="ulist">
<ul>
<li>
<p><code>index</code> is an <code>int</code> type value with initial value <code>1</code>, and will be incremented for each output file</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Sample implementation of ResourceSuffixCreator</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerListResourceSuffixCreator</span> <span class="directive">implements</span> ResourceSuffixCreator {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSuffix(<span class="type">int</span> index) {
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%02d</span><span class="delimiter">&quot;</span></span>, index) + <span class="string"><span class="delimiter">&quot;</span><span class="content">.csv</span><span class="delimiter">&quot;</span></span>;  <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ResourceSuffixCreator</code> class and override getSuffix method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use argument&#8217;s <code>index</code> to generate suffix to return.
<code>index</code> is an <code>int</code> type value with initial value <code>1</code>, and will be incremented for each output file.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Output_ControlBreak"><a class="anchor" href="#Ch05_FileAccess_Output_ControlBreak"></a>5.3.2.6. Control Break</h5>
<div class="paragraph">
<p>How to actually do the Control Break will be described here.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">What is Control Break</dt>
<dd>
<p>Control Break process(or Key Break process) is a process method to read sorted records one by one,
and handle records with a certain item(key item) as one group.<br>
It is an algorithm that is used mainly for aggregating data,
continues counting while key items are the same value,
and outputs aggregate values when key items become different values.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In order to perform the control break processing, it is necessary to pre-read the record in order to judge the change of the group.
Pre-reading records can be done by using <code>org.springframework.batch.item.support.SingleItemPeekableItemReader</code>.<br>
Also, control break can be processed only in tasklet model.
This is because of the premise that the chunk model is based on, which are "processing N data rows defined by one line" and "transaction boundaries every fixed number of lines",
does not fit with the control break&#8217;s basic algorithm, "proceed at the turn of group".</p>
</div>
<div class="paragraph">
<p>The execution timing of control break processing and comparison conditions are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute control break before processing the target record</p>
<div class="ulist">
<ul>
<li>
<p>Keep the previously read record, compare previous record with current record</p>
</li>
</ul>
</div>
</li>
<li>
<p>Execute control break after processing the target record</p>
<div class="ulist">
<ul>
<li>
<p>Pre-read the next record by <code>SingleItemPeekableItemReader</code> and compare the current record with the next record</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A sample for outputting process result from input data using control break is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Input Data</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
02,2016,12,900
02,2016,12,1200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Process Result</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">Header Branch Id : 01,,,
01,2016,10,1000
01,2016,11,1500
01,2016,12,1300
Summary Branch Id : 01,,,3800
Header Branch Id : 02,,,
02,2016,12,900
02,2016,12,1200
Summary Branch Id : 02,,,2100</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of Control Break</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ControlBreakTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Inject</span>
    SingleItemPeekableItemReader&lt;SalesPerformanceDetail&gt; reader; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPerformanceDetail&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        SalesPerformanceDetail previousData = <span class="predefined-constant">null</span>;   <span class="comment">// (2)</span>
        <span class="predefined-type">BigDecimal</span> summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);  <span class="comment">//(3)</span>

        <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();   <span class="comment">// (4)</span>

        <span class="keyword">try</span> {
            reader.open(executionContext);
            writer.open(executionContext);

            <span class="keyword">while</span> (reader.peek() != <span class="predefined-constant">null</span>) {   <span class="comment">// (5)</span>
                SalesPerformanceDetail data = reader.read(); <span class="comment">// (6)</span>

                <span class="comment">// (7)</span>
                <span class="keyword">if</span> (isBreakByBranchId(previousData, data)) {
                    SalesPerformanceDetail beforeBreakData =
                            <span class="keyword">new</span> SalesPerformanceDetail();
                    beforeBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Header Branch Id : </span><span class="delimiter">&quot;</span></span>
                              + currentData.getBranchId());
                    items.add(beforeBreakData);
                }

                <span class="comment">// omitted.</span>
                items.add(data);  <span class="comment">// (8)</span>

                SalesPerformanceDetail nextData = reader.peek();  <span class="comment">// (9)</span>
                summary = summary.add(data.getAmount());

                <span class="comment">// (10)</span>
                SalesPerformanceDetail afterBreakData = <span class="predefined-constant">null</span>;
                <span class="keyword">if</span> (isBreakByBranchId(nextData, data)) {
                    afterBreakData = <span class="keyword">new</span> SalesPerformanceDetail();
                    afterBreakData.setBranchId(<span class="string"><span class="delimiter">&quot;</span><span class="content">Summary Branch Id : </span><span class="delimiter">&quot;</span></span>
                            + currentData.getBranchId());
                    afterBreakData.setAmount(summary);
                    items.add(afterBreakData);
                    summary = <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>);
                    writer.write(items);  <span class="comment">// (11)</span>
                    items.clear();
                }
                previousData = data;  <span class="comment">// (12)</span>
            }
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
            <span class="keyword">try</span> {
                writer.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
    <span class="comment">// (13)</span>
    <span class="directive">private</span> <span class="type">boolean</span> isBreakByBranchId(SalesPerformanceDetail o1,
            SalesPerformanceDetail o2) {
        <span class="keyword">return</span> (o1 == <span class="predefined-constant">null</span> || !o1.getBranchId().equals(o2.getBranchId()));
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject <code>SingleItemPeekableItemReader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set the previously read record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set aggregated values for each group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable to set records for each group including the control break&#8217;s process result</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repeat the process until there is no input data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read the record to be processed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute a control break before target record processing.<br>
In the sample, if it is at the beginning of the group, heading is set stored it the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the process result to the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pre-read the next record.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute a control break after target record processing.
In this case, if it is at the end of the group, the aggregated data is set in the trailer and stored in the variable defined in (4).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Output processing results for each group.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the processing record in the variable defined in (2).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge whether the key item has switched or not.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.SingleItemPeekableItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:delegate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>

<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegateReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define bean for <code>SingleItemPeekableItemReader</code>. It will be injected to the Tasklet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the bean of ItemReader that actually reads the file to <code>delegate</code> property.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a bean for ItemReader that actually read the file.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_FileAccess_HowToExtend"><a class="anchor" href="#Ch05_FileAccess_HowToExtend"></a>5.3.3. How To Extend</h4>
<div class="paragraph">
<p>Here, an explanation will be written based on the below case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_FileAccess_FieldSetMapper">Implmementation of FieldSetMapper</a></p>
</li>
<li>
<p>Input/Output of <a href="#Ch05_FileAccess_Xml">XML File</a></p>
</li>
<li>
<p>Input/Output of <a href="#Ch05_FileAccess_MultiFormat">Multi format</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_FieldSetMapper"><a class="anchor" href="#Ch05_FileAccess_FieldSetMapper"></a>5.3.3.1. Implmementation of FieldSetMapper</h5>
<div class="paragraph">
<p>Explain how to implement <code>FieldSetMapper</code> yourself.</p>
</div>
<div class="paragraph">
<p>Implement <code>FieldSetMapper</code> class as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>FieldSetMapper</code> class and override mapFieldSet method.</p>
</li>
<li>
<p>Get the value from argument&#8217;s <code>FieldSet</code>, do any process needed, and then set it to the conversion target bean as a return value</p>
<div class="ulist">
<ul>
<li>
<p>The <code>FieldSet</code> class is a class that holds data in association with an index or name, as in the JDBC <code>ResultSet</code> class</p>
</li>
<li>
<p>The <code>FieldSet</code> class holds the value of each field of a record divided by <code>LineTokenizer</code></p>
</li>
<li>
<p>You can store and retrieve values by specifying an index or name</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is sample implementation for reading a file that includes data that needs to be converted, such as BigDecimal type with comma and Date type of Japanese calendar format.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">&quot;000001&quot;,&quot;平成28年1月1日&quot;,&quot;000000001&quot;,&quot;1,000,000,000&quot;
&quot;000002&quot;,&quot;平成29年2月2日&quot;,&quot;000000002&quot;,&quot;2,000,000,000&quot;
&quot;000003&quot;,&quot;平成30年3月3日&quot;,&quot;000000003&quot;,&quot;3,000,000,000&quot;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Input file specification</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 35%;">
<col style="width: 35%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Field Name</th>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">branchId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese calendar format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">customerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">include comma</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetail</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="predefined-type">Date</span> date;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of FieldSetMapper</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UseDateSalesPlanDetailFieldSetMapper</span> <span class="directive">implements</span> FieldSetMapper&lt;UseDateSalesPlanDetail&gt; {  <span class="comment">// (1)</span>
    <span class="comment">/**
     * {@inheritDoc}
     *
     * @param fieldSet {@inheritDoc}
     * @return Sales performance detail.
     * @throws BindException {@inheritDoc}
     */</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> UseDateSalesPlanDetail mapFieldSet(FieldSet fieldSet) <span class="directive">throws</span> <span class="exception">BindException</span> {
        UseDateSalesPlanDetail item = <span class="keyword">new</span> UseDateSalesPlanDetail();  <span class="comment">// (2)</span>

        item.setBranchId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (3)</span>

        <span class="comment">// (4)</span>
        <span class="predefined-type">DateFormat</span> japaneseFormat = <span class="keyword">new</span> <span class="predefined-type">SimpleDateFormat</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">GGGGy年M月d日</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Locale</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ja</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JP</span><span class="delimiter">&quot;</span></span>));
        <span class="keyword">try</span> {
            item.setDate(japaneseFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">date</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="comment">// (5)</span>
        item.setCustomerId(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>));

        <span class="comment">// (6)</span>
        <span class="predefined-type">DecimalFormat</span> decimalFormat = <span class="keyword">new</span> <span class="predefined-type">DecimalFormat</span>();
        decimalFormat.setParseBigDecimal(<span class="predefined-constant">true</span>);
        <span class="keyword">try</span> {
            item.setAmount((<span class="predefined-type">BigDecimal</span>) decimalFormat.parse(fieldSet.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">amount</span><span class="delimiter">&quot;</span></span>)));
        } <span class="keyword">catch</span> (<span class="exception">ParseException</span> e) {
            <span class="comment">// omitted exception handling</span>
        }

        <span class="keyword">return</span> item;  <span class="comment">// (7)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>FieldSetMapper</code> class and override mapFieldSet method.
Set conversion target class for type argument of <code>FieldSetMapper</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a variable of conversion target class to store converted data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>branchId</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Conversion for <code>branchId</code> is not done in the sample since it is not necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>date</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Use <code>SimpleDateFormat</code> to convert Japanese calendar format date to Date type value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>customerId</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Conversion for <code>customerId</code> is not done in the sample since it is not necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get <code>amount</code> from argument&#8217;s <code>FieldSet</code>, and store it to conversion target class variable.<br>
Use <code>DecimalFormat</code> to convert value with comma to BigDecimal type value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return the conversion target class holding the processing result.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Getting value from FieldSet class</div>
<div class="paragraph">
<p>The <code>FieldSet</code> class has methods corresponding to various data types for obtaining stored values such as listed below.<br>
When generating <code>FieldSet</code> if data is stored in association with the field name, it is possible to get data by specifying that name or by specifying the index.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>readString()</code></p>
</li>
<li>
<p><code>readInt()</code></p>
</li>
<li>
<p><code>readBigDecimal()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>etc</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_Xml"><a class="anchor" href="#Ch05_FileAccess_Xml"></a>5.3.3.2. XML File</h5>
<div class="paragraph">
<p>Describe the definition method when dealing with XML files.</p>
</div>
<div class="paragraph">
<p>For the conversion process between Bean and XML (O / X (Object / XML) mapping), use the library provided by Spring Framework.<br>
Implementation classes are provided as <code> Marshaller</code> and <code> Unmarshaller</code> using XStream, JAXB, etc. as libraries for converting between XML files and objects.<br>
Use one suitable for your situation.</p>
</div>
<div class="paragraph">
<p>Below are features and points for adopting JAXB and XStream.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">JAXB</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Specify the bean to be converted in the bean definition file</p>
</li>
<li>
<p>Validation using a schema file can be performed</p>
</li>
<li>
<p>It is useful when the schema is defined externally and the specification of the input file is strictly determined</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">XStream</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>You can map XML elements and bean fields flexibly in the bean definition file</p>
</li>
<li>
<p>It is useful when you need to flexibly map beans</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here is a sample using JAXB.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_Xml_Input"><a class="anchor" href="#Ch05_FileAccess_Xml_Input"></a>5.3.3.2.1. Input</h6>
<div class="paragraph">
<p>For inputting XML file, use <code>org.springframework.batch.item.xml.StaxEventItemReader</code> provided by Spring Batch.<br>
<code>StaxEventItemReader</code> can read the XML file by mapping the XML file to the bean using the specified <code>Unmarshaller</code>.</p>
</div>
<div class="paragraph">
<p>Implement <code>StaxEventItemReader</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>@XmlRootElement</code> to the conversion target class of XML root element</p>
</li>
<li>
<p>Set below property to <code>StaxEventItemReader</code></p>
<div class="ulist">
<ul>
<li>
<p>Set the file to read to property <code>resource</code></p>
</li>
<li>
<p>Set the name of the root element to property <code>fragmentRootElementName</code></p>
</li>
<li>
<p>Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> to property <code>unmarshaller</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below property to <code>Jaxb2Marshaller</code></p>
<div class="ulist">
<ul>
<li>
<p>Set conversion target classs in list format to property <code>classesToBeBound</code></p>
</li>
<li>
<p>To validate using schema file, set the 2 properties as below</p>
<div class="ulist">
<ul>
<li>
<p>Set the schema file for validation to property <code>schema</code></p>
</li>
<li>
<p>Set implementation class of <code>ValidationEventHandler</code> to property <code>validationEventHandler</code> to handle events occured during the validation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the sample setting to read the input file below.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000001<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2016<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>1<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000001<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>1000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000002<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2017<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>2<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000002<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>2000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
    <span class="tag">&lt;SalesPlanDetail&gt;</span>
        <span class="tag">&lt;branchId&gt;</span>000003<span class="tag">&lt;/branchId&gt;</span>
        <span class="tag">&lt;year&gt;</span>2018<span class="tag">&lt;/year&gt;</span>
        <span class="tag">&lt;month&gt;</span>3<span class="tag">&lt;/month&gt;</span>
        <span class="tag">&lt;customerId&gt;</span>0000000003<span class="tag">&lt;/customerId&gt;</span>
        <span class="tag">&lt;amount&gt;</span>3000000000<span class="tag">&lt;/amount&gt;</span>
    <span class="tag">&lt;/SalesPlanDetail&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlRootElement</code> annotation to make this as the root tag of XML.<br>
Set <code>SalesPlanDetail</code> for the tag name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:fragmentRootElementName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SalesPlanDetail</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unmarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="comment">&lt;!-- (5) (6) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:schema</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:files/test/input/ch05/fileaccess/SalesPlanDetail.xsd</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:validationEventHandler-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesPlanDetailValidationEventHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the input file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fragmentRootElementName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the name of the root element.<br>
If there are several target objects, use <code>fragmentRootElementNames</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">strict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true is set, an exception occurs if the input file does not exist(can not be opened).</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unmarshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the unmarshaller.<br>
Set Bean of <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> when using JAXB.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set shema file for validation.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validationEventHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>ValidationEventHandler</code> to handle events occured during the validation.<br>
Sample implementation of <code>ValidationEventHandler</code> is described later on.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set conversion target classes in list format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">Sample implementation of ValidationEventHandler</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="comment">// (1)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailValidationEventHandler</span> <span class="directive">implements</span> ValidationEventHandler {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPlanDetailValidationEventHandler.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleEvent(ValidationEvent event) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">[EVENT [SEVERITY:{}] [MESSAGE:{}] [LINKED EXCEPTION:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [LOCATOR: [LINE NUMBER:{}] [COLUMN NUMBER:{}] [OFFSET:{}]</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content"> [OBJECT:{}] [NODE:{}] [URL:{}] ] ]</span><span class="delimiter">&quot;</span></span>,
                event.getSeverity(),
                event.getMessage(),
                event.getLinkedException(),
                event.getLocator().getLineNumber(),
                event.getLocator().getColumnNumber(),
                event.getLocator().getOffset(),
                event.getLocator().getObject(),
                event.getLocator().getNode(),
                event.getLocator().getURL());
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;  <span class="comment">// (3)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ValidationEventHandler</code> class and override handleEvent method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get event information from argument&#8217;s event(<code>ValidationEvent</code>), and do any process needed.<br>
In the sample, logging is proceeded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return false to end the search process.
Return true to continue the search process.<br>
Return false to end this operation by generating appropriate <code>UnmarshalException</code>, <code>ValidationException</code> or <code>MarshalException</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Adding dependency library</div>
<div class="paragraph">
<p>Library dependency needs to be added as below when using
Spring Object/Xml Marshalling provided by Spring Framework
such as <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_Xml_Output"><a class="anchor" href="#Ch05_FileAccess_Xml_Output"></a>5.3.3.2.2. Output</h6>
<div class="paragraph">
<p>Use <code>org.springframework.batch.item.xml.StaxEventItemWriter</code> provided by Spring Batch for outputting XML file.<br>
<code>StaxEventItemWriter</code> can output an XML file by mapping the bean to XML using the specified <code>Marshaller</code>.</p>
</div>
<div class="paragraph">
<p>Implement <code>StaxEventItemWriter</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do the below setting to conversion target class</p>
<div class="ulist">
<ul>
<li>
<p>Add <code>@XmlRootElement</code> to the class as it is to be the root element of the XML</p>
</li>
<li>
<p>Use <code>@XmlType</code> annotation to set orders for outputting fields</p>
</li>
<li>
<p>If there is a field to be excluded from conversion to XML, add <code>@XmlTransient</code> to the getter method of it&#8217;s field</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below properties to <code>StaxEventItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>Set output target file to property <code>resource</code></p>
</li>
<li>
<p>Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> to property <code>marshaller</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Set below property to <code>Jaxb2Marshaller</code></p>
<div class="ulist">
<ul>
<li>
<p>Set conversion target classes in list format to property <code>classesToBeBound</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a sample for outputting below file.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div id="Ch05_FileAccess_Xml_Output_format" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About XML file fomatX(line break and indents)</div>
<div class="paragraph">
<p>In the sample above, the output XML file has been formatted(has line break and indents), but the actual XML will not be formatted.</p>
</div>
<div class="paragraph">
<p><code>Jaxb2Marshaller</code> has a function to format it when outputting the XML file, but it does not work as is it expected.<br>
This issue is being discussed in the Spring Forum, and might be fixed in the future.</p>
</div>
<div class="paragraph">
<p>To avoid this and output the formatted XML, set <code>marshallerProperties</code> as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted settings --&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshallerProperties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;map&gt;</span>
                <span class="tag">&lt;entry&gt;</span>
                    <span class="tag">&lt;key&gt;</span>
                        <span class="tag">&lt;util:constant</span>
                            <span class="attribute-name">static-field</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.xml.bind.Marshaller.JAXB_FORMATTED_OUTPUT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/key&gt;</span>
                    <span class="tag">&lt;value</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Boolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>true<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/entry&gt;</span>
            <span class="tag">&lt;/map&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/property&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@XmlRootElement</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Customer</span><span class="delimiter">&quot;</span></span>)  <span class="comment">// (2)</span>
<span class="annotation">@XmlType</span>(propOrder={<span class="string"><span class="delimiter">&quot;</span><span class="content">customerId</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customerAddress</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">customerTel</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">chargeBranchId</span><span class="delimiter">&quot;</span></span>})  <span class="comment">// (2)</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomerToJaxb</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerName;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerAddress;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerTel;
    <span class="directive">private</span> <span class="predefined-type">String</span> chargeBranchId;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> createDate;
    <span class="directive">private</span> <span class="predefined-type">Timestamp</span> updateDate;

    <span class="comment">// omitted getter/setter</span>

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getCreateDate() { <span class="keyword">return</span> createDate; }

    <span class="annotation">@XmlTransient</span>  <span class="comment">// (3)</span>
    <span class="directive">public</span> <span class="predefined-type">Timestamp</span> getUpdateDate() { <span class="keyword">return</span> updateDate; }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlRootElement</code> annotation to make this as the root tag of XML.<br>
Set <code>Customer</code> for the tag name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>@XmlType</code> annotation to set field output order.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>@XmlTransient</code> to getter method of fileds which is to be excluded from XML conversion.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The settings for writing the above file are as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) (3) (4) (5) (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MS932</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:rootTagName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">records</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:overwriteOutput</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:shouldDeleteIfEmpty</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:transactional</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (7) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.oxm.jaxb.Jaxb2Marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classesToBeBound</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (8) --&gt;</span>
                <span class="tag">&lt;list&gt;</span>
                    <span class="tag">&lt;value&gt;</span>org.terasoluna.batch.functionaltest.ch05.fileaccess.model.mst.CustomerToJaxb<span class="tag">&lt;/value&gt;</span>
                <span class="tag">&lt;/list&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set output file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set character encoding for output file<br>
<span class="icon"><i class="fa fa-warning"></i></span> Default value of character code for the component offered by Spring Batch varies for ItemReader and ItemWriter (Default value of ItemReader is "Default character set of JavaVM").<br>
Hence, it is recommended to explicitly set character code even while using default value.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UTF-8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rootTagName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set XML root tag name.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">overwriteOutput</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file if it already exists.<br>
If false, throw an exception if the file already exists.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shouldDeleteIfEmpty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, delete the file for output if output count is 0.<br>
<span class="icon"><i class="fa fa-warning"></i></span> Since unintended behaviour is likely to happen by combining with other properties, it is recommended not to set it to true. For details, refer <a href="#Ch05_FileAccess_VariableLength_Output_about-shouldDeleteIfEmpty">Notes for how to output variable length record</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transactional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to perform transaction control. For details, see <a href="#Ch05_Transaction">Transaction Control</a>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">marshaller</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the marshaller.
Set <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code> when using JAXB.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">classesToBeBound</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set conversion target classes in list format.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Adding dependency library</div>
<div class="paragraph">
<p>Library dependency needs to be added as below when using
Spring Object/Xml Marshalling provided by Spring Framework
such as <code>org.springframework.oxm.jaxb.Jaxb2Marshaller</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.springframework<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>spring-oxm<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect6">
<h7 id="Ch05_FileAccess_XML_HeaderFooter"><a class="anchor" href="#Ch05_FileAccess_XML_HeaderFooter"></a>Output Header / Footer</h7>
<div class="paragraph">
<p>For output of header and footer, use the implementation class of <code>org.springframework.batch.item.xml.StaxWriterCallback</code>.</p>
</div>
<div class="paragraph">
<p>Set implementation of <code>headerCallback</code> for header output, and <code>footerCallback</code> for footer output.</p>
</div>
<div class="paragraph">
<p>Below is a sample of output file.<br>
Header is printed right after the root tag&#8217;s openning element, and footer is printed right before the root element&#8217;s closing tag.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;records&gt;</span>
<span class="comment">&lt;!-- Customer list header --&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>001<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName001<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress001<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>001<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>002<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName002<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress002<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>002<span class="tag">&lt;/chargeBranchId&gt;</span><span class="tag">&lt;/Customer&gt;</span>
  <span class="tag">&lt;Customer&gt;</span>
    <span class="tag">&lt;customerId&gt;</span>003<span class="tag">&lt;/customerId&gt;</span>
    <span class="tag">&lt;customerName&gt;</span>CustomerName003<span class="tag">&lt;/customerName&gt;</span>
    <span class="tag">&lt;customerAddress&gt;</span>CustomerAddress003<span class="tag">&lt;/customerAddress&gt;</span>
    <span class="tag">&lt;customerTel&gt;</span>11111111111<span class="tag">&lt;/customerTel&gt;</span>
    <span class="tag">&lt;chargeBranchId&gt;</span>003<span class="tag">&lt;/chargeBranchId&gt;</span>
  <span class="tag">&lt;/Customer&gt;</span>
<span class="comment">&lt;!-- Customer list footer --&gt;</span>
<span class="tag">&lt;/records&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">About XML file fomatX(line break and indents)</div>
<div class="paragraph">
<p>In the sample above, the output XML file has been formatted(has line break and indents), but the actual XML will not be formatted.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="#Ch05_FileAccess_Xml_Output_format">About XML file fomatX(line break and indents)</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To output the above file, do the setting as below.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.xml.StaxEventItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:headerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeHeaderStaxWriterCallback</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:footerCallback-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writeFooterStaxWriterCallback</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">marshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted settings --&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">headerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StaxWriterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">footerCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set implementation class of <code>StaxWriterCallback</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implement <code>StaxWriterCallback</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>StaxWriterCallback</code> class and override write method</p>
</li>
<li>
<p>Print header/footer by using the argument&#8217;s <code>XMLEventWriter</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of StaxWriterCallback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">WriteHeaderStaxWriterCallback</span> <span class="directive">implements</span> StaxWriterCallback { <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> write(XMLEventWriter writer) <span class="directive">throws</span> <span class="exception">IOException</span> {
        XMLEventFactory factory = XMLEventFactory.newInstance();
        <span class="keyword">try</span> {
            writer.add(factory.createComment(<span class="string"><span class="delimiter">&quot;</span><span class="content"> Customer list header </span><span class="delimiter">&quot;</span></span>)); <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (XMLStreamException e) {
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>StaxWriterCallback</code> class and override write method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print header/footer by using the argument&#8217;s <code>XMLEventWriter</code><br></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">XML output using XMLEventFactory</div>
<div class="paragraph">
<p>In the output of the XML file using the <code>XMLEventWriter</code> class, you can efficiently generate <code>XMLEvent</code> by using the <code>XMLEventFactory</code> class.</p>
</div>
<div class="paragraph">
<p>The <code>XMLEventWriter</code> class has an add method defined, which takes an XMLEvent object as an argument and outputs an XML file.<br>
Since it is very time consuming to generate an <code>XMLEvent</code> object each time, use the <code>XMLEventFactory</code> class which can easily generate <code>XMLEvent</code>.<br>
In the <code>XMLEventFactory</code> class, methods corresponding to the event to be created are defined, such as <code>createStartDocument</code> method and <code>createStartElement</code> method.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_FileAccess_MultiFormat"><a class="anchor" href="#Ch05_FileAccess_MultiFormat"></a>5.3.3.3. Multi format</h5>
<div class="paragraph">
<p>Describe the definition method when dealing with multi format file.</p>
</div>
<div class="paragraph">
<p>As described in <a href="#Ch05_FileAccess_Overview">Overview</a>, multi format is basically (Header N Rows + Data N Rows + Trailer N Rows) * N + Footer N Rows format, but there are other format patterns like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When there is a footer record or not</p>
</li>
<li>
<p>When there are records with different formats in the same record classification</p>
<div class="ulist">
<ul>
<li>
<p>eg) there is a data record that has 5 items and a data record with 6 items in data part</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although there are several patterns to multi format file, implementation method will be the same.</p>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_MultiLine_Input"><a class="anchor" href="#Ch05_FileAccess_MultiLine_Input"></a>5.3.3.3.1. Input</h6>
<div class="paragraph">
<p>Use <code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code> provided by Spring Batch for readeing multi format file.<br>
In multi format file, each record needs to be mapped to defferent bean for each format.<br>
<code>PatternMatchingCompositeLineMapper</code> will select the <code>LineTokenizer</code> and <code>FieldSetMapper</code> to use for the record by regular expression.</p>
</div>
<div class="paragraph">
<p>For example, <code>LineTokenizers</code> to use can be selected like below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>userTokenizer</code> if the beginning of the record matches to regular expression <code>USER*</code></p>
</li>
<li>
<p>Use <code>lineATokenizer</code> if the beginning of the record matches to regular expression <code>LINEA*</code></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Restrictions on the format of records when reading multi-format files</div>
<div class="paragraph">
<p>In order to read a multi-format file, it must be in a format that can distinguish record classification by regular expression.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implement <code>PatternMatchingCompositeLineMapper</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define a class with record division for conversino target class, and inherit this class to each classes of each record division</p>
</li>
<li>
<p>Define <code>LineTokenizer</code> and <code>FieldSetMapper</code> to map each record to bean</p>
</li>
<li>
<p>Define <code>PatternMatchingCompositeLineMapper</code></p>
<div class="ulist">
<ul>
<li>
<p>Set <code>LineTokenizer</code> that correspond to each record division to property <code>tokenizers</code></p>
</li>
<li>
<p>Set <code>FieldSetMapper</code> that correspond to each record division to property <code>fieldSetMappers</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Define a class with record division for conversino target class, and inherit this class to each classes of each record division</div>
<div class="paragraph">
<p><code>ItemProcessor</code> has a specification that takes one type as an argument.</p>
</div>
<div class="paragraph">
<p>However, if you simply map <code>PatternMatchingCompositeLineMapper</code> to a multi-format file to a different bean for each record division, <code>ItemProcessor</code> can not handle multiple types as it takes one type as an argument.</p>
</div>
<div class="paragraph">
<p>Therefore, it is possible to solve this by giving an inheritance relation to the class to be converted and specifying a superclass as the type of the argument of <code>ItemProcessor</code>.</p>
</div>
<div class="paragraph">
<p>The class diagram of the conversion target class and the definition sample of <code>ItemProcessor</code> are shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_FileAccess_Conversion_target_class_with_inheritance_relationship.png" alt="Conversion target class definition when loading multiple formats">
</div>
<div class="title">Class diagram of conversion target class</div>
</div>
<div class="listingblock">
<div class="title">Implementation Sample of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="comment">// (1)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (2)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (3)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="comment">// omitted business logic</span>
        <span class="keyword">default</span>:
            <span class="comment">// omitted exception handling</span>
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the superclass of the class to be converted whose inheritance relation is given as the argument of <code>ItemProcessor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the record division from item.<br>
Actual classes are different depending on each record division, but record divison can be retrieved by polymorphism.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge the record division and process things needed for each record division.<br>
Perform class conversions as needed.</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a setting sample and implementation sample for reading below input file.</p>
</div>
<div class="listingblock">
<div class="title">Input File Sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is the bean definition sample of conversion target class.</p>
</div>
<div class="listingblock">
<div class="title">Class to be converted</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">/**
 * Model of record indicator of sales plan detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailMultiLayoutRecord</span> {

    <span class="directive">protected</span> <span class="predefined-type">String</span> record;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of sales plan detail header.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailHeader</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> description;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailData</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> year;
    <span class="directive">private</span> <span class="type">int</span> month;
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailTrailer</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {

    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;
    <span class="directive">private</span> <span class="type">int</span> number;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}

<span class="comment">/**
 * Model of Sales plan Detail.
 */</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPlanDetailEnd</span> <span class="directive">extends</span> SalesPlanDetailMultiLayoutRecord {
    <span class="comment">// omitted getter/setter</span>

    <span class="directive">private</span> <span class="type">int</span> headNum;
    <span class="directive">private</span> <span class="type">int</span> trailerNum;
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> total;

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting for reading the above file is as follows.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailHeader</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailData</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailTrailer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.fileaccess.model.plan.SalesPlanDetailEnd</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">tokenizers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (4) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMappers</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (5) --&gt;</span>
                <span class="tag">&lt;map&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">H*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">D*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">T*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">E*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endBeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/map&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>LineTokenizer</code> corresponding to each record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>LineTokenizer</code> that corresponds to each record.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>FieldSetMapper</code> corresponding to each record</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>FieldSetMapper</code> that corresponds to each record.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineMapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.mapping.PatternMatchingCompositeLineMapper</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>LineTokenizer</code> corresponding to each record in map format.<br>
Set regular expression to determine record for <code>key</code>, and set the <code>LineTokenizer</code> to use for <code>value-ref</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenizers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>FieldSetMapper</code> corresponding to each record in map format.<br>
Set regular expression to determine record for <code>key</code>, and set the <code>FieldSetMapper</code> to use for <code>value-ref</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_FileAccess_MultiLine_Output"><a class="anchor" href="#Ch05_FileAccess_MultiLine_Output"></a>5.3.3.3.2. Output</h6>
<div class="paragraph">
<p>Describe the definition method when dealing with multi format file.</p>
</div>
<div class="paragraph">
<p>For reading multi format file <code>PatternMatchingCompositeLineMapper</code> was provided to determine which <code>LineTokenizer</code> and <code>FieldSetMapper</code> to use for each record division.<br>
However for writing, no similar components are provided.<br></p>
</div>
<div class="paragraph">
<p>Therefore, processing up to conversion target class to record (character string) within <code>ItemProcessor</code> is carried out, and <code>ItemWriter</code> writes the received character string as it is to achieve writing of multi format file .</p>
</div>
<div class="paragraph">
<p>Implement multi format output as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessor</code> converts the conversion target class to a record (character string) and passes it to <code>ItemWriter</code></p>
<div class="ulist">
<ul>
<li>
<p>In the sample, define <code>LineAggregator</code> and <code>FieldExtractor</code> for each record division and use it by injecting it with <code>ItemProcessor</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ItemWriter</code> writes the received character string as it is to the file</p>
<div class="ulist">
<ul>
<li>
<p>Set <code>PassThroughLineAggregator</code> to property <code>lineAggregator</code> of <code>ItemWriter</code></p>
</li>
<li>
<p><code>PassThroughLineAggregator</code> is <code>LineAggregator</code> which returns <code>item.toString ()</code> result of received item</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a setting sample and implementation sample for writing below output file.</p>
</div>
<div class="listingblock">
<div class="title">Output file example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">H,Sales_plan_detail header No.1
D,000001,2016,1,0000000001,100000000
D,000001,2016,1,0000000002,200000000
D,000001,2016,1,0000000003,300000000
T,000001,3,600000000
H,Sales_plan_detail header No.2
D,00002,2016,1,0000000004,400000000
D,00002,2016,1,0000000005,500000000
D,00002,2016,1,0000000006,600000000
T,00002,3,1500000000
H,Sales_plan_detail header No.3
D,00003,2016,1,0000000007,700000000
D,00003,2016,1,0000000008,800000000
D,00003,2016,1,0000000009,900000000
T,00003,3,2400000000
E,3,9,4500000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Definition of conversion target class and <code>ItemProcessor</code> sample, notes are the same as <a href="#Ch05_FileAccess_MultiLine_Input">Multi format Input</a>.</p>
</div>
<div class="paragraph">
<p>Settings to output above file is as below.
Bean definition sample for <code>ItemProcessor</code> is written later.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,description</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,branchId,number,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">record,headNum,trailerNum,total</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.PassThroughLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 20%;">
<col style="width: 45%;">
<col style="width: 10%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Property Name</th>
<th class="tableblock halign-left valign-top">Setting contents</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>LineAggregator</code> and <code>FieldExtractor</code> corresponding to each record division</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>LineAggregator</code> and <code>FieldExtractor</code>.<br>
Use <code>LineAggregator</code> by injecting it to <code>ItemProcessor</code>.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lineAggregator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>org.springframework.batch.item.file.transform.PassThroughLineAggregator</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="icon"><i class="fa fa-check"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implementation sample of <code>ItemProcessor</code> is shown below.<br>
In this sample, only the process of converting the received item to a string and passing it to <code>ItemWriter</code> is performed.</p>
</div>
<div class="listingblock">
<div class="title">Sample Implementation of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MultiLayoutItemProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPlanDetailMultiLayoutRecord, <span class="predefined-type">String</span>&gt; {

    <span class="comment">// (1)</span>
    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">headerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; headerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; dataDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">trailerDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; trailerDelimitedLineAggregator;

    <span class="annotation">@Inject</span>
    <span class="annotation">@Named</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">endDelimitedLineAggregator</span><span class="delimiter">&quot;</span></span>)
    DelimitedLineAggregator&lt;SalesPlanDetailMultiLayoutRecord&gt; endDelimitedLineAggregator;

    <span class="annotation">@Override</span>
    <span class="comment">// (2)</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(SalesPlanDetailMultiLayoutRecord item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="predefined-type">String</span> record = item.getRecord();  <span class="comment">// (3)</span>

        <span class="keyword">switch</span> (record) {  <span class="comment">// (4)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">H</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> headerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">D</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> dataDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">T</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> trailerDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">E</span><span class="delimiter">&quot;</span></span>:
            <span class="keyword">return</span> endDelimitedLineAggregator.aggregate(item);  <span class="comment">// (5)</span>
        <span class="keyword">default</span>:
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectRecordClassificationException(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Record classification is incorrect.[value:</span><span class="delimiter">&quot;</span></span> + record + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Item list of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">No</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject <code>LineAggregator</code> corresponding to each record division.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the superclass of the class to be converted whose inheritance relation is given as the argument of <code>ItemProcessor</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the record division from item.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Judge record division and do any process for each record division.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>LineAggregator</code> corresponding to each record division to convert the conversion target class to a record (character string) and pass it to <code>ItemWriter</code>.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch05_ExclusiveControl"><a class="anchor" href="#Ch05_ExclusiveControl"></a>5.4. Exclusive Control</h3>
<div class="sect3">
<h4 id="Ch05_ExclusiveControl_Overview"><a class="anchor" href="#Ch05_ExclusiveControl_Overview"></a>5.4.1. Overview</h4>
<div class="paragraph">
<p>Exclusive control is a process performed to maintain consistency of data when update processing is performed simultaneously for the same resource from multiple transactions.
In the case where there is a possibility that updating processing is performed simultaneously for the same resource from multiple transactions, it is basically necessary to perform exclusive control.</p>
</div>
<div class="paragraph">
<p>Multiple transaction means following in this chapter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Transaction at the time of simultaneous execution of multiple jobs</p>
</li>
<li>
<p>Transaction at the time of simultaneous execution with online processing</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Exclusive control of multiple jobs</div>
<div class="paragraph">
<p>When multiple jobs are executed at the same time, it is fundamental to design jobs so that exclusive control is not required.
This means that it is basic to divide the resources to be accessed and the processing target for each job.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the concept of exclusive control is the same as online processing,
please refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html">Exclusive Control</a> in TERASOLUNA Server 5.x Development Guideline</p>
</div>
<div class="paragraph">
<p>Here, focus on the part not described in TERASOLUNA Server 5.x.</p>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Necessity"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Necessity"></a>5.4.1.1. Necessity of Exclusive Control</h5>
<div class="paragraph">
<p>For the necessity of exclusive control,
please refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#exclusioncontrol-necessity">Necessity of Exclusive Control</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_File"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_File"></a>5.4.1.2. Exclusive Control for File</h5>
<div class="paragraph">
<p>Exclusive control for file is generally implemented by file locking.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">File Locking</dt>
<dd>
<p>File locking is a mechanism for restricting reading and writing from other programs while using files with a certain program.
The outline of file lock processing is as follows.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Scenario</div>
<ul>
<li>
<p>The batch process A acquires the lock of the file and starts the file updating process.</p>
</li>
<li>
<p>Batch process B attempts to update the same file and attempts to acquire the file lock fails.</p>
</li>
<li>
<p>The batch process A ends the processing and unlocks the file</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch05_ExclusiveControl_File_Senario.png" alt="ExclusiveControl_File_Senario">
</div>
<div class="title">Overview of File Lock Processing</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Batch Process A tries to acquire the lock of the Target File.</p>
</li>
<li>
<p>The Batch Process A succeeds in acquiring the lock of the Target File.</p>
</li>
<li>
<p>The Batch Process B tries to acquire the lock of the Target File.</p>
</li>
<li>
<p>The Batch Process A writes the Target File.</p>
</li>
<li>
<p>Since the Batch Process A is locked the Target File, the Batch Process B fails to acquire the lock of the Target File.</p>
</li>
<li>
<p>The Batch Process B performs processing of file update failure.</p>
</li>
<li>
<p>The Batch Process A releases the lock of the Target File.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Prevention of Deadlock</div>
<div class="paragraph">
<p>Even in a file,in the same as a database, when acquiring a lock on multiple files, deadlock may occur in some cases.
Therefore, it is important to make a rule the update order of files.<br>
The prevention of deadlock is similar to prevention of deadlock between tables in the database.
For details, refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id9">Prevention of deadlock</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_DB"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_DB"></a>5.4.1.3. Exclusive Control of Database</h5>
<div class="paragraph">
<p>For details About Exclusive Control of Database, refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id5">Exclusive control using database locking</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Usecase"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Usecase"></a>5.4.1.4. Choose Exclusive Control Scheme</h5>
<div class="paragraph">
<p>Explain the locking scheme and suitable situation for TERASOLUNA Batch 5.x.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Choose exclusive control scheme</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Lock scheme</th>
<th class="tableblock halign-left valign-top">Suitable situation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id7">Optimistic locking</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The case where process can be continued with the update result of another transaction being out of processing targets in a transaction at the time of concurrent execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#id8">Pessimistic locking</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process in which the processing time is long and it is difficult to redo because the situation of the target data has changed during processing<br>
Process requiring exclusive control for files</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_Overview_Component"><a class="anchor" href="#Ch05_ExclusiveControl_Overview_Component"></a>5.4.1.5. Relationship between Exclusive Control and Components</h5>
<div class="paragraph">
<p>The relationship between each component provided by TERASOLUNA Batch 5.x and exclusive control is as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Optimistic lock</dt>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Relationship between exclusive control and components</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Processing model</th>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">File</th>
<th class="tableblock halign-left valign-top">Database</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Chunk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acquires data including a column that can confirm that the same data is obtained at the time of acquiring and updating such as Version column.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exclusive control is unnecessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check the difference between acquisition and update, confirm that it is not updated by other processing, then update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When acquiring data, execute the processing described in the ItemReader section, and when updating the data, the processing described in ItemWriter section.<br>
The concept is the same when using the Mapper interface directly.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Optimistic lock on files</div>
<div class="paragraph">
<p>Because of the characteristic of the file, do not apply optimistic lock on files.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Pessimistic lock</dt>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Relationship between exclusive control and components</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Processing model</th>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">File</th>
<th class="tableblock halign-left valign-top">Database</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Chunk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use FOR UPDATE of SQL statement.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemProcessor</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since it is fundamental to handle locked data, in principle, exclusive control is not performed here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemWriter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update data without conscious of exclusion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get a file lock right after opening a file with ItemStreamReader.<br>
Release the file lock just before closing ItemStreamWriter.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When acquiring data, execute the processing described in the ItemReader section, and when updating the data, the processing described in ItemWriter section.<br>
The concept is the same when using the Mapper interface directly.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Pessimistic lock on file</div>
<div class="paragraph">
<p>Pessimistic lock on files should be implemented in the tasklet model.
In the chunk model, due to its structure, there is a period that can not be excluded in the gap of chunk processing.
Also, it is assumed that file access is done by Injecting ItemStreamReader / ItemStreamWriter.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Waiting time due to Pessimistic lock in database</div>
<div class="paragraph">
<p>When pessimistic locking is performed, the wait time for processing due to contention may be prolonged.
In that case, it is reasonable to use the pessimistic lock by specifying the NO WAIT option and the timeout time.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch05_ExclusiveControl_HowToUse"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse"></a>5.4.2. How to use</h4>
<div class="paragraph">
<p>Explain how to use exclusive control by resource.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch05_ExclusiveControl_HowToUse_File">Exclusive control of file</a></p>
</li>
<li>
<p><a href="#Ch05_ExclusiveControl_HowToUse_DB">Exclusive Control of Database</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_HowToUse_File"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_File"></a>5.4.2.1. Exclusive control of file</h5>
<div class="paragraph">
<p>Exclusive control of file with TERASOLUNA Batch 5.x is realized by implementing Tasklet.
As a means of achieving exclusion, exclusive control is performed by file lock acquisition using the <code>java.nio.channels.FileChannel</code> class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Details of the FileChannel class</div>
<div class="paragraph">
<p>For details and how to use <code>FileChannel</code> class,
refer to <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/channels/FileChannel.html">Javadoc</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Show an example of using <code>FileChannel</code> class to get a file lock.</p>
</div>
<div class="listingblock">
<div class="title">Tasklet implementation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">FileExclusiveTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="predefined-type">String</span> targetPath = <span class="predefined-constant">null</span>; <span class="comment">// (1)</span>

    <span class="annotation">@Inject</span>
    ItemStreamReader&lt;SalesPlanDetail&gt; reader;

    <span class="annotation">@Inject</span>
    ItemStreamWriter&lt;SalesPlanDetailWithProcessName&gt; writer;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// omitted.</span>

        <span class="predefined-type">FileChannel</span> fc = <span class="predefined-constant">null</span>;
        <span class="predefined-type">FileLock</span> fileLock = <span class="predefined-constant">null</span>;

        <span class="keyword">try</span> {
            <span class="keyword">try</span> {
                <span class="predefined-type">File</span> file = <span class="keyword">new</span> <span class="predefined-type">File</span>(targetPath);
                fc = <span class="predefined-type">FileChannel</span>.open(file.toPath(), StandardOpenOption.WRITE,
                        StandardOpenOption.CREATE,
                        StandardOpenOption.APPEND); <span class="comment">// (2)</span>
                fileLock = fc.tryLock();  <span class="comment">// (3)</span>
            } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failure other than lock acquisition</span><span class="delimiter">&quot;</span></span>, e);
                <span class="keyword">throw</span> <span class="keyword">new</span> FailedOtherAcquireLockException(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Failure other than lock acquisition</span><span class="delimiter">&quot;</span></span>, e);
            }
            <span class="keyword">if</span> (fileLock == <span class="predefined-constant">null</span>) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to acquire lock. [processName={}]</span><span class="delimiter">&quot;</span></span>, processName);
                <span class="keyword">throw</span> <span class="keyword">new</span> FailedAcquireLockException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to acquire lock</span><span class="delimiter">&quot;</span></span>);
            }

            reader.open(executionConetxt);
            writer.open(executionConetxt);  <span class="comment">// (4)</span>

            <span class="comment">// (5)</span>
            SalesPlanDetail item;
            <span class="predefined-type">List</span>&lt;SalesPlanDetailWithProcessName&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
            <span class="keyword">while</span> ((item = reader.read()) != <span class="predefined-constant">null</span>) {

                <span class="comment">// omitted.</span>

                items.add(item);
                <span class="keyword">if</span> (items.size() &gt;= <span class="integer">10</span>) {
                    writer.write(items);
                    items.clear();
                }
            }
            <span class="keyword">if</span> (items.size() &gt; <span class="integer">0</span>) {
                writer.write(items);
            }

        } <span class="keyword">finally</span> {
            <span class="keyword">if</span> (fileLock != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> {
                    fileLock.release();  <span class="comment">// (6)</span>
                } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                    logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lock release failed.</span><span class="delimiter">&quot;</span></span>, e);
                }
            }
            <span class="keyword">if</span> (fc != <span class="predefined-constant">null</span>) {
                <span class="keyword">try</span> {
                    fc.close();
                } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                    <span class="comment">// do nothing.</span>
                }
            }
            <span class="keyword">try</span> {
                writer.close(); <span class="comment">// (7)</span>
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// ignore</span>
            }
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (ItemStreamException e) {
                <span class="comment">// ignore</span>
            }
        }
        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }

    <span class="comment">// (8)</span>
    <span class="annotation">@Value</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">void</span> setTargetPath(<span class="predefined-type">String</span> targetPath) {
        <span class="local-variable">this</span>.targetPath = targetPath;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">File path to be exclusively controlled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get file channel.<br>
In this example, channels for new creation, addition and writing of files are obtained.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get file lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open file to be locked if the file lock is fetched successfully.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute business logic with file output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Release file lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Close file to be exclusively controlled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set file path.<br>
In this example, it receives from the job parameter.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About the method of FileChannel used for lock acquisition</div>
<div class="paragraph">
<p>It is recommended to use the <code>tryLock()</code> method which is not waiting because the <code>lock()</code> method waits until the lock is released if the target file is locked.
Note that trylock() can select shared lock and exclusive lock, but in batch processing, exclusive lock is normally used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Exclusive control between threads in the same VM</div>
<div class="paragraph">
<p>Attention must be paid to exclusive control between threads in the same VM.
When processing files between threads in the same VM, the lock function using the <code>FileChannel</code> class can not determine whether a file is locked by another thread&#8217;s processing.<br>
Therefore, exclusive control between threads does not function. In order to avoid this, exclusive control between threads can be performed by performing synchronization processing in the part where writing to the file is performed.<br>
However, synchronizing reduces the merit of parallel processing, and it is not different from processing with a single thread.
As a result, since it is not suitable to perform exclusive control with different threads on the same file and process it, do not design and implement such processing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About appendAllowed property of FlatFileItemWriter</div>
<div class="paragraph">
<p>When creating (overwriting) a file, exclusive control can be realized by setting the <code>appendAllowed</code> property to <code>false</code> (default).
This is because <code>FileChannel</code> is controlled inside <code>FlatFileItemWriter</code>.
However, if the file is appended (<code>appendAllowed</code> property is <code>true</code>), developers need to implement exclusive control with <code>FileChannel</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch05_ExclusiveControl_HowToUse_DB"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB"></a>5.4.2.2. Exclusive Control of Database</h5>
<div class="paragraph">
<p>Explain exclusive control of database in TERASOLUNA Batch 5.x.</p>
</div>
<div class="paragraph">
<p>The exclusive control implementation of the database is basically
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">How to implement while using MyBatis3</a> in TERASOLUNA Server 5.x Development Guideline.
In this guideline,
Explain it on the premise that <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">How to implement while using MyBatis3</a> is done.</p>
</div>
<div class="paragraph">
<p>As shown in <a href="#Ch05_ExclusiveControl_Overview_Component">Relationship between Exclusive Control and Components</a>, there are variations due to combination of processing model and component.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Variation of exclusive control of database</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 30%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exclusive control scheme</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processing model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Component</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Optimistic lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chunk model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Tasklet model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper interface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Pessimistic lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chunk model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Tasklet model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ItemReader/ItemWriter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapper interface</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When using the Mapper interface in tasklet model, the explanation is omitted.
Refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/ExclusionControl.html#mybatis3">How to implement while using MyBatis3</a>.</p>
</div>
<div class="paragraph">
<p>When using ItemReader/ItemWriter in tasklet model, the calling part in the Mapper interface is replaced by ItemReader/ItemWriter, so the explanation is also omitted.</p>
</div>
<div class="paragraph">
<p>Therefore, exclusive control of chunk model will be explained here.</p>
</div>
<div class="sect5">
<h6 id="Ch05_ExclusiveControl_HowToUse_DB_OptimisticLock"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB_OptimisticLock"></a>5.4.2.2.1. Optimistic Lock</h6>
<div class="paragraph">
<p>Explain Optimistic lock in chunk model.</p>
</div>
<div class="paragraph">
<p>Since the behavior of the job changes according to the setting of the <code>assertUpdates</code> property of MyBatisBatchItemWriter, it is necessary to set it appropriately according to the business requirements.</p>
</div>
<div class="paragraph">
<p>Show the job definition for optimistic lock.</p>
</div>
<div class="listingblock">
<div class="title">job definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchFindOne</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['branchId']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (2) ---&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchExclusiveUpdate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:assertUpdates</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>  <span class="comment">&lt;!-- (3) --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkOptimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchEditItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set SQLID of data acquisition by optimistic lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set SQLID of data update by optimistic lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set whether to check the number of batch updates.<br>
If set to <code>true</code> (default), throw an exception if the number of updates is 0.<br>
if set to <code>false</code>, perform normal processing even if the number of updates is 0.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch05_ExclusiveControl_HowToUse_DB_PessimisticLock"><a class="anchor" href="#Ch05_ExclusiveControl_HowToUse_DB_PessimisticLock"></a>5.4.2.2.2. Pessimistic Lock</h6>
<div class="paragraph">
<p>Explain pessimistic lock in chunk model.</p>
</div>
<div class="paragraph">
<p>Show the job definition for pessimistic lock.</p>
</div>
<div class="listingblock">
<div class="title">job definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchFindOneWithNoWaitLock</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['branchId']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch05.exclusivecontrol.repository.ExclusiveControlRepository.branchUpdate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:assertUpdates</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{new Boolean(jobParameters['assertUpdates'])}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkPessimisticLockCheckJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkPessimisticLockCheckJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchEditItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set SQLID of data acquisition by pessimistic lock.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the same SQLID as SQL of data update without exclusive control.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Behavior during exclusive control</div>
<div class="paragraph">
<p>If performing pessimistic lock by setting NO WAIT or timeout, when excluded by another transaction, an exception is thrown in the <code>doOpen()</code> method of MyBatisCursorItemReader.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch06"><a class="anchor" href="#Ch06"></a>6. Support to abnormal system</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch06_InputValidation"><a class="anchor" href="#Ch06_InputValidation"></a>6.1. Input Validation</h3>
<div class="sect3">
<h4 id="Ch06_InputValidation_Overview"><a class="anchor" href="#Ch06_InputValidation_Overview"></a>6.1.1. Overview</h4>
<div class="paragraph">
<p>In this section, Explain the validation check of job input data (hereinafter referred to as input validation).</p>
</div>
<div class="paragraph">
<p>This function is the same usage for chunk model and tasklet model.</p>
</div>
<div class="paragraph">
<p>In general, input validation in batch processing is often carried out
to confirm that data received from other systems etc. is valid in its own system.<br>
Conversely, it can be said that it is unnecessary to perform input validation
on reliable data in its own system (for example, data stored in the database).</p>
</div>
<div class="paragraph">
<p>Please refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html">input Validation</a> in TERASOLUNA Server 5.x Development Guideline
because the input validation duplicates the contents of TERASOLUNA Server 5.x.
Explain the main comparisons below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Main comparison list</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Comparison target</th>
<th class="tableblock halign-left valign-top">TERASOLUNA Server 5.x</th>
<th class="tableblock halign-left valign-top">TERASOLUNA Batch 5.x</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Available input validation rules</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Same as TERASOLUNA Server 5.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The target to which the rule is attached</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>form class</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DTO</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation execute method</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Give @Validated annotation to the Controller</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Call the API of Validator class</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Setting error messages</p></td>
<td class="tableblock halign-center valign-top" colspan="2"><p class="tableblock">Same as
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html?highlight=validationmessages#validation-message-def">Definition of error messages</a> in TERASOLUNA Server 5.x Development Guideline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error message output destination</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">View</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log etc.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The input validation to be explained in this section mainly covers data obtained from <code>ItemReader</code>.<br>
For checking job parameters, refer to <a href="#Ch04_JobParameter_HowToUse_ParamsValidation">Validation check of parameters</a>.</p>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_Overview_Category"><a class="anchor" href="#Ch06_InputValidation_Overview_Category"></a>6.1.1.1. Classification of input validation</h5>
<div class="paragraph">
<p>The input validation is classified into single item check and correlation item check.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 15%;">
<col style="width: 30%;">
<col style="width: 25%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Implementation method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single item check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check to be completed with a single field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required input check<br>
Digit check<br>
Type check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean Validation (using Hibernate Validator as implementation library)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Correlation item check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check to compare multiple fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison of numerical values<br>
Comparison of dates</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Validation</code> class that implements <code>org.springframework.validation.Validator</code> interface<br>
or Bean Validation</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring supports Bean Validation which is a Java standard.
For this single item check, this Bean Validation is used.
For correlation item check, use Bean Validation of the <code>org.springframework.validation.Validator</code> interface provided by Spring.</p>
</div>
<div class="paragraph">
<p>In this respect,
same as <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html#id3">Classification of input validation</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_Overview_architecture"><a class="anchor" href="#Ch06_InputValidation_Overview_architecture"></a>6.1.1.2. Overview of Input Validation</h5>
<div class="paragraph">
<p>The timing of input validation in the chunk model and tasklet model is as follows.<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>For chunk model, use <code>ItemProcessor</code></p>
</li>
<li>
<p>For tasklet model, use <code>Tasklet#execute()</code> at an arbitrary timing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the chunk model and tasklet model, the implementation method of input validation is the same,
so here, explain the case where input validation is done in <code>ItemProcessor</code> of the chunk model.</p>
</div>
<div class="paragraph">
<p>First, explain an overview of input validation. The relationships of classes related to input validation are as follows.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_InputValidation_Architecture_classes.png" alt="InputValidation architecture">
</div>
<div class="title">Related class of input validation</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Inject <code>org.springframework.batch.item.validator.SpringValidator</code> which is
the implementation of <code>org.springframework.batch.item.validator.Validator</code> in <code>ItemProcessor</code> and execute the validate method.</p>
<div class="ulist">
<ul>
<li>
<p><code>SpringValidator</code> internally holds <code>org.springframework.validation.Validator</code> and execute the validate method.<br>
It can be said that it is a wrapper for <code>org.springframework.validation.Validator</code>.<br>
The implementation of <code>org.springframework.validation.Validator</code> is
<code>org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</code>.
Use Hibernate Validator through this class.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Implement <code>org.springframework.batch.item.ItemCountAware</code> in the input DTO to determine where the input validation error occured.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Setting the number of data</div>
<div class="paragraph">
<p><code>ItemCountAware#setItemCount</code> is set by <code>AbstractItemCountingItemStreamItemReader</code>.
Therefore, if you do not use <code>ItemReader</code> in the tasklet model, it will not be updated.
In this case, it is necessary for the user to set what error occurred in the data.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Validators such as javax.validation.Validator or org.springframework.validation.Validator should not be used directly.</div>
<div class="paragraph">
<p>Validators such as <code>javax.validation.Validator</code> or <code>org.springframework.validation.Validator</code> should not be used directly,
use <code>org.springframework.batch.item.validator.SpringValidator</code>.</p>
</div>
<div class="paragraph">
<p><code>SpringValidator</code> is wrapper of <code>org.springframework.validation.Validator</code>.<br>
<code>SpringValidator</code> wraps the raised exception in <code>BindException</code> and throws it as <code>ValidationException</code>.<br>
Therefore, <code>BindException</code> can be accessed via <code>ValidationException</code> which makes flexible handling easier.</p>
</div>
<div class="paragraph">
<p>On the other hand, if validators such as <code>javax.validation.Validator</code> and <code>org.springframework.validation.Validator</code> are used directly, it will be cumbersome logic to process the information that caused the validation error.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Do not use org.springframework.batch.item.validator.ValidatingItemProcessor</div>
<div class="paragraph">
<p>The input validation by <code>org.springframework.validation.Validator</code>
can also be realized by using <code>ValidatingItemProcessor</code> provided by Spring Batch.</p>
</div>
<div class="paragraph">
<p>However, depending on the circumstances, it is necessary to extend it because of the following reasons,
so do not use it from the viewpoint of unifying the implementation method.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input validation error can not be handled and processing can not be continued.</p>
</li>
<li>
<p>It is not possible to flexibly deal with data that has become an input validation error.</p>
<div class="ulist">
<ul>
<li>
<p>It is assumed that the processing for the data that becomes the input validation error becomes various kinds by the user (only log output, save error data to another file, etc.).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_InputValidation_HowToUse"><a class="anchor" href="#Ch06_InputValidation_HowToUse"></a>6.1.2. How to use</h4>
<div class="paragraph">
<p>As mentioned earlier, the implementation method of input validation is the same as TERASOLUNA Server 5.x as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>single item check uses Bean Validation.</p>
</li>
<li>
<p>correlation item check uses Bean Validation or the <code>org.springframework.validation.Validator</code> interface provided by Spring.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Explain The method of input validation in the following order.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_Settings">Various settings</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_defRules">Input validation rule definition</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_Execution">Input validation execution</a></p>
</li>
<li>
<p><a href="#Ch06_InputValidation_HowToUse_ErrorHandling">Input validation error handling</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_Settings"><a class="anchor" href="#Ch06_InputValidation_HowToUse_Settings"></a>6.1.2.1. Various settings</h5>
<div class="paragraph">
<p>Use Hibernate Validator for input validation.
Confirm that the definition of Hibernate Validator is in the library dependency and that the required bean definition exists.
These have already been set in the blank project provided by TERASOLUNA Batch 5.x.</p>
</div>
<div class="listingblock">
<div class="title">Setting example of dependent library</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.hibernate<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>hibernate-validator<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">validator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.SpringValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:validator-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">beanValidator</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.validation.beanvalidation.LocalValidatorFactoryBean</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Error message setting</div>
<p>As mentioned earlier, for setting of error messages,
refer to
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html?highlight=validationmessages#validation-message-def">Definition of error messages</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_defRules"><a class="anchor" href="#Ch06_InputValidation_HowToUse_defRules"></a>6.1.2.2. Input validation rule definition</h5>
<div class="paragraph">
<p>The target of implementing the rule of input validation is the DTO obtained through <code>ItemReader</code>.
Implement the DTO obtained through <code>ItemReader</code> as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>org.springframework.batch.item.ItemCountAware</code> in the input DTO to determine where the input validation error occured.</p>
<div class="ulist">
<ul>
<li>
<p>In the <code>setItemCount</code> method, hold a numerical value in the class field indicating the number of items read in the currently processed item received as an argument.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Define the input validation rule.</p>
<div class="ulist">
<ul>
<li>
<p>refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/WebApplicationDetail/Validation.html">Input Validation</a> in TERASOLUNA Server 5.x Development Guideline.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Show an example of a DTO defining an input validation rule below.</p>
</div>
<div class="listingblock">
<div class="title">An example of a DTO defining an input validation rule</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VerificationSalesPlanDetail</span> <span class="directive">implements</span> ItemCountAware {  <span class="comment">// (1)</span>

    <span class="directive">private</span> <span class="type">int</span> count;

    <span class="annotation">@NotEmpty</span>
    <span class="annotation">@Size</span>(min = <span class="integer">1</span>, max = <span class="integer">6</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> branchId;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="annotation">@Max</span>(<span class="integer">9999</span>)
    <span class="directive">private</span> <span class="type">int</span> year;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@Min</span>(<span class="integer">1</span>)
    <span class="annotation">@Max</span>(<span class="integer">12</span>)
    <span class="directive">private</span> <span class="type">int</span> month;

    <span class="annotation">@NotEmpty</span>
    <span class="annotation">@Size</span>(min = <span class="integer">1</span>, max = <span class="integer">10</span>)
    <span class="directive">private</span> <span class="predefined-type">String</span> customerId;

    <span class="annotation">@NotNull</span>
    <span class="annotation">@DecimalMin</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@DecimalMax</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">9999999999</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="predefined-type">BigDecimal</span> amount;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> setItemCount(<span class="type">int</span> count) {
        <span class="local-variable">this</span>.count = count;  <span class="comment">// (2)</span>
    }

    <span class="comment">// omitted getter/setter</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement the <code>ItemCountAware</code> class and override the <code>setItemCount</code> method.<br>
<code>ItemCountAware#setItemCount()</code> is passed to the argument as to what the data read by <code>ItemReader</code> is.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holds the <code>count</code> received in the argument in the class field.<br>
This value is used to determine the number of items of data that caused an input validation error.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_Execution"><a class="anchor" href="#Ch06_InputValidation_HowToUse_Execution"></a>6.1.2.3. Input validation execution</h5>
<div class="paragraph">
<p>Explain how to implement input validation.
Implement input validation execution as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute <code>org.springframework.batch.item.validator.Validator#validate()</code> in the implementation of <code>ItemProcessor</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Use an instance of <code>SpringValidator</code> by injecting it as <code>Validator</code> field.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Handle input validation error. For details, refer to <a href="#Ch06_InputValidation_HowToUse_ErrorHandling">Input validation error handling</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Show an implementation example of input validation below.</p>
</div>
<div class="listingblock">
<div class="title">An implementation example of input validation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndContinueItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="annotation">@Inject</span>  <span class="comment">// (1)</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (2)</span>
            validator.validate(item);  <span class="comment">// (3)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
          <span class="comment">// omitted exception handling</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject <code>SpringValidator</code> instance.<br>
For the type argument of <code>org.springframework.batch.item.validator.Validator</code>, set the DTO to be acquired via <code>ItemReader</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handle input validation error.<br>
In the example, exception is handled by catching with try/catch.<br>
For details, refer to <a href="#Ch06_InputValidation_HowToUse_ErrorHandling">Input validation error handling</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute <code>Validator#validate()</code> with the DTO obtained through <code>ItemReader</code> as an argument.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_InputValidation_HowToUse_ErrorHandling"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling"></a>6.1.2.4. Input validation error handling</h5>
<div class="paragraph">
<p>There are following 2 ways to handle input validation error.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Processing is aborted at the time when input validation error occurs, abnormally end the job.</p>
</li>
<li>
<p>Leave the occurrence of input validation error in the log etc. and continue processing the subsequent data. Thereafter, at the end of the job, the job is ended by specifying a warning.</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_Abend"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_Abend"></a>6.1.2.4.1. Abnormal Termination of Processing</h6>
<div class="paragraph">
<p>In order to abnormally terminate processing when an exception occurs, it throws <code>java.lang.RuntimeException</code> or its subclass.</p>
</div>
<div class="paragraph">
<p>There are two ways to perform processing such as log output when an exception occurs.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Catch exceptions with try/catch and do it before throwing an exception.</p>
</li>
<li>
<p>Do not catch exceptions with try/catch, implement <code>ItemProcessListener</code> and do it with the onProcessError method.</p>
<div class="ulist">
<ul>
<li>
<p><code>ItemProcessListener#onProcessError()</code> can be implemented using the <code>@OnProcessError</code> annotation.
For details, refer to <a href="#">Listener</a>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Following is an example of logging exception information and abnormally terminating processing when an exception occurs.</p>
</div>
<div class="listingblock">
<div class="title">An error handling example with try/catch</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndAbortItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndAbortItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (1)</span>
            validator.validate(item);  <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
            <span class="comment">// (3)</span>
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>,
                    item.getCount(), e.getMessage());
            <span class="keyword">throw</span> e;  <span class="comment">// (4)</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Catch exceptions with try/catch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute input validation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform log output processing before throwing an exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throw exceptions<br>
Since <code>org.springframework.batch.item.validator.ValidationException</code> is a subclass of <code>RuntimeException</code>,
it can be thrown as it is.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title">An error handling example with ItemProcessListener#OnProcessError</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndAbortItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {

    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndAbortItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        validator.validate(item);  <span class="comment">// (1)</span>

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }

    <span class="annotation">@OnProcessError</span>  <span class="comment">// (2)</span>
    <span class="type">void</span> onProcessError(VerificationSalesPlanDetail item, <span class="exception">Exception</span> e) {
        <span class="comment">// (3)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>, item.getCount() ,e.getMessage());
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute input validation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>ItemProcessListener#onProcessError()</code> using <code>@OnProcessError</code> annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform log output processing before throwing an exception.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Note on using ItemProcessListener#onProcessError()</div>
<div class="paragraph">
<p>Using of the onProcessError method is useful for improving the readability of source code, maintainability, etc. since business process and exception handling can be separated.<br>
However, when an exception other than <code>ValidationException</code> performing handling processing in the above example occurs, the same method is executed, so it is necessary to be careful.</p>
</div>
<div class="paragraph">
<p>When outputting log output in <code>ItemProcessor#process()</code> by exception,
it is necessary to judge the kind of exception caused by the onProcessError method and handle exception.
If this is cumbersome, it is good to share responsibility so that only input validation errors are handled by handling with try / catch and others are handed over to listeners.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_Skip"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_Skip"></a>6.1.2.4.2. Skipping Error Records</h6>
<div class="paragraph">
<p>After logging the information of the record where input validation error occurred, skip the record where the error occurred and continue the processing of the subsequent data as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Catch exceptions with try/catch.</p>
</li>
<li>
<p>Perform log output etc. when an exceptions occurs.</p>
</li>
<li>
<p>Return <code>null</code> as the return value of <code>ItemProcessor#process()</code>.</p>
<div class="ulist">
<ul>
<li>
<p>By returning <code>null</code>, records in which an input validation error occurs are no longer included in subsequent processing targets (output with <code>ItemWriter</code>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">A skipping example with ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ValidateAndContinueItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;VerificationSalesPlanDetail, SalesPlanDetail&gt; {
    <span class="comment">/**
     * Logger.
     */</span>
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(ValidateAndContinueItemProcessor.class);

    <span class="annotation">@Inject</span>
    <span class="predefined-type">Validator</span>&lt;VerificationSalesPlanDetail&gt; validator;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPlanDetail process(VerificationSalesPlanDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="keyword">try</span> {  <span class="comment">// (1)</span>
            validator.validate(item);  <span class="comment">// (2)</span>
        } <span class="keyword">catch</span> (ValidationException e) {
            <span class="comment">// (3)</span>
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Skipping item because exception occurred in input validation at the {} th item. [message:{}]</span><span class="delimiter">&quot;</span></span>,
                    item.getCount(), e.getMessage());
            <span class="comment">// (4)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;  <span class="comment">// skipping item</span>
        }

        SalesPlanDetail salesPlanDetail = <span class="keyword">new</span> SalesPlanDetail();
        <span class="comment">// omitted business logic</span>

        <span class="keyword">return</span> salesPlanDetail;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Catch exceptions with try/catch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute the input validation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Perform log output processing before returning <code>null</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return <code>null</code> to skip this data and move on to the next data processing.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_InputValidation_HowToUse_ErrorHandling_ExitCode"><a class="anchor" href="#Ch06_InputValidation_HowToUse_ErrorHandling_ExitCode"></a>6.1.2.4.3. Setting the exit code</h6>
<div class="paragraph">
<p>When an input validation error occurs, in order to distinguish between the case where input validation error did not occur and the state of the job, be sure to set an exit code that is not a normal termination.<br>
If data with input validation error is skipped, setting of exit code is required even when abnormal termination occurs.</p>
</div>
<div class="paragraph">
<p>For details on how to set the exit code, refer to <a href="#">Job Management</a>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch06_ExceptionHandling"><a class="anchor" href="#Ch06_ExceptionHandling"></a>6.2. Exception handling</h3>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_Overview"><a class="anchor" href="#Ch06_ExceptionHandling_Overview"></a>6.2.1. Overview</h4>
<div class="paragraph">
<p>How to handle exception generated at the time of job execution is explained.</p>
</div>
<div class="paragraph">
<p>Since this function has different usage for chunk model and tasklet model, each will be explained.</p>
</div>
<div class="paragraph">
<p>First, classification of exceptions is explained, and handling method according to the type of exception is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Classification"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Classification"></a>6.2.1.1. Classification of exception</h5>
<div class="paragraph">
<p>The exception generated at the time of job execution are classified into 3 types as below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Classification list of exceptions</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 30%;">
<col style="width: 35%;">
<col style="width: 30%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr.No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Classification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type">Exception type</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception that can be resolved the cause by job re-execution (parameters, change / modification of input data, etc.).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An exception that can resolve the cause by re-execution of a job that handles an exception with application code and performs exception handling.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_BusinessEx">Business exception</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_LibraryEx">Library exception occurring during normal operation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception that can not be resolved by job re-execution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exceptions that can be resolved by job re-execution are handled with the following pattern.</p>
<p class="tableblock">1. If exception can be caught in <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>,
handling exception with application code.<br></p>
<p class="tableblock">2. If exception cannot be caught in <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>,
handling exception in the framework.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_SystemEx">System exception</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx">Unexpected system exception</a><br>
<a href="#Ch06_ExceptionHandling_Overview_Type_FatalErrors">Fatal error</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(During asynchronous execution)Exception caused by illegal request for job request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception caused by illegal request of job request is handled in the framework and performs exception handling.</p>
<p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> In case of <a href="#Ch04_AsyncJobWithDB">Asynchronous execution(DB polling)</a>
in the polling process, the validity of the job request is not verified.Therefore, it is desirable that the input check for the request is made in advance by the application that registers the job request.</p>
<p class="tableblock"><span class="icon"><i class="fa fa-warning"></i></span> In case of <a href="#Ch04_AsyncJobWithWeb">Asynchronous execution(Web container)</a>
It is assumed that the input check for the request is made in advance by the Web application.</p>
<p class="tableblock">Therefore, exception handling is performed in an application that accepts requests or job requests.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Type_IllegalRequest">Invalid job request error</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Avoid transaction processing within exception processing</div>
<div class="paragraph">
<p>When performing transactional processing such as writing to a database in exception processing,
there is a possibility of causing a secondary exception.
Exception processing should be based on output log analysis and end code setting.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Type"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type"></a>6.2.1.2. Exception type</h5>
<div class="paragraph">
<p>Types of exceptions are explained.</p>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_BusinessEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_BusinessEx"></a>6.2.1.2.1. Business exception</h6>
<div class="paragraph">
<p>A business exception is <strong>an exception notifying that a violation of a business rule has been detected</strong>.<br>
This exception is generated within the logic of the step.<br>
Since it is assumed to be an application state, it is not necessary to deal with the system operator.</p>
</div>
<div class="ulist">
<div class="title">Business exception example</div>
<ul>
<li>
<p>In case of stock out at inventory reserve</p>
</li>
<li>
<p>When the number of days exceeds the scheduled date</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Applicable exception class</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.RuntimeException</code>and its subclass</p>
<div class="ulist">
<ul>
<li>
<p>It is recommended to create business exception classes by the user.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_LibraryEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_LibraryEx"></a>6.2.1.2.2. Library exception occurring during normal operation</h6>
<div class="paragraph">
<p>A library exception that occurs during normal operation refers to <strong>an exception that may occur when the system is operating normally</strong>, among exceptions generated in the framework and library.<br>
Exceptions raised in the framework and library are exception classes that occur in the Spring Framework and other libraries.<br>
Since it is assumed to be an application state, it is not necessary to deal with the system operator.</p>
</div>
<div class="ulist">
<div class="title">Example of library exception that occurs during normal operation</div>
<ul>
<li>
<p>Optimistic lock exception which occurs in <a href="#Ch05_ExclusiveControl">exclusive control</a> with online processing.</p>
</li>
<li>
<p>Unique constraint exception that occurs when registering the same data at same time from multiple jobs or online processing.</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Applicable exception class</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.dao.EmptyResultDataAccessException</code> (Exception that occurs when optimistic locking is done, when data update count is 0)</p>
</li>
<li>
<p><code>org.springframework.dao.DuplicateKeyException</code> (Exception that occurs when a unique constraint violation occurs)</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_SystemEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_SystemEx"></a>6.2.1.2.3. System exception</h6>
<div class="paragraph">
<p>A system exception is <strong>an exception  to notify that a state that should not occur is detected when the system is operating normally</strong>.<br>
This exception is generated within the logic of the step.<br>
Action by the system operator is required.</p>
</div>
<div class="ulist">
<div class="title">Example of system exception</div>
<ul>
<li>
<p>Master data, directory, file, etc. that should exist in advance do not exist.</p>
</li>
<li>
<p>When an exception classified as system abnormality is caught(IOException at file operation, etc.) among inspection exception occurring in the framework or library.</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Applicable exception class</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.RuntimeException</code> or its subclass</p>
<div class="ulist">
<ul>
<li>
<p>Creating a system exception class is recommended.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_UnexpectedSystemEx"></a>6.2.1.2.4. Unexpected system exception</h6>
<div class="paragraph">
<p>Unexpected system exceptions are <strong>non-inspection exceptions that do not occur when the system is operating normally</strong>. <br>
It is necessary for the system operator to deal with it or to analyze it by the system developer.</p>
</div>
<div class="paragraph">
<p>Unexpected system exceptions will not be handled except by doing the following processing.
If handled, throw the exception again.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Log capture exception for analysis and set the corresponding exit code.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Unexpected system exception example</div>
<ul>
<li>
<p>Bugs are hidden in applications, frameworks, and libraries.</p>
</li>
<li>
<p>When the DB server is down.</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Applicable exception class</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.NullPointerException</code> (Exception caused by a bug)</p>
</li>
<li>
<p><code>org.springframework.dao.DataAccessResourceFailureException</code>(Exception raised when the DB server is down)</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_FatalErrors"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_FatalErrors"></a>6.2.1.2.5. Fatal error</h6>
<div class="paragraph">
<p>A fatal error is an error <strong>that notifies that a fatal problem has occurred that affects the entire system (application)</strong>.<br>
It is necessary for system operator or system developer to cope with it and recover.</p>
</div>
<div class="paragraph">
<p>Fatal errors are not handled except for the following processing.If handled, throw the exception again.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Log capture exception for analysis and set the corresponding exit code.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fatal error example</div>
<ul>
<li>
<p>When memory available for Java virtual machine is insufficient.</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Applicable exception class</div>
<div class="ulist">
<ul>
<li>
<p>Classes that inherit<code>java.lang.Error</code>.</p>
<div class="ulist">
<ul>
<li>
<p>java.lang.OutOfMemoryError (Error occurred when memory is insufficient)etc</p>
</li>
</ul>
</div>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Type_IllegalRequest"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Type_IllegalRequest"></a>6.2.1.2.6. Invalid job request error</h6>
<div class="paragraph">
<p>Job request invalid error is an error <strong>to notify that a problem has occurred in the request for job request during asynchronous execution</strong>.<br>
It is necessary for the system operator to cope with and recover from it.</p>
</div>
<div class="paragraph">
<p>Job request incorrect error is based on exception handling in the application processing the request of job request,
It is not explained in this guideline.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Overview_Deal"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal"></a>6.2.1.3. How to handle exceptions</h5>
<div class="paragraph">
<p>How to handle exceptions is explained.</p>
</div>
<div class="paragraph">
<p>The exception handling pattern is as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Decide whether to continue the job when an exception occurs (3 types)</p>
</li>
<li>
<p>Decide how to re-execute the suspended job (2 types)</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">How to decide whether to continue the job</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 25%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">How to handle exceptions</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Skip">Skip</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip error record and continue processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Retry">Retry</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reprocess the error record until the specified condition (number of times, time etc.) is reached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_Overview_Deal_Interruption">Process interruption</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processing is interrupted.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if an exception has not occurred, the job may stop while processing because the job has exceeded the expected processing time.<br>
In this case, please refer <a href="#Ch07_JobManagement_JobStatusManagement_JobStop">Stopping a job</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">How to re-execute the suspended job</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 25%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">How to handle exceptions</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_RerunRestart_HowToUse_Rerun">Job rerun</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-execute the suspended job from the beginning.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_RerunRestart_HowToUse_Restart">Job restart</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Re-execute the interrupted job from the point where it was interrupted.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For details, please refer how to re-execute the suspended job <a href="#Ch06_RerunRestart">Rerun processing</a>.</p>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Skip"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Skip"></a>6.2.1.3.1. Skip</h6>
<div class="paragraph">
<p>Skipping is a method of skipping error data without stopping batch processing and continuing processing.</p>
</div>
<div class="ulist">
<div class="title">Skipping example</div>
<ul>
<li>
<p>Invalid record exists in input data</p>
</li>
<li>
<p>When a business exception occurs</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Reprocess skip record</div>
<div class="paragraph">
<p>When skipping, design how to deal with skipped invalid records.
In the case of extracting and reprocessing an invalid record, a case like processing it is included at the time of the next execution,can be considered.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Retry"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Retry"></a>6.2.1.3.2. Retry</h6>
<div class="paragraph">
<p>Retrying is a method of repeatedly attempting until a specified number of times or time is reached for a record that failed a specific process.<br>
It is used only when the cause of processing failure depends on the execution environment and it is expected to be resolved over time.</p>
</div>
<div class="ulist">
<div class="title">Example of retrying</div>
<ul>
<li>
<p>When the record to be processed is locked by exclusive control</p>
</li>
<li>
<p>When message transmission fails due to instantaneous interruption of network</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Application of retry</div>
<div class="paragraph">
<p>If the retry is applied in every scene, the processing time unnecessarily increases at the time of occurrence of an abnormality, there is a risk that the detection of the abnormality will be delayed<br>
Therefore, it is desirable to apply the retry to only a part of the process,
It is advisable to limit the target to those that are less reliable such as external system cooperation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_Overview_Deal_Interruption"><a class="anchor" href="#Ch06_ExceptionHandling_Overview_Deal_Interruption"></a>6.2.1.3.3. Process interruption</h6>
<div class="paragraph">
<p>Process interruption is literally a method of interrupting processing midway.<br>
It is used when processing cannot be continued on detecting an erroneous content or when there is requirement which does not allow skipping of records.</p>
</div>
<div class="ulist">
<div class="title">Examples of processing interruption</div>
<ul>
<li>
<p>Invalid record exists in input data</p>
</li>
<li>
<p>When a business exception occurs</p>
</li>
<li>
<p>etc &#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_HowToUse"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse"></a>6.2.2. How to use</h4>
<div class="paragraph">
<p>How to implement exception handling is explained.</p>
</div>
<div class="paragraph">
<p>A log is the main user interface for batch application operation.Therefore, monitoring of exception occurred will also be done through the log.</p>
</div>
<div class="paragraph">
<p>In Spring Batch, if an exception occurs during step execution, the log is output and abnormally terminated, so there is a possibility that the requirement can be satisfied without additional implementation by the user.
The following explanation should be implemented pinpoint only when it is necessary for the user to output logs according to the system.
Basically there are no case where all processing must be implemented.</p>
</div>
<div class="paragraph">
<p>For common log setting of exception handling, please refer <a href="#Ch07_JobManagement_Logging">Logging</a>.</p>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Step"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Step"></a>6.2.2.1. Step unit exception handling</h5>
<div class="paragraph">
<p>Exception handling method in step units is explained.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_ChunkListener">Exception handling with ChunkListener interface</a></dt>
<dd>
<p>If you want to handle exceptions uniquely regardless of the processing model,
use <a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a> interface.<br>
Although it can be implemented by using a step or job listener which is wider in scope than chunk
Adopt <code>ChunkListener</code> emphasizing in  handling it immediately as soon as possible after occurrence.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The exception handling method for each processing model is as follows.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk">Exception handling in chunk model</a></dt>
<dd>
<p>Implement the function using various Listener interfaces provided by Spring Batch.</p>
</dd>
<dt class="hdlist1"><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet">Exception handling in tasklet model</a></dt>
<dd>
<p>Implement exception handling independently within tasklet implementation.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Why unified handling possible with ChunkListener.</div>
<div class="paragraph">
<p>A sense of incompatibility might be felt with <code>ChunkListener</code> being able to handle exceptions occurring within tasklet implementation.
This is because in Spring Batch, execution of business logic is considered based on chunk,
since one tasklet execution is handled as one chunk processing.</p>
</div>
<div class="paragraph">
<p>This point also appears in <code>org.springframework.batch.core.step.tasklet.Tasklet</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Tasklet</span> {
  RepeatStatus execute(StepContribution contribution,
          ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span>;
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_ChunkListener"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_ChunkListener"></a>6.2.2.1.1. Exception handling with ChunkListener interface</h6>
<div class="paragraph">
<p>Implement <code>afterChunkError</code> method of <a href="#Ch04_Listener_Overview_Types_ChunkListener">ChunkListener</a> interface.<br>
Get error information from <code>ChunkContext</code> argument of <code>afterChunkError</code> method  using <code>ChunkListener.ROLLBACK_EXCEPTION_KEY</code>as a key.</p>
</div>
<div class="paragraph">
<p>For details on how to set the listener,please refer <a href="#Ch04_Listener_HowToUse_Configuration">Listerner setting</a>.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of ChunkListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ChunkAroundListener</span> <span class="directive">implements</span> ChunkListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(ChunkAroundListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeChunk(ChunkContext context) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">before chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunk(ChunkContext context) {
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">after chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context);
    }

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterChunkError(ChunkContext context) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while chunk. [context:{}]</span><span class="delimiter">&quot;</span></span>, context,
                context.getAttribute(ChunkListener.ROLLBACK_EXCEPTION_KEY)); <span class="comment">// (2)</span>
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>afterChunkError</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get error information from <code>ChunkContext</code> using <code>ChunkListener.ROLLBACK_EXCEPTION_KEY</code> as a key.<br>
In this example, the stack trace of the acquired exception is logged.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Difference in behavior of ChunkListener due to difference in processing model</div>
<div class="paragraph">
<p>In the chunk model, handling is not performed with the afterChunkError method because exceptions caused by opening / closing resources are outside the scope captured by the ChunkListener interface.
A schematic diagram is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_ExceptionHandling_DiffTimingOpenResourceByChunkModel.png" alt="Difference in resource open timing by chunk model">
</div>
<div class="title">Schematic diagram of exception handling in chunk model</div>
</div>
<div class="paragraph">
<p>In the tasklet model, exceptions caused by opening and closing resources are handled by the afterChunkError method because they are within the scope captured by the ChunkListener interface.
A schematic diagram is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch06_ExceptionHandling_DiffTimingOpenResourceByTaskletModel.png" alt="Difference in resource open timing by tasklet model">
</div>
<div class="title">Schematic diagram of exception handling in the tasklet model</div>
</div>
<div class="paragraph">
<p>If you wish to handle exceptions unifiedly by absorbing this behavior difference,
it can be implemented by checking the occurrence of an exception in the <a href="#Ch04_Listener_Overview_Types_StepExecutionListener">StepExecutionListener</a> interface.
However, the implementation is slightly more complicated than <code>ChunkListener</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example of StepExecutionListener implementation.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">StepErrorLoggingListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(StepErrorLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Throwable</span>&gt; exceptions = stepExecution.getFailureExceptions();
        <span class="comment">// (3)</span>
        <span class="keyword">if</span> (exceptions.isEmpty()) {
            <span class="keyword">return</span> ExitStatus.COMPLETED;
        }

        <span class="comment">// (4)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">This step has occurred some exceptions as follow. </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">[step-name:{}] [size:{}]</span><span class="delimiter">&quot;</span></span>,
                stepExecution.getStepName(), exceptions.size());
        <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : exceptions) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception has occurred in job.</span><span class="delimiter">&quot;</span></span>, th);
        }
        <span class="keyword">return</span> ExitStatus.FAILED;
    }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>afterStep</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get error information from the <code>stepExecution</code> argument.Be aware that you need to handle multiple exceptions together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">there is no error information, it is determined as normal termination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If there is error information, exception handling is performed.<br>
In this example, log output with stack trace is done for all exceptions that has occurred.</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk"></a>6.2.2.1.2. Exception handling in chunk model</h6>
<div class="paragraph">
<p>In the chunk model,
exception handling with an inherited Listener <a href="#Ch04_Listener_Overview_Types_StepListener">StepListener</a>.</p>
</div>
<div class="paragraph">
<p>For details on how to set listener, please refer <a href="#Ch04_Listener_HowToUse_Configuration">Listner setting</a>.</p>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemReader"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemReader"></a>Coding point(ItemReader)</h7>
<div class="paragraph">
<p>By implementing <code>onReadError</code> method of <a href="#Ch04_Listener_Overview_Types_ItemReadListener">ItemReadListener</a> interface,
exceptions raised within ItemReader are handled.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of ItemReadListener#onReadError</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemReadListener</span> <span class="directive">implements</span> ItemReadListener&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemReadListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onReadError(<span class="exception">Exception</span> ex) {
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while reading.</span><span class="delimiter">&quot;</span></span>, ex);  <span class="comment">// (2)</span>
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>onReadError</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling. <br>
In this example, the stack trace of the exception acquired from the argument is logged.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor"></a>Coding point (ItemProcessor)</h7>
<div class="paragraph">
<p>There are two ways to handle exception in ItemProcessor, and use it according to requirements.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to try ~ catch in ItemProcessor</p>
</li>
<li>
<p>Using <a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a> interface.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Why they are used properly is explained.<br>
The argument of the <code>onProcessError</code> method executed when an exception occurs in ItemProcessor processing has two items, processing item and exception.<br>
Depending on the requirements of the system, when handling exceptions such as log output in the <code>ItemProcessListener</code> interface, these two arguments may not satisfy the requirement.
In that case, it is recommended to catch the exception with try ~ catch in ItemProcessor and perform exception handling processing.<br>
Note that implementing try ~ catch in ItemProcessor and implementing the <code>ItemProcessListener</code> interface may result in double processing, so care must be taken<br>
If fine-grained exception handling is to be done, then adopt a method to try ~ catch in ItemProcessor.</p>
</div>
<div class="paragraph">
<p>Each method is explained.</p>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor_TryCatchExample" class="dlist">
<dl>
<dt class="hdlist1">How to try ~ catch in ItemProcessor</dt>
<dd>
<p>This is used to do fine-grained exception handling.<br>
As explained in the skip section below,it will be used when doing error record of <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip">Skip</a>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Implementation example of try ~ catch in ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (2)</span>
            logger.error(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [item:{}]</span><span class="delimiter">&quot;</span></span>, item, ae);
            <span class="comment">// (3)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>try～catch</code>.Here special handling is only for certain exceptions (<code>ArithmeticException</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, the stack trace of the exception acquired from the argument is logged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throw a transaction rollback exception.<br>
This exception throw also allows common exception handling with <code>ItemProcessListener</code>.</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">How to use the <code>ItemProcessListener</code> interface</dt>
<dd>
<p>Use this,if business exceptions can be handled in the same way.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Implemenation example of ItemProcessListener#onProcessError</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemProcessListener</span> <span class="directive">implements</span> ItemProcessListener&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemProcessListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onProcessError(<span class="predefined-type">Object</span> item, <span class="exception">Exception</span> e) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [item:{}]</span><span class="delimiter">&quot;</span></span>, item, e);
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>onProcessError</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, the processing target data acquired from the arguments and the stack trace of the exception are logged.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemWriter"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemWriter"></a>Coding point(ItemWriter)</h7>
<div class="paragraph">
<p>By implementing the <code>onWriteError</code> method of <a href="#Ch04_Listener_Overview_Types_ItemWriteListener">ItemWriteListener</a> interface
exceptions raised within ItemWriter are handled.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of ItemWriteListener#onWriteError</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">CommonItemWriteListener</span> <span class="directive">implements</span> ItemWriteListener&lt;<span class="predefined-type">Object</span>&gt; {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(CommonItemWriteListener.class);

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onWriteError(<span class="exception">Exception</span> ex, <span class="predefined-type">List</span> item) {
        <span class="comment">// (2)</span>
        logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. [items:{}]</span><span class="delimiter">&quot;</span></span>, item, ex);
    }

    <span class="comment">// omitted.</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>onWriteError</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, the chunk of the output target obtained from the argument and the stack trace of the exception are logged.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet"></a>6.2.2.1.3. Exception handling in tasklet model</h6>
<div class="paragraph">
<p>Implement exception handling of tasklet model on its own in tasklet.</p>
</div>
<div class="paragraph">
<p>When performing transaction processing, be sure to throw the exception again in order to roll back.</p>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet_TaskletExample" class="listingblock">
<div class="title">Exception handling implementation example in tasklet model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPerformanceTasklet.class);

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">10</span>);
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="comment">// omitted.</span>

                <span class="comment">// Pseudo operation of ItemProcessor</span>
                checkAmount(item.getAmount(), amountLimit);


                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="comment">// omitted.</span>

            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception in tasklet.</span><span class="delimiter">&quot;</span></span>, e);   <span class="comment">// (2)</span>
            <span class="keyword">throw</span> e;    <span class="comment">// (3)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>try-catch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, the stack trace of the exception that occurred is logged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throw the exception again to roll back the transaction.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Job"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Job"></a>6.2.2.2. Job-level exception handling</h5>
<div class="paragraph">
<p>Exception handling method on a job level is explained.<br>
It is a common handling method for chunk model and tasklet model.</p>
</div>
<div class="paragraph">
<p>Implement errors such as system exception and fatal error etc. in job level
<a href="#Ch04_Listener_Overview_Types_JobExecutionListener">JobExecutionListener</a> interface.</p>
</div>
<div class="paragraph">
<p>In order to collectively define exception handling processing, handling is performed on a job level without defining handling processing for each step.<br>
In the exception handling here, do output log and setting ExitCode, do not implement transaction processing.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Prohibition of transaction processing</div>
<div class="paragraph">
<p>The processing performed by <code>JobExecutionListener</code> is out of the scope of business transaction management.
Therefore, it is prohibited to execute transaction processing in exception handling on a job level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here, an example of handling an exception when occurs in ItemProcessor is shown.
For details on how to set the listener,please refer <a href="#Ch04_Listener_HowToUse_Configuration">Listner setting</a>.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="directive">private</span> StepExecution stepExecution;

    <span class="comment">// (1)</span>
    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="local-variable">this</span>.stepExecution = stepExecution;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (2)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (3)</span>
            stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR_ITEM</span><span class="delimiter">&quot;</span></span>, item);
            <span class="comment">// (4)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exception handling implementation in JobExecutionListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobErrorLoggingListener</span> <span class="directive">implements</span> JobExecutionListener {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobErrorLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// do nothing.</span>
    }

    <span class="comment">// (5)</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {

        <span class="comment">// whole job execution</span>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Throwable</span>&gt; exceptions = jobExecution.getAllFailureExceptions(); <span class="comment">// (6)</span>
        <span class="comment">// (7)</span>
        <span class="keyword">if</span> (exceptions.isEmpty()) {
            <span class="keyword">return</span>;
        }
        <span class="comment">// (8)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">This job has occurred some exceptions as follow. </span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">[job-name:{}] [size:{}]</span><span class="delimiter">&quot;</span></span>,
                jobExecution.getJobInstance().getJobName(), exceptions.size());
        <span class="keyword">for</span> (<span class="predefined-type">Throwable</span> th : exceptions) {
            logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception has occurred in job.</span><span class="delimiter">&quot;</span></span>, th);
        }
        <span class="comment">// (9)</span>
        <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions()) {
            <span class="predefined-type">Object</span> errorItem = stepExecution.getExecutionContext()
                    .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR_ITEM</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (10)</span>
            <span class="keyword">if</span> (errorItem != <span class="predefined-constant">null</span>) {
                logger.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">detected error on this item processing. </span><span class="delimiter">&quot;</span></span> +
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">[step:{}] [item:{}]</span><span class="delimiter">&quot;</span></span>, stepExecution.getStepName(),
                        errorItem);
            }
        }

    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In order to output error data with <code>JobExecutionListener</code>, get the <code>StepExecution</code> instance before step execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>try-catch</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, error data is stored in the context of the <code>StepExecution</code> instance with the key <code>ERROR_ITEM</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Throw an exception to do exception handling with <code>JobExecutionListener</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling in <code>afterJob</code> method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">From the argument <code>jobExecution</code> it gets error information which occurred in the entire job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If there is no error information, it is determined as normal termination.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If there is error information, exception handling is performed.<br>
In this example, log output with stack trace is done for all exceptions that occurred.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In this example, when there is error data, log output is performed.<br>
Get the <code>StepExecution</code> instance from all the steps defined in the job and check whether the error data is stored with the key <code>ERROR_ITEM</code>.
If it is stored, it is logged as error data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Object to be stored in ExecutionContext</div>
<div class="paragraph">
<p>The object to be stored in <code>ExecutionContext</code> must be a class that implements <code>java.io.Serializable</code>.
This is because <code>ExecutionContext</code> is stored in <code>JobRepository</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Determination_continued"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Determination_continued"></a>6.2.2.3. Determination as to whether processing can be continued</h5>
<div class="paragraph">
<p>How to decide whether or not to continue processing jobs when an exception occurs is explained.</p>
</div>
<div class="ulist">
<div class="title">Process continuation propriety method list</div>
<ul>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip">Skip</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Retry">Retry</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Interruption">Process interruption</a></p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip"></a>6.2.2.3.1. Skip</h6>
<div class="paragraph">
<p>A method of skipping an erroneous record and continuing processing is described.</p>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk"></a>Chunk model</h7>
<div class="paragraph">
<p>In the chunk model, the implementation method differs for components of each processing</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>before applying the contents described here, make sure to read <a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">About reason why &lt;skippable-exception-classes&gt; is not used</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemReader">Skip with ItemReader</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemProcessor">Skip with ItemProcessor</a></p>
</li>
<li>
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemWriter">Skip with ItemWriter</a></p>
</li>
</ul>
</div>
<div id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemReader" class="dlist">
<dl>
<dt class="hdlist1">Skip with ItemReader</dt>
<dd>
<p>Specify the skip method in <code>skip-policy</code> attribute of <code>&lt;batch:chunk&gt;</code>.
In <code>&lt;batch:skippable-exception-classes&gt;</code>, specify the exception class that occurs in the ItemReader to be skipped<br>
For the <code>skip-policy</code> attribute, use one of the following classes provided by Spring Batch.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">skip-policy list</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Class name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_SkipPolicy_AlwaysSkipItemSkipPolicy">AlwaysSkipItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Always skip.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_SkipPolicy_NeverSkipItemSkipPolicy">NeverSkipItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not skip.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_SkipPolicy_LimitCheckingItemSkipPolicy">LimitCheckingItemSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip until the upper limit of the specified number of skips is reached.<br>
When the upper limit value is reached, the following exception occurs.<br>
<code>org.springframework.batch.core.step.skip.SkipLimitExceededException</code></p>
<p class="tableblock">This is the skipping method used by default when <code>skip-policy</code> is omitted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch06_ExceptionHandling_SkipPolicy_ExceptionClassifierSkipPolicy">ExceptionClassifierSkipPolicy</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use this when you want to change <code>skip-policy</code> which applies to each exception.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Implementation example of skipping is explained.</p>
</div>
<div class="paragraph">
<p>Handle case where an incorrect record exists when reading a CSV file with <code>FlatFileItemReader</code>.<br>
The following exceptions occur at this time.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.ItemReaderException</code>(Base exception class)</p>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.file.FlatFileParseException</code> (Exception occured class)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>skip-policy</code> shows how to define it separately.</p>
</div>
<div class="listingblock">
<div class="title">Definition of ItemReader as a prerequisite</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['inputFile']}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.BeanWrapperFieldSetMapper</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:targetType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div id="Ch06_ExceptionHandling_SkipPolicy_AlwaysSkipItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">AlwaysSkipItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">Specification example of AlwaysSkipItemSkipPolicy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.AlwaysSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipAllReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipAllReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>AlwaysSkipItemSkipPolicy</code> as a bean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the bean defined in (1) to the <code>skip-policy</code> attribute of <code>&lt;batch:chunk&gt;</code></p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_SkipPolicy_NeverSkipItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">NeverSkipItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">Specification example of NeverSkipItemSkipPolicy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.NeverSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipNeverReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtSkipNeverReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>NeverSkipItemSkipPolicy</code>as a bean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the bean defined in (1) to the <code>skip-policy</code> attribute of <code>&lt;batch:chunk&gt;</code>.</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_SkipPolicy_LimitCheckingItemSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">LimitCheckingItemSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">Specification example of LimitCheckingItemSkipPolicy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">(1)
<span class="comment">&lt;!--
&lt;bean id=&quot;skipPolicy&quot;
      class=&quot;org.springframework.batch.core.step.skip.LimitCheckingItemSkipPolicy&quot;/&gt;
--&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>  <span class="comment">&lt;!-- (2) --&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;batch:skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- (4) --&gt;</span>
                    <span class="tag">&lt;batch:include</span>
                        <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.ItemReaderException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>LimitCheckingItemSkipPolicy</code> as a bean.<br>
The <code>skip-policy</code> attribute is omitted by default, so it does not have to be defined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the upper limit value of skip number in the <code>skip-limit</code> attribute of <code>&lt;batch:chunk&gt;</code><br>
The <code>skip-policy</code> attribute is omitted by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>&lt;batch:skippable-exception-classes&gt;</code> and set the targetted exception in the tag.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>ItemReaderException</code> as a skip target class.</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_SkipPolicy_ExceptionClassifierSkipPolicy" class="dlist">
<dl>
<dt class="hdlist1">ExceptionClassifierSkipPolicy</dt>
</dl>
</div>
<div class="listingblock">
<div class="title">ExceptionClassifierSkipPolicy specification example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.ExceptionClassifierSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">policyMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (2) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.ItemReaderException</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">value-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alwaysSkip</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>
<span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alwaysSkip</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.step.skip.AlwaysSkipItemSkipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidNolimitSkipReadError</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidNolimitSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- skip-limit value is dummy. --&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">skipPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (4) --&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>ExceptionClassifierSkipPolicy</code> as a bean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the <code>policyMap</code> property to a map whose key is an exception class and whose value is skipped.<br>
In this example, when <code>ItemReaderException</code> occurs, it is set to be the skip method defined in (3).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the skipping method you want to execute by exception.<br>
In this example, <code>AlwaysSkipItemSkipPolicy</code> is defined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the bean defined in (1) to the <code>skip-policy</code> attribute of <code>&lt;batch:chunk&gt;</code>.</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemProcessor" class="dlist">
<dl>
<dt class="hdlist1">Skip on ItemProcessor</dt>
<dd>
<p>Try ~ catch in ItemProcessor and return null.<br>
Skip with <code>skip-policy</code> is not used because reprocessing occurs in ItemProcessor.
For details, please refer <a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">About reason why &lt;skippable-exception-classes&gt; is not used</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Restrictions on exception handling in ItemProcessor</div>
<div class="paragraph">
<p>As in <a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">About reason why &lt;skippable-exception-classes&gt; is not used</a>,、
In ItemProcessor, skipping using <code>&lt;batch:skippable-exception-classes&gt;</code> is forbidden.
Therefore,cannot skip applying "How to use the <a href="#Ch04_Listener_Overview_Types_ItemProcessListener">ItemProcessListener</a> interface."  explained in
<a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor">Coding point (ItemProcessor)</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implementation example of skip.</p>
</div>
<div class="paragraph">
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor_TryCatchExample">Implementation example of try~catch in ItemProcessor</a> of
<a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk_ItemProcessor">Coding point (ItemProcessor)</a>
correspond to skip.</p>
</div>
<div class="listingblock">
<div class="title">try~catch example in ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">AmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item) <span class="directive">throws</span> <span class="exception">Exception</span> {
        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            checkAmount(item.getAmount(), amountLimit);
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred while processing. Skipped. [item:{}]</span><span class="delimiter">&quot;</span></span>,
                    item, ae); <span class="comment">// (2)</span>
            <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// (3)</span>
        }
        <span class="keyword">return</span> item;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>try～catch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling<br>
In this example, the stack trace of the exception acquired from the argument is logged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skip error data by returning null.</p></td>
</tr>
</tbody>
</table>
<div id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Chunk_ItemWriter" class="dlist">
<dl>
<dt class="hdlist1">Skip with ItemWriter</dt>
<dd>
<p>In ItemWriter skip processing is not done generally.<br>
Even when skipping is necessary, skipping by <code>skip-policy</code> will not be used as the chunk size will change.
For details, please refer <a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">About reason why &lt;skippable-exception-classes&gt; is not used</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect6">
<h7 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Tasklet"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Skip_Tasklet"></a>Tasket model</h7>
<div class="paragraph">
<p>Handle exceptions in business logic and implement processing to skip error records independently.</p>
</div>
<div class="paragraph">
<p><a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet_TaskletExample">Implementation example</a> of
<a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet">Exception handling in tasklet model</a>
corresponds to skip.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example with tasklet model</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesPerformanceTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(SalesPerformanceTasklet.class);

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        <span class="keyword">try</span> {
            reader.open(chunkContext.getStepContext().getStepExecution()
                    .getExecutionContext());

            <span class="predefined-type">List</span>&lt;SalesPerformanceDetail&gt; items = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(<span class="integer">10</span>);
            SalesPerformanceDetail item = <span class="predefined-constant">null</span>;
            <span class="keyword">do</span> {
                <span class="comment">// Pseudo operation of ItemReader</span>
                <span class="comment">// omitted.</span>

                <span class="comment">// Pseudo operation of ItemProcessor</span>
                checkAmount(item.getAmount(), amountLimit);


                <span class="comment">// Pseudo operation of ItemWriter</span>
                <span class="comment">// omitted.</span>

            } <span class="keyword">while</span> (item != <span class="predefined-constant">null</span>);
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            logger.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">exception in tasklet. Skipped.</span><span class="delimiter">&quot;</span></span>, e);   <span class="comment">// (2)</span>
            <span class="keyword">continue</span>;    <span class="comment">// (3)</span>
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                reader.close();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                <span class="comment">// do nothing.</span>
            }
        }

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement <code>try-catch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implement exception handling.<br>
In this example, the stack trace of the exception that occurred is logged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processing of error data is skipped by continue.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Retry"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Retry"></a>6.2.2.3.2. Retry</h6>
<div class="paragraph">
<p>When an exception is detected, a method of reprocessing until the specified number of times is reached is described.</p>
</div>
<div class="paragraph">
<p>For retry, it is necessary to consider various factors such as the presence or absence of state management and the situation where retry occurs,
there is no reliable method, and retrying it unnecessarily deteriorates the situation.</p>
</div>
<div class="paragraph">
<p>Therefore, this guideline explains how to use <code>org.springframework.retry.support.RetryTemplate</code> which implements a local retry.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As with skip, there is also a way to specify the target exception class with <code>&lt;retryable-exception-classes&gt;</code>.
However, as with <a href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses">About reason why &lt;skippable-exception-classes&gt; is not used</a>
There is a side effect that causes performance degradation, so TERASOLUNA Batch 5.x does not use it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">RetryTemplate Implementation code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RetryableAmountCheckProcessor</span> <span class="directive">implements</span>
        ItemProcessor&lt;SalesPerformanceDetail, SalesPerformanceDetail&gt; {

    <span class="comment">// omitted.</span>

    <span class="comment">// (1)</span>
    <span class="directive">private</span> RetryPolicy retryPolicy;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SalesPerformanceDetail process(SalesPerformanceDetail item)
            <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (2)</span>
        RetryTemplate rt = <span class="keyword">new</span> RetryTemplate();
        <span class="keyword">if</span> (retryPolicy != <span class="predefined-constant">null</span>) {
            rt.setRetryPolicy(retryPolicy);
        }

        <span class="keyword">try</span> {
            <span class="comment">// (3)</span>
            rt.execute(<span class="keyword">new</span> RetryCallback&lt;SalesPerformanceDetail, <span class="exception">Exception</span>&gt;() {
                <span class="annotation">@Override</span>
                <span class="directive">public</span> SalesPerformanceDetail doWithRetry(RetryContext context) <span class="directive">throws</span> <span class="exception">Exception</span> {
                    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">execute with retry. [retry-count:{}]</span><span class="delimiter">&quot;</span></span>, context.getRetryCount());
                    <span class="comment">// retry mocking</span>
                    <span class="keyword">if</span> (context.getRetryCount() == adjustTimes) {
                        item.setAmount(item.getAmount().divide(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">10</span>)));
                    }
                    checkAmount(item.getAmount(), amountLimit);
                    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
                }
            });
        } <span class="keyword">catch</span> (<span class="exception">ArithmeticException</span> ae) {
            <span class="comment">// (4)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">check error at processor.</span><span class="delimiter">&quot;</span></span>, ae);
        }
        <span class="keyword">return</span> item;
    }

    <span class="directive">public</span> <span class="type">void</span> setRetryPolicy(RetryPolicy retryPolicy) {
        <span class="local-variable">this</span>.retryPolicy = retryPolicy;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch06.exceptionhandling.RetryableAmountCheckProcessor</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:retryPolicy-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>

<span class="comment">&lt;!-- (6) (7) (8)--&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.retry.policy.SimpleRetryPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:maxAttempts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:retryableExceptions-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.ArithmeticException</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/util:map&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store the retry condition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create an instance of RetryTemplate.<br>
The default retry count = 3, all exceptions are subject to retry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the <code>RetryTemplate#execute</code> method to execute the business logic you wish to retry<br>
Execute only the part that you want to retry with the <code>RetryTemplate#execute</code> method, not the entire business logic.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception handling when the number of retries exceeds the specified number of times<br>
The exception that occurs in the business logic is thrown as it is.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the retry condition defined in (6).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the retry condition in the class that implements <code>org.springframework.retry.RetryPolicy</code>.<br>
In this example, we use <code>SimpleRetryPolicy</code> which is provided by Spring Batch.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the number of retries in the <code>maxAttempts</code> constructor argument.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the map that defines the target exception to be retried defined in (9) in <code>retryableExceptions</code> of the constructor argument.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a map in which the target exception class to be retried and the boolean value are set in the key<br>
If the boolean value is <code>true</code>, target exception is retried.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Interruption"><a class="anchor" href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Interruption"></a>6.2.2.3.3. Process interruption</h6>
<div class="paragraph">
<p>If you want to abort step execution, throw RuntimeException or its subclass other than skip / retry object.</p>
</div>
<div class="paragraph">
<p>Implementation example of skip is shown based on <a href="#Ch06_ExceptionHandling_SkipPolicy_LimitCheckingItemSkipPolicy">LimitCheckingItemSkipPolicy</a></p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfAtValidSkipReadError.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- (1) --&gt;</span>
                    <span class="tag">&lt;batch:include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.validator.ValidationException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/batch:chunk&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If an exception other than <code>ValidationException</code> occurs, processing is interrupted.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An implementation example of retry is shown based on  <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Retry">Retry</a>.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.retry.policy.SimpleRetryPolicy</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:maxAttempts</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">c:retryableExceptions-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exceptionMap</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.UnsupportedOperationException</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/util:map&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSalesPerfWithRetryPolicy.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailCSVReader</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountCheckProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">detailWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If an exception other than <code>UnsupportedOperationException</code> occurs, processing is interrupted.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_ExceptionHandling_Appendix"><a class="anchor" href="#Ch06_ExceptionHandling_Appendix"></a>6.2.3. Appendix</h4>
<div class="sect4">
<h5 id="Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses"><a class="anchor" href="#Ch06_ExceptionHandling_Appendix_SkippableExceptionClasses"></a>6.2.3.1. About reason why &lt;skippable-exception-classes&gt; is not used</h5>
<div class="paragraph">
<p>Spring Batch provides a function to specify an exception to be skipped for the entire job, skip processing the item where the exception occurred, and continue the processing.</p>
</div>
<div class="paragraph">
<p>It implements the function by setting the <code>&lt;skippable-exception-classes&gt;</code> tag under the <code>&lt;chunk&gt;</code> tag and specifying the exception to be skipped as follows.</p>
</div>
<div class="listingblock">
<div class="title">Usage example of &lt;skippable-exception-classes&gt;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">flowJob</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">retryStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tasklet&gt;</span>
            <span class="tag">&lt;chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemWriter</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">skip-limit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;skippable-exception-classes&gt;</span>
                    <span class="comment">&lt;!-- specify exceptions to the skipped --&gt;</span>
                    <span class="tag">&lt;include</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Exception</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;exclude</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.NullPointerException</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/skippable-exception-classes&gt;</span>
            <span class="tag">&lt;/chunk&gt;</span>
        <span class="tag">&lt;/tasklet&gt;</span>
    <span class="tag">&lt;/step&gt;</span>
<span class="tag">&lt;/job&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By using this function, it is possible to skip the record where the input check error has occurred and continue processing the subsequent data,
For TERASOLUNA Batch 5.x it is not used for the following reasons.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If an exception is skipped using the  <code>&lt;skippable-exception-classes&gt;</code> tag,
since the number of data items included in one chunk varies, performance deterioration may occur.</p>
<div class="ulist">
<ul>
<li>
<p>This depends on where the exception occurred (<code> ItemReader</code> / <code> ItemProcessor</code> / <code> ItemWriter</code>). Details are described later.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Avoid using SkipPolicy without defining &lt;skippable-exception-classes&gt;</div>
<div class="paragraph">
<p>All exceptions are implicitly registered, and the possibility of performance degradation increases dramatically.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The behavior of each exception occurrence (<code> ItemReader</code> / <code> ItemProcessor</code> / <code> ItemWriter</code>) is explained respectively.<br>
The transaction operation is not processed regardless of where the exception occurred, but if an exception occurs, it is always rolled back and then processed again.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">When an exception occurs in ItemReader</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>When an exception occurs in the process of <code>ItemReader</code>, the processing object moves to the next item.</p>
</li>
<li>
<p>There is no side effect by this.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">When an exception occurs in ItemProcessor</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>If an exception occurs within the processing of <code> ItemProcessor</code>, return to the beginning of the chunk and reprocess from the first.</p>
</li>
<li>
<p>Items to be skipped for reprocessing are not included.</p>
</li>
<li>
<p>The chunk size at the first processing and reprocessing does not change.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">When an exception occurs in ItemWriter</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>If an exception occurs within the processing of <code>ItemWriter</code>, return to the beginning of the chunk and reprocess from the first.</p>
</li>
<li>
<p>Reprocessing is fixed to <code>ChunkSize=1</code> and executed one by one.</p>
</li>
<li>
<p>Items to be skipped for reprocessing are also included.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If an exception occurs in <code>ItemProcessor</code>, considering the case of <code>ChunkSize=1000</code> as an example,
when an exception occurs on the 1000th case, reprocessing is done from the 1st and total of 1999 processes are executed.</p>
</div>
<div class="paragraph">
<p>If an exception occurs in <code>ItemWriter</code>, <code>ChunkSize=1</code> is fixed and reprocessed.
Considering the case of <code> ChunkSize = 1000</code> as an example,
it is divided into 1000 transactions regardless of originally 1 transaction and processed.</p>
</div>
<div class="paragraph">
<p>These means that the processing time of the entire job is prolonged, and there is a high possibility of deteriorating the situation at the time of abnormality.
In addition, there is a possibility that the double treatment itself becomes a problem, and it gives rise to additional consideration to the design manufacturing.</p>
</div>
<div class="paragraph">
<p>Therefore, we do not recommend using <code>&lt;skippable-exception-classes&gt;</code>.
Skipping data that failed in <code>ItemReader</code> does not cause these problems,
in order to prevent accidents, basically avoid it and apply it only when it is absolutely necessary.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch06_RerunRestart"><a class="anchor" href="#Ch06_RerunRestart"></a>6.3. Restart processing</h3>
<div class="sect3">
<h4 id="Ch06_RerunRestart_Overview"><a class="anchor" href="#Ch06_RerunRestart_Overview"></a>6.3.1. Overview</h4>
<div class="paragraph">
<p>After the job gets terminated abnormally due to occurence of some failure,means to recover to restart the job is explained.</p>
</div>
<div class="paragraph">
<p>Since this function has different usage for chunk model and tasklet model, each will be explained.</p>
</div>
<div class="paragraph">
<p>There are the following methods to restart a job.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Job rerun</p>
</li>
<li>
<p>Job restart</p>
<div class="ulist">
<ul>
<li>
<p>Stateless restart</p>
<div class="ulist">
<ul>
<li>
<p>Number based restart</p>
</li>
</ul>
</div>
</li>
<li>
<p>Stateful restart</p>
<div class="ulist">
<ul>
<li>
<p>Determine processing status, restart process to extract unprocessed data</p>
<div class="ulist">
<ul>
<li>
<p>It is necessary to separately implement a process for identifying the processing state</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is terminology definition:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Rerun</dt>
<dd>
<p>Redoing the job from the beginning.<br>
As a preliminary work, it is necessary to recover to the state before failure occurred such as initializing data,at the time of starting the job.</p>
</dd>
<dt class="hdlist1">Restart</dt>
<dd>
<p>Resume the processing from where the job was interrupted.<br>
It is necessary to design/implement retention of restart position processing, acquisition method, data skip method till restart position etc in advance.<br>
There are two types of restart, stateless and stateful.</p>
</dd>
<dt class="hdlist1">Stateless restart</dt>
<dd>
<p>A restart method not considering the state (unprocessed / processed) for each input data.</p>
</dd>
<dt class="hdlist1">Number based restart</dt>
<dd>
<p>One of stateless restart.<br>
A method of retaining the processed input data count and skipping that input data at the time of restart.<br>
If the output is a non-transactional resource, it is also necessary to hold the output position and move the write position to that position at the time of restart.</p>
</dd>
<dt class="hdlist1">Stateful restart</dt>
<dd>
<p>A restart method in which the state (unprocessed / processed) for each input data is judged, and only unprocessed data is acquired as an acquisition condition.<br>
If the output is a non-transactional resource, make the resource additional, and at the time of restart, add it to the previous result.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Generally rerun is the easiest way to re-execute.
With Rerun &lt; Stateless restart &lt; Stateful restart order, it becomes difficult to design and implement.
Of course, it is always preferable to use rerun if possible,
For each job that the user implements, please consider which method to apply depending on the allowable batch window and processing characteristics.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch06_RerunRestart_HowToUse"><a class="anchor" href="#Ch06_RerunRestart_HowToUse"></a>6.3.2. How to use</h4>
<div class="paragraph">
<p>Implementation method of Rerun and restart is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Rerun"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Rerun"></a>6.3.2.1. Job rerun</h5>
<div class="paragraph">
<p>How to implement job rerun is explained.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Preliminary work of data recovery such as initialization of data before re-run is carried out.</p>
</li>
<li>
<p>Execute the failed job again with the same condition (same parameter).</p>
<div class="ulist">
<ul>
<li>
<p>In Spring Batch, if you execute a job with the same parameters, it will be treated as double execution, but TERASOLUNA Batch 5.x treats it as a separate job<br>
For details,please refer<a href="#Ch04_JobParameter_HowToUse_Converter">"About parameter conversion class"</a>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Restart"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Restart"></a>6.3.2.2. Job restart</h5>
<div class="paragraph">
<p>How to restart a job is explained.</p>
</div>
<div class="paragraph">
<p>When restarting a job, it is basically done on a job executed synchronously.</p>
</div>
<div class="paragraph">
<p>It is recommended that asynchronously executed jobs should be designed with a corresponding job design with a rerun instead of a restart.
This is difficult to judge whether it is <strong>"intended restart execution"</strong> or <strong>"unintended duplicate execution"</strong>,
this is because there is a possibility of confusion in operation.</p>
</div>
<div class="paragraph">
<p>If restart requirements can not be excluded for asynchronous execution job,
The following methods can be used to clarify <strong>"intended restart execution"</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restart by <code>-restart</code> of <code>CommandLineJobRunner</code></p>
<div class="ulist">
<ul>
<li>
<p>Restart asynchronously executed job separately from synchronous execution. It becomes effective when progressing the recovery process sequentially.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Restart by <code>JobOperator#restart(JobExecutionId)</code></p>
<div class="ulist">
<ul>
<li>
<p>Restart the asynchronously executed job on the mechanism of asynchronous execution again.It is effective when progressing with recovery processing collectively.</p>
<div class="ulist">
<ul>
<li>
<p><a href="#">Asynchronous execution(DB polling)</a> does not support restart. Therefore, it is necessary to implement it separately by the user.</p>
</li>
<li>
<p><a href="#">Asynchronous execution(Web container)</a> guides how to implement restart.User implements it according to this description.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About restart when there is input check</div>
<div class="paragraph">
<p>The input check error is not recoverable unless the input resource causing the check error is corrected.
For reference, an input resource correction example when an input check error occurs is shown below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When an input check error occurs, log output is performed so that the target data can be specified.</p>
</li>
<li>
<p>Based on the output log information, correct the input data.</p>
<div class="ulist">
<ul>
<li>
<p>Make sure that the order of input data does not change.</p>
</li>
<li>
<p>Correction method differs according to generation method of input resource.</p>
<div class="ulist">
<ul>
<li>
<p>Correct manually</p>
</li>
<li>
<p>Recreate with job etc</p>
</li>
<li>
<p>Retransmission from collaboration source</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Deploy corrected input data and execute restart.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">In the case of multiple processing (Partition Step)</div>
<div class="paragraph">
<p>When restarting in <a href="#Ch08_ParallelAndMultiple_Partitioning">"multiple processing(Partition Step)"</a>,
processing is carried out again <strong>from split processing</strong>.
When all of the data are processed as the result of dividing the data, unnecessary splitting is performed and recorded on <code>JobRepository</code>,
there is no problem such as data inconsistency caused by this.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Restart_Stateless"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Restart_Stateless"></a>6.3.2.3. Stateless restart</h5>
<div class="paragraph">
<p>How to implement stateless restart is explained.</p>
</div>
<div class="paragraph">
<p>Stateless restart with TERASOLUNA Batch 5.x refers to a number based restart.This is implemented by using the mechanism of Spring Batch as it is.<br>
The number based restart can be used in job execution of chunk model.
In addition, the number based restart uses context information about inputs and outputs registered in <code>JobRepository</code>.
Therefore, in a number based restart, it is assumed that <code>JobRepository</code> does not use the in-memory database, but uses persistence guaranteed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About failure occurence of JobRepository</div>
<div class="paragraph">
<p>Updating to <code>JobRepository</code> is done in transactions that are independent of transactions of the database used by the business process.<br>
In other words, only the failure to the business process is subject to recovery.<br>
This means that if a failure occurs in <code>JobRepository</code>, there is a possibility that it will deviate from the actual count of processes,
it means that there is a danger of double processing at restart.<br>
Therefore, it is necessary to consider how to deal with failure. For example, design availability of <code>JobRepository</code> higher, then review rerun&#8217;s method in advance, and so on.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Input at restart</dt>
<dd>
<p>Since most of the ItemReaders provided by Spring Batch are compatible with the number-based restart, special support is not necessary.<br>
If you want to create a number based restartable ItemReader yourself, the following abstract classes can be extended that have restart processing implemented.</p>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.item.support.AbstractItemCountingItemStreamItemReader</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1"></dt>
<dd>
<p>Since the number based restart determines the restart starting point based only on the number of items to the last, it can not detect change / addition / deletion of input data.
Often the input data is corrected after the job ends abnormally,
When data change like the following, be careful as there will be a difference in the output between,
the result after the job ends normally and the result after the job ends abnormally is restarted and recovered.</p>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Change the data acquisition order</p>
<div class="ulist">
<ul>
<li>
<p>At the time of restart, duplicate or unprocessed data will get generated, so never go as it results in a different recovery result from the result of rerun.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Update processed data</p>
<div class="ulist">
<ul>
<li>
<p>Since the data updated at the time of restarting is skipped, it is not preferred as there are cases where rerun result and the recovered result by restart result changes.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Update or add unprocessed data</p>
<div class="ulist">
<ul>
<li>
<p>As rerun result and recovered result becomes same, its allowed. However, it is different from the result of the normal termination in the first execution.
This should be used when patching abnormal data in an emergency coping manner or when processing as much as possible data received at the time of execution.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">Output at Restart</dt>
<dd>
<p>Care must be taken in output to non-transactional resources. For example in a file, it is necessary to grasp the position to which the output was made and output from that position.<br>
The <code>FlatFileItemWriter</code> provided by Spring Batch gets the previous output position from the context and outputs from that position at the time of restart, so no special countermeasure is necessary.<br>
For transactional resources, since rollback is performed at the time of failure, it is possible to perform processing without taking any special action at restart.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the above conditions are satisfied, add the option <code>-restart</code> to the failed job and execute it again.
Below an example of job restart is shown.</p>
</div>
<div class="listingblock">
<div class="title">Restart example of synchronous job</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (1)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; -restart</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr.No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At <code>CommandLineJobRunner</code>specify the failed job&#8217;s job bean path and job name, add <code>-restart</code>and execute it<br>
Since job parameters are restored from <code>JobRepository</code>, it is not necessary to specify them.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An example of restarting a job executed in asynchronous execution (DB polling) is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Restart example of job executed in asynchronous execution (DB polling)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (1)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;JobExecutionId&gt; -restart</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr.No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Run <code>CommandLineJobRunner</code>by specifying the same job execution ID (JobExecutionId) as the failed job and adding <code>-restart</code>.<br>
Since job parameters are restored from <code>JobRepository</code>, it is not necessary to specify them.</p>
<p class="tableblock">The job execution ID can be acquired from the job-request-table.
About the job-request-table, please refer <a href="#Ch04_AsyncJobWithDB_Arch_RequireTable">"About polling table"</a>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Output log of job execution ID</div>
<div class="paragraph">
<p>In order to promptly specify the job execution ID of the abnormally terminated job,
It is recommended to implement a listener or exception handling class that logs the job execution ID when the job ends or when an exception occurs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An example of restart in asynchronous execution (Web container) is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Examples of restarting jobs executed in asynchronous execution (web container)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">long</span> restart(<span class="type">long</span> JobExecutionId) <span class="directive">throws</span> Execption {
  <span class="keyword">return</span> jobOperator.restart(JobExecutionId); <span class="comment">// (1)</span>
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sr.No.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the same job execution ID (JobExecutionId) as the failed job to <code>JobOperator</code> and execute it with <code>restart</code> method.<br>
Job parameters are restored from <code>JobRepository</code>.</p>
<p class="tableblock">The job execution ID can be obtained from the ID acquired when executing the job with the web application or from <code>JobRepository</code>.
For acquisition method, please refer <a href="#Ch07_JobManagement_JobStatusManagement">"Job status management"</a>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch06_RerunRestart_HowToUse_Restart_Statefull"><a class="anchor" href="#Ch06_RerunRestart_HowToUse_Restart_Statefull"></a>6.3.2.4. Stateful restart</h5>
<div class="paragraph">
<p>How to achieve stateful restart is explained.</p>
</div>
<div class="paragraph">
<p>Stateful restart is a method of reprocessing by acquiring only unprocessed data together with input/output results at the time of execution.
Although this method is difficult to design such as state retaining / determination unprocessed etc, it is sometimes used because it has a strong characteristic in data change.</p>
</div>
<div class="paragraph">
<p>In stateful restart, since restart conditions are determined from input / output resources, persistence of <code>JobRepository</code> becomes unnecessary.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Input at restart</dt>
<dd>
<p>Prepare an ItemReader that implements logic that acquires only unprocessed data with input / output results.</p>
</dd>
<dt class="hdlist1">Output at restart</dt>
<dd>
<p>Similar to <a href="#Ch06_RerunRestart_HowToUse_Restart_Stateless">Stateless restart</a> caution is required for output to non-transactional resource.<br>
In the case of a file, assuming that the context is not used, it is necessary to design such that file addition is permitted.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Stateful restart,similar to <a href="#Ch06_RerunRestart_HowToUse_Rerun">Job rerun</a> reruns the job with the same condition as with the failed job.<br>
Unlike stateless restart, <code>-restart</code> option is not used.</p>
</div>
<div class="paragraph">
<p>An example of implementing an easy stateful restart is shown below.</p>
</div>
<div class="olist arabic">
<div class="title">Processing specification</div>
<ol class="arabic">
<li>
<p>Define a processed column in the input target table, and update it with a value other than NULL if the processing succeeds.</p>
<div class="ulist">
<ul>
<li>
<p>For the extraction condition of unprocessed data, the value of the processed column is NULL.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Output the processing result to a file.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">RestartOnConditionRepository.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByProcessedIsNull</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, customer_id AS customerId, amount
    FROM
        sales_plan_detail
    WHERE
        processed IS NULL
    ORDER BY
        branch_id ASC, year ASC, month ASC, customer_id ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;update</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.plan.SalesPlanDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    UPDATE
        sales_plan_detail
    SET
        processed = '1'
    WHERE
        branch_id = #{branchId}
    AND
        year = #{year}
    AND
        month = #{month}
    AND
        customer_id = #{customerId}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/update&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">restartOnConditionBasisJob.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (3) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch06.reprocessing.repository.RestartOnConditionRepository.findByZeroOrLessAmount</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dbWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisBatchItemWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:statementId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch06.reprocessing.repository.RestartOnConditionRepository.update</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionTemplate-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">batchModeSqlSessionTemplate</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['outputFile']}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:appendAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineAggregator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldExtractor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId,year,month,customerId,amount</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>
<span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.support.CompositeItemWriter</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delegates</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">bean</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dbWriter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restartOnConditionBasisJob</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restartable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (7) --&gt;</span>

    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">restartOnConditionBasisJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">amountUpdateItemProcessor</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">compositeWriter</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example of restart command execution</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># (8)
java -cp dependency/* org.springframework.batch.core.launch.support.CommandLineJobRunner &lt;jobPath&gt; &lt;jobName&gt; &lt;jobParameters&gt; ...</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr.No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define SQL so that the processed column has only NULL data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define SQL to update processed columns with non-NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For ItemReader, set the SQLID defined in (1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For updating to the database, set the SQLID defined in (2).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">At restart,allow addition of files in order to make it possible to write from the last interruption point.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set <code>CompositeItemWriter</code> to be processed in the order of file output &#8594; database update, and set it to chunk writer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is not mandatory, but set the <code>restartable</code> attribute to false so that it will get an error if it is started accidentally with the <code>-restart</code> option.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute again according to the execution condition of the failed job.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About the job&#8217;s restartable attribute</div>
<div class="paragraph">
<p>If <code>restartable</code>is true, as explained in <a href="#Ch06_RerunRestart_HowToUse_Restart_Stateless">Stateless restart</a>, use the context information to skip input / output data.
If you are using ItemReader or ItemWriter provided by Spring Batch in stateful restart, there is a possibility that this process may stop processing as expected.
Therefore, by setting <code>restartable</code> to false, activation with the <code>-restart</code> option will result in an error, preventing malfunction.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch07_JobManagement"><a class="anchor" href="#Ch07_JobManagement"></a>7. Job Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch07_JobManagement_Overview"><a class="anchor" href="#Ch07_JobManagement_Overview"></a>7.1. Overview</h3>
<div class="paragraph">
<p>Explain how to manage job execution.</p>
</div>
<div class="paragraph">
<p>This function is the same usage for chunk model and tasklet model.</p>
</div>
<div class="sect3">
<h4 id="what-is-job-execution-management"><a class="anchor" href="#what-is-job-execution-management"></a>7.1.1. What is Job Execution Management?</h4>
<div class="paragraph">
<p>It means to record the activation state and execution result of the job and maintain the batch system.
In particular, it is important to secure necessary information in order to detect when an abnormality has occurred and determine what action should be taken next (such as rerun / restart after abnormal termination).
Due to the characteristics of the batch application, it is rare that the result can be confirmed on the user interface immediately after startup.
Therefore, it is necessary to have a mechanism to record execution status and results separately from job execution, such as job scheduler / RDBMS / application log.</p>
</div>
<div class="sect4">
<h5 id="functions-offered-by-spring-batch"><a class="anchor" href="#functions-offered-by-spring-batch"></a>7.1.1.1. Functions Offered by Spring Batch</h5>
<div class="paragraph">
<p>Spring Batch provides the following interface for job execution management.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of job management functions</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Corresponding interface</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Record job execution status/result</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.repository.JobRepository</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert job exit code and process exit code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.springframework.batch.core.launch.support.ExitCodeMapper</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Spring Batch uses <code>JobRepository</code> for recording the job&#8217;s activation status and execution result.
For TERASOLUNA Batch 5.x, if all of the following are true, persistence is optional:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using TERASOLUNA Batch 5.x only for synchronous job execution.</p>
</li>
<li>
<p>Managing all job execution with the job scheduler including job stop/restart.</p>
<div class="ulist">
<ul>
<li>
<p>Especially not using restart assuming <code>JobRepository</code> of Spring Batch.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When these are applicable, use <code>H2</code> which is an in-memory/built-in database as an option of RDBMS used by <code>JobRepository</code>.<br>
On the other hand, when using asynchronous execution or when using stop/restart of Spring Batch, an RDBMS that can persist the job execution status/result is required.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Default transaction isolation level</div>
<div class="paragraph">
<p>In xsd provided by Spring Batch, the transaction isolation level of <code>JobRepository</code> has <code>SERIALIZABLE</code> as the default value.
However, in this case, when multiple jobs are executed concurrently regardless of whether it is synchronous or asynchronous, an exception occurs in updating <code>JobRepository</code>.
Therefore, TERASOLUNA Batch 5.x sets the transaction isolation level of <code>JobRepository</code> to <code>READ_COMMITTED</code> in advance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">In-memory JobRepository Options</div>
<div class="paragraph">
<p>Spring Batch has <code>org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean</code>
which performs job execution management in-memory,
but it is not used in this guideline.<br>
As shown in the Javadoc of this class,
It is explained that it is for testing as
<code>This repository is only really intended for use in testing and rapid prototyping.</code>
and  that it is inappropriate for parallel processing as
<code>Not suited for use in multi-threaded jobs with splits</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the job execution management using job scheduler, refer to the manual of each product.<br>
In this guideline,
explain the following items related to managing the job status using <code>JobRepository</code> within TERASOLUNA Batch 5.x.</p>
</div>
<div class="ulist">
<div class="title">Items related to state management within TERASOLUNA Batch</div>
<ul>
<li>
<p><a href="#Ch07_JobManagement_JobStatusManagement">Job Status Management</a></p>
<div class="ulist">
<ul>
<li>
<p>How to persist state</p>
</li>
<li>
<p>How to check the status</p>
</li>
<li>
<p>How to stop the job manually</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch07_JobManagement_ExitCode">Customizing Exit Codes</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_DuplicateSafe">Double Activation Prevention</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_Logging">Logging</a></p>
</li>
<li>
<p><a href="#Ch07_JobManagement_MessageManagement">Message Management</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch07_JobManagement_HowToUse"><a class="anchor" href="#Ch07_JobManagement_HowToUse"></a>7.2. How to use</h3>
<div class="paragraph">
<p><code>JobRepository</code> automatically registers/updates the job status/execution result in RDBMS through Spring Batch.
When confirming them, select one of the following methods so that unintended change processing is not performed from inside or outside the batch application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query the table relating to <a href="#Ch07_JobManagement_JobStatusManagement">Job Status Management</a></p>
</li>
<li>
<p>Use <code>org.springframework.batch.core.explore.JobExplorer</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_JobStatusManagement"><a class="anchor" href="#Ch07_JobManagement_JobStatusManagement"></a>7.2.1. Job Status Management</h4>
<div class="paragraph">
<p>Explain job status management method using <code>JobRepository</code>.<br>
By Spring Batch, the following Entities are registered in the RDBMS table.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Entity class and table name managed by JobRepository</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Entity class</th>
<th class="tableblock halign-left valign-top">Table name</th>
<th class="tableblock halign-left valign-top">Generation unit</th>
<th class="tableblock halign-left valign-top">Desctiption</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution of one job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintain job status/execution result.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION_CONTEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution of one job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintain the context inside the job.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobExecutionParams</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_EXECUTION_PARAMS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution of one job</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hold job parameters given at startup.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_STEP_EXECUTION</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution of one step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintain the state/execution result of the step, commit/rollback number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StepExecutionContext</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_STEP_EXECUTION_CONTEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution of one step</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintain the context inside the step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JobInstance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BATCH_JOB_INSTANCE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Combination of job name and job parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hold job name and string serialized job parameter.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, when three steps are executed with one job execution, the following difference occurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JobExecution</code>, <code>JobExecutionContext</code> and <code>JobExecutionParams</code> register 1 record.</p>
</li>
<li>
<p><code>StepExecution</code> and <code>StepExecutionContext</code> register 3 record.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, <code>JobInstance</code> is used to suppress double execution by the same name job and same parameter started in the past,
TERASOLUNA Batch 5.x does not check this. For details, refer to  <a href="#Ch07_JobManagement_DuplicateSafe">Double Activation Prevention</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The structure of each table by <code>JobRepository</code> is described
in <a href="#">Architecture of Spring Batch</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About the item count of StepExecution in the chunk method</div>
<div class="paragraph">
<p>As shown below, it seems that inconsistency is occurring, but there are cases where it is reasonable from the specification.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The transaction issue count of <code>StepExecution(BATCH_STEP_EXECUTION table)</code> sometimes does not match the number of input data counts.</p>
<div class="ulist">
<ul>
<li>
<p>The number of transaction issues refers to the sum of <code>COMMIT_COUNT</code> and <code>ROLLBACK_COUNT</code> of <code>BATCH_STEP_EXECUTION</code>.<br>
However, <code>COMMIT_COUNT</code> becomes +1 if the number of input data is divisible by the chunk size.<br>
This is because null representing the end is also counted as input data and is processed empty, after reading the number of input data counts.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The number of processing of <code>BATCH_STEP_EXECUTION</code> and <code>BATCH_STEP_EXECUTION_CONTEXT</code> may be different.</p>
<div class="ulist">
<ul>
<li>
<p>In <code>READ_COUNT</code> and <code>WRITE_COUNT</code> of <code>BATCH_STEP_EXECUTION</code>, the number of items read and written by <code>ItemReader</code> and <code>ItemWriter</code> are recorded.</p>
</li>
<li>
<p>The <code>SHORT_CONTEXT</code> column in the <code>BATCH_STEP_EXECUTION_CONTEXT</code> table records the number of read operations by <code>ItemReader</code> in JSON format.
However, it does not necessarily match the number of processing by <code>BATCH_STEP_EXECUTION</code>.<br></p>
</li>
<li>
<p>This means that the <code>BATCH_STEP_EXECUTION</code> table based on the chunk method records the number of reads and writes irrespective of success or failure,
whereas the <code>BATCH_STEP_EXECUTION_CONTEXT</code> table records the position to be resumed by a restart in case of a failure in the course of processing.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_JobStatusManagement_Persistence"><a class="anchor" href="#Ch07_JobManagement_JobStatusManagement_Persistence"></a>7.2.1.1. Status Persistence</h5>
<div class="paragraph">
<p>By using external RDBMS, job execution management information by <code>JobRepository</code> can be made persistent.
To enable this, change the following items in batch-application.properties to be data sources, schema settings for external RDBMS.</p>
</div>
<div class="listingblock">
<div class="title">batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># (1)
# Admin DataSource settings.
admin.jdbc.driver=org.postgresql.Driver
admin.jdbc.url=jdbc:postgresql://serverhost:5432/admin
admin.jdbc.username=postgres
admin.jdbc.password=postgres

# (2)
spring-batch.schema.script=classpath:org/springframework/batch/core/schema-postgresql.sql</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents (PostgreSQL)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Describe the setting of the external RDBMS to be connected as the value of the property to which the prefix <code>admin</code> is attached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify a script file to automatically generate the schema as <code>JobRepository</code> at application startup.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Supplementary to administrative/business data sources</div>
<div class="ulist">
<ul>
<li>
<p>Connection settings to DB are separately defined as management and business data sources.<br>
TERASOLUNA Batch 5.x separately defined,
<code>JobRepository</code> has been set up to use an administrative data source prefixed with <code>admin</code> as its property prefix.</p>
</li>
<li>
<p>When using asynchronous execution (DB polling), specify the same management data source and schema generation script in the job request table.<br>
For details, refer to <a href="#Ch04_AsyncJobWithDB">Asynchronous Execution (DB polling)</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_JobStatusManagement_Retrieve"><a class="anchor" href="#Ch07_JobManagement_JobStatusManagement_Retrieve"></a>7.2.1.2. Confirmation of job status/execution result</h5>
<div class="paragraph">
<p>Explain how to check the job execution status from <code>JobRepository</code><br>
In either method, the job execution ID to be checked is known in advance.</p>
</div>
<div class="sect5">
<h6 id="query-directly"><a class="anchor" href="#query-directly"></a>7.2.1.2.1. Query directly</h6>
<div class="paragraph">
<p>Using the RDBMS console, query directly on the table persisted by <code>JobRepository</code>.</p>
</div>
<div class="listingblock">
<div class="title">SQL sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">admin=<span class="comment"># select JOB_EXECUTION_ID, START_TIME, END_TIME, STATUS, EXIT_CODE from BATCH_JOB_EXECUTION where JOB_EXECUTION_ID = 1;</span>
 job_execution_id |       start_time        |        end_time         |  status   | exit_code
<span class="comment">------------------+-------------------------+-------------------------+-----------+-----------</span>
                <span class="integer">1</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">17</span>:<span class="integer">57</span>:<span class="float">38.486</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">18</span>:<span class="integer">19</span>:<span class="float">45.421</span> | COMPLETED | COMPLETED
(<span class="integer">1</span> <span class="type">row</span>)
admin=<span class="comment"># select JOB_EXECUTION_ID, STEP_EXECUTION_ID, START_TIME, END_TIME, STATUS, EXIT_CODE from BATCH_STEP_EXECUTION where JOB_EXECUTION_ID = 1;</span>
 job_execution_id | step_execution_id |       start_time        |        end_time        |  status   | exit_code
<span class="comment">------------------+-------------------+-------------------------+------------------------+-----------+-----------</span>
                <span class="integer">1</span> |                 <span class="integer">1</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">17</span>:<span class="integer">57</span>:<span class="float">38.524</span> | <span class="integer">2017</span><span class="integer">-02</span><span class="integer">-14</span> <span class="integer">18</span>:<span class="integer">19</span>:<span class="float">45.41</span> | COMPLETED | COMPLETED
(<span class="integer">1</span> <span class="type">row</span>)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-code-jobexplorer-code"><a class="anchor" href="#use-code-jobexplorer-code"></a>7.2.1.2.2. Use <code>JobExplorer</code></h6>
<div class="paragraph">
<p>Under sharing the application context of the batch application, <code>JobExplorer</code> enables to confirm job execution status by injecting it.</p>
</div>
<div class="listingblock">
<div class="title">API code sample</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// omitted.</span>

<span class="annotation">@Inject</span>
<span class="directive">private</span> JobExplorer jobExplorer;

<span class="directive">private</span> <span class="type">void</span> monitor(<span class="type">long</span> jobExecutionId) {

   <span class="comment">// (1)</span>
   JobExecution jobExecution = jobExplorer.getJobExecution(jobExecutionId);

   <span class="comment">// (2)</span>
   <span class="predefined-type">String</span> jobName = jobExecution.getJobInstance().getJobName();
   <span class="predefined-type">Date</span> jobStartTime = jobExecution.getStartTime();
   <span class="predefined-type">Date</span> jobEndTime = jobExecution.getEndTime();
   BatchStatus jobBatchStatus = jobExecution.getStatus();
   <span class="predefined-type">String</span> jobExitCode = jobExecution.getExitStatus().getExitCode();

   <span class="comment">// omitted.</span>

   <span class="comment">// (3)</span>
   <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions())
       <span class="predefined-type">String</span> stepName = stepExecution.getStepName();
       <span class="predefined-type">Date</span> stepStartTime = stepExecution.getStartTime();
       <span class="predefined-type">Date</span> stepEndTime = stepExecution.getEndTime();
       BatchStatus stepStatus = stepExecution.getStatus();
       <span class="predefined-type">String</span> stepExitCode = stepExecution.getExitStatus().getExitCode();

       <span class="comment">// omitted.</span>
   }
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of setting contents (PostgreSQL)</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the job execution ID from the injected <code>JobExplorer</code> and get <code>JobExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the job execution result by <code>JobExecution</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get a collection of steps executed within the job from <code>JobExecution</code> and get individual execution result.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch07_JobManagement_JobStatusManagement_JobStop"><a class="anchor" href="#Ch07_JobManagement_JobStatusManagement_JobStop"></a>7.2.1.3. Stopping a Job</h5>
<div class="paragraph">
<p>"Stopping a job" is a function that updates the running status of <code>JobRepository</code> to a stopping status
and stops jobs at the boundary of steps or at chunk commit by chunk method.<br>
Combined with restart, processing from the stopped position can be restarted.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For details of the restart, refer to <a href="#Ch06_RerunRestart_HowToUse_Restart">"Job Restart"</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>"Stopping a job" is not a function to immediately stop a job in progress but to update the running status of <code>JobRepository</code> to the stopping status.<br>
It does not perform any kind of stop processing such as interrupting the in-process thread immediately for the job.</p>
</div>
<div class="paragraph">
<p>Therefore, it can be said that stopping the job is "to reserve to stop when a processing that becomes a milestone is completed, such as a chunk break".
For example, even if you stop the job under the following circumstances, it will not be the expected behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job execution consisting of <code>Tasklet</code> in a single step.</p>
</li>
<li>
<p>When number of data input &lt; <code>commit-interval</code> in chunk method.</p>
</li>
<li>
<p>When an infinite loop has occurred within processing.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Explain how to stop the job below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop from command line</p>
<div class="ulist">
<ul>
<li>
<p>Available for both synchronous and asynchronous jobs</p>
</li>
<li>
<p>Use <code>-stop</code> option of <code>CommandLineJobRunner</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">The method of specifying the job name at startup</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    classpath:/META-INF/jobs/job01.xml job01 -stop</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Stopping a job by its name specification is suitable for synchronous batch execution when jobs with the same name rarely start in parallel.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">The method of specifying the job execution ID (JobExecutionId)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">$ java org.springframework.batch.core.launch.support.CommandLineJobRunner \
    classpath:/META-INF/jobs/job01.xml 3 -stop</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Stopping a job by JobExecutionId specification is suitable for asynchronous batch execution when jobs with tha same name often start in parallel.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>For the confirmation method of JobExecutionId, refer to <a href="#Ch07_JobManagement_JobStatusManagement_Retrieve">Confirmation of job status/execution result</a>.</p>
</li>
<li>
<p><code>JobOpertion#stop()</code> can be used to stop the job based on the JobExecutionId.<br>
For stopping jobs using <code>JobOperation#stop()</code>,
refer to <a href="#Ch04_AsyncJobWithWeb_HowToExtend_Stop_And_Restart">"Stopping and restarting jobs"</a>.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_ExitCode"><a class="anchor" href="#Ch07_JobManagement_ExitCode"></a>7.2.2. Customizing Exit Codes</h4>
<div class="paragraph">
<p>When the job is terminated by synchronous execution, the exit code of the java process can be customized according to the exit code of the job or step.
To customize the exit code, the following operations are required.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change exit code of step.</p>
</li>
<li>
<p>Change exit code of job in accordance with exit code of step.</p>
</li>
<li>
<p>Map exit code of job and exit code of java process.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About significance of exit code</div>
<div class="paragraph">
<p>In this section, exit codes are handled with two significances and respective explanations are given below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exit code of character strings like COMPLETED, FAILED are considered as exit codes of job or step.</p>
</li>
<li>
<p>Exit code of numerical values like 0, 255 are considered as exit codes of Java process.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="change-exit-codes-of-step"><a class="anchor" href="#change-exit-codes-of-step"></a>7.2.2.1. Change exit codes of step</h5>
<div class="paragraph">
<p>How to change exit code of step for each process model is shown below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Change exit code of step in chunk model</dt>
<dd>
<p>Implement afterStep method of StepExecutionListener as a process while terminating step and return exit code of any step.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">An implementation example of StepExecutionListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExitStatusChangeListener</span> <span class="directive">implements</span> StepExecutionListener {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {

        ExitStatus exitStatus = stepExecution.getExitStatus();
        <span class="keyword">if</span> (conditionalCheck(stepExecution)) {
            <span class="comment">// (1)</span>
            exitStatus = <span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOM STEP FAILED</span><span class="delimiter">&quot;</span></span>);
        }
        <span class="keyword">return</span> exitStatus;
    }

    <span class="directive">private</span> <span class="type">boolean</span> conditionalCheck(StepExecution stepExecution) {
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Job definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitStatusChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of implementation contents</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set custom exit code according to the execution result of step.</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">Change exit code of step in tasklet model</dt>
<dd>
<p>Configure exit code of any step in StepContribution - an argument of execute method of Tasklet.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Tasklet implementation example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

    <span class="comment">// omitted.</span>
    <span class="keyword">if</span> (errorCount &gt; <span class="integer">0</span>) {
        contribution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">STEP COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>));  <span class="comment">// (1)</span>
    }
    <span class="keyword">return</span> RepeatStatus.FINISHED;
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of implementation contents</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure a unique exit code in accordance with the execution results of tasklet.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="change-exit-code-of-job"><a class="anchor" href="#change-exit-code-of-job"></a>7.2.2.2. Change exit code of job</h5>
<div class="paragraph">
<p>Implement afterJob method of JobExecutionListener as a process while terminating the job and configure exit code of last job by exit code of each step.</p>
</div>
<div class="listingblock">
<div class="title">An Implementation example of JobExecutionListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExitCodeChangeListener</span> <span class="directive">extends</span> JobExecutionListenerSupport {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="comment">// (1)</span>
        <span class="keyword">for</span> (StepExecution stepExecution : jobExecution.getStepExecutions()) {
            <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">STEP COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>.equals(stepExecution.getExitStatus().getExitCode())) {
                jobExecution.setExitStatus(<span class="keyword">new</span> ExitStatus(<span class="string"><span class="delimiter">&quot;</span><span class="content">JOB COMPLETED WITH SKIPS</span><span class="delimiter">&quot;</span></span>));
                logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Change status 'JOB COMPLETED WITH SKIPS'</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">break</span>;
            }

        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Job definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitstatusjob.step</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- omitted --&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExitCodeChangeListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">List of implementation contents</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the final job exit code to <code>JobExecution</code> according to the execution result of the job.<br>
In this case, if <code>CUSTOM STEP FAILED</code> is included in one of the exit codes returned from the step,
It has an exit code <code>CUSTOM FAILED</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="mapping-of-exit-codes"><a class="anchor" href="#mapping-of-exit-codes"></a>7.2.2.3. Mapping of exit codes</h5>
<div class="paragraph">
<p>Define the mapping between exit code of job and exit code of the process.</p>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- exitCodeMapper --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.launch.support.SimpleJvmExitCodeMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;util:map</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exitCodeMapper</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">key-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.Integer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- ExitStatus --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NOOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STOPPED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UNKNOWN</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">255</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CUSTOM FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> <span class="comment">&lt;!-- Custom Exit Status --&gt;</span>
        <span class="tag">&lt;/util:map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Process exit code 1 is prohibited</div>
<div class="paragraph">
<p>Generally, when a Java process is forcibly terminated due to a VM crash or SIGKILL signal reception,
the process may return 1 as the exit code.
Since it should be clearly distinguished from the exit code of a batch application regardless of whether it is normal or abnormal,
do not define 1 as a process exit code within an application.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">About the difference between status and exit code</div>
<div class="paragraph">
<p>There are "status (<code>STATUS</code>)" and "exit code (<code>EXIT_CODE</code>)" as the states of jobs and steps managed by <code>JobRepository</code>, but they differ in the following points.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The status can not be customized because it is used in internal control of Spring Batch and specific value by enum type <code>BatchStatus</code> is defined.</p>
</li>
<li>
<p>The exit code can be used for job flow control and process exit code change, and can be customized.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_DuplicateSafe"><a class="anchor" href="#Ch07_JobManagement_DuplicateSafe"></a>7.2.3. Double Activation Prevention</h4>
<div class="paragraph">
<p>In Spring Batch, when running a job,
confirm whether the following combination exists from <code>JobRepositry</code> to <code>JobInstance(BATCH_JOB_INSTANCE table)</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Job name to be activated</p>
</li>
<li>
<p>Job parameters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TERASOLUNA Batch 5.x makes it possible to activate multiple times even if the combinations of job and job parameters match.<br>
That is, it allows double activation.
For details, refer to <a href="#">Job Activation Parameter</a></p>
</div>
<div class="paragraph">
<p>In order to prevent double activation, it is necessary to execute in the job scheduler or application.<br>
Detailed means are strongly dependent on job scheduler products and business requirements, so omitted here.<br>
Consider whether it is necessary to suppress double start for each job.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_Logging"><a class="anchor" href="#Ch07_JobManagement_Logging"></a>7.2.4. Logging</h4>
<div class="paragraph">
<p>Explain log setting method.</p>
</div>
<div class="paragraph">
<p>Log output, settings and considerations are in common with TERASOLUNA Server 5.x.
At first, refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/GeneralFuncDetail/Logging.html">Logging</a>.</p>
</div>
<div class="paragraph">
<p>Explain specific considerations of TERASOLUNA Batch 5.x here.</p>
</div>
<div class="sect4">
<h5 id="clarification-of-log-output-source"><a class="anchor" href="#clarification-of-log-output-source"></a>7.2.4.1. Clarification of log output source</h5>
<div class="paragraph">
<p>It is necessary to be able to clearly specify the output source job and job execution at the time of batch execution.
Therefore, it is good to output the thread name, the job name and the job execution ID.
Especially at asynchronous execution, since jobs with the same name will operate in parallel with different threads,
recording only the job name may make it difficult to specify the log output source.</p>
</div>
<div class="paragraph">
<p>Each element can be realized in the following way.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Thread name</dt>
<dd>
<p>Specify <code>%thread</code> which is the output pattern of <code>logback.xml</code></p>
</dd>
<dt class="hdlist1">Job name / Job Execution ID</dt>
<dd>
<p>Create a component implementing <code>JobExecutionListener</code> and record it at the start and end of the job</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">An implementation example of JobExecutionListener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and import omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JobExecutionLoggingListener</span> <span class="directive">implements</span> JobExecutionListener {
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger =
            LoggerFactory.getLogger(JobExecutionLoggingListener.class);

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> beforeJob(JobExecution jobExecution) {
        <span class="comment">// (1)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job started. [JobName:{}][jobExecutionId:{}]</span><span class="delimiter">&quot;</span></span>,
            jobExecution.getJobInstance().getJobName(), jobExecution.getId());
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterJob(JobExecution jobExecution) {
        <span class="comment">// (2)</span>
        logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">job finished.[JobName:{}][jobExecutionId:{}][ExitStatus:{}]</span><span class="delimiter">&quot;</span></span>
                , jobExecution.getJobInstance().getJobName(),
                , jobExecution.getId(), jobExecution.getExitStatus().getExitCode());
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Job Bean definition file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- omitted. --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loggingJob.step01</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- omitted. --&gt;</span>
        <span class="tag">&lt;/batch:tasklet&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:listeners&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:listener</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobExecutionLoggingListener</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:listeners&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted. --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">An example of log output of job name and job execution ID</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Before starting the job, the job name and job execution ID are output to the INFO log.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the job ends, an exit code is also output in addition to (1).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associate <code>JobExecutionLoggingListener</code> registered as a component with the bean definition of a specific job.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="log-monitoring"><a class="anchor" href="#log-monitoring"></a>7.2.4.2. Log Monitoring</h5>
<div class="paragraph">
<p>In the batch application, the log is the main user interface of the operation.
Unless the monitoring target and the actions at the time of occurrence are clearly designed,
filtering becomes difficult and there is a danger that logs necessary for action are buried.
For this reason, it is advisable to determine in advance a message or code system to be a keyword to be monitored for logs.
For message management to be output to the log, refer to <a href="#Ch07_JobManagement_MessageManagement">"Message Management"</a> below.</p>
</div>
</div>
<div class="sect4">
<h5 id="log-output-destination"><a class="anchor" href="#log-output-destination"></a>7.2.4.3. Log Output Destination</h5>
<div class="paragraph">
<p>For log output destinations in batch applications, it is good to design in which units logs are distributed / aggregated.
For example, even when logs are output to a flat file, multiple patterns are considered as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Output to 1 file per 1 job</p>
</li>
<li>
<p>Output to 1 file in units of multiple jobs grouped together</p>
</li>
<li>
<p>1 Output to 1 file per server</p>
</li>
<li>
<p>Output multiple servers in 1 file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In each case, depending on the total number of jobs / the total amount of logs / I/O rate to be generated in the target system,
it is decided which unit is best to be grouped.
It also depends on how to check logs. It is assumed that options will change depending on the utilization method
such as whether to refer frequently from the job scheduler or from the console frequently.</p>
</div>
<div class="paragraph">
<p>The important thing is to carefully examine the log output in operational design and to verify the usefulness of the log in the test.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch07_JobManagement_MessageManagement"><a class="anchor" href="#Ch07_JobManagement_MessageManagement"></a>7.2.5. Message Management</h4>
<div class="paragraph">
<p>Explain message management.</p>
</div>
<div class="paragraph">
<p>In order to prevent variations in the code system and to facilitate designing extraction as a keyword to be monitored,
it is desirable to give messages according to certain rules.</p>
</div>
<div class="paragraph">
<p>As with logging, message management is basically the same as TERASOLUNA Server 5.x.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">About utilization of MessageSource</div>
<div class="paragraph">
<p><code>MessageSource</code> can be used to use messages from property files.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For specific settings and implementation examples,
refer to <a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/GeneralFuncDetail/Logging.html#id8">Uniform management of log messages</a></p>
<div class="ulist">
<ul>
<li>
<p>As a sample of log output here, it is exemplified along the case of the Spring MVC controller,
but please replace it to any component of Spring Batch.</p>
</li>
<li>
<p>Instance of <code>MessageSource</code> is generated independently here, but it is not necessary for TERASOLUNA Batch 5.x.
This is because each component is accessed only after <code>ApplicationContext</code> is created.
In TERASOLUNA Batch 5.x, it is set as follows.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">messageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.context.support.ResourceBundleMessageSource</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:basenames</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">i18n/application-messages</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch08"><a class="anchor" href="#Ch08"></a>8. Flow control and parallel, multiple processing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch08_FlowControll"><a class="anchor" href="#Ch08_FlowControll"></a>8.1. Flow control</h3>
<div class="sect3">
<h4 id="Ch08_FCh08_FlowControll_Overview"><a class="anchor" href="#Ch08_FCh08_FlowControll_Overview"></a>8.1.1. Overview</h4>
<div class="paragraph">
<p>It is a method of implementing a single business process by splitting one job to multiple jobs and combining them
instead of implementing by integrating them in one job.
The item wherein dependency relationship between jobs is defined, is called as job net.</p>
</div>
<div class="paragraph">
<p>The advantages of defining a job net are enumerated below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is easier to visualize progress status of a process</p>
</li>
<li>
<p>It is possible to do partial re-execution,  pending execution and stop execution of jobs</p>
</li>
<li>
<p>It is easier to do parallel execution of jobs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When designing a batch process, it is common to design the job net and the jobs together.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Suitability of processing contents and job net</div>
<div class="paragraph">
<p>Job nets are often not suitable for simple business process that need not be split and the process for integrating with online process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this guideline, control of the flow of jobs between job nets is called flow control.
In the processing flow, the previous job is called as preceding job and the next job is called as subsequent job.
The dependency relationship between the preceding job and the subsequent job is called preceding and succeeding relationship.</p>
</div>
<div class="paragraph">
<p>The conceptual diagram of flow control is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_FlowControl_Overview.png" alt="Flow Control Overview">
</div>
<div class="title">Overview of flow control</div>
</div>
<div class="paragraph">
<p>As shown above, flow control can be implemented by both the job scheduler and TERASOLUNA Batch 5.x.
However, it is desirable to use the job scheduler as much as possible due to the following reasons.</p>
</div>
<div class="ulist">
<div class="title">When implemented in TERASOLUNA Batch 5.x</div>
<ul>
<li>
<p>There is a strong tendency to have diverse processes and status for one job making it easier to form a black box.</p>
</li>
<li>
<p>The boundary between the job scheduler and the job becomes ambiguous</p>
</li>
<li>
<p>It becomes difficult to see the situation at the time of error from the job scheduler</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, it is generally known that there are following disadvantages when the number of jobs defined in the job scheduler increases.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The cost mentioned below increases and the processing time of the entire system increases due to the job scheduler</p>
<div class="ulist">
<ul>
<li>
<p>Job scheduler product specific communication, control of execution node, etc.</p>
</li>
<li>
<p>Overhead cost associated with Java process start for each job</p>
</li>
</ul>
</div>
</li>
<li>
<p>Number of job registrations limit</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The policy is as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basically, flow control is performed by the job scheduler.</p>
</li>
<li>
<p>Following measures are taken only when any damage is caused due to the large number of jobs.</p>
<div class="ulist">
<ul>
<li>
<p>Multiple sequential processes are consolidated in one job in TERASOLUNA Batch 5.x.</p>
<div class="ulist">
<ul>
<li>
<p>Simple preceding and succeeding relationships are only consolidated in one job.</p>
</li>
<li>
<p>Changing the step exit code and conditional branch of executing subsequent step by it can be used functionally.
However, because job execution management becomes complicated,
it is used in principle only for the process exit code determination at the end of the job.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to <a href="#Ch07_JobManagement_ExitCode">"Customization of exit code"</a> for the details of deciding job exit code.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The points to be considered for implementing preceding and succeeding process are shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_Jobnet.png" alt="Job net">
</div>
<div class="title">Flow control by job scheduler</div>
</div>
<div class="ulist">
<div class="title">Points to be considered</div>
<ul>
<li>
<p>Job scheduler starts java process through shell.</p>
</li>
<li>
<p>One job should correspond to one java process.</p>
<div class="ulist">
<ul>
<li>
<p>In the entire process, 4 java processes start.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The job scheduler controls the start order of each process. Each java process is independent.</p>
</li>
<li>
<p>The process exit code of the preceding job is used for deciding the start of the succeeding job.</p>
</li>
<li>
<p>External resources such as files, DB etc. should be used to pass the data between jobs.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch08/FlowControl/Ch08_FlowControl_StepExecution.png" alt="FlowControl">
</div>
<div class="title">Flow control by TERASOLUNA Batch 5.x</div>
</div>
<div class="ulist">
<div class="title">Points to be considered</div>
<ul>
<li>
<p>Job scheduler starts java process through shell.</p>
</li>
<li>
<p>One job should be one java process.</p>
<div class="ulist">
<ul>
<li>
<p>In the entire process, only one java process is used.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Start order of each step is controlled by one java process. Each step is independent.</p>
</li>
<li>
<p>The exit code of the preceding job is used for deciding the start of the succeeding job.</p>
</li>
<li>
<p>The data can be passed between steps by in-memory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to implement flow control by TERASOLUNA Batch 5.x is explained below.<br>
The flow control of job scheduler is strongly dependent on the product specifications so it is not explained here.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Application example of flow control</div>
<div class="paragraph">
<p>In general, parallel/multiple processes of multiple jobs is often implemented by job scheduler and job net.<br>
However, in TERASOLUNA Batch 5.x, how to implement parallel and multiple processes of multiple jobs by applying the flow control function, is explained.
Refer to <a href="#Ch08_ParallelAndMultiple">"Parallel and multiple process"</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FCh08_FlowControll_HowToUse"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToUse"></a>8.1.2. How to use</h4>
<div class="paragraph">
<p>How to use flow control in TERASOLUNA Batch 5.x is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch08_FCh08_FlowControll_HowToUse_SequencialFlow"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToUse_SequencialFlow"></a>8.1.2.1. Sequential flow</h5>
<div class="paragraph">
<p>Sequential flow is a flow that links the before step and after step in series.<br>
If any business process ends abnormally in a step of the sequential flow, the succeeding step is not executed and the job is interrupted.
In this case, the step and job status and exit code associated with the job execution ID are
recorded as <code>FAILED</code> by <code> JobRepository</code>.<br>
By restarting after recovering the cause of failure, it is possible to resume the process from the abnormally ended step.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Refer to <a href="#Ch06_RerunRestart_HowToUse_Restart">"Job restart"</a> for how to restart a job.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set sequential flow of the job consisting of 3 steps.</p>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch08.flowcontrol.SequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">p:failExecutionStep</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{jobParameters['failExecutionStep']}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sequentialFlowTasklet</span><span class="delimiter">&quot;</span></span>
                   <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>   <span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the next step to be started after this step ends normally in <code>&lt;batch:step&gt;</code>.<br>
Set <code>id</code> of the next step to <code>next</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>next</code> attribute is not required in the step at the end of the flow.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As a result, steps are started in series in the following order.<br>
<code>jobSequentialFlow.step1</code> &#8594; <code>jobSequentialFlow.step2</code> &#8594; <code>jobSequentialFlow.step3</code><br></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to define using &lt;batch:flow&gt;</div>
<div class="paragraph">
<p>In the above example, the flow is directly defined in <code> &lt;batch: job&gt; </code>.
Flow definition can be defined outside using <code>&lt;batch:flow&gt;</code>.
An example of using <code>&lt;batch:flow&gt;</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">innerFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:flow</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">outerFlow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step1</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step2</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSequentialOuterFlow.step3</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:flow&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set flow id is defined in (2) in the parent attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define sequential flow.</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps"></a>8.1.2.2. Passing data between steps</h5>
<div class="paragraph">
<p>In Spring Batch, <code>ExecutionContext</code> of execution context that can be used in the scope of each step and job is provided.
By using the step execution context, data can be shared between the components in the step.
At this time, since the step execution context cannot be shared between steps, the preceding step execution context cannot be referred from the succeeding step execution context.
It can be implemented if the job execution context is used, but since it can be referred from all steps, it needsto be handled carefully.
When the information between the steps needs to be inherited, it can be done by the following procedure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the post-processing of the preceding step, the information stored in the step execution context is passed to the job execution context.</p>
</li>
<li>
<p>The succeeding step gets information from the job execution context.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By using <code>ExecutionContextPromotionListener</code> provided by Spring Batch,
the first procedure can be realized only by specifying the inherited information to the listener even without implementing it.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes on using ExecutionContext</div>
<div class="paragraph">
<p><code> ExecutionContext</code> used for passing data is saved in serialized state in
<code>BATCH_JOB_EXECUTION_CONTEXT</code> and <code>BATCH_JOB_STEP_EXECUTION_CONTEXT</code> of RDBMS
so note the following 3 points.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The passed data should be an object in a serializable format.</p>
<div class="ulist">
<ul>
<li>
<p><code>java.io.Serializable</code> should be implemented.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Minimum required passed data should be retained.<br>
<code> ExecutionContext</code> is also used for storing execution control information by Spring Batch,
 so larger the passed data, the more the serialization cost.<br></p>
</li>
<li>
<p>The above <code> ExecutionContextPromotionListener</code> should be used for passed data without saving it directly in the job execution context.<br>
The job execution context has a wider scope than the step execution context, unnecessary serialized data gets easily accumulated.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, it is possible to exchange information by sharing Bean of Singleton or Job scope rather than going through the execution context.
Note that the larger the size of this method more the pressure on memory resources.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The data passed between steps is explained for the tasklet model and the chunk model respectively below.</p>
</div>
<div class="sect5">
<h6 id="Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps_Tasklet"></a>8.1.2.2.1. Data passing between steps using tasklet model</h6>
<div class="paragraph">
<p>In order to save and fetch passing data, get <code>ExecutionContext</code> from <code> ChunkContext</code> and pass the data between the steps.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing source Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package, imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SavePromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) <span class="directive">throws</span> <span class="exception">Exception</span> {

        <span class="comment">// (1)</span>
        chunkContext.getStepContext().getStepExecution().getExecutionContext()
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing destination Tasklet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ConfirmPromotionalTasklet</span> <span class="directive">implements</span> Tasklet {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> RepeatStatus execute(StepContribution contribution,
            ChunkContext chunkContext) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = chunkContext.getStepContext().getJobExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// omitted.</span>

        <span class="keyword">return</span> RepeatStatus.FINISHED;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">savePromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">confirmPromotionalTasklet</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>
<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the value to be passed to the after step in the <code> ExecutionContext</code> of the step execution context.
Here, <code> promotion</code> is specified as the key required for a series of data passing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the passing data set in (1) of the preceding step using <code>promotion</code> key specified
in the passing source from <code>ExecutionContext</code>.<br>
Note that the <code>ExecutionContext</code> used here is not the step execution context of (1) but
is the job execution context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>ExecutionContextPromotionListener</code>,
pass the data from the step execution context to the job execution context.<br>
Specify the passing key specified in (1) to <code>keys</code> property.<br>
<code>IllegalArgumentException</code> is thrown by <code>strict=true</code> property when it does not exist in the step execution context.
In case of <code> false</code>, processing continues even if there is no passing data.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Regarding ExecutionContextPromotionListener and step exit code</div>
<div class="paragraph">
<p><code>ExecutionContextPromotionListener</code> passes the data from step execution context to job execution context
only when the step exit code of data passing source ends normally (<code>COMPLETED</code>).<br>
To customize the exit code in which the succeeding step is executed continuously,
exit code should be specified in <code>status</code> property in the array format.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToUse_PassingDataToFutureSteps_Chunk"></a>8.1.2.2.2. Data passing between steps using the chunk model</h6>
<div class="paragraph">
<p>Use the method assigned with <code>@AfterStep</code>、<code>@BeforeStep</code> annotation in <code>ItemProcessor</code>.
The listener to be used for data passing and how to use <code> ExecutionContext</code> is the same as the tasklet model.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing source ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionSourceItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@AfterStep</span>
    <span class="directive">public</span> ExitStatus afterStep(StepExecution stepExecution) {
        <span class="comment">// (1)</span>
        stepExecution.getExecutionContext().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of data passing target ItemProcessor</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// package and imports are omitted.</span>

<span class="annotation">@Component</span>
<span class="annotation">@Scope</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">PromotionTargetItemProcessor</span> <span class="directive">implements</span> ItemProcessor&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> process(<span class="predefined-type">String</span> item) {
        <span class="comment">// omitted.</span>
    }

    <span class="annotation">@BeforeStep</span>
    <span class="directive">public</span> <span class="type">void</span> beforeStep(StepExecution stepExecution) {
        <span class="comment">// (2)</span>
        <span class="predefined-type">Object</span> promotion = stepExecution.getJobExecution().getExecutionContext()
                .get(<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// omitted.</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- import,annotation,component-scan definitions are omitted --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceStep</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:listeners&gt;</span>
            <span class="tag">&lt;batch:listener&gt;</span>
                <span class="comment">&lt;!-- (3) --&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.listener.ExecutionContextPromotionListener</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:keys</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">promotion</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:strict</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/batch:listener&gt;</span>
        <span class="tag">&lt;/batch:listeners&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobChunkPromotionalFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">targetStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- step definitions are omitted. --&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set the value to be passed to the succeeding step to <code>ExecutionContext</code> of step execution context.
Here, <code> promotion</code> is specified as the key required for a series of data passing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the passing data set in (1) of the preceding step using <code>promotion</code> key specified in the passing source
from <code>ExecutionContext</code>.<br>
Note that the <code>ExecutionContext</code> used here is not the step execution context of (1) but
is the job execution context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>ExecutionContextPromotionListener</code>,
pass the data from the step execution context to the job execution context.<br>
Specification of property is same as the tasklet.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_FCh08_FlowControll_HowToExtend"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToExtend"></a>8.1.3. How to extend</h4>
<div class="paragraph">
<p>Here, conditional branching of succeeding step and the condition to stop the job before executing the after step isexplained.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Difference between exit code and status of job and step.</div>
<div class="paragraph">
<p>In the following explanation, the terms "Status" and "Exit code" frequently appear.<br>
When distinction cannot be made, it may cause confusion,
so refer to <a href="#Ch07_JobManagement_ExitCode">"Customization of exit code</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="Ch08_FCh08_FlowControll_HowToExtend_ConditionFlow"><a class="anchor" href="#Ch08_FCh08_FlowControll_HowToExtend_ConditionFlow"></a>8.1.3.1. Conditional branching</h5>
<div class="paragraph">
<p>The conditional branch means receiving the exit code which is the execution result of the preceding step, selecting one from multiple after steps and continuing execution.<br>
To stop the job without executing any succeeding step, refer to <a href="#Ch08_FCh08_FlowControll_StopConfig">"Stop condition"</a>.</p>
</div>
<div class="listingblock">
<div class="title">Description example Job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepA</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="comment">&lt;!-- (2) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepB</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobConditionalFlow.stepC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">conditionalFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of implementation contents</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not specify <code>next</code> attribute in the <code>&lt;batch:step&gt;</code> element as in the sequential flow.
By setting multiple <code>&lt;batch:next&gt;</code>, it can be assigned to the succeeding step specified by <code>to</code> attribute.<br>
Specify exit code of the step  that is the transition condition, in <code>on</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is the succeeding step executed only when the step exit code of (1) is <code>COMPLETED</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is the succeeding step executed only when the step exit code of (1) is <code>FAILED</code>.<br>
By specifying this, succeeding step such as recovery process etc. is executed without stopping the job when the preceding stepprocess fails.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Notes on recovery process by after steps</div>
<div class="paragraph">
<p>When recovery process of the succeeding step is performed due to failure of preceding step process (Exit code is <code>FAILED</code>),
the status of before step changes to <code>ABANDONED</code> and it cannot restart regardless of success or failure of the recovery process.</p>
</div>
<div class="paragraph">
<p>When the recovery process of the succeeding step fails, only the recovery process is re-executed on restarting the job.<br>
For this reason, when processing is to be performed again including the preceding step, it is necessary to rerun as anotherjob execution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch08_FCh08_FlowControll_StopConfig"><a class="anchor" href="#Ch08_FCh08_FlowControll_StopConfig"></a>8.1.3.2. Stop condition</h5>
<div class="paragraph">
<p>How to stop the job depending on the exit code of the preceding step, is explained.<br>
There are methods to specify the following 3 elements as means to stop.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>end</code></p>
</li>
<li>
<p><code>fail</code></p>
</li>
<li>
<p><code>stop</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If these exit codes correspond to the preceding step, the succeeding step is not executed.<br>
Multiple exit codes can be specified within the same step.</p>
</div>
<div class="listingblock">
<div class="title">Description example of job Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (1) --&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:end</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">END_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (3) --&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_NO_EXIT_CODE</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;batch:fail</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_FAIL_WITH_EXIT_CODE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FAILED_CUSTOM</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (4) --&gt;</span>
        <span class="tag">&lt;batch:stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FORCE_STOP</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">exit-code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="comment">&lt;!-- (2) --&gt;</span>
        <span class="tag">&lt;batch:next</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">*</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobStopFlow.step4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stopFlow.parentStep</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Explanation of setting contents of job stop</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>on</code> attribute of <code>&lt;batch:end&gt;</code> and the step exit code match, the job is recorded as normal end
(Status : <code>COMPLETED</code>) in <code>JobRepository</code>.<br>
When <code>exit-code</code> attribute is assigned, exit code of job can be customized from <code>COMPLETED</code> by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By specifying wildcard (<code>*</code>) in <code>on</code> attribute of <code>&lt;batch:next&gt;</code>, when it does not correspond to any of <code>end</code>, <code>fail</code>,
<code>stop</code>, subsequent job can be continued.<br>
It is described at the end of step elements however, since matching condition of exist code is evaluated before,
the arrangement order of elements is optional if it is within step elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>&lt;batch:fail&gt;</code> is used, the job is recorded as abnormal end (Status: <code>FAILED</code>) in <code>JobRepository</code>.<br>
Like <code>&lt;batch:end&gt;</code>, by assigning <code>exit-code</code> attribute, exit code of job can be customized from <code>FAILED</code> by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When <code>&lt;batch:stop&gt;</code> is used, the job is recorded as stopped (Status: <code>STOPPED</code>) in <code>JobRepository</code> at the time ofnormal end of step.<br>
For <code>restart</code> attribute, specify the stop where the job is resumed from stop at the time of restart.<br>
Like <code>&lt;batch:end&gt;</code>, <code>exit-code</code> attribute can be assigned, however, null string should be specified.(refer to column later)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">When customizing the exit code by the exit-code attribute, it should be mapped to the process exit code without omission.</div>
<div class="paragraph">
<p>Refer to <a href="#Ch07_JobManagement_ExitCode">"Customization of exit code"</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Empty charactor string should be specified to exit-code in &lt;batch:stop&gt;.</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;stop</span> <span class="attribute-name">on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETED</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">restart</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/step&gt;</span>

<span class="tag">&lt;step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">s2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expected flow control should be that when step1 ends normally, the job stops and step2 is executed when restart is executed again.<br>
However, due to some failure in Spring Batch, the operation does not take place as expected.<br>
step2 is not executed after restart, the exit code of job becomes <code>NOOP</code> and status <code>COMPLETED</code>.</p>
</div>
<div class="paragraph">
<p>To avoid this, "" (empty charactor string) should be assigned in <code>exit-code</code> as shown above.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://jira.spring.io/browse/BATCH-2315">Spring Batch/BATCH-2315</a> for the details of failure.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch08_ParallelAndMultiple"><a class="anchor" href="#Ch08_ParallelAndMultiple"></a>8.2. Parallel processing and multiple processing</h3>
<div class="sect3">
<h4 id="Ch08_ParallelAndMultiple_Overview"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview"></a>8.2.1. Overview</h4>
<div class="paragraph">
<p>Generally, the batch system where the batch window is severe (time available for batch processing) is designed
to reduce overall processing time as much as possible by operating multiple jobs in parallel (hereafter referred to as parallel processing).<br>
However, it may happen that processing time does not fit in the batch window due to large size of 1 processing job.<br>
In this case, a method to reduce processing time by dividing the processing data of a job and performing multiple processing (hereafter referred to as multiple processing) can be used.<br>
Although parallel processing and multiple processing can be handled with the same significance, the definitions are given here as below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parallel processing</dt>
<dd>
<p>Execute multiple different jobs at the same time.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Overview_Parallel.png" alt="Parallel Step">
</div>
<div class="title">Schematic diagram of parallel processing</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Multiple processing</dt>
<dd>
<p>Divide the processing target of 1 job and execute simultaneously.</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Overview_Multiple.png" alt="Partition Step">
</div>
<div class="title">Schematic diagram of multiple processing</div>
</div>
<div class="paragraph">
<p>A method to use job scheduler and a method to use TERASOLUNA Batch 5.x are used for both parallel processing and multiple processing.<br>
Note that, parallel processing and multiple processing in TERASOLUNA Batch 5.x is established
on <a href="#Ch08_FlowControll">Flow control</a>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">How to implement parallel processing and multiple processing</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Implementation method</th>
<th class="tableblock halign-left valign-top">Parallel processing</th>
<th class="tableblock halign-left valign-top">Multiple processing</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job scheduler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is defined to enable execution of multiple different jobs without dependencies to run at the same time.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It is defined to execute multiple identical jobs in different data scopes. Pass information to narrow down data to be processed by each job argument, to each job.<br>
For example, divide data of 1 year for each month, divide by units such as area, branch etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERASOLUNA Batch 5.x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch08_ParallelAndMultiple_ParallelStep">Parallel Step  (Parallel processing)</a><br>
Perform parallel processing in steps.<br>
Each step need not have identical processing and parallel processing can be performed for resources of different types such as DB and file.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Ch08_ParallelAndMultiple_Partitioning">Partitioning Step (Multiple processing)</a><br>
In the master step, a key to distribute target data is fetched and in the slave step,
the distributed data is processed based on this key.<br>
Unlike parallel step, the processing of the slave step is identical.</p></td>
</tr>
</tbody>
</table>
<div class="dlist">
<dl>
<dt class="hdlist1">When job scheduler is used</dt>
<dd>
<p>Since 1 process is allocated to 1 job, it is activated by multiple processes. Hence, designing and implementing one job is not very difficult.<br>
However, since multiple processes are started, the load on machine resources increase when number of synchronous executions increase.<br>
Hence, when the number of synchronous executions is 3 or 4, a job scheduler may be used.<br>
Of course, this number is not absolute. It would like you to used as a guide as it depends on execution environment or job implementation.</p>
</dd>
<dt class="hdlist1">When TERASOLUNA Batch 5.x is used</dt>
<dd>
<p>Since each step is assigned to a thread, it is operated as 1 process with multiple threads. Hence, the difficulty level for design and implementation of 1 job is higher than while using a job scheduler.<br>
However, since the process is implemented by multiple threads, the load on machine resources will not be as high as the time when job scheduler is used even when the number of synchronous executions show an increase.
Hence, when number of synchronous executions is large (5 or more than 5), TERASOLUNA Batch 5.x may be used.<br>
Of course, this number is not absolute. It would like you to used as a guide as it depends on execution environment and system characteristics.</p>
</dd>
</dl>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>One of the parallel processing methods that can be executed in Spring Batch is <code>Multi Thread Step</code>, however, its use in TERASOLUNA Batch 5.x is deprecated due to following reasons.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">A Multi Thread Step method</dt>
<dd>
<p>performs parallel processing by multiple threads in chunk units.</p>
</dd>
<dt class="hdlist1">Reason for deprecation</dt>
<dd>
<p>A majority of Readers and Writers offered by Spring Batch are not designed for multi-thread processing.
Hence, issues like loss of data or duplicate processing are likely to occur resulting in low process reliability. Further, since the process is performed in multiple threads, a definite processing order is not established.<br>
Even when ItemReader/ItemProcessor/ItemWriter is created on its own, various points must be taken into consideration in order to use <code>Multi Thread Step</code> like thread safe wherein difficulty of implementation and operation is high.
<code>Multi Thread Step</code> is deprecated for these reasons.<br>
It is recommended to use <a href="#Ch08_ParallelAndMultiple_Partitioning">Partitioning Step (Multiple processing)</a> as an alternative.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Existing ItemReader can be made thread safe by using <code>org.springframework.batch.item.support.SynchronizedItemStreamReader</code>.
Even then issue of processing sequence is still to be considered, <code>Multi Thread Step</code> is not used in TERASOLUNA Batch 5.x.</p>
</div>
</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When data is to be updated to 1 database by parallel processing and multiple processing, resource conflict and deadlock are likely to occur.
Potential conflicts should be eliminated from the job design stage.</p>
</div>
<div class="paragraph">
<p>Distributed processing for multiple processes and multiple housings is included in Spring Batch as a function. However, since the failure design becomes difficult for TERASOLUNA Batch 5.x, it should not be used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The usage method of this function is same in the chunk model as well as tasklet model.</p>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_Overview_Scheduler"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_Scheduler"></a>8.2.1.1. Parallel processing and multiple processing by job scheduler</h5>
<div class="paragraph">
<p>Parallel processing and multiple processing using a job scheduler is explained here.</p>
</div>
<div class="paragraph">
<p>For job registration and schedule setting, refer the manual of the job scheduler to be used.</p>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_Overview_SchedulerParallelJob"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_SchedulerParallelJob"></a>8.2.1.1.1. Parallel processing of jobs using job scheduler</h6>
<div class="paragraph">
<p>The processes to be executed in parallel are registered as jobs and schedules are set so that each job starts on the time.
Each job can be registered as a different process.</p>
</div>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_Overview_SchedulerMultiplelJob"><a class="anchor" href="#Ch08_ParallelAndMultiple_Overview_SchedulerMultiplelJob"></a>8.2.1.1.2. Multiple processing of jobs using job scheduler</h6>
<div class="paragraph">
<p>Processes to be subjected to multiple processing are registered multiple times and extraction scope of target data is specified by parameters.
Further, the schedule is set to enable the respective jobs at the same time.
Although each job is in the same process, data range to be processed must be independent.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch08_ParallelAndMultiple_HowToUse"><a class="anchor" href="#Ch08_ParallelAndMultiple_HowToUse"></a>8.2.2. How to use</h4>
<div class="paragraph">
<p>A method to perform parallel processing and multiple processing in TERASOLUNA Batch 5.x is explained.</p>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_ParallelStep"><a class="anchor" href="#Ch08_ParallelAndMultiple_ParallelStep"></a>8.2.2.1. Parallel Step  (Parallel processing)</h5>
<div class="paragraph">
<p>A method of Parallel Step  (parallel processing) is explained.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Parallel_Step.png" alt="Parallel Step">
</div>
<div class="title">Schematic diagram for Parallel Step</div>
</div>
<div class="paragraph">
<div class="title">Description of schematic diagram</div>
<p>Separate processes can be defined for each step and can be executed in parallel.
A thread is allocated for each step.</p>
</div>
<div class="paragraph">
<p>How to define Parallel Step is shown below using schematic diagram of Parallel Step.</p>
</div>
<div class="listingblock">
<div class="title">Job definition of Parallel Step</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- Task Executor --&gt;</span>
<span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Job Definition --&gt;</span>
<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;batch:split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.split</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.chunk.db</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (4) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                  <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">databaseWriter</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;/batch:tasklet&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.tasklet.chunk</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (5) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">chunkTransactionTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.tasklet.single</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="comment">&lt;!-- (6) --&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">singleTransactionTasklet</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

      <span class="tag">&lt;batch:flow&gt;</span>  <span class="comment">&lt;!-- (3)  --&gt;</span>
          <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelStepJob.step.chunk.file</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                   <span class="comment">&lt;!-- (7) --&gt;</span>
                  <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">databaseReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fileWriter</span><span class="delimiter">&quot;</span></span>
                          <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;/batch:tasklet&gt;</span>
          <span class="tag">&lt;/batch:step&gt;</span>
      <span class="tag">&lt;/batch:flow&gt;</span>

  <span class="tag">&lt;/batch:split&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Sr. No.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a thread pool to assign to each thread for parallel processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define steps to be executed in parallel in <code>&lt;batch:split&gt;</code> tag in a format which uses <code>&lt;batch:flow&gt;</code> tag.<br>
Set the Bean of thread pool defined in (1), in <code>task-executor</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>&lt;batch:step&gt;</code> wherein parallel processing is to be performed for each <code>&lt;batch:flow&gt;</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step 1 of schematic diagram ：Define intermediate commit method processing of chunk model.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step 2 of schematic diagram ：Define intermediate commit method processing of tasket model.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step 3 of schematic diagram ：Define batch commit method processing of tasket model.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step 4 of schematic diagram ：Define intermediate commit method processing for non-transactional resources of chunk model.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Cases wherein processing performance deteriorates due to parallel processing</div>
<div class="paragraph">
<p>In the parallel processing, same process can be run in parallel by changing the data range, similar to multiple processing. In this case, data range is assigned by the parameters.<br>
At this time, when the amount of data to be processed is not very significant for each process,
footprints like resource amount and processing time which are occupied at the time of execution proves to be a disadvantage in parallel processing,
and on the contrary, processing performance may get deteriorated.</p>
</div>
<div class="ulist">
<div class="title">Examples of footprints</div>
<ul>
<li>
<p>Processing from opening for input resources to fetching initial data range</p>
<div class="ulist">
<ul>
<li>
<p>Resource open requires more processing time than fetching data</p>
</li>
<li>
<p>Similarly, a process which initializes memory area of data range requires time</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Further, steps of common processing can be defined as well before and after Parallel Step process.</p>
</div>
<div class="listingblock">
<div class="title">Example of Parallel Step which includes common processing steps</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (1) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.preprocess</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">next</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.split</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">deleteDetailTasklet</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>

    <span class="comment">&lt;!--(2) --&gt;</span>
    <span class="tag">&lt;batch:split</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.split</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:flow&gt;</span>
            <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.plan</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">planWriter</span><span class="delimiter">&quot;</span></span>
                            <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:tasklet&gt;</span>
            <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;/batch:flow&gt;</span>
        <span class="tag">&lt;batch:flow&gt;</span>
            <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelRegisterJob.step.performance</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performanceWriter</span><span class="delimiter">&quot;</span></span>
                            <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/batch:tasklet&gt;</span>
            <span class="tag">&lt;/batch:step&gt;</span>
        <span class="tag">&lt;/batch:flow&gt;</span>
    <span class="tag">&lt;/batch:split&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define steps to be processed as preprocessing. Specify id set in <code>&lt;batch:split&gt;</code>, in <code>next</code> attribute.<br>
For details of subsequent step specification using <code>next</code> attribute, refer <a href="#Ch08_FCh08_FlowControll_HowToUse_SequencialFlow">"Sequential flow"</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Parallel Step.<br>
Define <code>&lt;batch:step&gt;</code> wherein parallel processing is to be performed for each <code>&lt;batch:flow&gt;</code>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="Ch08_ParallelAndMultiple_Partitioning"><a class="anchor" href="#Ch08_ParallelAndMultiple_Partitioning"></a>8.2.2.2. Partitioning Step (Multiple processing)</h5>
<div class="paragraph">
<p>A method of Partitioning Step (multiple processing) is explained.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_Step.png" alt="Partitioning Step">
</div>
<div class="title">Schematic diagram of Partitioning Step</div>
</div>
<div class="paragraph">
<div class="title">Description of schematic diagram</div>
<p>Partitioning Step is divided into processing phases of Master step and Slave step.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In Master step, <code>Partitioner</code> generates a <code>Parition Key</code> to specify data range wherein each Slave step is processed.
<code>Parition Key</code> is stored in the step context.</p>
</li>
<li>
<p>In Slave step, <code>Parition Key</code> assigned on its own from step context is fetched and data for processing is specified using the same.
Step defined for specified data for processing are executed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the Partitioning Step, although it is necessary to divide the processing data, either of the variable number and fixed number are handled for the number of partitionings.</p>
</div>
<div class="dlist">
<div class="title">Number of partitionings</div>
<dl>
<dt class="hdlist1">In case of a variable number</dt>
<dd>
<p>Divide by department or process for each file existing in specific directory</p>
</dd>
<dt class="hdlist1">In case of a fixed number</dt>
<dd>
<p>Process data by dividing overall data in fixed numbers</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In Spring Batch, fixed number is called <code>grid-size</code> and data partitioning range is determined so that <code>grid-size</code> becomes <code>Partitioner</code>.</p>
</div>
<div class="paragraph">
<p>In Partitioning Step, number of partitionings can be significantly higher than the thread size.
In this case, multiple executions are performed using number of threads and a step is generated wherein the process is not executed until the thread becomes empty.</p>
</div>
<div class="paragraph">
<p>Use case of Partitioning Step is shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Partitioning Step use case</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Use case</th>
<th class="tableblock halign-left valign-top">Master(Patitioner)</th>
<th class="tableblock halign-left valign-top">Slave</th>
<th class="tableblock halign-left valign-top">Number of partitionings</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A case wherein transaction information is divided or multiple processing is performed from master information<br>
Aggregate processing for each department and for each month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB (Master information)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB (Transaction information)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A case wherein multiple processing is performed for 1 file from a list of files<br>
Branch-wise multiple processing of transfer data from each branch (Aggregate processing for each branch)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A case wherein a large amount of data is divided by a fixed number or multiple processing is performed</p>
<p class="tableblock">A case wherein since recovery design other than re-run becomes difficult in case of a failure occurrence, it is not used the actual operation.<br>
In case of a re-run, since all the records are processed again, merits of partitioning are eliminated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify data range from <code>grid-size</code> and transaction information count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DB (Transaction information)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed</p></td>
</tr>
</tbody>
</table>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_VariablePartitonNumber"><a class="anchor" href="#Ch08_ParallelAndMultiple_VariablePartitonNumber"></a>8.2.2.2.1. When number of partitionings are variable</h6>
<div class="paragraph">
<p>A method wherein number of partitionings are made variable by Partitioning Step is explained.<br>
Processing image is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_variable.png" alt="Variable Partiton Number">
</div>
<div class="title">Processing image diagram</div>
</div>
<div class="paragraph">
<p>How to implement is shown below using the processing image as an example.</p>
</div>
<div class="listingblock">
<div class="title">Defining Repository(SQLMapper) (PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAll</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.mst.Branch</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId,
        branch_name AS branchName,
        branch_address AS branchAddrss,
        branch_tel AS branchTel,
        create_date AS createDate,
        update_date AS updateDate
    FROM
        branch_mst
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">summarizeInvoice</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceDetail</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branchId, year, month, customerId, SUM(amount) AS amount
    FROM (
        SELECT
            t2.charge_branch_id AS branchId,
            date_part('year', t1.invoice_date) AS year,
            date_part('month', t1.invoice_date) AS month,
            t1.customer_id AS customerId,
            t1.invoice_amount AS amount
        FROM invoice t1
        INNER JOIN customer_mst t2 ON t1.customer_id = t2.customer_id
        WHERE
            t2.charge_branch_id = #{branchId}
        ) t3
    GROUP BY branchId, year, month, customerId
    ORDER BY branchId ASC, year ASC, month ASC, customerId ASC
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of Partitioner</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BranchPartitioner</span> <span class="directive">implements</span> Partitioner {

    <span class="annotation">@Inject</span>
    BranchRepository branchRepository; <span class="comment">// (3)</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; partition(<span class="type">int</span> gridSize) {

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; map = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        <span class="predefined-type">List</span>&lt;Branch&gt; branches = branchRepository.findAll();

        <span class="type">int</span> index = <span class="integer">0</span>;
        <span class="keyword">for</span> (Branch branch : branches) {
            ExecutionContext context = <span class="keyword">new</span> ExecutionContext();
            context.putString(<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span>, branch.getBranchId()); <span class="comment">// (4)</span>
            map.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">partition</span><span class="delimiter">&quot;</span></span> + index, context);  <span class="comment">// (5)</span>
            index++;
        }

        <span class="keyword">return</span> map;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (6) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${thread.size}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (7) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.repository.performance.InvoiceRepository.summarizeInvoice</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="comment">&lt;!-- (8) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchId</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['branchId']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (9) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (10) --&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">branchPartitioner</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (12) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleInvoiceSummarizeJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a SQL wherein processing target is fetched from master data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a SQL wherein fetched values from master data are considered as search conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject defined Repository(SQLMapper).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store master value processed by 1 Slave step in the step context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store each Slave in Map so that it can fetch corresponding context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a thread pool to assign to each thread of Slave step in multiple processing.<br>
Master step is processed by the main thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define ItemReader for fetching data using master value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch master value set in (4) from  step context and add to search conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Master step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define processing to generate partitioning conditions of data.<br>
Set <code>Partitioner</code> interface implementation, in <code>partitioner</code> attribute.<br>
Set Bean ID of Slave Step defined in (12), in <code>step</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since <code>grid-size</code> is not used in <code>partitioner</code>, set any arbitrary value in <code>grid-size</code> attribute.
Set Bean ID of thread pool defined in (6), in <code>task-executor</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Slave step.<br>
Set ItemReader defined in (7), in <code>reader</code> attribute.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When multiple processing is performed for each file from the list of files, <code>Partitioner</code> given below offered by Spring Batch can be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.batch.core.partition.support.MultiResourcePartitioner</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How to use <code>MultiResourcePartitioner</code> is shown below.</p>
</div>
<div class="listingblock">
<div class="title">An example wherein multiple processing is performed for files</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.FlatFileItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['fileName']}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <span class="comment">&lt;!-- (3) --&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.mapping.DefaultLineMapper</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">p:fieldSetMapper-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceFieldSetMapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lineTokenizer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.item.file.transform.DelimitedLineTokenizer</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">p:names</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invoiceNo,salesDate,productId,customerId,quant,price</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/bean&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- (4) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">patitioner</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.batch.core.partition.support.MultiResourcePartitioner</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:resources</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file:#{jobParameters['basedir']}/input/invoice-*.csv</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <span class="comment">&lt;!-- (5) --&gt;</span>

<span class="comment">&lt;!--(6) --&gt;</span>
<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">patitioner</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (7) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inspectPartitioninglStepFileJob.step.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a thread pool to be assigned to each thread of Slave step in multiple processing.<br>
Master step is processed in the main thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define ItemReader to read a single file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In <code>resouce</code> property, specify the file split by <code>MultiResourcePartitioner</code> in input file.<br>
<code>MultiResourcePartitioner</code> stores the file path in the step context using a key called "fileName".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define <code>MultiResourcePartitioner</code> as <code>Partitioner</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiple files can be handled by using a pattern wherein * is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Master step.<br>
Definition contents are the same as contents of Partitioning Step described above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Slave step.<br>
Set ItemReader defined in (2), in <code>reader</code> attribute.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="Ch08_ParallelAndMultiple_FixingPartitonNumber"><a class="anchor" href="#Ch08_ParallelAndMultiple_FixingPartitonNumber"></a>8.2.2.2.2. When number of partitionings are fixed</h6>
<div class="paragraph">
<p>How to fix number of partitionings in Partitioning Step is explained.<br>
Processing image diagram is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Ch08_ParallelAndMultiple_Partitioing_fixed.png" alt="Fixing Partiton Number">
</div>
<div class="title">Processing image diagram</div>
</div>
<div class="paragraph">
<p>How to implement is shown below using the processing image as an example.</p>
</div>
<div class="listingblock">
<div class="title">Definition of Repository(SQLMapper) (PostgreSQL)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (1) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.app.model.performance.SalesPerformanceSummary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        branch_id AS branchId, year, month, amount
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    ORDER BY
        branch_id ASC
    LIMIT
        #{dataSize}
    OFFSET
        #{offset}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- (2) --&gt;</span>
<span class="tag">&lt;select</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">countByYearAndMonth</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">resultType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_int</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="inline-delimiter">&lt;![CDATA[</span>
    SELECT
        count(*)
    FROM
        sales_performance_summary
    WHERE
        year = #{year} AND month = #{month}
    <span class="inline-delimiter">]]&gt;</span>
<span class="tag">&lt;/select&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Implementation example of Partitioner</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SalesDataPartitioner</span> <span class="directive">implements</span> Partitioner {

    <span class="annotation">@Inject</span>
    SalesSummaryRepository repository;  <span class="comment">// (3)</span>

    <span class="comment">// omitted.</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; partition(<span class="type">int</span> gridSize) {

        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ExecutionContext&gt; map = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
        <span class="type">int</span> count = repository.countByYearAndMonth(year, month);
        <span class="type">int</span> dataSize = (count / gridSize) + <span class="integer">1</span>;        <span class="comment">// (4)</span>
        <span class="type">int</span> offset = <span class="integer">0</span>;

        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; gridSize; i++) {
            ExecutionContext context = <span class="keyword">new</span> ExecutionContext();
            context.putInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSize</span><span class="delimiter">&quot;</span></span>, dataSize);     <span class="comment">// (5)</span>
            context.putInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span>, offset);         <span class="comment">// (6)</span>
            offset += dataSize;
            map.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">partition:</span><span class="delimiter">&quot;</span></span> + i, context);       <span class="comment">// (7)</span>
        }

        <span class="keyword">return</span> map;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Bean definition</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- (8) --&gt;</span>
<span class="tag">&lt;task:executor</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span>
               <span class="attribute-name">pool-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${thread.size}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">queue-capacity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

<span class="comment">&lt;!-- (9) --&gt;</span>
<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.mybatis.spring.batch.MyBatisCursorItemReader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scope</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:queryId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.terasoluna.batch.functionaltest.ch08.parallelandmultiple.repository.SalesSummaryRepository.findByYearAndMonth</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">p:sqlSessionFactory-ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobSqlSessionFactory</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameterValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;map&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">year</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{new Integer(jobParameters['year'])}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">month</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{new Integer(jobParameters['month'])}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- (10) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSize</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['dataSize']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- (11) --&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offset</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{stepExecutionContext['offset']}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/map&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="comment">&lt;!-- omitted --&gt;</span>

<span class="tag">&lt;batch:job</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">job-repository</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobRepository</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- (12) --&gt;</span>
    <span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.master</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- (13) --&gt;</span>
        <span class="tag">&lt;batch:partition</span> <span class="attribute-name">partitioner</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">salesDataPartitioner</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">step</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="comment">&lt;!-- (14) --&gt;</span>
            <span class="tag">&lt;batch:handler</span> <span class="attribute-name">grid-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">task-executor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parallelTaskExecutor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/batch:partition&gt;</span>
    <span class="tag">&lt;/batch:step&gt;</span>
<span class="tag">&lt;/batch:job&gt;</span>

<span class="comment">&lt;!-- (15) --&gt;</span>
<span class="tag">&lt;batch:step</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">multipleCreateSalesPlanSummaryJob.slave</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;batch:tasklet</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;batch:chunk</span> <span class="attribute-name">reader</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reader</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">processor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addProfitsItemProcessor</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">writer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">writer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">commit-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/batch:tasklet&gt;</span>
<span class="tag">&lt;/batch:step&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Description</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a pagination search (SQL narrowing down method) to fetch a specific data range.<br>
For details of pagination search (SQL narrowing down method),refer
<a href="http://terasolunaorg.github.io/guideline/5.3.0.RELEASE/en/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.html#entity-sql">Pagination search of Entity (SQL narrow down method)</a> of TERASOLUNA Server 5.x Development Guideline.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define SQL to fetch total number of records for processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inject defined Repository(SQLMapper).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calculate data records processed by one Slave step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store data records of (4) in step context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store search start position of each Slave step in step context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Each Slave is stored in the Map to enable fetching of corresponding context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a thread poolto be assigned to each thread of Slave step in multiple processing.<br>
Master step is processed by main thread.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(9)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define ItemReader for fetching data by using pagination search (SQL narrow down method).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(10)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch data records set in (5) from step context and add to search conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(11)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch search start position set in (6) from step context and add to search conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(12)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Master step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define a process which generates partitioning conditions for data.<br>
Set <code>Partitioner</code> interface implementation in <code>partitioner</code> attribute.<br>
Set Bean ID of Slave step defined in (15), in <code>step</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(14)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set number of partitionings (fixed number) in <code>grid-size</code> attribute.<br>
Set Bean ID of thread pool defined in (8), in <code>task-executor</code> attribute.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">(15)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define Slave step.<br>
Set ItemReader defined in (9), in <code>reader</code> attribute.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch09"><a class="anchor" href="#Ch09"></a>9. Tutorial</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch09_Introduction"><a class="anchor" href="#Ch09_Introduction"></a>9.1. Introduction</h3>
<div class="sect3">
<h4 id="Ch09_Introduction_Purpose"><a class="anchor" href="#Ch09_Introduction_Purpose"></a>9.1.1. Objective of the tutorial</h4>
<div class="paragraph">
<p>This tutorial aims to achieve the basic knowledge of TERASOLUNA Batch 5.x by actually experiencing the development
of the application based on the contents described in TERASOLUNA Batch 5.x Development guideline.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_Target"><a class="anchor" href="#Ch09_Introduction_Target"></a>9.1.2. Target readers</h4>
<div class="paragraph">
<p>This tutorial is written for architects and programmers who are experienced in software development
and it is assumed that readers possess the following knowledge.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic knowledge of DI or AOP of Spring Framework</p>
</li>
<li>
<p>Basic knowledge of SQL</p>
</li>
<li>
<p>Experience of developing a Java-based application</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_Environment"><a class="anchor" href="#Ch09_Introduction_Environment"></a>9.1.3. Verification environment</h4>
<div class="paragraph">
<p>Verification of environment conditions for this tutorials are shown as below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Environment conditions</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Software classification</th>
<th class="tableblock halign-left valign-top">Product name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Windows 7 Professional SP1 (64bit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">openjdk-1.8.0.131.x86_64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Tool Suite 3.8.2 released</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build Tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache Maven 3.3.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RDBMS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">H2 Database 1.4.193</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_AboutFrameWork"><a class="anchor" href="#Ch09_Introduction_AboutFrameWork"></a>9.1.4. Overview of framework</h4>
<div class="paragraph">
<p>Overview of processing model and architecture differences are explained here as the overview of framework.<br>
For Spring Batch, refer <a href="#Ch02_SpringBatchArch">Architecture of Spring Batch</a> of TERASOLUNA Batch 5.x Development guideline for details.</p>
</div>
<div class="paragraph">
<p>Processing models offered by TERASOLUNA Batch 5.x include a chunk model and a tasklet model.<br>
Respective features are explained below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Chunk model</dt>
<dd>
<p>A method which inputs/processes/outputs a certain number of data records together. This collection of data is called as a chunk.
A job can be implemented by standardizing flow of processes like data input/processing/output and then implementing only a part of the process.
It is used while processing a large amount of data effectively.<br>
For details, refer <a href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Chunk">Chunk model</a>.</p>
</dd>
<dt class="hdlist1">Tasklet model</dt>
<dd>
<p>A method which describes a process freely. It is used in simple cases like issuing SQL only once, issuing only command or in complex cases
where it is difficult to standardize like accessing from multiple databases or files while processing.<br>
For details, refer <a href="#Ch02_SpringBatchArch_Detail_BusinessLogic_Tasklet">Tasklet model</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For the processing model, the components and functional differences are shown in the table below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Functional differences of processing model</caption>
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function</th>
<th class="tableblock halign-left valign-top">Chunk model</th>
<th class="tableblock halign-left valign-top">Tasklet model</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Components</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It consists of ItemReader, ItemProcessor, ItemWriter and ChunkOrientedTasklet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It consists of Tasklet only.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction occurs for every chunk unit. Transaction control is only for the intermediate commit.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process is done by 1 transaction. Either a batch commit method or intermediate commit method can be used for transaction control.
Former method uses a transaction control system of Spring Batch whereas the transaction is done directly by the user in the later method.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommended reprocessing methods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rerun and restart can be used.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generally, only rerun is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception handling can be easily performed by using a listener. It can also be implemented individually by using try-catch.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Individual implementation by using try-catch is required.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this tutorial, how to implement a chunk model and a tasklet model is explained for the applications which use the basic functions.
Since the implementation method varies according to architecture of chunk model and tasklet model,
it is recommended to proceed further after completely understanding respective features of the model.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Introduction_HowToProceed"><a class="anchor" href="#Ch09_Introduction_HowToProceed"></a>9.1.5. How to proceed with the tutorial</h4>
<div class="paragraph">
<p>Since the applications (jobs) created in this tutorial consists of jobs created
by adding implementations to created jobs, the sequence in which they are created must be considered.</p>
</div>
<div class="paragraph">
<p>How to read and proceed with this tutorial is shown in the figure below along with sequence relation of jobs to be created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/Introduction/Ch09_Introduction_HowToProceed.png" alt="How to Proceed with the Tutorial">
</div>
<div class="title">How to proceed with the tutorial</div>
</div>
<div class="paragraph">
<div class="title">Execution timing for the asynchronous execution type job</div>
<p>The asynchronous execution method job is assumed to be the last job in the order of the progress of this tutorial.
However, if at least one job is created in the chunk model or tasklet model, the asynchronous execution method job may be executed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Additional implementation of jobs which inputs/outputs data by accessing a file</div>
<div class="paragraph">
<p>Implementation is added based on <a href="Ch09_DBAccessJob.html#Ch09_DBAccessJob">Job which inputs/outputs data by accessing database</a>,
besides explanation of <a href="Ch09_FileAccessJob.html#Ch09_FileAccessJob">Job which inputs/outputs data by accessing the file</a> and the execution example is displayed.
When you want to add an implementation based on a job which inputs/outputs data by accessing a file, it must be remembered that it is necessary to read the same.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_TutorialApplication"><a class="anchor" href="#Ch09_TutorialApplication"></a>9.2. Description of the application to be created</h3>
<div class="sect3">
<h4 id="Ch09_Application_Overview"><a class="anchor" href="#Ch09_Application_Overview"></a>9.2.1. Background</h4>
<div class="paragraph">
<p>Some mass retail stores issue point cards for members.<br>
Membership types include "Gold member", "Normal member" and the services are provided based on the membership types.<br>
As a part of the service, 100 points are added for "gold members" and 10 points are added for "normal members" at the end of the month, for the members who have purchased a product during that month.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_ProcessingOverview"><a class="anchor" href="#Ch09_Application_ProcessingOverview"></a>9.2.2. Process overview</h4>
<div class="paragraph">
<p>TERASOLUNA Batch 5.x will be using an application as a monthly batch process which adds points based on membership type.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_BusinessRequirements"><a class="anchor" href="#Ch09_Application_BusinessRequirements"></a>9.2.3. Business specifications</h4>
<div class="paragraph">
<p>Business specifications are as shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"Members who have purchased a product within the month" are indicated by "product purchasing" flag</p>
<div class="ulist">
<ul>
<li>
<p>Product purchasing flag "0" indicates initial state whereas "1" indicates processing target</p>
</li>
</ul>
</div>
</li>
<li>
<p>When Product purchasing flag is "1"(processing target), points are added according to membership type</p>
<div class="ulist">
<ul>
<li>
<p>Add 100 points when membership type is "G"(gold member) and add 10 points when membership type is "N"(Normal member)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Product purchasing flag is updated to "0" (initial state) after adding points</p>
</li>
<li>
<p>Upper limit for the points is 1,000,000 points</p>
</li>
<li>
<p>If the points exceed 1,000,000 points after adding the points, they are adjusted to 1,000,000 points</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_Application_ImplementationMethod"><a class="anchor" href="#Ch09_Application_ImplementationMethod"></a>9.2.4. Learning contents</h4>
<div class="paragraph">
<p>We will learn about various functions and processing methods related to jobs by creating applications for simple business specifications.<br>
Note that jobs implement tasklet model and chunk model respectively.<br>
The main learning in each job is the functions and processing methods used in the job are shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Jobs created in this tutorial</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 30%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Jobs</th>
<th class="tableblock halign-left valign-top">Contents learnt</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_DBAccessJob.html#Ch09_DBAccessJob">A job that inputs/outputs data by accessing a database</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn about database access method which use ItemReader and ItemWriter for MyBatis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_FileAccessJob.html#Ch09_FileAccessJob">A job that inputs/outputs data by accessing a file</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn about file access method which use ItemReader and ItemWriter for input and output of a flat file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_ValidationJob.html#Ch09_ValidationJob">A job that validates input data</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn input check methods using Bean Validation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">D</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_ExceptionHandlingWithListenerJob.html#Ch09_ExceptionHandlingWithListenerJob">A job that performs exception handling by ChunkListener</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn exception handling methods which use ChunkListener as a listener.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_ExceptionHandlingWithTryCatchJob.html#Ch09_ExceptionHandlingWithTryCatchJob">A job which performs exception handling by try-catch</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn exception handling and skipping which use try-catch, and a method which outputs customised exit codes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="Ch09_AsyncExecutionJob.html#Ch09_AsyncExecutionJob">Asynchronous execution type job</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Learn the methods of asynchronous execution which use DB polling function offered by TERASOLUNA Batch 5.x.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Correspondence table for Functions and processing methods used in A~F jobs, and explanation of TERASOLUNA Batch 5.x Development guideline is shown as below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Correspondence table for A~F jobs and TERASOLUNA Batch 5.x Development guideline explanation</caption>
<colgroup>
<col style="width: 5%;">
<col style="width: 41%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
<col style="width: 9%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Sr. No.</th>
<th class="tableblock halign-left valign-top">Functions</th>
<th class="tableblock halign-left valign-top">A</th>
<th class="tableblock halign-left valign-top">B</th>
<th class="tableblock halign-left valign-top">C</th>
<th class="tableblock halign-left valign-top">D</th>
<th class="tableblock halign-left valign-top">E</th>
<th class="tableblock halign-left valign-top">F</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start job &gt; Activation method &gt; <a href="#Ch04_SyncJob">Synchronous execution</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start job &gt; Activation method &gt; <a href="#Ch04_AsyncJobWithDB">Asynchronous execution (DB polling)</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start job &gt; Start-up parameters of job &gt; <a href="#Ch04_JobParameter_HowToUse_CLIArgs">Assign from command line argument</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start job &gt; <a href="#Ch04_Listener">Listener</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; Transaction control &gt; <a href="#Ch05_Transaction_architecture_UnderSpringBatch">Transaction control in Spring Batch</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; Transaction control &gt; Single data source &gt; <a href="#Ch05_Transaction_HowToUse_SingleDataSource_Tx">Implementing transaction control</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; Database access &gt; <a href="#Ch05_DBAccess_HowToUse_Input">Database access in ItemReader</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; Database access &gt; <a href="#Ch05_DBAccess_HowToUse_Output">Database access in ItemWriter</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application development flow &gt; Create Tasklet model job &gt; <a href="#Ch03_CreateTaskletJob_HowToUse_Implements_InOut">Tasklet implementation which use components of chunk model</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; File access &gt; Variable length record &gt; <a href="#Ch05_FileAccess_VariableLength_Input">Input</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data input/output &gt; File access &gt; Variable length record &gt; <a href="#Ch05_FileAccess_VariableLength_Output">Output</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling abnormalities &gt; <a href="#Ch06_InputValidation">Input check</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling abnormalities &gt; Exception handling &gt; Step unit exception handling &gt; <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_ChunkListener">Exception handling by using ChunkListener interface</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling abnormalities &gt; Exception handling &gt; Step unit exception handling &gt; <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Chunk">Exception handling in chunk model</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling abnormalities &gt; Exception handling &gt; Step unit exception handling &gt; <a href="#Ch06_ExceptionHandling_HowToUse_ExceptionHandling_Tasklet">Exception handling in tasklet model</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handling abnormalities &gt; Exception handling &gt; Determine whether to continue processing &gt; <a href="#Ch06_ExceptionHandling_Overview_Deal_Skip">Skip</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job management &gt; Job status management &gt; <a href="#Ch07_JobManagement_JobStatusManagement_Retrieve">Verify job status and execution results</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job management &gt; <a href="#Ch07_JobManagement_ExitCode">Customize exit code</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job management &gt; <a href="#Ch07_JobManagement_Logging">Logging</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Job management &gt; <a href="#Ch07_JobManagement_MessageManagement">Message management</a></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="red">Chunk</span> <span class="blue">Tasklet</span></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_EnvironmentConstruction"><a class="anchor" href="#Ch09_EnvironmentConstruction"></a>9.3. Environment construction</h3>
<div class="paragraph">
<p>Construct an environment to implement the tutorial with the following flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_BlankProject">Creating a project</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_Import">Import project</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_BlankProjectConstruction">Build project</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_Setting">Verify / edit setup file</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation">Preparation of input data</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_DataSourceExplorer">Preparation to refer database from STS</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck">Verify operations of project</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_BlankProject"><a class="anchor" href="#Ch09_EnvironmentConstruction_BlankProject"></a>9.3.1. Creating a project</h4>
<div class="paragraph">
<p>At first, use <code>mvn archetype:generate</code> of <code>Maven Archetype Plugin</code> and create a project.<br>
A procedure to create a project by using Windows command prompt.</p>
</div>
<div class="paragraph">
<p>For details of how to create a project by using <code>mvn archetype:generate</code>, refer <a href="#Ch03_CreateProject_HowToCreate">Create a project</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Through proxy server</div>
<div class="paragraph">
<p>If it is necessary to go through proxy server for connecting to internet, use Proxy settings of STS, and <a href="http://maven.apache.org/guides/mini/guide-proxies.html">Proxy settings of Maven</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Execute following command in the directory wherein a project is created.</p>
</div>
<div class="listingblock">
<div class="title">Command prompt (Windows)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate ^
  -DarchetypeGroupId=org.terasoluna.batch ^
  -DarchetypeArtifactId=terasoluna-batch-archetype ^
  -DarchetypeVersion=5.0.1.RELEASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set interactively as shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Value to be set while creating a project</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item name</th>
<th class="tableblock halign-left valign-top">Setting example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groupId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">artifactId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">terasoluna-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.0.0-SNAPSHOT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.terasoluna.batch.tutorial</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Verify that "BUILD SUCCESS" is displayed for mvn command as shown below.</p>
</div>
<div class="listingblock">
<div class="title">Implementation example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn archetype:generate -DarchetypeGroupId=org.terasoluna.batch -Darchetyp
eArtifactId=terasoluna-batch-archetype -DarchetypeVersion=5.0.1.RELEASE
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building Maven Stub Project (No POM) 1
[INFO] ------------------------------------------------------------------------

(.. omitted)

Define value for property 'groupId': org.terasoluna.batch
Define value for property 'artifactId': terasoluna-batch-tutorial
Define value for property 'version' 1.0-SNAPSHOT: : 1.0.0-SNAPSHOT
Define value for property 'package' org.terasoluna.batch: : org.terasoluna.batch
.tutorial
Confirm properties configuration:
groupId: org.terasoluna.batch
artifactId: terasoluna-batch-tutorial
version: 1.0.0-SNAPSHOT
package: org.terasoluna.batch.tutorial
 Y: : y
[INFO] -------------------------------------------------------------------------
---
[INFO] Using following parameters for creating project from Archetype: terasolun
a-batch-archetype:5.0.1.RELEASE
[INFO] -------------------------------------------------------------------------
---
[INFO] Parameter: groupId, Value: org.terasoluna.batch
[INFO] Parameter: artifactId, Value: terasoluna-batch-tutorial
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: package, Value: org.terasoluna.batch.tutorial
[INFO] Parameter: packageInPathFormat, Value: org/terasoluna/batch/tutorial
[INFO] Parameter: package, Value: org.terasoluna.batch.tutorial
[INFO] Parameter: version, Value: 1.0.0-SNAPSHOT
[INFO] Parameter: groupId, Value: org.terasoluna.batch
[INFO] Parameter: artifactId, Value: terasoluna-batch-tutorial
[INFO] Project created from Archetype in dir: C:\xxx\terasoluna-batch-tutorial
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 45.293 s
[INFO] Finished at: 2017-08-22T09:03:01+09:00
[INFO] Final Memory: 16M/197M
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute sample job and verify that the project was created successfully.</p>
</div>
<div id="Ch09_EnvironmentConstruction_BlankProject_ExecSample" class="listingblock">
<div class="title">Execution of sample job (Verify that it is successfully created)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;cd terasoluna-batch-tutorial
C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package
C:\xxx&gt;java -cp &quot;lib/*;target/*&quot; ^
org.springframework.batch.core.launch.support.CommandLineJobRunner ^
META-INF/jobs/job01.xml job01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that "BUILD SUCCESS" is displayed for mvn command and "COMPLETED" is displayed for java command, as shown below.</p>
</div>
<div class="listingblock">
<div class="title">Output example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;cd terasoluna-batch-tutorial

C:\xxx\terasoluna-batch-tutorial&gt;mvn clean dependency:copy-dependencies -Doutput
Directory=lib package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building TERASOLUNA Batch Framework for Java (5.x) Blank Project 1.0.0-SN
APSHOT
[INFO] ------------------------------------------------------------------------

(.. omitted)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 9.462 s
[INFO] Finished at: 2017-08-22T09:12:22+09:00
[INFO] Final Memory: 26M/211M
[INFO] ------------------------------------------------------------------------

C:\xxx\terasoluna-batch-tutorial&gt;java -cp &quot;lib/*;target/*&quot; org.springframework.b
atch.core.launch.support.CommandLineJobRunner META-INF/jobs/job01.xml job01
[2017/08/22 09:17:32] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Re
freshing org.springframework.context.support.ClassPathXmlApplicationContext@6204
3840: startup date [Tue Aug 22 09:17:32 JST 2017]; root of context hierarchy

(.. ommited)

[2017/08/22 09:17:35] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJ
ob: [name=job01]] launched with the following parameters: [{jsr_batch_run_id=1}]

[2017/08/22 09:17:35] [main] [o.s.b.c.j.SimpleStepHandler] [INFO ] Executing ste
p: [job01.step01]
[2017/08/22 09:17:35] [main] [o.s.b.c.l.s.SimpleJobLauncher] [INFO ] Job: [FlowJ
ob: [name=job01]] completed with the following parameters: [{jsr_batch_run_id=1}
] and the following status: [COMPLETED]
[2017/08/22 09:17:35] [main] [o.s.c.s.ClassPathXmlApplicationContext] [INFO ] Cl
osing org.springframework.context.support.ClassPathXmlApplicationContext@6204384
0: startup date [Tue Aug 22 09:17:32 JST 2017]; root of context hierarchy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_Import"><a class="anchor" href="#Ch09_EnvironmentConstruction_Import"></a>9.3.2. Import project</h4>
<div class="paragraph">
<p>Import a created project to STS.<br>
Select [File] &#8594; [Import] &#8594; [Maven] &#8594; [Existing Maven Projects] &#8594; [Next] from STS menu and select a project created by archetype.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_ImportMavenProjects.png" alt="Import Existing Maven Projects">
</div>
</div>
<div class="paragraph">
<p>Set <code>C:\xxx\terasoluna-batch-tutorial</code> in Root Directory and press [Finish] when pom.xml of org.terasoluna.batch is selected in Projects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_Import.png" alt="Select Maven Projects">
</div>
</div>
<div class="paragraph">
<p>When the import is complete, the following project is displayed as below in the Package Explorer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_Import_PackageExplorer.png" alt="Package Explorer">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">When a build error occurs after import</div>
<div class="paragraph">
<p>When a build error occurs after import, right click project name, click "Maven" &#8594; "Update Project&#8230;&#8203;", click "OK" to resolve the error.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Setting display format for the package</div>
<div class="paragraph">
<p>Display format of the package is "Flat" by default, but it should be set to "Hierarchical".<br>
Click "View Menu" of Package Explorer (Down right arrow) and select "Package Presentation" &#8594; "Hierarchical".</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_BlankProjectConstruction"><a class="anchor" href="#Ch09_EnvironmentConstruction_BlankProjectConstruction"></a>9.3.3. Build project</h4>
<div class="paragraph">
<p>For project structure, refer <a href="#Ch03_CreateProject_ProjectStructure">Project structure</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_Setting"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting"></a>9.3.4. Verify / edit setup file</h4>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_Setting_Check"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting_Check"></a>9.3.4.1. Verify setup file</h5>
<div class="paragraph">
<p>A majority of the settings like Spring Batch and MyBatis are already configured in the created project.<br>
For setting file of created project, refer <a href="#Ch03_CreateProject_ProjectStructure">Build project</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Customizing setting value</div>
<div class="paragraph">
<p>When implementing the tutorial, you do not need to understand the setting values that need customization according to user&#8217;s situation. However, you should read it before or after you perform the tutorial.
For details, refer <a href="#Ch03_CreateProject_Make_Setting">Settings for whole application</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_Setting_Edit"><a class="anchor" href="#Ch09_EnvironmentConstruction_Setting_Edit"></a>9.3.4.2. Editing setting file</h5>
<div class="paragraph">
<p>Change setting of H2 Database for implementing the tutorial. Changes in the setting are shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is possible to connect to database from processes of multiple batch applications without manually starting the server.</p>
</li>
<li>
<p>It is possible to connect to database when the data is retained even after terminating batch application processes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, refer <a href="http://www.h2database.com/html/features.html">Features of H2 official document</a> for details of H2 Database settings.</p>
</div>
<div class="paragraph">
<p>Basic details of editing are shown below.</p>
</div>
<div class="paragraph">
<p>Open batch-application.properties and edit <code>admin.jdbc.url</code> and <code>jdbc.url</code> as shown below.<br>
Only the lines to be edited are described here for the sake of clarity in the example below, a new line is added after comment out instead of overwriting.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">##  Application settings.

# Admin DataSource settings.
#admin.jdbc.url=jdbc:h2:mem:batch-admin;DB_CLOSE_DELAY=-1
admin.jdbc.url=jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE

# Job DataSource settings.
#jdbc.url=jdbc:h2:mem:batch;DB_CLOSE_DELAY=-1
jdbc.url=jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Reasons for specifying same database name (batch-admin) for admin.jdbc.url and jdbc.url</div>
<div class="paragraph">
<p>Same database name is specified for <code>admin.jdbc.url</code> and <code>jdbc.url</code>, for connection settings of JDBC driver while implementing the tutorial.</p>
</div>
<div class="paragraph">
<p>As described in <a href="#Ch03_CreateProject_Make_Setting">Settings of overall application</a>, <code>admin.jdbc.url</code> is a URL used by FW(Spring Batch and TERASOLUNA Batch 5.x) and <code>jdbc.url</code> is a URL used by individual jobs.</p>
</div>
<div class="paragraph">
<p>Originally, it is preferable to separate databases used by FW and individual jobs.<br>
However, it is not necessary to switch between the databases in this tutorial, this setting is used to enable easy reference to the table to be used in FW and tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_InputDataPreparation"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation"></a>9.3.5. Preparation of input data</h4>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB"></a>9.3.5.1. Input data of jobs which inputs or outputs data by accessing database</h5>
<div class="paragraph">
<p>Prepare input data to be used in <a href="Ch09_DBAccessJob.html#Ch09_DBAccessJob">A job which inputs or outputs data by accessing database</a>.<br>
Note that, implementation is not required when a job which inputs or outputs data by accessing database is not be to created.</p>
</div>
<div class="paragraph">
<p>Preparation of input data is shown with the following flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL">Create table and initial data insertion script</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting">Adding settings which executes script automatically while executing a job</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Execute a script at the time of job execution (while generating ApplicationContext) and initialize database by applying these settings.</p>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_SQL"></a>9.3.5.1.1. Create table and initial data insertion script</h6>
<div class="paragraph">
<p>Create table and initial data insertion script.</p>
</div>
<div class="paragraph">
<p>Create a <code>sqls</code> directory in the project root directory and store following 3 scripts.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A script to create a table (<code>create-member-info-table.sql</code>)</p>
</li>
<li>
<p>A script to insert initial data (normal) (<code>insert-member-info-data.sql</code>)</p>
</li>
<li>
<p>A script to insert initial data (abnormal) (<code>insert-member-info-error-data.sql</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Contents of the file to be created are shown below.</p>
</div>
<div class="listingblock">
<div class="title">sqls/create-member-info-table.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> member_info (
    id <span class="predefined-type">CHAR</span>(<span class="integer">8</span>),
    type <span class="predefined-type">CHAR</span>(<span class="integer">1</span>),
    status <span class="predefined-type">CHAR</span>(<span class="integer">1</span>),
    point <span class="predefined-type">INT</span>,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span>(id)
);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">sqls/insert-member-info-data.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">TRUNCATE</span> <span class="type">TABLE</span> member_info;
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000001</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000002</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000003</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000004</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000005</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000006</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000007</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000008</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000009</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000010</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000011</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000012</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000013</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999901</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000014</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999991</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000015</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">999900</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000016</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">999990</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000017</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000018</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000019</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000020</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000021</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000022</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000023</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000024</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000025</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000026</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000027</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000028</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">1000000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000029</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999899</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000030</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999989</span>);
<span class="class">COMMIT</span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">sqls/insert-member-info-error-data.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">TRUNCATE</span> <span class="type">TABLE</span> member_info;
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000001</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000002</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000003</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000004</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000005</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000006</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">100</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000007</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000008</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000009</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000010</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">0</span><span class="delimiter">'</span></span>, <span class="integer">10000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000011</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000012</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">100000</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000013</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">1000001</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000014</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">N</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999991</span>);
<span class="class">INSERT</span> <span class="class">INTO</span> member_info (id, type, status, point) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">00000015</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">G</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1</span><span class="delimiter">'</span></span>, <span class="integer">999901</span>);
<span class="class">COMMIT</span>;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB_Setting"></a>9.3.5.1.2. Adding settings which executes script automatically while executing a job</h6>
<div class="paragraph">
<p>Execute a script while executing a job (while generating ApplicationContext) and add definition of <code>&lt;jdbc:initialize-database&gt;</code> tag to initialize database.<br></p>
</div>
<div class="paragraph">
<p>Edit following 2 files.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add path setting for script to be executed in batch-application.properties</p>
</li>
<li>
<p>Add definition of <code>&lt;jdbc:initialize-database&gt;</code> tag in launch-context.xml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specific setting details are shown below.</p>
</div>
<div class="paragraph">
<p>Open batch-application.properties and add path settings of script to be executed in the end.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tutorial.create-table.script(A path for a script to create a table)</p>
</li>
<li>
<p>tutorial.insert-data.script(A path for a script to insert initial data)<br></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Normal data and abnormal data are defined with the same property name to enable easy change of script to be executed, for the path of initial data insertion script, and commented out.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/batch-application.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt"># Database Initialize
tutorial.create-table.script=file:sqls/create-member-info-table.sql
tutorial.insert-data.script=file:sqls/insert-member-info-data.sql
#tutorial.insert-data.script=file:sqls/insert-member-info-error-data.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open launch-context.xml, and add definition of &lt;jdbc:initialize-database&gt; tag, in <code>&lt;beans&gt;</code> tag.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/spring/launch-context.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="comment">&lt;!-- database initialize definition --&gt;</span>
<span class="tag">&lt;jdbc:initialize-database</span> <span class="attribute-name">data-source</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jobDataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${data-source.initialize.enabled:false}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ignore-failures</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ALL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${tutorial.create-table.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;jdbc:script</span> <span class="attribute-name">location</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${tutorial.insert-data.script}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/jdbc:initialize-database&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_InputDataPreparation_File"><a class="anchor" href="#Ch09_EnvironmentConstruction_InputDataPreparation_File"></a>9.3.5.2. Input data for a job which inputs or outputs data by accessing the file</h5>
<div class="paragraph">
<p>Prepare input data to be used in <a href="Ch09_FileAccessJob.html#Ch09_FileAccessJob">A job which inputs or outputs data by accessing a file</a>.<br>
Note that, the implementation is not required when a job which inputs or outputs data by accessing a file is not created.</p>
</div>
<div class="paragraph">
<p>A storage directory is created for input and output files, and an input file is created for preparation of input data.</p>
</div>
<div class="paragraph">
<p>Create following 2 directories to store input / output files in the project root directory.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>files/input</code></p>
</li>
<li>
<p><code>files/output</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create following 2 files under <code>files/input</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Normal data input file (<code>input-member-info-data.csv</code>)</p>
</li>
<li>
<p>Abnormal data input file (<code>input-member-info-error-data.csv</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Store input file with following details in created input file storage directory.</p>
</div>
<div class="paragraph">
<p>Contents of the file to be created are as below.</p>
</div>
<div class="listingblock">
<div class="title">files/input/input-member-info-data.csv</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">00000001,G,1,0
00000002,N,1,0
00000003,G,0,10
00000004,N,0,10
00000005,G,1,100
00000006,N,1,100
00000007,G,0,1000
00000008,N,0,1000
00000009,G,1,10000
00000010,N,1,10000
00000011,G,0,100000
00000012,N,0,100000
00000013,G,1,999901
00000014,N,1,999991
00000015,G,0,999900
00000016,N,0,999990
00000017,G,1,10
00000018,N,1,10
00000019,G,0,100
00000020,N,0,100
00000021,G,1,1000
00000022,N,1,1000
00000023,G,0,10000
00000024,N,0,10000
00000025,G,1,100000
00000026,N,1,100000
00000027,G,0,1000000
00000028,N,0,1000000
00000029,G,1,999899
00000030,N,1,999989</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">files/input/input-member-info-error-data.csv</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">00000001,G,0,0
00000002,N,0,0
00000003,G,1,10
00000004,N,1,10
00000005,G,0,100
00000006,N,0,100
00000007,G,1,1000
00000008,N,1,1000
00000009,G,0,10000
00000010,N,0,10000
00000011,G,1,100000
00000012,N,1,100000
00000013,G,1,1000001
00000014,N,1,999991
00000015,G,1,999901</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_DataSourceExplorer"><a class="anchor" href="#Ch09_EnvironmentConstruction_DataSourceExplorer"></a>9.3.6. Preparation to refer database from STS</h4>
<div class="paragraph">
<p>Since Data Source Explorer is used to refer database in this tutorial, configure Data Source Explorer.<br>
Database can be referred and SQL can be executed on STS by using Data Source Explorer.</p>
</div>
<div class="paragraph">
<p>Database targets to be referred in the tutorial are as shown below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data for managing batch applications execution results and status persisting in JobRepository</p>
</li>
<li>
<p>Data which uses <a href="Ch09_DBAccessJob.html#Ch09_DBAccessJob">A job which inputs or outputs data by accessing database</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At first, display Data Source Explorer View.<br>
Select [Window] &#8594; [Show View] &#8594; [Other&#8230;&#8203;] from STS menu and press [OK] when Data Source Explorer is selected under Data Source Management.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_ShowView.png" alt="Show View">
</div>
</div>
<div class="paragraph">
<p>Data Source Explorer View is displayed on the workbench.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_DataSourceExplorerView.png" alt="Data Source Explorer View">
</div>
</div>
<div class="paragraph">
<p>Next, create a ConnectionProfile to connect to a database.<br>
Right-click Database Connection of Data Source Explorer View, press [New&#8230;&#8203;] and display Connection Profile.<br>
Then, select Generic JDBC, and click [Next] when <code>H2 Database</code> is entered in Name.<br>
(Any value can be entered in Name.)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewConnectionProfileType.png" alt="New Conenction Profile Type">
</div>
</div>
<div class="paragraph">
<p>Since Driver is not configured in the initial state, add a Driver to connect to H2 Database.<br>
Click New Driver Definition button on the right side of Drivers drop down list, and display definition window of Driver.</p>
</div>
<div class="paragraph">
<p>Select Generic JDBC driver under Available driver templates, of Name/Type tab.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionName.png" alt="New Driver Difinition Name/Type">
</div>
</div>
<div class="paragraph">
<p>Next, open JAR List tab, click [Add Jar/Zip&#8230;&#8203;], select jar file of H2 Database and click [Open].</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">A location where jar of H2 Database is stored</div>
<div class="paragraph">
<p>jar of H2 Database is stored under <code>lib</code> directory of project root directory.<br>
This is because dependency libraries are copied under <code> lib</code> directory by executing following command of <a href="#Ch09_EnvironmentConstruction_BlankProject_ExecSample">Execution of sample jobs (Verify that they are created appropriately)</a>.
Following command should be executed when <code>lib</code> directory does not store jar of H2 Database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">C:\xxx&gt;mvn clean dependency:copy-dependencies -DoutputDirectory=lib package</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionJARList.png" alt="New Driver Difinition JAR List">
</div>
</div>
<div class="paragraph">
<p>Next, open the Properties tab, set following contents, click [OK] and add Driver.</p>
</div>
<div class="paragraph">
<p>Any value can be set in Database Name. Other setting values are same as values set in batch-application.properties.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Values set in Properties tab</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbc:h2:~/batch-admin;AUTO_SERVER=TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">terasoluna-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Driver Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.h2.Driver</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sa</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewDriverDifinitionProperties.png" alt="New Driver Difinition Properties">
</div>
</div>
<div class="paragraph">
<p>Verify that Driver is added to configured details and click [Finish].</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_NewConnectionProfileDetails.png" alt="New Conenction Profile Details">
</div>
</div>
<div class="paragraph">
<p>When Connection Profile is created, connection to H2 Database is displayed in Data Source Explorer View.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_DataSourceExplorer_DataSourceExplorerAddedConnection.png" alt="Data Source Explorer added Connection">
</div>
</div>
<div class="paragraph">
<p>Preparation to refer database from STS is now complete.<br>
Settings of Data Source Explorer are verified in <a href="#Ch09_EnvironmentConstruction_OperationCheck">Verify operations of project</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="Ch09_EnvironmentConstruction_OperationCheck"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck"></a>9.3.7. Verify operations of project</h4>
<div class="paragraph">
<p>Procedure to verify operations of project are shown below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob">Execute job in STS</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB">Refer a database by using Data Source Explorer</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob"></a>9.3.7.1. Execute job in STS</h5>
<div class="paragraph">
<p>Procedure to execute job in STS is shown below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf">Creating Run Configuration (Execution configuration)</a></p>
</li>
<li>
<p><a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run">Job execution and results verification</a></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to execute a job</div>
<div class="paragraph">
<p>Although the job is originally executed from a shell script, a procedure to execute the job in STS is used in the tutorial for easy explanation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf"></a>9.3.7.1.1. Creating Run Configuration (Execution configuration)</h6>
<div class="paragraph">
<p>How to create Run Configuration (execution configuration) using execution of sample job as an example is explained.</p>
</div>
<div class="paragraph">
<p>Select Java Application from STS menu - [Run] &#8594; [Run Configurations&#8230;&#8203;] &#8594; List of types, right-click &#8594; select [New], display Run Configuration creation screen and set value given below.<br></p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Value set in Main tab of Run Configurations</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execute Job01<br>
(Set any value)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">terasoluna-batch-tutorial</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.springframework.batch.core.launch.support.CommandLineJobRunner</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf_Main.png" alt="Run Configurations Main tab">
</div>
</div>
<div class="paragraph">
<p>Next, open Arguments tab and set value given below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Value to be set in Arguments tab of Run Configurations</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item name</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Program arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF/jobs/job01.xml job01</p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf_Arg.png" alt="Run Configurations Arguments tab">
</div>
</div>
<div class="paragraph">
<p>Click [Apply] when settings are completed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Value to be set while creating Run Configuration</div>
<div class="paragraph">
<p>Parameters same as command for <a href="#Ch09_EnvironmentConstruction_BlankProject_ExecSample">Execution of sample job (Verify that it is created successfully)</a> are set in Run Configuration.<br>
However, the class path is resolved automatically by STS while setting the project to Project of Main tab.<br>
Parameters should be changed according to the job to be executed, for the parameters set in Run Configuration.<br>
Note that, parameters of inputFile and outputFile are also required for the job accessing the file.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run"></a>9.3.7.1.2. Job execution and results verification</h6>
<div class="paragraph">
<p>How to verify job execution and results is explained.<br>
Verification of execution results for the job explained here include console log verification and exit code verification for the job.</p>
</div>
<div class="paragraph">
<p>Use Debug View in this tutorial to verify exit code of job execution. How to display Debug View is subsequently explained.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Reasons to display Debug View</div>
<div class="paragraph">
<p>If Debug View is not displayed in STS, it is not possible to verify exit code while executing a job.<br>
Result must be verified by displaying Debug View to convert the exit code of the job by listener in <a href="Ch09_ExceptionHandlingWithTryCatchJob.html#Ch09_ExceptionHandlingWithTryCatchJob">Job which performs exception handling by try-catch</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At first, a method to execute job is explained.</p>
</div>
<div class="paragraph">
<p>Select Execute job created in <a href="#Ch09_EnvironmentConstruction_OperationCheck_ExecJob_RunConf">Creating Run Configuration (Execution configuration)</a> under Java Application from STS menu - [Run] &#8594; [Run Configurations&#8230;&#8203;] &#8594; Type list, click [Run] to execute the job.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_Job01.png" alt="Run Job01">
</div>
</div>
<div class="paragraph">
<p>Verify execution results of the job in console log.<br>
Job is executed successfully if the display is as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_Job01Console.png" alt="Run Job01 console">
</div>
</div>
<div class="paragraph">
<p>Next, display Debug View and verify the exit code of job execution.</p>
</div>
<div class="paragraph">
<p>Select [Window] &#8594; [Show View] &#8594; [Other&#8230;&#8203;] from STS menu, and click [OK] when Debug is selected under Debug.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_ShowView.png" alt="Show View">
</div>
</div>
<div class="paragraph">
<p>Debug is displayed on the workbench.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_ExecJob_Run_DebugView.png" alt="Debug View">
</div>
</div>
<div class="paragraph">
<p>It can be verified that exit code of job execution is <code>0</code> by displaying <code>&lt;terminated, exit value: 0&gt;</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">When job execution fails in STS</div>
<div class="paragraph">
<p>If execution of job fails in STS even though correct source code is used, job can be executed successfully by resolving incomplete build status. Procedure is shown below.<br>
Select [project] &#8594; [clean] from STS menu.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Ch09_EnvironmentConstruction_OperationCheck_RefDB"><a class="anchor" href="#Ch09_EnvironmentConstruction_OperationCheck_RefDB"></a>9.3.7.2. Refer a database by using Data Source Explorer</h5>
<div class="paragraph">
<p>A method to use database by using Data Source Explorer View is explained.</p>
</div>
<div class="paragraph">
<p>List of tables can be verified by opening the database BATCH-ADMIN  in Data Source Explorer in hierarchy as below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_RefDB_Tables.png" alt="Show Tables">
</div>
</div>
<div class="paragraph">
<p>When Spring Batch metadata table (For details, refer <a href="#Ch02_SpringBatchArch_Detail_JobRepository_Metadata">metadata schema of JobRepository</a>) and,
<a href="#Ch09_EnvironmentConstruction_InputDataPreparation_DB">Preparation of input data for the job which inputs or outputs data by accessing a database</a> are implemented, verify that <code>MEMBER_INFO</code> table is created.</p>
</div>
<div class="paragraph">
<p>Next, records stored in the table can be referred by the method given below.</p>
</div>
<div class="paragraph">
<p>Right-click the table to be referred, select [Data] &#8594; [Edit] and you can refer a record stored in the table in table format.<br>
An example referring to <code>BATCH_JOB_INSTANCE</code> table is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ch09/EnvironmentConstruction/Ch09_EnvironmentConstruction_OperationCheck_RefDB_BATCH_JOB_INSTANCE.png" alt="Show BATCH_JOB_INSTANCE">
</div>
</div>
<div class="paragraph">
<p>You can see that a job called <code>job01</code> is executed.</p>
</div>
<div class="paragraph">
<p>Environment construction tutorial is now complete.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Ch09_JobCoding"><a class="anchor" href="#Ch09_JobCoding"></a>9.4. Implementation of batch jobs</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="Ch09_DBAccessJob.html">A job that performs data input and output by accessing a database</a></p>
</li>
<li>
<p><a href="Ch09_FileAccessJob.html">A job which performs data input and output by accessing a file</a></p>
</li>
<li>
<p><a href="Ch09_ValidationJob.html">A job that validates input data</a></p>
</li>
<li>
<p><a href="Ch09_ExceptionHandlingWithListenerJob.html">A job that performs exception handling by ChunkListener</a></p>
</li>
<li>
<p><a href="Ch09_ExceptionHandlingWithTryCatchJob.html">A job that performs exception handling by try-catch</a></p>
</li>
<li>
<p><a href="Ch09_AsyncExecutionJob.html">Asynchronous execution type job</a></p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="Ch09_Conclusion"><a class="anchor" href="#Ch09_Conclusion"></a>9.5. Conclusion</h3>
<div class="paragraph">
<p>We will learn following contents in this tutorial.</p>
</div>
<div class="paragraph">
<p>How to implement a basic batch job using TERASOLUNA Batch 5.x</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="Ch09_DBAccessJob.html#Ch09_DBAccessJob">A job that performs data input and output by accessing a database</a></p>
</li>
<li>
<p><a href="Ch09_FileAccessJob.html#Ch09_FileAccessJob">A job that performs data input and output by accessing a file</a></p>
</li>
<li>
<p><a href="Ch09_ValidationJob.html#Ch09_ValidationJob">A job that validates input data</a></p>
</li>
<li>
<p><a href="Ch09_ExceptionHandlingWithListenerJob.html#Ch09_ExceptionHandlingWithListenerJob">A job that performs exception handling by ChunkListener</a></p>
</li>
<li>
<p><a href="Ch09_ExceptionHandlingWithTryCatchJob.html#Ch09_ExceptionHandlingWithTryCatchJob">A job that performs exception handling by try-catch</a></p>
</li>
<li>
<p><a href="Ch09_AsyncExecutionJob.html#Ch09_AsyncExecutionJob">A job that executes asynchronously</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, TERASOLUNA Batch 5.x should be used and the guidelines mentioned in <a href="#Ch99_SummaryOfPoints_AboutThis">Precautions while using</a> should be followed while developing a batch application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ch99_SummaryOfPoints"><a class="anchor" href="#Ch99_SummaryOfPoints"></a>10. Summary of points</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Ch99_SummaryOfPoints_AboutThis"><a class="anchor" href="#Ch99_SummaryOfPoints_AboutThis"></a>10.1. Notes on TERASOLUNA Batch 5.x</h3>
<div class="paragraph">
<p>This is a summarized list of the rules and notes about using TERASOLUNA Batch 5.x that are explained in each section.
Users should keep in mind the following points and proceed when developing a batch application.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only the salient points are mentioned here instead of covering the entire consider material.
Users should read the guideline of function to be used.</p>
</div>
</td>
</tr>
</table>
</div>
<hr>
<div class="ulist">
<div class="title">Rules and notes to be considered for batch process</div>
<ul>
<li>
<p>Single batch process should be simplified and complex logical structures should be avoided.</p>
</li>
<li>
<p>Same operation should not be performed in multiple jobs over and over again.</p>
</li>
<li>
<p>Usage of system resources should be minimized, unnecessary physical I/O should be avoided and on-memory operations should be utilized.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Guidelines for TERASOLUNA Batch 5.x</div>
<ul>
<li>
<p><a href="#Ch03_CreateProject">Development of batch application</a></p>
<div class="ulist">
<ul>
<li>
<p>Create as 1 job=1 Bean definition(1 job definition)</p>
</li>
<li>
<p>Create as 1 step=1 batch process=1 business logic</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateChunkJob">Chunk model</a></p>
<div class="ulist">
<ul>
<li>
<p>Use it for efficiently processing large amount of data.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">Tasklet model</a></p>
<div class="ulist">
<ul>
<li>
<p>Use for simple processing, processing that is hard to standardize, and to process data by single commit.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_SyncJob">Synchronous job</a></p>
<div class="ulist">
<ul>
<li>
<p>Use for starting a job as per the schedule and for batch processing by combining multiple jobs.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithDB">Asynchronous job(DB polling)</a></p>
<div class="ulist">
<ul>
<li>
<p>Use for delayed process, continuous execution of job with short processing time and consolidation of large jobs.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch04_AsyncJobWithWeb">Asynchronous job (Web container)</a></p>
<div class="ulist">
<ul>
<li>
<p>Similar to DB polling. However, use when instantaneous start is required.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Management of JobRepository</p>
<div class="ulist">
<ul>
<li>
<p>In Spring Batch, use <code>JobRepository</code> for recording start status and execution result of job.</p>
</li>
<li>
<p>In TERASOLUNA Batch 5.x, persistence is optional if it corresponds to all the following.</p>
<div class="ulist">
<ul>
<li>
<p>Using TERASOLUNA Batch 5.x for executing synchronous job only.</p>
</li>
<li>
<p>All job execution management including stop, restart of job is assigned to the job scheduler.</p>
<div class="ulist">
<ul>
<li>
<p>Do not use restart where the <code>JobRepository</code> possessed by Spring Batch is a prerequisite.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>When these are applicable, use <code> H2</code> which is an in-memory and built-in database as an option of RDBMS used by <code> JobRepository</code>.
On the other hand, when using asynchronous job or stop and restart by Spring Batch, RDBMS that can make the job execution status and result permanent, is required.<br>
For this point, <a href="#">Job management</a> should also be read.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">How to choose chunk model or tasklet model</div>
<ul>
<li>
<p><a href="#Ch03_CreateChunkJob">Chunk model</a></p>
<div class="ulist">
<ul>
<li>
<p>When you want to steadily process large amount of data</p>
</li>
<li>
<p>When you want to restart based on the record count</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="#Ch03_CreateTaskletJob">Tasklet model</a></p>
<div class="ulist">
<ul>
<li>
<p>When you want to make recovery as simple as possible</p>
</li>
<li>
<p>When you want to consolidate the process contents</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#Ch03_ChunkOrTasklet">How to choose chunk model or tasklet model</a> should also be read.</p>
</div>
<hr>
<div class="ulist">
<div class="title">Unification of bean scope</div>
<ul>
<li>
<p>In the Tasklet implementation, match with the scope of component to be Injected.</p>
</li>
<li>
<p>Composite type component matches with the scope of component to be delegated.</p>
</li>
<li>
<p>When using JobParameter, set to the scope of <code> step</code>.</p>
</li>
<li>
<p>If you want to save instance variables in Step unit, set to the scope of <code> step</code>.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Performance tuning points</div>
<ul>
<li>
<p>Adjust chunk size</p>
<div class="ulist">
<ul>
<li>
<p>When using Chunk, set the number of commits to an appropriate size. Do not increase the size too much.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Adjust fetch size</p>
<div class="ulist">
<ul>
<li>
<p>In database access, set fetch size to an appropriate size. Do not increase the size too much.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Make file reading more efficient</p>
<div class="ulist">
<ul>
<li>
<p>Provide a dedicated FieldSetMapper interface implementation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Parallel process and multiple processes</p>
<div class="ulist">
<ul>
<li>
<p>Implement by job scheduler.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Distributed processing</p>
<div class="ulist">
<ul>
<li>
<p>Implement by job scheduler.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div id="Ch99_SummaryOfPoints_dbpolling" class="ulist">
<div class="title">Asynchronous job (DB polling)</div>
<ul>
<li>
<p>Usage of in-memory database</p>
<div class="ulist">
<ul>
<li>
<p>It is not suitable for long-term continuous operation so it is desirable to restart it periodically.</p>
</li>
<li>
<p>When it is to be used for long-term continuous operation, maintenance work such as periodically deleting data from <code>JobRepository</code> is required.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Narrow-down of registered job</p>
<div class="ulist">
<ul>
<li>
<p>Specify the designed and implemented job based on asynchronous execution.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Mass processing of very short batch is not suitable since performance deterioration is possible.</p>
</li>
<li>
<p>Since parallel execution of the same job is possible, it is necessary to prevent the same job from affecting in parallel execution</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Asynchronous job (Web container)</div>
<ul>
<li>
<p>The basic consideration is same as <a href="#Ch99_SummaryOfPoints_dbpolling">Asynchronous job (DB polling)</a>.</p>
</li>
<li>
<p>Adjust thread pool.</p>
<div class="ulist">
<ul>
<li>
<p>Apart from the thread pool of asynchronous execution, it is necessary to consider the request thread of the Web container and other applications operating within the same unit.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In Web and batch, you cannot cross-reference data source, MyBatis setting and Mapper interface.</p>
</li>
<li>
<p>Failure to start a job due to thread pool exhaustion cannot be captured at job start, so provide a means to confirm it separately.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Database access and transaction</div>
<ul>
<li>
<p>"Use <code>MyBatisBatchItemWriter</code> in ItemWriter" and "Update reference using Mapper interface in ItemProcessor" cannot be done at the same time.</p>
<div class="ulist">
<ul>
<li>
<p>There is a restriction in MyBatis of not executing with two or more <code> ExecutorType</code> in the same transaction.
Refer to <a href="#Ch05_DBAccess_HowToUse_Processor">Database access of other than ItemReader/ItemWriter</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Notes on input/output of database to the same table</p>
<div class="ulist">
<ul>
<li>
<p>As the result of losing the information that guarantees reading consistency due to output (issue of UPDATE), error may occur in the input (SELECT). Consider the following measures.</p>
<div class="ulist">
<ul>
<li>
<p>It depends on the database so, increase the area to secure the information.</p>
</li>
<li>
<p>Split the input data and perform multiple processing.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">File access</div>
<ul>
<li>
<p>When dealing with the following fixed-length file, be sure to use the component provided by TERASOLUNA Batch 5.x.</p>
<div class="ulist">
<ul>
<li>
<p>Fixed-length file containing multibyte characters</p>
</li>
<li>
<p>Fixed length file without line break</p>
</li>
</ul>
</div>
</li>
<li>
<p>When skipping footer records, it is necessary to process with OS command.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Exclusive control</div>
<ul>
<li>
<p>When multiple jobs are concurrently executed, design a job so that the exclusive control is not required.</p>
<div class="ulist">
<ul>
<li>
<p>Resources to be accessed and processing targets should be split for each job.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Design in such a way that deadlocks are prevented from occurring.</p>
</li>
<li>
<p>File exclusive control should be implemented in the tasklet model.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Handling abnormal system</div>
<ul>
<li>
<p>Do not perform transaction processing in exception handling.</p>
</li>
<li>
<p>Note that ChunkListener behaves differently by the process model.</p>
<div class="ulist">
<ul>
<li>
<p>The exceptions generated by opening and closing the resources are</p>
<div class="ulist">
<ul>
<li>
<p>Chunk model: Not in the scope of catching  by ChunkListener interface.</p>
</li>
<li>
<p>Tasklet model: In the scope of catching  by ChunkListener interface.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Input check error cannot be recovered even by restarting unless the input resource that is the cause of check error is modified</p>
</li>
<li>
<p>How to cope when a failure occurs in JobRepository should be considered.</p>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">About ExecutionContext</div>
<ul>
<li>
<p>Since <code>ExecutionContext</code> is stored in the <code>JobRepository</code>, there are following restrictions.</p>
<div class="ulist">
<ul>
<li>
<p>The object to be stored in <code>ExecutionContext</code> should be the class that implements <code>java.io.Serializable</code>.</p>
</li>
<li>
<p>There should be a limit in the size that can be stored.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Exit code</div>
<ul>
<li>
<p>Exit code at the time of forced termination of Java process and the exit code of batch application are clearly distinguished.</p>
<div class="ulist">
<ul>
<li>
<p>It is strictly prohibited to set the exit code of process to 1 by batch application.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
<div class="ulist">
<div class="title">Parallel processing and multiple processing</div>
<ul>
<li>
<p>Do not use <code>Multi Thread Step</code>.</p>
</li>
<li>
<p>Depending on the processing content, be careful to possibility of resource contention and deadlock</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="container">

  <div class="common-bg">
    <div class="information">
      TERASOLUNA Batch Framework for Java (5.x) Development Guideline - version 5.0.1.RELEASE, 2017-9-27
    </div>
    <div class="index">
      <a href="#">&gt; INDEX</a>
    </div>
  </div>

  <div class="footer-bg">
    <div class="copyright">
      &copy; Copyright 2017 NTT DATA Corporation.
    </div>
  </div>

</div>
</body>
</html>